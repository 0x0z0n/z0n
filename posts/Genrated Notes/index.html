<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
  <meta charset="UTF-8" />
  <title>Windows Internals Notes</title>
  <link rel="icon" type="image/png" href="assets/tab.png" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

  <link rel="stylesheet" href="../style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Segoe+UI:wght@400;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet" />
  
  <link id="hljs-theme" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

  <style>
  :root {
    /* === Dark Theme (Default) === */
    --accent: #4caf50;
    --accent-glow: rgba(76, 175, 80, 0.4);
    --bg: #0c0c0c;
    --text: #e0e0e0;
    --text-muted: #888;
    --sidebar-bg: #111;
    --border: #333;
    --term-header: #2d2d2d;
    --code-bg: #1e1e1e;
    --input-bg: #1a1a1a;
    --admonition-bg: #151b23;
    --external-link: #f1c40f;
    --hover-bg: #1a1a1a;
    --scrollbar-thumb: #333;
    --shadow: rgba(0,0,0,0.5);
  }

  /* === Light Theme Overrides === */
  [data-theme="light"] {
    --accent: #2e7d32; /* Slightly darker green for contrast on white */
    --accent-glow: rgba(46, 125, 50, 0.3);
    --bg: #ffffff;
    --text: #24292f;
    --text-muted: #57606a;
    --sidebar-bg: #f6f8fa;
    --border: #d0d7de;
    --term-header: #e1e4e8;
    --code-bg: #ffffff;
    --input-bg: #ffffff;
    --admonition-bg: #f6f8fa;
    --external-link: #d32f2f; /* Red/Orange for better visibility on light */
    --hover-bg: #eaeef2;
    --scrollbar-thumb: #bbb;
    --shadow: rgba(0,0,0,0.15);
  }

  * { box-sizing: border-box; }
  html { height: 100%; scroll-behavior: smooth; }

  body {
    margin: 0;
    font-family: "Segoe UI", sans-serif;
    background: var(--bg);
    color: var(--text);
    display: flex;
    height: 100vh;
    overflow: hidden;
    transition: background 0.3s, color 0.3s;
  }

  /* === External Link Styling === */
  #content a.ext-link {
    color: var(--external-link) !important;
    text-decoration: underline;
    text-underline-offset: 3px;
    font-weight: 600;
  }
  #content a.ext-link:hover {
    filter: brightness(1.2);
  }

  /* === Top Progress Bar === */
  #progress-bar {
    position: fixed; top: 0; left: 0; width: 0%; height: 3px;
    background: linear-gradient(90deg, var(--accent), #00ff99);
    z-index: 9999; box-shadow: 0 0 10px var(--accent-glow);
    transition: width 0.1s linear;
  }

  /* === Sidebar (Left) === */
  .sidebar {
    width: 300px;
    background: var(--sidebar-bg);
    border-right: 1px solid var(--border);
    padding: 1.5rem;
    height: 100vh;
    flex-shrink: 0;
    display: flex; flex-direction: column;
    z-index: 100;
    transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), background 0.3s, border-color 0.3s;
  }

  .sidebar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
  }

  .sidebar h2 {
    color: var(--text); font-size: 0.85rem; letter-spacing: 1.5px;
    margin: 0; text-transform: uppercase; opacity: 0.6; font-weight: 700;
  }

  /* === Theme Toggle Button === */
  .theme-btn {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text);
      width: 35px; height: 35px;
      border-radius: 50%;
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s;
  }
  .theme-btn:hover { background: var(--hover-bg); border-color: var(--accent); color: var(--accent); }

  .search-box { position: relative; margin-bottom: 1.5rem; }
  .search-box input {
    width: 100%; background: var(--input-bg); border: 1px solid var(--border);
    color: var(--text); padding: 8px 10px 8px 30px; border-radius: 6px;
    outline: none; font-size: 0.85rem; transition: border-color 0.2s, background 0.3s;
  }
  .search-box input:focus { border-color: var(--accent); }
  .search-box i { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 0.8rem; }

  /* === Minimalist Sidebar CSS === */
  #toc, #toc ul { list-style: none; margin: 0; padding: 0; }
  #toc > li { margin-bottom: 4px; }
  #toc > li > a {
    font-weight: 600; color: var(--text-muted); display: block;
    padding: 8px 12px; border-radius: 6px; transition: all 0.2s;
    font-size: 0.95rem; text-decoration: none;
    display: flex; align-items: center; gap: 8px;
  }
  #toc > li > a:hover { color: var(--text); background: var(--hover-bg); }
  #toc > li > a.active { color: var(--accent); background: rgba(76, 175, 80, 0.1); font-weight: 700; }

  #toc > li > ul { margin-left: 0; padding-left: 0; }
  #toc li ul a {
    font-size: 0.9rem; color: var(--text-muted); opacity: 0.8;
    padding: 6px 12px 6px 32px;
    display: block; border-radius: 6px; transition: 0.2s; text-decoration: none;
    display: flex; align-items: center; gap: 8px;
  }
  #toc li ul a:hover { color: var(--text); background: var(--hover-bg); opacity: 1; }
  #toc li ul a.active { color: var(--accent); background: transparent; font-weight: 600; opacity: 1; }

  #toc-container { flex: 1; overflow-y: auto; padding-right: 5px; scroll-behavior: smooth; }
  #toc-container::-webkit-scrollbar { width: 4px; }
  #toc-container::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 4px; }

  /* === Main Content === */
  main {
    flex: 1; padding: 3rem 5rem;
    overflow-y: auto; height: 100vh; position: relative;
    scroll-behavior: smooth;
  }
  main::-webkit-scrollbar { width: 6px; }
  main::-webkit-scrollbar-thumb { background: var(--scrollbar-thumb); border-radius: 3px; }

  #content { max-width: 950px; margin: 0 auto; line-height: 1.8; font-size: 1.05rem; padding-bottom: 5rem; }

  .meta-info { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 2rem; display: flex; gap: 1.5rem; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 1rem; }
  h1, h2, h3 { color: var(--accent); margin-top: 3rem; position: relative; scroll-margin-top: 2rem; }
  h1 { font-size: 2.5rem; border-bottom: 1px solid var(--border); padding-bottom: 1rem; margin-top: 0; }
  .anchor-link { position: absolute; left: -25px; top: 0; color: var(--text-muted); font-size: 0.8em; opacity: 0; transition: opacity 0.2s; text-decoration: none; padding: 0 5px; cursor: pointer; }
  h1:hover .anchor-link, h2:hover .anchor-link, h3:hover .anchor-link { opacity: 1; }

  /* Terminal & UI elements */
  .terminal-wrapper { margin: 2rem 0; background: var(--code-bg); border-radius: 8px; box-shadow: 0 10px 30px var(--shadow); border: 1px solid var(--border); overflow: hidden; transition: background 0.3s, border-color 0.3s; }
  .terminal-header { background: var(--term-header); padding: 8px 15px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid var(--border); transition: background 0.3s; }
  .terminal-controls { display: flex; gap: 6px; }
  .control { width: 10px; height: 10px; border-radius: 50%; }
  .lang-badge { color: var(--text-muted); font-size: 0.7rem; font-family: 'JetBrains Mono'; font-weight: bold; text-transform: uppercase;}
  .copy-btn { background: transparent; border: 1px solid var(--text-muted); color: var(--text-muted); padding: 2px 8px; border-radius: 3px; font-size: 0.7rem; cursor: pointer; transition: 0.2s; }
  .copy-btn:hover { background: var(--border); color: var(--text); border-color: var(--text); }
  pre { margin: 0; padding: 1.5rem; overflow-x: auto; color: var(--text); }
  
  img { max-width: 100%; border-radius: 8px; margin: 2rem auto; display: block; box-shadow: 0 5px 20px var(--shadow); cursor: zoom-in; }
  
  .admonition { border-left: 4px solid; background: var(--admonition-bg); padding: 1rem 1.5rem; margin: 1.5rem 0; border-radius: 0 6px 6px 0; border-top: 1px solid var(--border); border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); transition: background 0.3s; }
  .admonition-title { font-weight: bold; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 10px; }
  .note { border-color: #1f6feb; } .note .admonition-title { color: #1f6feb; }
  .warning { border-color: #d29922; } .warning .admonition-title { color: #d29922; }
  .danger { border-color: #f85149; } .danger .admonition-title { color: #f85149; }

  #lightbox {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.95); display: flex; justify-content: center; align-items: center;
    z-index: 2000; opacity: 0; pointer-events: none; transition: opacity 0.3s;
  }
  #lightbox.active { opacity: 1; pointer-events: all; }
  #lb-img { max-height: 90vh; max-width: 90vw; box-shadow: 0 0 30px var(--accent-glow); transition: transform 0.2s ease; }

  .lb-nav {
    position: absolute; top: 50%; transform: translateY(-50%);
    color: #fff; font-size: 2rem; cursor: pointer; padding: 20px;
    background: rgba(0,0,0,0.3); border-radius: 50%;
    transition: 0.2s; z-index: 2001;
  }
  .lb-nav:hover { background: var(--accent); color: #000; }
  .lb-prev { left: 20px; }
  .lb-next { right: 20px; }
  
  .lb-counter {
    position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
    color: #888; font-family: 'JetBrains Mono'; font-size: 0.9rem;
    background: rgba(0,0,0,0.6); padding: 5px 15px; border-radius: 20px;
  }

  .skeleton { animation: shimmer 2s infinite linear; background: linear-gradient(to right, var(--sidebar-bg) 4%, var(--border) 25%, var(--sidebar-bg) 36%); background-size: 1000px 100%; }
  .sk-title { height: 40px; margin-bottom: 20px; width: 60%; border-radius: 4px; }
  .sk-line { height: 15px; margin-bottom: 12px; width: 100%; border-radius: 4px; }
  .sk-block { height: 200px; margin: 20px 0; width: 100%; border-radius: 8px; }
  @keyframes shimmer { 0% { background-position: -1000px 0; } 100% { background-position: 1000px 0; } }

  .back-to-top {
    position: fixed; bottom: 30px; right: 30px; background: var(--accent); color: #000;
    width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
    box-shadow: 0 4px 15px var(--accent-glow); cursor: pointer; opacity: 0; transform: translateY(20px);
    transition: all 0.3s; pointer-events: none; z-index: 90;
  }
  .back-to-top.visible { opacity: 1; transform: translateY(0); pointer-events: all; }

  @media (max-width: 992px) {
    .sidebar { position: fixed; left: -100%; box-shadow: 10px 0 30px rgba(0,0,0,0.8); }
    .sidebar.active { left: 0; }
    main { padding: 1.5rem; }
    .mobile-toggle { display: flex; position: fixed; bottom: 20px; left: 20px; width: 50px; height: 50px; background: #222; border: 1px solid #444; border-radius: 50%; color: #fff; align-items: center; justify-content: center; z-index: 101; }
    .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 99; opacity: 0; pointer-events: none; transition: 0.3s; }
    .overlay.active { opacity: 1; pointer-events: all; }
    .lb-nav { display: none; } 
  }
  </style>
</head>

<body>
  <div id="progress-bar"></div>
  <div class="overlay" onclick="toggleSidebar()"></div>
  <div class="mobile-toggle" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></div>

  <nav class="sidebar">
    <div class="sidebar-header">
        <h2>Structure</h2>
        <button class="theme-btn" onclick="toggleTheme()" title="Switch Theme">
            <i class="fa-solid fa-sun" id="theme-icon"></i>
        </button>
    </div>

    <div class="search-box">
      <i class="fa-solid fa-search"></i>
      <input type="text" id="toc-search" placeholder="Filter..." autocomplete="off">
    </div>
    
    <div id="toc-container"><ul id="toc"></ul></div>
    <div style="margin-top:auto; font-size:0.8rem; color:var(--text-muted); text-align:center; padding-top:20px;">
      &copy; 2026 0x0z0n
    </div>
  </nav>

  <main id="main-scroll">
    <a href="../../index.html" style="color:var(--accent);font-weight:bold;text-decoration:none;">‚Üê Return Home</a>
    
    <div id="skeleton-ui" style="margin-top:2rem;">
      <div class="skeleton sk-title"></div>
      <div class="skeleton sk-line"></div>
      <div class="skeleton sk-block"></div>
    </div>

    <div id="meta-info" class="meta-info" style="display:none;"></div>
    <div id="content" style="display:none; opacity:0; transition: opacity 0.5s ease;"></div>
    
    <div class="back-to-top" onclick="document.getElementById('main-scroll').scrollTo({top:0, behavior:'smooth'})">
      <i class="fa-solid fa-arrow-up"></i>
    </div>
  </main>

  <div id="lightbox">
    <div class="lb-nav lb-prev"><i class="fa-solid fa-chevron-left"></i></div>
    <img id="lb-img">
    <div class="lb-nav lb-next"><i class="fa-solid fa-chevron-right"></i></div>
    <div class="lb-counter"></div>
  </div>

  <script>
  // === Theme Logic ===
  const themeBtn = document.getElementById('theme-icon');
  const hljsLink = document.getElementById('hljs-theme');
  
  // 1. Check LocalStorage on load
  const savedTheme = localStorage.getItem('theme') || 'dark';
  document.documentElement.setAttribute('data-theme', savedTheme);
  updateThemeUI(savedTheme);

  function toggleTheme() {
      const html = document.documentElement;
      const current = html.getAttribute('data-theme');
      const next = current === 'dark' ? 'light' : 'dark';
      
      html.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
      updateThemeUI(next);
  }

  function updateThemeUI(theme) {
      // Icon
      themeBtn.className = theme === 'dark' ? 'fa-solid fa-sun' : 'fa-solid fa-moon';
      
      // Syntax Highlighting Swap (Atom One Dark <-> Atom One Light)
      const lightCss = "https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-light.min.css";
      const darkCss = "https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css";
      hljsLink.href = theme === 'dark' ? darkCss : lightCss;
  }

  // === Existing Logic ===
  const mdFile = "Internal_Notes.md";
  const safeId = t => t.trim().toLowerCase().replace(/[^\w]+/g, "-");

  function toggleSidebar() {
    document.querySelector('.sidebar').classList.toggle('active');
    document.querySelector('.overlay').classList.toggle('active');
  }

  fetch(mdFile)
    .then(res => res.text())
    .then(md => {
      marked.setOptions({
        highlight: (code, lang) => {
          const l = highlight.getLanguage(lang) ? lang : 'plaintext';
          return highlight.highlight(code, { language: l }).value;
        }
      });

      // Render Markdown
      let html = marked.parse(md);
      
      // Admonitions
      html = html.replace(/<blockquote>\s*<p>\[!(NOTE|WARNING|DANGER)\]\s*(.*?)<\/p>\s*((.|[\r\n])*?)<\/blockquote>/gim, 
        (match, type, title, body) => {
           const t = type.toLowerCase();
           const icon = t==='note'?'fa-info-circle':t==='warning'?'fa-exclamation-triangle':'fa-skull';
           return `<div class="admonition ${t}"><div class="admonition-title"><i class="fa-solid ${icon}"></i> ${title||type}</div><div>${body}</div></div>`;
        });

      const contentDiv = document.getElementById("content");
      contentDiv.innerHTML = html;

      // === YELLOW/RED HIGHLIGHT FOR EXTERNAL LINKS ===
      document.querySelectorAll('#content a').forEach(link => {
        const href = link.getAttribute('href');
        if (href && (href.startsWith('http://') || href.startsWith('https://'))) {
          link.classList.add('ext-link');
          link.setAttribute('target', '_blank');
          link.setAttribute('rel', 'noopener noreferrer');
        }
      });
      
      // Meta Info
      const wordCount = contentDiv.innerText.split(/\s+/).length;
      document.getElementById("meta-info").innerHTML = `<span><i class="fa-regular fa-clock"></i> ${Math.ceil(wordCount/200)} min</span><span><i class="fa-solid fa-pen-nib"></i> ${wordCount} words</span>`;
      document.getElementById("meta-info").style.display = "flex";

      document.getElementById("skeleton-ui").style.display = "none";
      contentDiv.style.display = "block";
      setTimeout(() => contentDiv.style.opacity = 1, 50);

      // TOC & Anchors
      const headings = Array.from(document.querySelectorAll("#content h1, #content h2, #content h3"));
      const toc = document.getElementById("toc");
      const tocStack = [{ level: 0, ul: toc }];

      headings.forEach((h, i) => {
        h.id = safeId(h.textContent) || `h-${i}`;
        const anchor = document.createElement("a");
        anchor.className = "anchor-link"; anchor.href = `#${h.id}`;
        anchor.innerHTML = '<i class="fa-solid fa-link"></i>';
        h.appendChild(anchor);

        const level = parseInt(h.tagName.substring(1));
        const iconClass = level < 3 ? "fa-regular fa-folder" : "fa-solid fa-angle-right";
        const li = document.createElement("li");
        li.innerHTML = `<a href="#${h.id}" data-target="${h.id}"><i class="${iconClass}" style="font-size:0.8em; opacity:0.7;"></i> ${h.childNodes[0].textContent}</a>`;
        
        while (tocStack.length > 1 && tocStack[tocStack.length - 1].level >= level) tocStack.pop();
        tocStack[tocStack.length - 1].ul.appendChild(li);
        
        const next = headings[i+1];
        if(next && parseInt(next.tagName.substring(1)) > level) {
          const ul = document.createElement("ul");
          li.appendChild(ul);
          tocStack.push({ level, ul });
        }
      });

      // Code Blocks
      document.querySelectorAll("pre").forEach(pre => {
        const wrapper = document.createElement("div"); wrapper.className = "terminal-wrapper";
        const lang = (pre.querySelector("code").className.match(/language-(\w+)/) || [])[1] || "TEXT";
        wrapper.innerHTML = `<div class="terminal-header"><div class="terminal-controls"><div class="control" style="background:#ff5f56"></div><div class="control" style="background:#ffbd2e"></div><div class="control" style="background:#27c93f"></div></div><div class="lang-badge">${lang}</div><button class="copy-btn">Copy</button></div>`;
        pre.parentNode.insertBefore(wrapper, pre);
        wrapper.appendChild(pre);
        wrapper.querySelector(".copy-btn").onclick = function() { navigator.clipboard.writeText(pre.innerText); this.textContent="Copied!"; setTimeout(()=>this.textContent="Copy",2000); };
      });

      // Gallery / Lightbox logic
      const lb = document.getElementById("lightbox");
      const lbImg = document.getElementById("lb-img");
      const lbCounter = document.querySelector(".lb-counter");
      const imgs = Array.from(document.querySelectorAll("#content img"));
      let curIndex = 0;

      imgs.forEach((img, index) => {
        img.onclick = () => {
          curIndex = index;
          updateLightbox();
          lb.classList.add("active");
          document.body.style.overflow = "hidden";
        };
      });

      function updateLightbox() {
        lbImg.style.opacity = 0;
        setTimeout(() => {
          lbImg.src = imgs[curIndex].src;
          lbImg.style.opacity = 1;
          lbCounter.innerText = `${curIndex + 1} / ${imgs.length}`;
        }, 100);
      }

      const nextImg = (e) => { if(e) e.stopPropagation(); curIndex = (curIndex + 1) % imgs.length; updateLightbox(); };
      const prevImg = (e) => { if(e) e.stopPropagation(); curIndex = (curIndex - 1 + imgs.length) % imgs.length; updateLightbox(); };

      document.querySelector(".lb-next").onclick = nextImg;
      document.querySelector(".lb-prev").onclick = prevImg;
      lb.onclick = () => { lb.classList.remove("active"); document.body.style.overflow = ""; };

      // === SCROLL SPY LOGIC ===
      const main = document.getElementById("main-scroll");
      const sidebarLinks = document.querySelectorAll("#toc a");
      const backBtn = document.querySelector(".back-to-top");

      main.addEventListener("scroll", () => {
        // Progress bar
        const pct = (main.scrollTop / (main.scrollHeight - main.clientHeight)) * 100;
        document.getElementById("progress-bar").style.width = pct + "%";
        
        // Back to top
        backBtn.classList.toggle("visible", main.scrollTop > 500);

        // Heading detection
        let current = "";
        const scrollPos = main.scrollTop + 100; // Offset for better detection
        
        headings.forEach(h => {
          if (scrollPos >= h.offsetTop) {
            current = h.id;
          }
        });

        // Sidebar Sync
        sidebarLinks.forEach(l => {
          l.classList.remove("active");
          if(l.getAttribute("data-target") === current) {
            l.classList.add("active");
            
            // Auto-scroll the sidebar container if the active link is hidden
            const container = document.getElementById("toc-container");
            const linkRect = l.getBoundingClientRect();
            const containerRect = container.getBoundingClientRect();

            if (linkRect.top < containerRect.top || linkRect.bottom > containerRect.bottom) {
                l.scrollIntoView({ behavior: "smooth", block: "nearest" });
            }
          }
        });
      });

      // Filter
      document.getElementById("toc-search").addEventListener("input", (e) => {
        const val = e.target.value.toLowerCase();
        document.querySelectorAll("#toc li").forEach(li => li.style.display = li.innerText.toLowerCase().includes(val) ? "block" : "none");
      });
    });
  </script>
</body>
</html>